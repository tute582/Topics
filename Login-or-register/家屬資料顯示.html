<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å®¶å±¬å€‹äººè³‡æ–™</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      /* --- æ²¿ç”¨ä¹‹å‰çš„ CSS --- */
      body {
        font-family: "Arial", sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
      }
      .card {
        max-width: 720px;
        margin: 24px auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
      }
      h1 { margin: 0; font-size: 28px; }
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #0078d4;
        margin-bottom: 0px;
      }
      dl {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 8px 16px;
        text-align: left;
        margin-top: 10px;
      }
      dt { font-weight: 700; color: #333; }
      dd { margin: 0; color: #222; word-break: break-word; }
      .back {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #0078d4;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
      }
      #editBtn {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #3a3d3f;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
        cursor: pointer;
      }
      .empty { color: #666; }
      
      /* Nav Bar */
      .nav-1 {
        display: flex;
        font-weight: bold;
        align-items: center;
        justify-content: space-between;
        padding: 10px 25px;
        position: sticky;
        top: 0;
        z-index: 1001;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        color: black;
        background-color: white;
        box-sizing: border-box;
        border-bottom: 1px solid #ddd;
      }

      /* Modal CSS */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center; /* è®“ modal-content å‚ç›´ç½®ä¸­ */
        z-index: 2000;
        backdrop-filter: blur(4px); 
        padding: 20px; /* å¢åŠ å››å‘¨é–“è·ï¼Œç¢ºä¿ä¸æœƒè²¼é‚Š */
        box-sizing: border-box;
      }

      /* â˜…â˜…â˜… æ–°å¢ï¼šæ•™å­¸ Modal çš„å±¤ç´šè¦æ¯”ä¸€èˆ¬ Modal é«˜ â˜…â˜…â˜… */
      #helpModal {
        z-index: 2100; 
      }
      
      .modal-content {
        background: #fff;
        /* margin: 40px auto;  <-- é€™ä¸€è¡Œå¯ä»¥æ‹¿æ‰ï¼Œç”± overlay çš„ padding æ§åˆ¶ */
        padding: 20px 15px;
        border-radius: 16px;
        position: relative;
        width: 90%;
        max-width: 400px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        
        /* --- é—œéµä¿®æ”¹é» --- */
        max-height: 90vh;      /* é™åˆ¶æœ€å¤§é«˜åº¦ç‚ºè¢å¹•é«˜åº¦çš„ 90% */
        overflow-y: auto;      /* ç•¶å…§å®¹è¶…é max-height æ™‚ï¼Œè‡ªå‹•é¡¯ç¤ºå‚ç›´æ²è»¸ */
        display: flex;         /* ç¢ºä¿å…§éƒ¨æ’ç‰ˆç©©å®š */
        flex-direction: column;
      }
      
      .close-btn {
        position: absolute;
        top: 12px; 
        right: 12px; 
        width: 30px; 
        height: 30px; 
        background-color: #f37a7a;
        color: white;
        border-radius: 50%; 
        border: none; 
        font-size: 14px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer;
        z-index: 10;
      }

      .family-form {
        max-width: 100%;      /* æ”¹ç‚º 100% é…åˆçˆ¶å®¹å™¨ */
        margin: 10px 0;       /* ç¨å¾®èª¿æ•´é–“è· */
        padding: 10px;        /* ç¸®æ¸›ä¸€äº›å…§è·ï¼ŒæŠŠç©ºé–“ç•™çµ¦å…§å®¹ */
        box-shadow: none;     /* å› ç‚ºå¤–é¢å·²ç¶“æœ‰ modal-content çš„é™°å½±äº† */
      }
      .family-form h3 { text-align: center; margin-bottom: 20px; }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
      .form-group input, .form-group select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #4a90e2;
      }
      .btn {
        padding: 14px;
        border: none; 
        border-radius: 12px; 
        color: #fff; 
        cursor: pointer; 
        font-size: 16px; 
        width: 100%; 
        margin-top: 25px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        font-weight: bold;
        background-color: #4a90e2;
      }

      /* â˜…â˜…â˜… æ–°å¢ï¼šå•è™Ÿåœ–ç¤ºèˆ‡æ•™å­¸åœ–ç‰‡æ¨£å¼ â˜…â˜…â˜… */
      .input-with-icon {
        display: flex;
        align-items: center;
        gap: 10px; /* è¼¸å…¥æ¡†èˆ‡å•è™Ÿçš„é–“è· */
      }
      .help-btn {
        color: #aaa; /* æ·ºç°è‰² */
        font-size: 20px;
        cursor: pointer;
        transition: color 0.3s;
      }
      .help-btn:hover {
        color: #0984e3; /* é»æ“Šæˆ–æ»‘éè®Šæ·±è‰² */
      }
      .tutorial-img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        margin-top: 10px;
        border: 1px solid #eee;
      }
      .tutorial-step {
        margin-bottom: 15px;
        text-align: left;
        line-height: 1.5;
        color: #444;
      }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div>
        <h1>å®¶å±¬å€‹äººè³‡æ–™</h1>
      </div>
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span class="volunteer-area" style="display: flex; align-items: center; gap: 8px">
            <img id="navAvatar" class="avatar" src="default-avatar.png" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #0984e3;" />
            <span id="navName" style="cursor: pointer">æœªç™»å…¥</span>
          </span>
        </h1>
      </div>
    </nav>

    <div class="card">
      <img id="mainAvatar" class="avatar" src="default-avatar.png" alt="ä½¿ç”¨è€…é ­åƒ" />
      <div id="content"></div>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
        <a id="editBtn" onclick="openFamilyModal()">ä¿®æ”¹è³‡æ–™</a>
        <a id="backBtn" class="back">å›åˆ°åŸé é¢</a>
    </div>

    <script>
      let currentFamily = null;
      const content = document.getElementById("content");
      const navAvatar = document.getElementById("navAvatar");
      const mainAvatar = document.getElementById("mainAvatar");
      const navName = document.getElementById("navName");

      const userId = localStorage.getItem("userId");
      console.log("å–å¾—çš„ userIdï¼š", userId);

      content.innerHTML = `<p>è³‡æ–™è¼‰å…¥ä¸­...</p>`;

      if (!userId) {
        content.innerHTML = '<p class="empty">å°šæœªç™»å…¥ï¼Œç„¡æ³•å–å¾—è³‡æ–™ã€‚</p>';
      } else {
        fetch(`https://supabase-api-six.vercel.app/familys/${userId}`)
          .then((res) => res.json())
          .then((result) => {
            if (!result.success || !result.data) {
              content.innerHTML = '<p class="empty">æ‰¾ä¸åˆ°å®¶å±¬è³‡æ–™ã€‚</p>';
              return;
            }

            const d = result.data;
            currentFamily = d;

            const avatarUrl = d.image_url && d.image_url.trim() !== "" ? d.image_url : "default-avatar.png";
            navAvatar.src = avatarUrl;
            mainAvatar.src = avatarUrl;

            navName.textContent = d.family_name || "æœªç™»å…¥";

            const html = `
            <dl>
              <dt>å§“å</dt><dd>${d.family_name || ""}</dd>
              <dt>é€£çµ¡é›»è©±</dt><dd>${d.phone || ""}</dd>
              <dt>é›»å­éƒµä»¶</dt><dd>${d.email || "â€”"}</dd>
              <dt>åœ°å€</dt><dd>${d.address || "â€”"}</dd>
              
              <hr style="grid-column: 1 / -1; width: 100%; border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
              
              <dt style="color: #0984e3;">ç¶å®šé•·è€… ID</dt><dd>${d.elder_user_id || "<span style='color:#999'>(å°šæœªç¶å®š)</span>"}</dd>
              <dt>èˆ‡é•·è€…é—œä¿‚</dt><dd>${d.relationship || ""}</dd>
            </dl>
          `;
            content.innerHTML = html;
          })
          .catch((error) => {
            console.error("API éŒ¯èª¤:", error);
            content.innerHTML = '<p class="empty">ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ã€‚</p>';
          });
      }

      const fromPage = localStorage.getItem("fromPage");
      let targetUrl = "../../Topics/Topics/bookvolunteer/index.html"; 
      document.getElementById("backBtn").href = targetUrl;

      /* ================= Modal é‚è¼¯ ================= */
      function openFamilyModal() {
        if (!currentFamily) return;
        document.getElementById("familyModal").style.display = "flex";
        
        const f = document.forms.familyForm;
        f.family_name.value = currentFamily.family_name || "";
        f.phone.value = currentFamily.phone || "";
        f.email.value = currentFamily.email || "";
        f.address.value = currentFamily.address || "";
        f.relationship.value = currentFamily.relationship || "";
        f.elder_user_id.value = currentFamily.elder_user_id || "";
      }

      function closeFamilyModal() {
        document.getElementById("familyModal").style.display = "none";
      }

      /* â˜…â˜…â˜… æ–°å¢ï¼šé–‹å•Ÿ/é—œé–‰æ•™å­¸è¦–çª—é‚è¼¯ â˜…â˜…â˜… */
      function openHelpModal() {
        document.getElementById("helpModal").style.display = "flex";
      }
      function closeHelpModal() {
        document.getElementById("helpModal").style.display = "none";
      }

      /* ================= ä¿®æ”¹è³‡æ–™ API ================= */
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("familyForm");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(form);

          const payload = {
            family_name: formData.get("family_name"),
            phone: formData.get("phone"),
            email: formData.get("email"),
            address: formData.get("address"),
            relationship: formData.get("relationship"),
            elder_user_id: formData.get("elder_user_id") 
          };

          console.log("é€å‡º payload ğŸ‘‰", payload);

          fetch(`https://supabase-api-six.vercel.app/familys/${userId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then(res => res.json())
            .then(result => {
              if (!result.success) {
                alert("æ›´æ–°å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
                return;
              }
              alert("ä¿®æ”¹æˆåŠŸ âœ…");
              closeFamilyModal();
              location.reload();
            })
            .catch(err => {
              console.error(err);
              alert("ç³»çµ±éŒ¯èª¤");
            });
        });
      });
    </script>

    <div id="familyModal" class="modal-overlay">
      <div class="modal-content">
        <button class="close-btn" onclick="closeFamilyModal()"><i class="fas fa-times"></i></button>
        <form id="familyForm" class="family-form" name="familyForm">
          <h3>å®¶å±¬è³‡æ–™ä¿®æ”¹</h3>
        
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="family_name" required />
          </div>
        
          <div class="form-group">
            <label>é€£çµ¡é›»è©±</label>
            <input type="tel" name="phone" required />
          </div>

          <div class="form-group">
            <label>é›»å­éƒµä»¶</label>
            <input type="email" name="email" />
          </div>
        
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" name="address" required />
          </div>

          <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">

          <div class="form-group">
            <label style="color: #0984e3;">ç¶å®šé•·è€… ID</label>
            <div class="input-with-icon">
                <input type="text" name="elder_user_id" placeholder="è«‹è¼¸å…¥é•·è¼©çš„ ID" style="flex: 1;" />
                <i class="fa-solid fa-circle-question help-btn" onclick="openHelpModal()" title="å¦‚ä½•å–å¾— IDï¼Ÿ"></i>
            </div>
          </div>

          <div class="form-group">
            <label>èˆ‡é•·è€…é—œä¿‚</label>
             <select name="relationship" required>
                <option value="é…å¶">é…å¶</option>
                <option value="å­å¥³">å­å¥³</option>
                <option value="å­«å­å¥³">å­«å­å¥³</option>
                <option value="å…„å¼Ÿå§Šå¦¹">å…„å¼Ÿå§Šå¦¹</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
        
          <button type="submit" class="btn">å„²å­˜ä¿®æ”¹</button>
        </form>
      </div>
    </div>

    <div id="helpModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeHelpModal()"><i class="fas fa-times"></i></button>
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">å¦‚ä½•å–å¾—é•·è€… IDï¼Ÿ</h3>
            
            <div style="text-align: left; padding: 0 10px;">
                <div class="tutorial-step">
                    <strong>æ­¥é©Ÿ 1ï¼š</strong> è«‹é•·è€…æ‰“é–‹ LINEã€‚
                </div>
                <div class="tutorial-step">
                    <strong>æ­¥é©Ÿ 2ï¼š</strong> é»é¸ã€ŒAI æ™ºèƒ½è¼”åŠ©æ©Ÿå™¨äººã€å®˜æ–¹å¸³è™Ÿã€‚
                </div>
                <div class="tutorial-step">
                    <strong>æ­¥é©Ÿ 3ï¼š</strong> åœ¨èŠå¤©ç•«é¢ä¸­è¼¸å…¥é—œéµå­—ã€ŒIDã€ï¼Œç³»çµ±æœƒè‡ªå‹•å›å‚³é•·è€…çš„ IDã€‚
                </div>
                <div class="tutorial-step">
                    <strong>æ­¥é©Ÿ 4ï¼š</strong> è«‹å°‡æ”¶åˆ°çš„ ID è¤‡è£½å¾Œï¼Œæä¾›çµ¦å®¶å±¬é€²è¡Œç¶å®šã€‚
                </div>
                
                <p style="font-size: 14px; color: #666; margin-bottom: 5px;">åƒè€ƒç•«é¢ï¼š</p>
                <img src="../Images/getId.png" class="tutorial-img" alt="æ•™å­¸ç¤ºæ„åœ–">
            </div>

            <button class="btn" onclick="closeHelpModal()" style="background-color: #888; margin-top: 20px;">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

  </body>
</html>