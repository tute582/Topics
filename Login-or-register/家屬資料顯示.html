<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>å®¶å±¬å€‹äººè³‡æ–™</title>

    <style>
      /* --- æ²¿ç”¨é•·è¼©é é¢çš„ CSS æ¨£å¼ --- */
      body {
        font-family: "Arial", sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
      }
      .card {
        max-width: 720px;
        margin: 24px auto;
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        text-align: center;
      }
      h1 { margin: 0; font-size: 28px; }
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #0078d4;
        margin-bottom: 0px;
      }
      dl {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 8px 16px;
        text-align: left;
        margin-top: 10px;
      }
      dt { font-weight: 700; color: #333; }
      dd { margin: 0; color: #222; word-break: break-word; }
      .back {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #0078d4;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
      }
      #editBtn {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #3a3d3f;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
        cursor: pointer;
      }
      .empty { color: #666; }
      
      /* Nav Bar */
      .nav-1 {
        display: flex;
        font-weight: bold;
        align-items: center;
        justify-content: space-between;
        padding: 10px 25px;
        position: sticky;
        top: 0;
        z-index: 1001;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        color: black;
        background-color: white;
        box-sizing: border-box;
        border-bottom: 1px solid #ddd;
      }

      /* Modal CSS */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index:2000;
        backdrop-filter: blur(4px); 
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
      }
      
      .modal-content {
        background: #fff;
        margin: 40px auto; 
        overflow-y: auto;
        padding: 20px 15px;
        border-radius: 16px;
        position: relative;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        max-width: 400px; 
      }
      
      .close-btn {
        position: absolute;
        top: 12px; 
        right: 12px; 
        width: 30px; 
        height: 30px; 
        background-color: #f37a7a;
        color: white;
        border-radius: 50%; 
        border: none; 
        font-size: 14px; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer;
        z-index: 10;
      }

      .family-form {
        max-width: 500px;
        margin: 30px auto;
        padding: 24px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        font-family: Arial, sans-serif;
      }
      .family-form h3 { text-align: center; margin-bottom: 20px; }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
      .form-group input, .form-group select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }
      .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #4a90e2;
      }
      .btn {
        padding: 14px;
        border: none; 
        border-radius: 12px; 
        color: #fff; 
        cursor: pointer; 
        font-size: 16px; 
        width: 100%; 
        margin-top: 25px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        font-weight: bold;
        background-color: #4a90e2;
      }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div>
        <h1>å®¶å±¬å€‹äººè³‡æ–™</h1>
      </div>
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span class="volunteer-area" style="display: flex; align-items: center; gap: 8px">
            <img id="navAvatar" class="avatar" src="default-avatar.png" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid #0984e3;" />
            <span id="navName" style="cursor: pointer">æœªç™»å…¥</span>
          </span>
        </h1>
      </div>
    </nav>

    <div class="card">
      <img id="mainAvatar" class="avatar" src="default-avatar.png" alt="ä½¿ç”¨è€…é ­åƒ" />
      <div id="content"></div>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
        <a id="editBtn" onclick="openFamilyModal()">ä¿®æ”¹è³‡æ–™</a>
        <a id="backBtn" class="back">å›åˆ°åŸé é¢</a>
    </div>

    <script>
      let currentFamily = null;
      const content = document.getElementById("content");
      const navAvatar = document.getElementById("navAvatar");
      const mainAvatar = document.getElementById("mainAvatar");
      const navName = document.getElementById("navName");

      // å¾ localStorage å–å¾— UserID
      const userId = localStorage.getItem("userId");
      console.log("å–å¾—çš„ userIdï¼š", userId);

      content.innerHTML = `<p>è³‡æ–™è¼‰å…¥ä¸­...</p>`;

      if (!userId) {
        content.innerHTML = '<p class="empty">å°šæœªç™»å…¥ï¼Œç„¡æ³•å–å¾—è³‡æ–™ã€‚</p>';
      } else {
        // å‘¼å«å®¶å±¬ API
        fetch(`https://supabase-api-six.vercel.app/familys/${userId}`)
          .then((res) => res.json())
          .then((result) => {
            if (!result.success || !result.data) {
              content.innerHTML = '<p class="empty">æ‰¾ä¸åˆ°å®¶å±¬è³‡æ–™ã€‚</p>';
              return;
            }

            const d = result.data;
            currentFamily = d;

            /* é ­åƒè™•ç† */
            const avatarUrl = d.image_url && d.image_url.trim() !== "" ? d.image_url : "default-avatar.png";
            navAvatar.src = avatarUrl;
            mainAvatar.src = avatarUrl;

            /* åç¨±é¡¯ç¤º */
            navName.textContent = d.family_name || "æœªç™»å…¥";

            /* é¡¯ç¤ºå®¶å±¬æ¬„ä½ */
            const html = `
            <dl>
              <dt>å§“å</dt><dd>${d.family_name || ""}</dd>
              <dt>é€£çµ¡é›»è©±</dt><dd>${d.phone || ""}</dd>
              <dt>é›»å­éƒµä»¶</dt><dd>${d.email || "â€”"}</dd>
              <dt>åœ°å€</dt><dd>${d.address || "â€”"}</dd>
              
              <hr style="grid-column: 1 / -1; width: 100%; border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
              
              <dt style="color: #0984e3;">ç¶å®šé•·è€… ID</dt><dd>${d.elder_user_id || "<span style='color:#999'>(å°šæœªç¶å®š)</span>"}</dd>
              <dt>èˆ‡é•·è€…é—œä¿‚</dt><dd>${d.relationship || ""}</dd>
            </dl>
          `;
            content.innerHTML = html;
          })
          .catch((error) => {
            console.error("API éŒ¯èª¤:", error);
            content.innerHTML = '<p class="empty">ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ã€‚</p>';
          });
      }

      // è¿”å›æŒ‰éˆ•é‚è¼¯
      const fromPage = localStorage.getItem("fromPage");
      let targetUrl = "../../Topics/Topics/bookvolunteer/index.html"; 
      // å¯æ ¹æ“šéœ€æ±‚å¢åŠ  case
      document.getElementById("backBtn").href = targetUrl;

      /* ================= Modal é‚è¼¯ ================= */
      function openFamilyModal() {
        if (!currentFamily) return;
        document.getElementById("familyModal").style.display = "flex";
        
        const f = document.forms.familyForm;
        // å¡«å…¥ç¾æœ‰è³‡æ–™
        f.family_name.value = currentFamily.family_name || "";
        f.phone.value = currentFamily.phone || "";
        f.email.value = currentFamily.email || "";
        f.address.value = currentFamily.address || "";
        f.relationship.value = currentFamily.relationship || "";
        
        // â˜…â˜…â˜… æ–°å¢ï¼šå°‡é•·è€… ID å¡«å…¥æ¬„ä½ â˜…â˜…â˜…
        f.elder_user_id.value = currentFamily.elder_user_id || "";
      }

      function closeFamilyModal() {
        document.getElementById("familyModal").style.display = "none";
      }

      /* ================= ä¿®æ”¹è³‡æ–™ API ================= */
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("familyForm");
        if (!form) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(form);

          // æº–å‚™ Patch Payload
          const payload = {
            family_name: formData.get("family_name"),
            phone: formData.get("phone"),
            email: formData.get("email"),
            address: formData.get("address"),
            relationship: formData.get("relationship"),
            // â˜…â˜…â˜… æ–°å¢ï¼šåŠ å…¥é•·è€… ID åˆ°æ›´æ–° payload â˜…â˜…â˜…
            elder_user_id: formData.get("elder_user_id") 
          };

          console.log("é€å‡º payload ğŸ‘‰", payload);

          fetch(`https://supabase-api-six.vercel.app/familys/${userId}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then(res => res.json())
            .then(result => {
              if (!result.success) {
                alert("æ›´æ–°å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
                return;
              }
              alert("ä¿®æ”¹æˆåŠŸ âœ…");
              closeFamilyModal();
              location.reload();
            })
            .catch(err => {
              console.error(err);
              alert("ç³»çµ±éŒ¯èª¤");
            });
        });
      });
    </script>

    <div id="familyModal" class="modal-overlay">
      <div class="modal-content">
        <button class="close-btn" onclick="closeFamilyModal()"><i class="fas fa-times"></i>âœ•</button>
        <form id="familyForm" class="family-form" name="familyForm">
          <h3>å®¶å±¬è³‡æ–™ä¿®æ”¹</h3>
        
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="family_name" required />
          </div>
        
          <div class="form-group">
            <label>é€£çµ¡é›»è©±</label>
            <input type="tel" name="phone" required />
          </div>

          <div class="form-group">
            <label>é›»å­éƒµä»¶</label>
            <input type="email" name="email" />
          </div>
        
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" name="address" required />
          </div>

          <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">

          <div class="form-group">
            <label style="color: #0984e3;">ç¶å®šé•·è€… ID</label>
            <input type="text" name="elder_user_id" placeholder="è«‹è¼¸å…¥é•·è¼©çš„ ID ä»¥é€²è¡Œç¶å®š" />
          </div>

          <div class="form-group">
            <label>èˆ‡é•·è€…é—œä¿‚</label>
             <select name="relationship" required>
                <option value="é…å¶">é…å¶</option>
                <option value="å­å¥³">å­å¥³</option>
                <option value="å­«å­å¥³">å­«å­å¥³</option>
                <option value="å…„å¼Ÿå§Šå¦¹">å…„å¼Ÿå§Šå¦¹</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
        
          <button type="submit" class="btn">å„²å­˜ä¿®æ”¹</button>
        </form>
      </div>
    </div>

  </body>
</html>