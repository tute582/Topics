<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>é•·è¼©å€‹äººè³‡æ–™</title>

    <style>
      /* --- æ•´é«”é é¢è¨­å®š --- */
      body {
        font-family: "Arial", sans-serif; /* å­—å‹ */
        background: #f4f6f8; /* æ·ºç°èƒŒæ™¯ */
        margin: 0;
        padding: 0;
      }

      /* --- ä¸»è¦å…§å®¹å¡ç‰‡ --- */
      .card {
        max-width: 720px; /* æœ€å¤§å¯¬åº¦ */
        margin: 24px auto; /* å‚ç›´é–“è· + ç½®ä¸­ */
        background: #fff; /* ç™½è‰²èƒŒæ™¯ */
        padding: 20px;
        border-radius: 8px; /* åœ“è§’ */
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08); /* é™°å½± */
        text-align: center; /* å…§å®¹ç½®ä¸­ */
      }

      /* --- æ¨™é¡Œè¨­å®š --- */
      h1 {
        margin: 0 0 0 0;
        font-size: 28px;
      }

      /* --- é ­åƒåœ–ç‰‡æ¨£å¼ --- */
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%; /* åœ“å½¢ */
        object-fit: cover; /* åœ–ç‰‡è‡ªå‹•è£åˆ‡å¡«æ»¿ */
        border: 3px solid #0078d4; /* å¤–æ¡†è—è‰² */
        margin-bottom: 0px;
      }

      /* --- å®šç¾©æ¸…å–®æ¨£å¼ (é¡¯ç¤ºå€‹äººè³‡æ–™ç”¨) --- */
      dl {
        display: grid; /* ä½¿ç”¨ç¶²æ ¼æ’ç‰ˆ */
        grid-template-columns: 140px 1fr; /* å·¦æ¨™é¡Œæ¬„ + å³å…§å®¹æ¬„ */
        gap: 8px 16px; /* é–“è· */
        text-align: left;
        margin-top: 10px;
      }

      dt {
        font-weight: 700; /* æ¨™é¡Œç²—é«” */
        color: #333;
      }

      dd {
        margin: 0;
        color: #222;
        word-break: break-word; /* è‡ªå‹•æ›è¡Œé¿å…æº¢å‡º */
      }

      /* --- è¿”å›æŒ‰éˆ•æ¨£å¼ --- */
      .back {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #0078d4;
        color: #fff;
        border-radius: 6px;
        text-decoration: none; /* ç§»é™¤åº•ç·š */
      }
      
       #editBtn{
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #3a3d3f;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
      }
      
      .empty {
        color: #666;
      }
      
      /* --- å°è¦½åˆ—(nav bar) --- */
      .nav-1 {
        display: flex; /* æ°´å¹³æ’åˆ— */
        font-weight: bold;
        align-items: center; /* å‚ç›´ç½®ä¸­ */
        justify-content: space-between; /* å·¦å³å…©ç«¯å°é½Š */
        padding: 10px 25px;
        position: sticky; /* æ»¾å‹•æ™‚å›ºå®šä¸Šæ–¹ */
        top: 0;
        z-index: 1001; /* ä½æ–¼æœ€ä¸Šå±¤ */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        color: black;
        background-color: white;
        box-sizing: border-box;
        border-bottom: 1px solid #ddd; /* ä¸‹é‚Šç•Œç·š */
      }

      .tag-display {
        display: inline-block;
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
        border-radius: 12px;
        padding: 4px 10px;
        margin: 4px 6px 0 0;
        font-size: 14px;
        white-space: nowrap;
      }

      /* ä¿®æ”¹modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index:2000;
        backdrop-filter: blur(4px); 
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch;
      }
      
      .modal-content {
        background: #fff;
        margin: 40px auto; 
        overflow-y: auto;
        padding: 20px 15px;
        border-radius: 16px;
        position: relative;
        width: 90%; /* ç¨å¾®ç¸®å°å¯¬åº¦ */
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
        max-width: 400px; 
      }
      
      .close-btn {
        position: absolute;
        top: 12px; 
        right: 12px; 
        width: 30px; 
        height: 30px; 
        background-color: #f37a7a;
        color: white;
        border-radius: 50%; 
        border: none; 
        font-size: 14px; 
        isplay: flex; 
        align-items: center; 
        ustify-content: center;
        cursor: pointer;
        z-index: 10;
      }

        /* modal è¡¨å–® */
      .elder-form {
        max-width: 500px;
        margin: 30px auto;
        padding: 24px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        font-family: Arial, sans-serif;
          }
          
          .elder-form h3 {
            text-align: center;
            margin-bottom: 20px;
          }
          
          .form-group {
            margin-bottom: 15px;
          }
          
          .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
          }
          
          .form-group input:focus,
          .form-group select:focus,
          .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
          }
          
          .btn {
            padding: 14px;
            border: none; 
            border-radius: 12px; 
            color: #fff; 
            cursor: pointer; 
            font-size: 16px; 
            width: 100%; 
            margin-top: 25px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-weight: bold;
            background-color: #4a90e2;
          }
      
    </style>
  </head>

  <body>
    <!-- å°è¦½åˆ— -->
    <nav class="nav-1">
      <div>
        <h1>é•·è¼©å€‹äººè³‡æ–™</h1>
      </div>

      <!-- å°è¦½åˆ—å³å´é¡¯ç¤ºå¿—å·¥é ­åƒèˆ‡åç¨± -->
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <!-- å°è¦½åˆ—ä¸Šçš„å°é ­åƒ -->
            <img
              id="avatar"
              class="avatar"
              src="default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <!-- é¡¯ç¤ºå¿—å·¥åç¨±ï¼ˆé è¨­æœªç™»å…¥ï¼‰ -->
            <span
              id="volunteerName"
              title="é»æ­¤ä»¥ Line ç™»å…¥"
              style="cursor: pointer"
              >æœªç™»å…¥</span
            >
          </span>
        </h1>
      </div>
    </nav>

    <!-- ä¸»è¦å¡ç‰‡å…§å®¹ -->
    <div class="card">
      <!-- ä½¿ç”¨è€…é ­åƒï¼ˆå¡ç‰‡å…§çš„å¤§é ­åƒï¼‰ -->
      <img
        id="volunteerAvatar"
        class="avatar"
        src="default-avatar.png"
        alt="ä½¿ç”¨è€…é ­åƒ"
      />

      <!-- é€™è£¡æ”¾ä½¿ç”¨è€…è©³ç´°è³‡æ–™ -->
      <div id="content"></div>
      
    </div>

      <!-- è¿”å›é é¢å’Œä¿®æ”¹æŒ‰éˆ• -->
      <a id="editBtn" class="edit" onclick="openElderModal()">ä¿®æ”¹è³‡æ–™</a>
      <a id="backBtn" class="back">å›åˆ°åŸé é¢</a>


    <!-- JavaScript å€åŸŸ -->
    <script>
      let currentElder = null;
      // å–å¾—ç¶²é ä¸­éœ€è¦æ“ä½œçš„å…ƒç´ 
      const content = document.getElementById("content"); // é¡¯ç¤ºè³‡æ–™å…§å®¹å€
      const avatar = document.getElementById("avatar"); // å°è¦½åˆ—é ­åƒ
      const volunteerAvatar = document.getElementById("volunteerAvatar"); // å¡ç‰‡å¤§é ­åƒ
      const raw = localStorage.getItem("seniors"); // å¾ localStorage å–è³‡æ–™ï¼ˆJSON å­—ä¸²ï¼‰
      const volunteerName = document.getElementById("volunteerName");


      // å¾ localStorage å–å¾—ä¸Šæ¬¡å„²å­˜çš„å¿—å·¥è³‡æ–™
      const userId = localStorage.getItem("userId");
      console.log("å–å¾—çš„userIdï¼š", userId);

      // é¡¯ç¤º loadingï¼ˆå¯é¸ï¼‰
      content.innerHTML = `<p>è³‡æ–™è¼‰å…¥ä¸­...</p>`;

      if (!userId) {
        content.innerHTML = '<p class="empty">å°šæœªç™»å…¥ï¼Œç„¡æ³•å–å¾—è³‡æ–™ã€‚</p>';
      } else {
        // å‘¼å« Elder API
        fetch(`https://supabase-api-six.vercel.app/elders/${userId}`)
          .then((res) => res.json())
          .then((result) => {
            // API å›å‚³å¤±æ•—
            if (!result.success || !result.data) {
              content.innerHTML = '<p class="empty">æ‰¾ä¸åˆ°é•·è¼©è³‡æ–™ã€‚</p>';
              return;
            }

            const d = result.data;
            currentElder = d;
            /* ======== é ­åƒ ======== */
            const avatarUrl =
              d.image_url && d.image_url.trim() !== ""
                ? d.image_url
                : "default-avatar.png";

            avatar.src = avatarUrl; // ä¸»å¡é ­åƒ
            volunteerAvatar.src = avatarUrl; // å°è¦½åˆ—å°é ­åƒ

            /* ======== åç¨±é¡¯ç¤º ======== */
            volunteerName.textContent = d.elder_name || "æœªç™»å…¥";

            /* ======== é¡¯ç¤ºå€‹äººè³‡æ–™ ======== */
            const html = `
            <dl>
              <dt>å§“å</dt><dd>${d.elder_name || ""}</dd>
              <dt>é€£çµ¡é›»è©±</dt><dd>${d.phone || ""}</dd>
              <dt>å‡ºç”Ÿå¹´æœˆæ—¥</dt><dd>${d.birthday || ""}</dd>
              <dt>æ€§åˆ¥</dt><dd>${
                d.gender === "ç”·æ€§" ? "ç”·æ€§" : d.gender === "å¥³æ€§" ? "å¥³æ€§" : ""
              }</dd>
              <dt>åœ°å€</dt><dd>${d.address || ""}</dd>
              <dt>ç·Šæ€¥è¯çµ¡äºº</dt><dd>${d.emergency_contact || "â€”"}</dd>
              <dt>ç·Šæ€¥è¯çµ¡äººé›»è©±</dt><dd>${
                d.emergency_contact_phone || "â€”"
              }</dd>
              <dt>å¥åº·å‚™è¨»</dt><dd>${d.health_note || "â€”"}</dd>

              <dt>å€‹æ€§ç‰¹è³ª</dt>
              <dd>
                ${
                  Array.isArray(d.preference_tags)
                    ? d.preference_tags
                        .map((tag) => `<span class="tag-display">${tag}</span>`)
                        .join("")
                    : "â€”"
                }
              </dd>
              <dt>ä½¿ç”¨è€…ID</dt>
              <dd> ${d.elder_user_id || ""}  <a href='https://line.me/R/share?text=${d.elder_user_id || ""}'>  <button onclick="location.href='https://line.me/R/share?text=...'">åˆ†äº«</button>


              </dl>
          `;

            content.innerHTML = html;
          })
          .catch((error) => {
            console.error("API éŒ¯èª¤:", error);
            content.innerHTML = '<p class="empty">ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ã€‚</p>';
          });
      }

      // è®€å–å…ˆå‰å„²å­˜çš„ä¾†æºé é¢
      const fromPage = localStorage.getItem("fromPage");
      // è¨­å®šè·³è½‰é é¢
      let targetUrl = "../../Topics/Topics/bookvolunteer/index.html";
      switch (fromPage) {
        case "blood-pressre":
          targetUrl = "../../Topics/Topics/blood-pressre/index.html";
          break;
        case "bookvolunteer":
          targetUrl = "../../Topics/Topics/bookvolunteer/index.html";
          break;
        case "calendar":
          targetUrl = "../../Topics/Topics/calendar/index.html";
          break;
        case "record-information":
          targetUrl = "../../Topics/Topics/record-information/index.html";
          break;
      }

      //è®€å–è¨»å†Šé 
      let registerS ="../../Topics/Login-or-register/index.html";
      

      //é»é¸è¿”å›æŒ‰éˆ•
      const backBtn = document.getElementById("backBtn");
      backBtn.href = targetUrl;

      // openmodal
      function openElderModal() {
        if (!currentElder) return;
      
        document.getElementById("elderModal").style.display = "flex";
      
        const f = document.forms.elderForm;
      
        f.elder_name.value = currentElder.elder_name || "";
        f.phone.value = currentElder.phone || "";
        f.address.value = currentElder.address || "";
        f.emergency_contact.value = currentElder.emergency_contact || "";
        f.emergency_contact_phone.value =
          currentElder.emergency_contact_phone || "";
        f.health_note.value = currentElder.health_note || "";
      }

      //close modal
      function closeElderModal() {
        document.getElementById("elderModal").style.display = "none";
      }

      //ä¿®æ”¹åŠŸèƒ½api
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("elderForm");
        if (!form) {
          console.error("æ‰¾ä¸åˆ° elderForm");
          return;
        }

        form.addEventListener("submit", async (e) => {
        e.preventDefault();
      
          const formData = new FormData(elderForm);
      
          const payload = {
            elder_name: formData.get("elder_name"),
            phone: formData.get("phone"),
            birthday: formData.get("birthday"),
            gender: formData.get("gender"),
            address: formData.get("address"),
            emergency_contact: formData.get("emergency_contact"),
            emergency_contact_phone: formData.get("emergency_contact_phone"),
            health_note: formData.get("health_note"),
          };
      
          console.log("é€å‡º payload ğŸ‘‰", payload); // ğŸ”¥ä¸€å®šè¦çœ‹
      
         fetch(`https://supabase-api-six.vercel.app/elders/${userId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(res => res.json())
            .then(result => {
              console.log("API å›å‚³ ğŸ‘‰", result);
      
              if (!result.success) {
                alert("æ›´æ–°å¤±æ•—");
                return;
              }
      
              alert("ä¿®æ”¹æˆåŠŸ âœ…");
              closeElderModal();
              location.reload();
            })
            .catch(err => {
              console.error(err);
              alert("ç³»çµ±éŒ¯èª¤ "+ err);
            });
     });
    })
     

      
    </script>
          <div id="elderModal" class="modal-overlay">
          <div class="modal-content">
            <button class="close-btn" onclick="closeElderModal()"><i class="fas fa-times"></i></button>
            <form id="elderForm" class="elder-form">
          <h3>é•·è¼©è³‡æ–™ä¿®æ”¹</h3>
        
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="elder_name" required />
          </div>
        
          <div class="form-group">
            <label>é€£çµ¡é›»è©±</label>
            <input type="tel" name="phone" required />
          </div>
        
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" name="address" required />
          </div>
        
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡äºº</label>
            <input type="text" name="emergency_contact" required />
          </div>
        
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡äººé›»è©±</label>
            <input type="text" name="emergency_contact_phone" required />
          </div>
        
          <div class="form-group">
            <label>å¥åº·å‚™è¨»</label>
            <textarea name="health_note" rows="3"></textarea>
          </div>
        
          <button type="submit"  class="btn">å„²å­˜ä¿®æ”¹</button>
        </form>
          </div>
        </div>

  </body>
</html>
