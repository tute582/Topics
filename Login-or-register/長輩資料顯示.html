<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <title>é•·è¼©å€‹äººè³‡æ–™</title>

    <style>
      /* --- æ•´é«”é é¢è¨­å®š --- */
      body {
        font-family: "Arial", sans-serif; /* å­—å‹ */
        background: #f4f6f8; /* æ·ºç°èƒŒæ™¯ */
        margin: 0;
        padding: 0;
      }

      /* --- ä¸»è¦å…§å®¹å¡ç‰‡ --- */
      .card {
        max-width: 720px; /* æœ€å¤§å¯¬åº¦ */
        margin: 24px auto; /* å‚ç›´é–“è· + ç½®ä¸­ */
        background: #fff; /* ç™½è‰²èƒŒæ™¯ */
        padding: 20px;
        border-radius: 8px; /* åœ“è§’ */
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08); /* é™°å½± */
        text-align: center; /* å…§å®¹ç½®ä¸­ */
      }

      /* --- æ¨™é¡Œè¨­å®š --- */
      h1 {
        margin: 0 0 0 0;
        font-size: 28px;
      }

      /* --- é ­åƒåœ–ç‰‡æ¨£å¼ --- */
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%; /* åœ“å½¢ */
        object-fit: cover; /* åœ–ç‰‡è‡ªå‹•è£åˆ‡å¡«æ»¿ */
        border: 3px solid #0078d4; /* å¤–æ¡†è—è‰² */
        margin-bottom: 0px;
      }

      /* --- å®šç¾©æ¸…å–®æ¨£å¼ (é¡¯ç¤ºå€‹äººè³‡æ–™ç”¨) --- */
      dl {
        display: grid; /* ä½¿ç”¨ç¶²æ ¼æ’ç‰ˆ */
        grid-template-columns: 140px 1fr; /* å·¦æ¨™é¡Œæ¬„ + å³å…§å®¹æ¬„ */
        gap: 8px 16px; /* é–“è· */
        text-align: left;
        margin-top: 10px;
      }

      dt {
        font-weight: 700; /* æ¨™é¡Œç²—é«” */
        color: #333;
      }

      dd {
        margin: 0;
        color: #222;
        word-break: break-word; /* è‡ªå‹•æ›è¡Œé¿å…æº¢å‡º */
      }

      /* --- è¿”å›æŒ‰éˆ•æ¨£å¼ --- */
      .back {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #0078d4;
        color: #fff;
        border-radius: 6px;
        text-decoration: none; /* ç§»é™¤åº•ç·š */
      }
      
       #editBtn{
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #3a3d3f;
        color: #fff;
        border-radius: 6px;
        text-decoration: none;
      }
      
      .empty {
        color: #666;
      }
      
      /* --- å°è¦½åˆ—(nav bar) --- */
      .nav-1 {
        display: flex; /* æ°´å¹³æ’åˆ— */
        font-weight: bold;
        align-items: center; /* å‚ç›´ç½®ä¸­ */
        justify-content: space-between; /* å·¦å³å…©ç«¯å°é½Š */
        padding: 10px 25px;
        position: sticky; /* æ»¾å‹•æ™‚å›ºå®šä¸Šæ–¹ */
        top: 0;
        z-index: 1001; /* ä½æ–¼æœ€ä¸Šå±¤ */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        color: black;
        background-color: white;
        box-sizing: border-box;
        border-bottom: 1px solid #ddd; /* ä¸‹é‚Šç•Œç·š */
      }

      .tag-display {
        display: inline-block;
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
        border-radius: 12px;
        padding: 4px 10px;
        margin: 4px 6px 0 0;
        font-size: 14px;
        white-space: nowrap;
      }

      /* ä¿®æ”¹modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center; /* è®“ modal-content å‚ç›´ç½®ä¸­ */
        z-index: 2000;
        backdrop-filter: blur(4px); 
        padding: 20px; /* å¢åŠ å››å‘¨é–“è·ï¼Œç¢ºä¿ä¸æœƒè²¼é‚Š */
        box-sizing: border-box;
      }
      
      .modal-content {
        background: #fff;
        /* margin: 40px auto;  <-- é€™ä¸€è¡Œå¯ä»¥æ‹¿æ‰ï¼Œç”± overlay çš„ padding æ§åˆ¶ */
        padding: 20px 15px;
        border-radius: 16px;
        position: relative;
        width: 90%;
        max-width: 400px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        
        /* --- é—œéµä¿®æ”¹é» --- */
        max-height: 90vh;      /* é™åˆ¶æœ€å¤§é«˜åº¦ç‚ºè¢å¹•é«˜åº¦çš„ 90% */
        overflow-y: auto;      /* ç•¶å…§å®¹è¶…é max-height æ™‚ï¼Œè‡ªå‹•é¡¯ç¤ºå‚ç›´æ²è»¸ */
        display: flex;         /* ç¢ºä¿å…§éƒ¨æ’ç‰ˆç©©å®š */
        flex-direction: column;
      }
      
      .close-btn {
        position: absolute;
        top: 12px; 
        right: 12px; 
        width: 30px; 
        height: 30px; 
        background-color: #f37a7a;
        color: white;
        border-radius: 50%; 
        border: none; 
        font-size: 14px; 
        isplay: flex; 
        align-items: center; 
        ustify-content: center;
        cursor: pointer;
        z-index: 10;
      }

        /* modal è¡¨å–® */
      .elder-form {
        max-width: 100%;      /* æ”¹ç‚º 100% é…åˆçˆ¶å®¹å™¨ */
        margin: 10px 0;       /* ç¨å¾®èª¿æ•´é–“è· */
        padding: 10px;        /* ç¸®æ¸›ä¸€äº›å…§è·ï¼ŒæŠŠç©ºé–“ç•™çµ¦å…§å®¹ */
        box-shadow: none;     /* å› ç‚ºå¤–é¢å·²ç¶“æœ‰ modal-content çš„é™°å½±äº† */
      }
    
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: #333;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 93%;
        padding: 8px 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #4a90e2;
      }
  
      /* submit */
      .btn {
        padding: 14px;
        border: none; 
        border-radius: 12px; 
        color: #fff; 
        cursor: pointer; 
        font-size: 16px; 
        width: 100%; 
        margin-top: 25px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        gap: 8px; 
        font-weight: bold;
        background-color: #4a90e2;
      }
      /* æ¨™ç±¤tag */
      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .tag {
        padding: 8px 16px;
        border: 1px solid #ccc;
        border-radius: 20px;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 16px;
        user-select: none;
      }

      .tag:hover {
        background-color: #e9ecef;
      }

      .tag.selected {
        background: #0078d4;
        color: white;
        border-color: #0078d4;
      }
       /* tag modal */
        .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .modal.show {
        opacity: 1;
      }
      .modal-c {
        background-color: white;
        padding: 25px 40px;
        border-radius: 15px;
        text-align: center;
        position: relative;
        min-width: 280px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      #closeModal {
        background-color: transparent;
        border: none;
        color: #999;
        font-size: 28px;
        position: absolute;
        top: 5px;
        right: 15px;
        cursor: pointer;
        transition: color 0.3s;
      }
      #closeModal:hover {
        color: #e74c3c;
      }
      
    </style>
  </head>

  <body>
    <!-- å°è¦½åˆ— -->
    <nav class="nav-1">
      <div>
        <h1>é•·è¼©å€‹äººè³‡æ–™</h1>
      </div>

      <!-- å°è¦½åˆ—å³å´é¡¯ç¤ºå¿—å·¥é ­åƒèˆ‡åç¨± -->
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <!-- å°è¦½åˆ—ä¸Šçš„å°é ­åƒ -->
            <img
              id="avatar"
              class="avatar"
              src="default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <!-- é¡¯ç¤ºå¿—å·¥åç¨±ï¼ˆé è¨­æœªç™»å…¥ï¼‰ -->
            <span
              id="volunteerName"
              title="é»æ­¤ä»¥ Line ç™»å…¥"
              style="cursor: pointer"
              >æœªç™»å…¥</span
            >
          </span>
        </h1>
      </div>
    </nav>

    <!-- ä¸»è¦å¡ç‰‡å…§å®¹ -->
    <div class="card">
      <!-- ä½¿ç”¨è€…é ­åƒï¼ˆå¡ç‰‡å…§çš„å¤§é ­åƒï¼‰ -->
      <img
        id="volunteerAvatar"
        class="avatar"
        src="default-avatar.png"
        alt="ä½¿ç”¨è€…é ­åƒ"
      />

      <!-- é€™è£¡æ”¾ä½¿ç”¨è€…è©³ç´°è³‡æ–™ -->
      <div id="content"></div>
      
  

      <!-- è¿”å›é é¢å’Œä¿®æ”¹æŒ‰éˆ• -->
    <div>
      <a id="editBtn" class="edit" onclick="openElderModal()">ä¿®æ”¹è³‡æ–™</a>
      <a id="backBtn" class="back">å›åˆ°åŸé é¢</a>
    </div>
</div>

        <!-- edit modal -->
          <div id="elderModal" class="modal-overlay" style="display: none;">
          <div class="modal-content">
            <button class="close-btn" onclick="closeElderModal()"><i class="fas fa-times"></i></button>
            <h3 style="margin: 0;text-align: center;color:#2c3e50;">é•·è¼©è³‡æ–™ä¿®æ”¹</h3>
          <form id="elderForm" class="elder-form">
          <div class="form-group">
            <label>å§“å</label>
            <input type="text" name="elder_name" required />
          </div>
        
          <div class="form-group">
            <label>é€£çµ¡é›»è©±</label>
            <input type="tel" name="phone" pattern="09[0-9]{8}" title="è¼¸å…¥æ ¼å¼:09********" required />
          </div>
        
          <div class="form-group">
            <label>åœ°å€</label>
            <input type="text" name="address" required />
          </div>
        
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡äºº</label>
            <input type="text" name="emergency_contact" required />
          </div>
        
          <div class="form-group">
            <label>ç·Šæ€¥è¯çµ¡äººé›»è©±</label>
            <input type="tel" name="emergency_contact_phone" pattern="09[0-9]{8}" title="è¼¸å…¥æ ¼å¼:09********" required />
          </div>
        
          <div class="form-group">
            <label>å¥åº·å‚™è¨»</label>
            <textarea name="health_note" rows="3"></textarea>
          </div>
          <div name="test" >
            <input id="text" value=`${d.preference_tags}`  readonly>
          </div>
          <div class="form-group">
            <label>å€‹æ€§ç‰¹è³ªï¼ˆå¯å¤šé¸ï¼Œæœ€å¤š6å€‹ï¼‰</label>
            <div class="tags" id="seniorTags">
              <div class="tag">æ¨‚è§€é–‹æœ—</div>
              <div class="tag">æº«å’Œè¦ªåˆ‡</div>
              <div class="tag">å¹½é»˜é¢¨è¶£</div>
              <div class="tag">ç†±æ„›ç”Ÿæ´»</div>
              <div class="tag">å‹¤å„‰æŒå®¶</div>
              <div class="tag">é—œå¿ƒå®¶äºº</div>
              <div class="tag">æ¨‚æ–¼åŠ©äºº</div>
              <div class="tag">å–œæ­¡èŠå¤©</div>
              <div class="tag">æ„›é‹å‹•</div>
              <div class="tag">ç”Ÿæ´»è¦å¾‹</div>
            </div>
          </div>
        
          <button type="submit"  class="btn">å„²å­˜ä¿®æ”¹</button>
        </form>
          </div>
          </div>
    <!-- tag modal -->
       <div id="modal" class="modal">
        <div class="modal-c">
          <span id="closeModal" title="é—œé–‰">&times;</span>
          <p style="font-size: 18px; font-weight: bold; margin-top: 10px">
            æœ€å¤šåªèƒ½é¸ 6 å€‹ç‰¹è³ª
          </p>
        </div>
      </div>
    
    <!-- JavaScript å€åŸŸ -->
    <script>
      let currentElder = null;
      // å–å¾—ç¶²é ä¸­éœ€è¦æ“ä½œçš„å…ƒç´ 
      const content = document.getElementById("content"); // é¡¯ç¤ºè³‡æ–™å…§å®¹å€
      const avatar = document.getElementById("avatar"); // å°è¦½åˆ—é ­åƒ
      const volunteerAvatar = document.getElementById("volunteerAvatar"); // å¡ç‰‡å¤§é ­åƒ
      const raw = localStorage.getItem("seniors"); // å¾ localStorage å–è³‡æ–™ï¼ˆJSON å­—ä¸²ï¼‰
      const volunteerName = document.getElementById("volunteerName");


      // å¾ localStorage å–å¾—ä¸Šæ¬¡å„²å­˜çš„å¿—å·¥è³‡æ–™
      const userId = localStorage.getItem("userId");
      console.log("å–å¾—çš„userIdï¼š", userId);

      // é¡¯ç¤º loadingï¼ˆå¯é¸ï¼‰
      content.innerHTML = `<p>è³‡æ–™è¼‰å…¥ä¸­...</p>`;

      if (!userId) {
        content.innerHTML = '<p class="empty">å°šæœªç™»å…¥ï¼Œç„¡æ³•å–å¾—è³‡æ–™ã€‚</p>';
      } else {
        // å‘¼å« Elder API
        fetch(`https://supabase-api-six.vercel.app/elders/${userId}`)
          .then((res) => res.json())
          .then((result) => {
            // API å›å‚³å¤±æ•—
            if (!result.success || !result.data) {
              content.innerHTML = '<p class="empty">æ‰¾ä¸åˆ°é•·è¼©è³‡æ–™ã€‚</p>';
              return;
            }

            const d = result.data;
            currentElder = d;
            /* ======== é ­åƒ ======== */
            const avatarUrl =
              d.image_url && d.image_url.trim() !== ""
                ? d.image_url
                : "default-avatar.png";

            avatar.src = avatarUrl; // ä¸»å¡é ­åƒ
            volunteerAvatar.src = avatarUrl; // å°è¦½åˆ—å°é ­åƒ

            /* ======== åç¨±é¡¯ç¤º ======== */
            volunteerName.textContent = d.elder_name || "æœªç™»å…¥";

            /* ======== é¡¯ç¤ºå€‹äººè³‡æ–™ ======== */
            const html = `
            <dl>
              <dt>å§“å</dt><dd>${d.elder_name || ""}</dd>
              <dt>é€£çµ¡é›»è©±</dt><dd>${d.phone || ""}</dd>
              <dt>å‡ºç”Ÿå¹´æœˆæ—¥</dt><dd>${d.birthday || ""}</dd>
              <dt>æ€§åˆ¥</dt><dd>${
                d.gender === "ç”·æ€§" ? "ç”·æ€§" : d.gender === "å¥³æ€§" ? "å¥³æ€§" : ""
              }</dd>
              <dt>åœ°å€</dt><dd>${d.address || ""}</dd>
              <dt>ç·Šæ€¥è¯çµ¡äºº</dt><dd>${d.emergency_contact || "â€”"}</dd>
              <dt>ç·Šæ€¥è¯çµ¡äººé›»è©±</dt><dd>${
                d.emergency_contact_phone || "â€”"
              }</dd>
              <dt>å¥åº·å‚™è¨»</dt><dd>${d.health_note || "â€”"}</dd>

              <dt>å€‹æ€§ç‰¹è³ª</dt>
              <dd>
                ${
                  Array.isArray(d.preference_tags)
                    ? d.preference_tags
                        .map((tag) => `<span class="tag-display">${tag}</span>`)
                        .join("")
                    : "â€”"
                }
              </dd>
              <dt>ä½¿ç”¨è€…ID</dt>
              <dd> ${d.elder_user_id || ""}  <a href='https://line.me/R/share?text=${d.elder_user_id || ""}'>  <button onclick="location.href='https://line.me/R/share?text=...'">åˆ†äº«</button>


              </dl>
          `;

            content.innerHTML = html;
          })
          .catch((error) => {
            console.error("API éŒ¯èª¤:", error);
            content.innerHTML = '<p class="empty">ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ã€‚</p>';
          });
      }

      // è®€å–å…ˆå‰å„²å­˜çš„ä¾†æºé é¢
      const fromPage = localStorage.getItem("fromPage");
      // è¨­å®šè·³è½‰é é¢
      let targetUrl = "../../Topics/Topics/bookvolunteer/index.html";
      switch (fromPage) {
        case "blood-pressre":
          targetUrl = "../../Topics/Topics/blood-pressre/index.html";
          break;
        case "bookvolunteer":
          targetUrl = "../../Topics/Topics/bookvolunteer/index.html";
          break;
        case "calendar":
          targetUrl = "../../Topics/Topics/calendar/index.html";
          break;
        case "record-information":
          targetUrl = "../../Topics/Topics/record-information/index.html";
          break;
      }

      //è®€å–è¨»å†Šé 
      let registerS ="../../Topics/Login-or-register/index.html";
      

      //é»é¸è¿”å›æŒ‰éˆ•
      const backBtn = document.getElementById("backBtn");
      backBtn.href = targetUrl;

      // openmodal
      function openElderModal() {
        if (!currentElder) return;
      
        document.getElementById("elderModal").style.display = "flex";
      
        const f = document.forms.elderForm;
        
        setupTags("seniorTags");
      
        f.elder_name.value = currentElder.elder_name || "";
        f.phone.value = currentElder.phone || "";
        f.address.value = currentElder.address || "";
        f.emergency_contact.value = currentElder.emergency_contact || "";
        f.emergency_contact_phone.value =
          currentElder.emergency_contact_phone || "";
        f.health_note.value = currentElder.health_note || "";

        
      }

      //close modal
      function closeElderModal() {
        const modal = document.getElementById("elderModal");
        const t =document.getElementsByClassName("tag");
        const l = t.length
        if (!modal) {
          console.error("æ‰¾ä¸åˆ° volunteerModal");
          return;
        }
        for (let i = 0; i < l ;i++ )
        {
         t[i].classList.remove("selected")
        }
        modal.style.display = "none";
      }

      //ä¿®æ”¹åŠŸèƒ½api
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("elderForm");
        if (!form) {
          console.error("æ‰¾ä¸åˆ° elderForm");
          return;
        }

        form.addEventListener("submit", async (e) => {
        e.preventDefault();
      
          const formData = new FormData(elderForm);
      
          const payload = {
            elder_name: formData.get("elder_name"),
            phone: formData.get("phone"),
            address: formData.get("address"),
            emergency_contact: formData.get("emergency_contact"),
            emergency_contact_phone: formData.get("emergency_contact_phone"),
            health_note: formData.get("health_note"),
             preference_tags: getSelectedTags("seniorTags"),
          };
      
          console.log("é€å‡º payload ğŸ‘‰", payload); // ğŸ”¥ä¸€å®šè¦çœ‹
      
         fetch(`https://supabase-api-six.vercel.app/elders/${userId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then(res => res.json())
            .then(result => {
              console.log("API å›å‚³ ğŸ‘‰", result);
      
              if (!result.success) {
                alert("æ›´æ–°å¤±æ•—");
                return;
              }
      
              alert("ä¿®æ”¹æˆåŠŸ âœ…");
              closeElderModal();
              location.reload();
            })
            .catch(err => {
              console.error(err);
              alert("ç³»çµ±éŒ¯èª¤ "+ err);
            });
     });
    })

      // æ¨™ç±¤é¸å–é‚è¼¯
      function setupTags(containerId) {
        const maxSelect = 6;
        const container = document.getElementById(containerId);
        container.addEventListener("click", (e) => {
          if (e.target.classList.contains("tag")) {
            const selectedCount =
              container.querySelectorAll(".tag.selected").length;
            if (e.target.classList.contains("selected")) {
              e.target.classList.remove("selected");
            } else if (selectedCount < maxSelect) {
              e.target.classList.add("selected");
            } else {
                  showModal();
                }
          }
        });
      }
      

      function getSelectedTags(containerId) {
        return Array.from(
          document.querySelectorAll(`#${containerId} .tag.selected`)
        ).map((tag) => tag.textContent.trim());
      }
      // tag Modal æ§åˆ¶
      function showModal() {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("show"), 10);
      }
      function hideModal() {
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
      }
      closeModal.addEventListener("click", hideModal);
      window.addEventListener("click", (e) => {
        if (e.target === modal) hideModal();
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") hideModal();
      });
 
    </script>
    
</body>
</html>
