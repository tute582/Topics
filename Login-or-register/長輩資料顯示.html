<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>長輩個人資料</title>

    <style>
      /* --- 整體頁面設定 --- */
      body {
        font-family: "Arial", sans-serif; /* 字型 */
        background: #f4f6f8; /* 淺灰背景 */
        margin: 0;
        padding: 0;
      }

      /* --- 主要內容卡片 --- */
      .card {
        max-width: 720px; /* 最大寬度 */
        margin: 24px auto; /* 垂直間距 + 置中 */
        background: #fff; /* 白色背景 */
        padding: 20px;
        border-radius: 8px; /* 圓角 */
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08); /* 陰影 */
        text-align: center; /* 內容置中 */
      }

      /* --- 標題設定 --- */
      h1 {
        margin: 0 0 0 0;
        font-size: 28px;
      }

      /* --- 頭像圖片樣式 --- */
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%; /* 圓形 */
        object-fit: cover; /* 圖片自動裁切填滿 */
        border: 3px solid #0078d4; /* 外框藍色 */
        margin-bottom: 0px;
      }

      /* --- 定義清單樣式 (顯示個人資料用) --- */
      dl {
        display: grid; /* 使用網格排版 */
        grid-template-columns: 140px 1fr; /* 左標題欄 + 右內容欄 */
        gap: 8px 16px; /* 間距 */
        text-align: left;
        margin-top: 10px;
      }

      dt {
        font-weight: 700; /* 標題粗體 */
        color: #333;
      }

      dd {
        margin: 0;
        color: #222;
        word-break: break-word; /* 自動換行避免溢出 */
      }

      /* --- 返回按鈕樣式 --- */
      .back {
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #0078d4;
        color: #fff;
        border-radius: 6px;
        text-decoration: none; /* 移除底線 */
      }

      .empty {
        color: #666;
      }

      .edit{
        display: inline-block;
        margin-top: 20px;
        padding: 8px 14px;
        background: #0078d4;
        color: #fff;
        border-radius: 6px;
        text-decoration: none; /* 移除底線 */
      }
       

      /* --- 導覽列(nav bar) --- */
      .nav-1 {
        display: flex; /* 水平排列 */
        font-weight: bold;
        align-items: center; /* 垂直置中 */
        justify-content: space-between; /* 左右兩端對齊 */
        padding: 10px 25px;
        position: sticky; /* 滾動時固定上方 */
        top: 0;
        z-index: 1001; /* 位於最上層 */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        color: black;
        background-color: white;
        box-sizing: border-box;
        border-bottom: 1px solid #ddd; /* 下邊界線 */
      }

      .tag-display {
        display: inline-block;
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
        border-radius: 12px;
        padding: 4px 10px;
        margin: 4px 6px 0 0;
        font-size: 14px;
        white-space: nowrap;
      }

      /* 修改modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }
      
      .modal-content {
        background: #fff;
        width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        padding: 20px;
        border-radius: 8px;
        position: relative;
      }
      
      .modal-close {
        position: absolute;
        right: 12px;
        top: 8px;
        font-size: 24px;
        cursor: pointer;
      }

        /* modal 表單 */
      .elder-form {
            max-width: 500px;
            margin: 30px auto;
            padding: 24px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            font-family: Arial, sans-serif;
          }
          
          .elder-form h3 {
            text-align: center;
            margin-bottom: 20px;
          }
          
          .form-group {
            margin-bottom: 15px;
          }
          
          .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
          }
          
          .form-group input,
          .form-group select,
          .form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
          }
          
          .form-group input:focus,
          .form-group select:focus,
          .form-group textarea:focus {
            outline: none;
            border-color: #4a90e2;
          }
          
          .btn {
            width: 100%;
            padding: 10px;
            background-color: #4a90e2;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
          }
          
          .btn:hover {
            background-color: #357abd;
          }

      
    </style>
  </head>

  <body>
    <!-- 導覽列 -->
    <nav class="nav-1">
      <div>
        <h1>長輩個人資料</h1>
      </div>

      <!-- 導覽列右側顯示志工頭像與名稱 -->
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <!-- 導覽列上的小頭像 -->
            <img
              id="avatar"
              class="avatar"
              src="default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <!-- 顯示志工名稱（預設未登入） -->
            <span
              id="volunteerName"
              title="點此以 Line 登入"
              style="cursor: pointer"
              >未登入</span
            >
          </span>
        </h1>
      </div>
    </nav>

    <!-- 主要卡片內容 -->
    <div class="card">
      <!-- 使用者頭像（卡片內的大頭像） -->
      <img
        id="volunteerAvatar"
        class="avatar"
        src="default-avatar.png"
        alt="使用者頭像"
      />

      <!-- 這裡放使用者詳細資料 -->
      <div id="content"></div>
      
    </div>

      <!-- 返回原本頁面按鈕 -->
    <div>
    <button onclick="openElderModal()" class="edit">修改資料</button>
      <a id="backBtn" class="back">回到原頁面</a>
    </div>

    <!-- JavaScript 區域 -->
    <script>
      let currentElder = null;
      // 取得網頁中需要操作的元素
      const content = document.getElementById("content"); // 顯示資料內容區
      const avatar = document.getElementById("avatar"); // 導覽列頭像
      const volunteerAvatar = document.getElementById("volunteerAvatar"); // 卡片大頭像
      const raw = localStorage.getItem("seniors"); // 從 localStorage 取資料（JSON 字串）
      const volunteerName = document.getElementById("volunteerName");


      // 從 localStorage 取得上次儲存的志工資料
      const userId = localStorage.getItem("userId");
      console.log("取得的userId：", userId);

      // 顯示 loading（可選）
      content.innerHTML = `<p>資料載入中...</p>`;

      if (!userId) {
        content.innerHTML = '<p class="empty">尚未登入，無法取得資料。</p>';
      } else {
        // 呼叫 Elder API
        fetch(`https://supabase-api-six.vercel.app/elders/${userId}`)
          .then((res) => res.json())
          .then((result) => {
            // API 回傳失敗
            if (!result.success || !result.data) {
              content.innerHTML = '<p class="empty">找不到長輩資料。</p>';
              return;
            }

            const d = result.data;
            currentElder = d;
            /* ======== 頭像 ======== */
            const avatarUrl =
              d.image_url && d.image_url.trim() !== ""
                ? d.image_url
                : "default-avatar.png";

            avatar.src = avatarUrl; // 主卡頭像
            volunteerAvatar.src = avatarUrl; // 導覽列小頭像

            /* ======== 名稱顯示 ======== */
            volunteerName.textContent = d.elder_name || "未登入";

            /* ======== 顯示個人資料 ======== */
            const html = `
            <dl>
              <dt>姓名</dt><dd>${d.elder_name || ""}</dd>
              <dt>連絡電話</dt><dd>${d.phone || ""}</dd>
              <dt>出生年月日</dt><dd>${d.birthday || ""}</dd>
              <dt>性別</dt><dd>${
                d.gender === "男性" ? "男性" : d.gender === "女性" ? "女性" : ""
              }</dd>
              <dt>地址</dt><dd>${d.address || ""}</dd>
              <dt>緊急聯絡人</dt><dd>${d.emergency_contact || "—"}</dd>
              <dt>緊急聯絡人電話</dt><dd>${
                d.emergency_contact_phone || "—"
              }</dd>
              <dt>健康備註</dt><dd>${d.health_note || "—"}</dd>

              <dt>個性特質</dt>
              <dd>
                ${
                  Array.isArray(d.preference_tags)
                    ? d.preference_tags
                        .map((tag) => `<span class="tag-display">${tag}</span>`)
                        .join("")
                    : "—"
                }
              </dd>
              <dt>使用者ID</dt>
              <dd> ${d.elder_user_id || ""}  <a href='https://line.me/R/share?text=${d.elder_user_id || ""}'>  <button onclick="location.href='https://line.me/R/share?text=...'">分享</button>


              </dl>
          `;

            content.innerHTML = html;
          })
          .catch((error) => {
            console.error("API 錯誤:", error);
            content.innerHTML = '<p class="empty">無法連線到伺服器。</p>';
          });
      }

      // 讀取先前儲存的來源頁面
      const fromPage = localStorage.getItem("fromPage");
      // 設定跳轉頁面
      let targetUrl = "../../Topics/Topics/bookvolunteer/index.html";
      switch (fromPage) {
        case "blood-pressre":
          targetUrl = "../../Topics/Topics/blood-pressre/index.html";
          break;
        case "bookvolunteer":
          targetUrl = "../../Topics/Topics/bookvolunteer/index.html";
          break;
        case "calendar":
          targetUrl = "../../Topics/Topics/calendar/index.html";
          break;
        case "record-information":
          targetUrl = "../../Topics/Topics/record-information/index.html";
          break;
      }

      //讀取註冊頁
      let registerS ="../../Topics/Login-or-register/index.html";
      

      //點選返回按鈕
      const backBtn = document.getElementById("backBtn");
      backBtn.href = targetUrl;

      //modal
      function openElderModal() {
        if (!currentElder) return;
      
        document.getElementById("elderModal").style.display = "flex";
      
        const f = document.forms.elderForm;
      
        f.elder_name.value = currentElder.elder_name || "";
        f.phone.value = currentElder.phone || "";
        f.address.value = currentElder.address || "";
        f.emergency_contact.value = currentElder.emergency_contact || "";
        f.emergency_contact_phone.value =
          currentElder.emergency_contact_phone || "";
        f.health_note.value = currentElder.health_note || "";
      }
      
      function closeElderModal() {
        document.getElementById("elderModal").style.display = "none";
      }

      //修改功能api
      document
        .getElementById("elderForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
      
          const formData = new FormData(e.target);
      
          const payload = {
            elder_name: formData.get("elder_name"),
            phone: formData.get("phone"),
            address: formData.get("address"),
            emergency_contact: formData.get("emergency_contact"),
            emergency_contact_phone: formData.get(
              "emergency_contact_phone"
            ),
            health_note: formData.get("health_note"),
          };
      
          fetch(`https://supabase-api-six.vercel.app/elders/${userId}`, {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((res) => res.json())
            .then((result) => {
              if (!result.success) {
                alert("更新失敗");
                return;
              }
      
              alert("修改成功 ✅");
              closeElderModal();
              location.reload();
            })
            .catch((err) => {
              console.error(err);
              alert("系統錯誤");
            });
        });


      
    </script>
          <div id="elderModal" class="modal-overlay">
          <div class="modal-content">
            <span class="modal-close" onclick="closeElderModal()">×</span>
        
            <form id="elderForm" class="elder-form">
          <h3>長輩資料修改</h3>
        
          <div class="form-group">
            <label>姓名</label>
            <input type="text" name="elder_name" required />
          </div>
        
          <div class="form-group">
            <label>連絡電話</label>
            <input type="tel" name="phone" required />
          </div>
        
          <div class="form-group">
            <label>地址</label>
            <input type="text" name="address" />
          </div>
        
          <div class="form-group">
            <label>緊急聯絡人</label>
            <input type="text" name="emergency_contact" />
          </div>
        
          <div class="form-group">
            <label>緊急聯絡人電話</label>
            <input type="text" name="emergency_contact_phone" />
          </div>
        
          <div class="form-group">
            <label>健康備註</label>
            <textarea name="health_note" rows="3"></textarea>
          </div>
        
          <button type="submit" class="btn">儲存修改</button>
        </form>
        
          </div>
        </div>

  </body>
</html>
