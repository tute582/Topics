<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>志工管理系統 Volunteer Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f7f9fb;
        margin: 0;
        padding: 0;
        padding-bottom: 80px;
      }

      /* 1. 導覽列 */
      .nav-1 {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 25px; position: sticky; top: 0; z-index: 1001;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); width: 100%;
        background-color: white; box-sizing: border-box; border-bottom: 1px solid #ddd;
      }

      /* 2. 分頁按鈕 */
      .tab-container {
        display: flex; background: white; margin-top: 1px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px;
      }
      .tab-btn {
        flex: 1; text-align: center; padding: 15px 0; font-size: 16px;
        font-weight: bold; color: #888; cursor: pointer;
        border-bottom: 3px solid transparent; transition: all 0.3s;
      }
      .tab-btn.active {
        color: #0984e3; border-bottom: 3px solid #0984e3; background-color: #f0f8ff;
      }
      .tab-content {
        display: none; padding: 10px 20px; justify-content: center;
        animation: fadeIn 0.3s ease-in-out;
      }
      .tab-content.active {
        display: flex; flex-direction: column; align-items: center;
      }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

      /* 3. 志工卡片 */
      .card {
        width: 100%; max-width: 360px; background: #ffffff;
        border-radius: 15px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        overflow: hidden; position: relative; margin-bottom: 20px;
      }
      .card-cover { width: 100%; height: 150px; background-color: #c2dfff; }
      .card-avatar {
        width: 100px; height: 100px; border-radius: 50%;
        border: 3px solid rgb(94, 131, 252); position: absolute; top: 100px; left: 50%;
        transform: translateX(-50%); object-fit: cover; background: #fff;
      }
      .card-content { padding: 70px 20px 30px; text-align: center; }
      .card-title { font-size: 1.3em; margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
      .special { background: #ffeaa7; color: #2d3436; padding: 2px 10px 6px; border-radius: 10px; font-size: 0.8em; }
      .card-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 8px; }
      .card-tags .tag { background-color: #e9f5ff; color: #007bff; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; }
      .card-text { margin-top: 10px; color: #636e72; line-height: 1.5; }

      .edit-input, .edit-textarea { width: 90%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
      .edit-btn { margin-top: 15px; background: #0984e3; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
      .save-btn { background: #00b894; margin-right: 10px; }
      .cancel-btn { background: #b2bec3; }

      /* 4. 日曆樣式 */
      .calendar-wrapper {
        width: 100%; max-width: 95%; background-color: #fff;
        border-radius: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 20px; box-sizing: border-box;
      }
      @media (max-width: 768px) {
        .calendar-wrapper { padding: 10px; max-width: 100%; border-radius: 0; }
        .fc .fc-daygrid-day-frame { min-height: 80px !important; }
      }
      .fc-toolbar-title { font-size: 1.5em !important; font-weight: bold; }
      .fc-button { font-size: 0.9em !important; }

      /* 表格線條處理 */
      .fc-theme-standard td, .fc-theme-standard th {
          border-bottom: 1px solid #f0f0f0 !important;
          border-left: none !important; border-right: none !important; border-top: none !important;
      }
      .fc-theme-standard .fc-scrollgrid { border: none !important; }
      .fc-col-header-cell { border-bottom: 2px solid #ddd !important; padding-bottom: 5px !important; }

      /* 隱藏非本月日期 */
      .fc-daygrid-day { background-color: #fff !important; }
      .fc-day-other .fc-daygrid-day-frame { opacity: 0 !important; pointer-events: none !important; }
      .fc-day-other { border-bottom: none !important; }

      /* --- 事件 (Event) 樣式 --- */
      .fc-event {
        border: none !important; border-radius: 4px !important;
        box-shadow: none !important; margin-bottom: 3px !important;
        padding: 2px 4px !important; cursor: pointer;
        overflow: hidden; 
      }
      .fc-event-main {
        color: #333333 !important; font-weight: 600; font-size: 0.9em;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      }

      .booked-slot { background-color: #fca5a5 !important; border-left: 4px solid #ef4444 !important; }
      .booked-slot:hover { background-color: #f87171 !important; }
      .available-slot { background-color: #6ee7b7 !important; border-left: 4px solid #10b981 !important; }
      .available-slot:hover { background-color: #34d399 !important; }

      .calendar-wrapper .fc .fc-daygrid-day.my-past:not(.fc-day-other) .fc-daygrid-day-frame { background: #fbfbfc !important; }
      .calendar-wrapper .fc .fc-daygrid-day.my-past:not(.fc-day-other) .fc-daygrid-day-number { color: #bdbfc2 !important; }
      
      /* 更多連結樣式 */
      .fc-daygrid-more-link {
          color: #0984e3 !important; 
          font-weight: bold;
          font-size: 0.85em;
          text-decoration: none;
      }
      
      /* 5. 檔期區塊 */
      .schedule-section { background: #fff; margin: 15px 20px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
      .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
      .schedule-title { font-weight: bold; font-size: 1.1em; color: #333; }
      .schedule-legend { font-size: 12px; color: #888; display: flex; gap: 10px; }
      .dot { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; }
      .dot-free { background-color: #6ee7b7; border: 1px solid #10b981; } 
      .dot-busy { background-color: #fca5a5; border: 1px solid #ef4444; } 
      .dot-none { background-color: #e5e7eb; border: 1px solid #d1d5db; }

      .month-scroll-wrapper { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
      .month-scroll-wrapper::-webkit-scrollbar { display: none; }
      .month-card {
        min-width: 110px; background: #fff; border: 1px solid #f0f0f0; border-radius: 8px; padding: 10px;
        cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 6px;
      }
      .month-card.active { border-color: #0984e3; background-color: #f0f8ff; }
      .month-info { display: flex; justify-content: space-between; align-items: baseline; }
      .month-label { font-size: 15px; font-weight: bold; color: #2d3436; }
      .month-stats { font-size: 12px; color: #636e72; font-weight: bold;}
      .progress-container { display: flex; height: 6px; background-color: #eee; border-radius: 3px; overflow: hidden; }
      .p-segment { height: 100%; transition: flex 0.5s ease-in-out; }
      .p-busy { background-color: #fca5a5; } .p-free { background-color: #6ee7b7; } .p-none { background-color: #e5e7eb; } 

      /* --- 通用 Modal 樣式 --- */
      .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: rgba(0, 0, 0, 0.5); z-index: 2000; 
        display: none; justify-content: center; align-items: center; 
      }
      .modal-overlay.show { display: flex; }
      .modal-box { 
        background: white; width: 90%; max-width: 400px; 
        border-radius: 12px; overflow: hidden; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      }
      .modal-header { 
        background-color: #f0f8ff; padding: 15px 20px; 
        border-bottom: 1px solid #eee; display: flex; 
        justify-content: space-between; align-items: center; 
      }
      .modal-body { padding: 20px; font-size: 1em; color: #555; line-height: 1.6; }
      .modal-footer { padding: 15px; text-align: right; border-top: 1px solid #eee; }
      .modal-row { margin-bottom: 10px; display: flex; align-items: flex-start; }
      .modal-label { font-weight: bold; color: #0984e3; min-width: 50px; margin-right: 10px; }
      
      /* 統一的灰色關閉按鈕 (解決藍色問題) */
      .close-icon { 
        cursor: pointer; font-size: 28px; color: #999; 
        line-height: 1; font-weight: normal;
        transition: color 0.2s;
      }
      .close-icon:hover { color: #333; }

      /* --- 更多列表的項目樣式 --- */
      .list-event-item {
        padding: 10px; margin-bottom: 8px; border-radius: 6px; cursor: pointer;
        font-weight: bold; color: #333; display: flex; justify-content: space-between; align-items: center;
      }
      .list-event-item:hover { opacity: 0.9; }

    </style>
  </head>
  <body>

    <nav class="nav-1">
      <div><h1 style="margin: 0; font-size: 28px">志工管理系統</h1></div>
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span class="volunteer-area" style="display: flex; align-items: center; gap: 8px">
            <img id="volunteerAvatar" class="avatar" src="default-avatar.png" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #0984e3; display: none;" />
            <span id="volunteerName" style="cursor: pointer; font-size: 26px">未登入</span>
          </span>
        </h1>
      </div>
    </nav>

    <div class="schedule-section">
      <div class="schedule-header">
        <span class="schedule-title">檔期安排</span>
        <div class="schedule-legend">
          <span class="legend-item"><span class="dot dot-busy"></span> 已預約</span>
          <span class="legend-item"><span class="dot dot-free"></span> 可預約</span>
          <span class="legend-item"><span class="dot dot-none"></span> 未設置/已過</span>
        </div>
      </div>
      <div class="month-scroll-wrapper" id="monthNav"></div>
    </div>

    <div class="tab-container">
      <div class="tab-btn active" onclick="switchTab('info')">志工資訊</div>
      <div class="tab-btn" onclick="switchTab('calendar')">預約紀錄</div>
    </div>

    <section id="tab-info" class="tab-content active">
      <div class="card">
        <div class="card-cover"></div>
        <img class="card-avatar" src="https://i.pravatar.cc/150?img=32" alt="頭像" />
        <div class="card-content">
          <div id="viewMode">
            <h2 class="card-title">
              <span id="view-name">王小明</span>
              <span id="view-special" class="special">醫護證照</span>
            </h2>
            <div id="view-tags" class="card-tags">
              <span class="tag">親切</span><span class="tag">細心</span><span class="tag">熱心助人</span>
            </div>
            <p id="view-text" class="card-text">擁有豐富的醫院志工經驗，熱愛幫助他人。</p>
            <button class="edit-btn" onclick="toggleEdit(true)">✏️ 編輯資料</button>
          </div>
          <div id="editMode" style="display: none;">
            <label style="color:#888; font-size:0.8em;">姓名</label>
            <input type="text" id="input-name" class="edit-input" value="王小明">
            <label style="color:#888; font-size:0.8em;">特殊稱號</label>
            <input type="text" id="input-special" class="edit-input" value="醫護證照">
            <label style="color:#888; font-size:0.8em;">標籤</label>
            <input type="text" id="input-tags" class="edit-input" value="親切, 細心, 熱心助人">
            <label style="color:#888; font-size:0.8em;">自我介紹</label>
            <textarea id="input-text" class="edit-textarea" rows="4">擁有豐富的醫院志工經驗，熱愛幫助他人。</textarea>
            <div style="margin-top: 10px;">
              <button class="edit-btn save-btn" onclick="saveData()">儲存</button>
              <button class="edit-btn cancel-btn" onclick="toggleEdit(false)">取消</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-calendar" class="tab-content">
      <div class="calendar-wrapper">
        <div id="calendar"></div>
      </div>
    </section>

    <div id="timeSlotModal" class="modal-overlay">
      <div class="modal-box" style="max-width:420px;padding:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <h3 style="margin:0">新增可服務時段 — <span id="slotDateStr"></span></h3>
          <span class="close-icon" onclick="closeTimeSlotModal()">×</span>
        </div>
        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
          <button class="slot-select" data-time="09:00" style="padding:8px 12px;border-radius:8px;border:none;background:#6ee7b7;color:#333;cursor:pointer;font-weight:bold;">上午</button>
          <button class="slot-select" data-time="14:00" style="padding:8px 12px;border-radius:8px;border:none;background:#6ee7b7;color:#333;cursor:pointer;font-weight:bold;">下午</button>
          <button class="slot-select" data-time="18:00" style="padding:8px 12px;border-radius:8px;border:none;background:#6ee7b7;color:#333;cursor:pointer;font-weight:bold;">晚上</button>
        </div>
        <div style="text-align:center;color:#666;margin-bottom:10px;">或選擇自訂時間</div>
        <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
          <input id="customSlotTime" type="time" style="padding:8px;border:1px solid #ddd;border-radius:6px;" />
        </div>
        <div style="text-align:right;">
          <button onclick="closeTimeSlotModal()" style="padding:8px 12px;border-radius:8px;border:none;background:#aaa;color:#fff;cursor:pointer;margin-right:8px;">取消</button>
          <button id="slotConfirm" style="padding:8px 12px;border-radius:8px;border:none;background:#0984e3;color:#fff;cursor:pointer;">新增</button>
        </div>
      </div>
    </div>

    <div id="eventModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
      <div class="modal-box">
        <div class="modal-header">
          <div class="modal-title" id="m-title">標題</div>
          <span class="close-icon" onclick="closeModal()">×</span>
        </div>
        <div class="modal-body">
          <div class="modal-row"><span class="modal-label">時間:</span><span id="m-time"></span></div>
          <div class="modal-row" id="row-location"><span class="modal-label">地點:</span><span id="m-location"></span></div>
          <div class="modal-row" id="row-elder"><span class="modal-label">長者:</span><span id="m-elder"></span></div>
        </div>
        <div class="modal-footer"><button class="modal-btn" onclick="closeModal()">關閉</button></div>
      </div>
    </div>

    <div id="moreEventsModal" class="modal-overlay" onclick="closeMoreEventsOnOverlay(event)">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title" id="more-title">當日事件</div>
                <span class="close-icon" onclick="closeMoreEventsModal()">×</span>
            </div>
            <div class="modal-body" style="max-height:60vh; overflow-y:auto;" id="more-events-list">
                </div>
            <div class="modal-footer">
                <button class="modal-btn" onclick="closeMoreEventsModal()">關閉</button>
            </div>
        </div>
    </div>

    <script>
      let calendar; 
      let currentSlotDateStr = '';
      
      // === 假資料生成 ===
      function generateMonthlyData(baseDate) {
        const events = [];
        const taskTitles = ["醫院陪診", "居家清潔", "代購物資", "電話問安", "活動支援", "行政協助"];
        const locations = ["亞東醫院", "板橋區", "活動中心", "衛生所", "服務中心"];
        
        for (let i = 0; i < 6; i++) {
          const targetMonth = new Date(baseDate.getFullYear(), baseDate.getMonth() + i, 1);
          const year = targetMonth.getFullYear();
          const month = targetMonth.getMonth(); 
          const daysInMonth = new Date(year, month + 1, 0).getDate();

          const bookedCount = Math.floor(Math.random() * 6) + 3;
          const availableCount = Math.floor(Math.random() * 5) + 2;

          for (let b = 0; b < bookedCount; b++) {
            const day = Math.floor(Math.random() * (daysInMonth - 1)) + 1; 
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const randomTitle = taskTitles[Math.floor(Math.random() * taskTitles.length)];
            events.push({
              title: randomTitle,
              start: `${dateStr}T${9 + Math.floor(Math.random()*8)}:00:00`,
              classNames: ['booked-slot'], 
              extendedProps: { location: locations[Math.floor(Math.random()*locations.length)], elder: "某長者" }
            });
          }
          for (let a = 0; a < availableCount; a++) {
            const day = Math.floor(Math.random() * (daysInMonth - 1)) + 1;
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            events.push({
              title: "可服務時段",
              start: `${dateStr}T${9 + Math.floor(Math.random()*8)}:00:00`,
              classNames: ['available-slot'], 
              extendedProps: { note: "自行排班", location: "未定" }
            });
          }
        }
        return events;
      }

      document.addEventListener("DOMContentLoaded", function () {
        try {
          const calendarEl = document.getElementById("calendar");
          const now = new Date();
          const fakeEvents = generateMonthlyData(now);

          calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            initialDate: now, 
            locale: "zh-tw",
            height: 'auto',
            headerToolbar: { left: "prev,next", center: "title", right: "today" },
            events: fakeEvents, 
            fixedWeekCount: false, 
            dayMaxEvents: 2, 
            
            dayHeaderContent: function(arg) { return arg.text.slice(-1); },
            dayCellContent: function(arg) { return arg.dayNumberText.replace('日', ''); },
            
            eventClick: function(info) { showModal(info); },
            
            // --- 關鍵修改：攔截 More Link 點擊，使用我們自己的 Modal ---
            moreLinkClick: function(info) {
                // info.date 是 Date 物件
                showMoreEventsModal(info.date);
                return "void"; // 阻止 FullCalendar 預設行為
            },
            
            dayCellDidMount: function(arg) {
               if (arg.isOther) return; 
               const today = new Date(); today.setHours(0,0,0,0);
               const cellDate = new Date(arg.date); cellDate.setHours(0,0,0,0);
               if (cellDate < today) {
                 arg.el.classList.add('my-past');
                 arg.el.setAttribute('aria-disabled','true');
               }
            },
            
            dateClick: function(info) {
               const clicked = new Date(info.dateStr + 'T00:00:00');
               const today = new Date(); today.setHours(0,0,0,0);
               if (clicked < today) return; 
               showTimeSlotModal(info.dateStr);
            },
            eventsSet: function() {
               if (typeof updateMonthProgress === 'function') updateMonthProgress();
            }
          });
 
          calendar.render();
          createMonthNav(now);

        } catch (err) {
          console.error('初始化錯誤:', err);
        }

        // 綁定「新增時段」Modal 按鈕
        document.querySelectorAll('.slot-select').forEach(btn => {
            btn.onclick = function() {
                const time = btn.dataset.time;
                document.getElementById('customSlotTime').value = time;
                document.querySelectorAll('.slot-select').forEach(b => b.style.opacity = '0.6');
                btn.style.opacity = '1';
            };
        });

        document.getElementById('slotConfirm').onclick = function() {
            const t = document.getElementById('customSlotTime').value;
            if (!t) { alert('請選擇時間或點選上方時段'); return; }
            
            const dt = new Date(`${currentSlotDateStr}T${t}:00`);
            if (dt.getTime() <= Date.now()) { alert('無法新增已過的時段'); return; }
            
            calendar.addEvent({
              title: `可服務 ${t}`,
              start: dt.toISOString(),
              allDay: false,
              classNames: ['available-slot'],
              extendedProps: { note: '排班 (自訂)' }
            });
            closeTimeSlotModal();
        };

        // LIFF
        initLiffAndSetProfile();
      });
      
      // --- Helper Functions ---

      function showTimeSlotModal(dateStr) {
        currentSlotDateStr = dateStr;
        document.getElementById('slotDateStr').innerText = dateStr;
        document.getElementById('timeSlotModal').classList.add('show');
        document.getElementById('customSlotTime').value = '';
        document.querySelectorAll('.slot-select').forEach(b => b.style.opacity = '1');
      }

      function closeTimeSlotModal() {
        document.getElementById('timeSlotModal').classList.remove('show');
      }

      // --- 自訂 More Events List Modal ---
      function showMoreEventsModal(date) {
        // 篩選當天所有事件
        const allEvents = calendar.getEvents();
        const dailyEvents = allEvents.filter(ev => {
           return ev.start.getDate() === date.getDate() && 
                  ev.start.getMonth() === date.getMonth() && 
                  ev.start.getFullYear() === date.getFullYear();
        });

        // 設定標題
        const dateStr = date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric', weekday: 'short' });
        document.getElementById('more-title').innerText = `${dateStr} 的所有事件`;
        
        // 填入列表
        const listBody = document.getElementById('more-events-list');
        listBody.innerHTML = '';
        
        if (dailyEvents.length === 0) {
            listBody.innerHTML = '<div style="text-align:center; color:#999;">無事件</div>';
        } else {
            dailyEvents.forEach(event => {
                const div = document.createElement('div');
                // 根據 classNames 判斷顏色
                const isAvailable = event.classNames.includes('available-slot');
                const className = isAvailable ? 'available-slot' : 'booked-slot';
                
                div.className = `list-event-item ${className}`;
                div.innerText = event.title;
                // 為了讓樣式與日曆上一致，手動加上一點樣式
                div.style.padding = '8px 12px';
                div.style.marginBottom = '6px';
                div.style.borderRadius = '6px';
                div.style.cursor = 'pointer';
                div.style.borderLeft = isAvailable ? '4px solid #10b981' : '4px solid #ef4444';
                div.style.backgroundColor = isAvailable ? '#d1fae5' : '#fee2e2';

                div.onclick = function() {
                    // 關閉列表，打開詳情
                    closeMoreEventsModal();
                    // 呼叫 showModal (模擬 info 結構)
                    showModal({ 
                        event: event 
                    });
                };
                listBody.appendChild(div);
            });
        }
        
        document.getElementById('moreEventsModal').classList.add('show');
      }

      function closeMoreEventsModal() {
          document.getElementById('moreEventsModal').classList.remove('show');
      }
      
      function closeMoreEventsOnOverlay(e) {
        if (e.target.id === 'moreEventsModal') {
            closeMoreEventsModal();
        }
      }

      function updateMonthProgress() {
        if (!calendar) return;
        const allEvents = calendar.getEvents();
        const monthCards = document.querySelectorAll('.month-card');
        const MONTH_CAPACITY = 20; 

        monthCards.forEach(card => {
          const year = parseInt(card.dataset.year);
          const month = parseInt(card.dataset.month);
          const monthEvents = allEvents.filter(ev => {
            const start = ev.start;
            return start && start.getFullYear() === year && (start.getMonth() + 1) === month;
          });
          const bookedCount = monthEvents.filter(e => e.classNames.includes('booked-slot')).length;
          const availableCount = monthEvents.filter(e => e.classNames.includes('available-slot')).length;
          const noneCount = Math.max(0, MONTH_CAPACITY - bookedCount - availableCount);

          const pBusy = card.querySelector('.p-busy');
          const pFree = card.querySelector('.p-free');
          const pNone = card.querySelector('.p-none');

          if (pBusy && pFree && pNone) {
            pBusy.style.flex = bookedCount;
            pFree.style.flex = availableCount;
            pNone.style.flex = noneCount;
            pBusy.style.backgroundColor = '#fca5a5'; 
            pFree.style.backgroundColor = '#6ee7b7'; 
          }
          const statsEl = card.querySelector('.month-stats');
          if (statsEl) statsEl.innerText = `(${bookedCount}/${availableCount})`;
        });
      }

      function createMonthNav(now) {
        const monthNav = document.getElementById('monthNav');
        if (!monthNav) return;
        monthNav.innerHTML = '';
        for (let i = 0; i < 6; i++) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
          const m = targetDate.getMonth() + 1;
          const y = targetDate.getFullYear();
          const displayMonth = i === 0 ? "本月" : (m < 10 ? '0' + m : m) + "月";
          
          const card = document.createElement('div');
          card.className = `month-card ${i === 0 ? 'active' : ''}`;
          card.dataset.month = m;
          card.dataset.year = y;
          card.innerHTML = `
            <div class="month-info">
              <span class="month-label">${displayMonth}</span>
              <span class="month-stats">(0/0)</span>
            </div>
            <div class="progress-container">
              <div class="p-segment p-busy" style="flex:0;"></div>
              <div class="p-segment p-free" style="flex:0;"></div>
              <div class="p-segment p-none" style="flex:1;"></div>
            </div>
          `;
          card.addEventListener('click', () => {
            document.querySelectorAll('.month-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            if (calendar) calendar.gotoDate(`${y}-${(m < 10 ? '0'+m : m)}-01`);
          });
          monthNav.appendChild(card);
        }
        updateMonthProgress();
      }

      // --- LIFF ---
      const LIFF_ID = "2008228534-R8763A2n";
      const avatarEl = document.getElementById("volunteerAvatar");
      const nameEl = document.getElementById("volunteerName");
      async function initLiffAndSetProfile() {
        try {
          if (typeof liff === 'undefined') return;
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            nameEl.innerText = "未登入";
            avatarEl.style.display = "none";
            return;
          }
          const profile = await liff.getProfile();
          nameEl.innerText = profile.displayName || "志工";
          if (profile.pictureUrl) {
            avatarEl.src = profile.pictureUrl;
            avatarEl.style.display = "inline-block";
          }
        } catch (err) { console.error("LIFF error:", err); }
      }
      nameEl.addEventListener("click", () => {
        if (typeof liff !== 'undefined' && !liff.isLoggedIn()) liff.login({ redirectUri: window.location.href });
      });

      // --- Event Details Modal ---
      function showModal(info) {
        const event = info.event;
        const props = event.extendedProps;
        document.getElementById('m-title').innerText = event.title;
        const timeStr = event.start.toLocaleString('zh-TW', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        document.getElementById('m-time').innerText = timeStr;
        const locRow = document.getElementById('row-location');
        if(props.location) { document.getElementById('m-location').innerText = props.location; locRow.style.display = 'flex'; } 
        else { locRow.style.display = 'none'; }
        const elderRow = document.getElementById('row-elder');
        if(props.elder) { document.getElementById('m-elder').innerText = props.elder; elderRow.style.display = 'flex'; }
        else { elderRow.style.display = 'none'; }
        document.getElementById('eventModal').classList.add('show');
      }
      function closeModal() { document.getElementById('eventModal').classList.remove('show'); }
      function closeModalOnOverlay(e) { if (e.target.id === 'eventModal') closeModal(); }

      function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if (tabName === 'info') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        if (tabName === 'calendar') document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        if (tabName === 'calendar' && calendar) setTimeout(() => { calendar.updateSize(); }, 50);
      }

      function toggleEdit(showEdit) {
        if (showEdit) {
          document.getElementById('input-name').value = document.getElementById('view-name').innerText;
          document.getElementById('input-special').value = document.getElementById('view-special').innerText;
          document.getElementById('input-text').value = document.getElementById('view-text').innerText;
          const tags = Array.from(document.querySelectorAll('#view-tags .tag')).map(t => t.innerText).join(', ');
          document.getElementById('input-tags').value = tags;
          document.getElementById('viewMode').style.display = 'none';
          document.getElementById('editMode').style.display = 'block';
        } else {
          document.getElementById('viewMode').style.display = 'block';
          document.getElementById('editMode').style.display = 'none';
        }
      }
      function saveData() {
        document.getElementById('view-name').innerText = document.getElementById('input-name').value;
        document.getElementById('view-special').innerText = document.getElementById('input-special').value;
        document.getElementById('view-text').innerText = document.getElementById('input-text').value;
        const tagsStr = document.getElementById('input-tags').value;
        const tagsArr = tagsStr.split(',').map(t => t.trim()).filter(t => t);
        const tagsContainer = document.getElementById('view-tags');
        tagsContainer.innerHTML = ''; 
        tagsArr.forEach(tagText => {
          const span = document.createElement('span'); span.className = 'tag'; span.innerText = tagText;
          tagsContainer.appendChild(span);
        });
        toggleEdit(false);
      }
    </script>
  </body>
</html>