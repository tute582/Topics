<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>志工管理系統 Volunteer Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f7f9fb;
        margin: 0;
        padding: 0;
        padding-bottom: 80px;
      }

      /* =========================================
         1. 導覽列
         ========================================= */
      .nav-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 25px;
        position: sticky;
        top: 0;
        z-index: 1001;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        left: 0;
        right: 0;
        color: black;
        background-color: white;
        box-sizing: border-box;
        border-bottom: 1px solid #ddd;
      }

      /* =========================================
         2. 分頁按鈕
         ========================================= */
      .tab-container {
        display: flex;
        background: white;
        margin-top: 1px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 20px;
      }
      .tab-btn {
        flex: 1;
        text-align: center;
        padding: 15px 0;
        font-size: 16px;
        font-weight: bold;
        color: #888;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s;
      }
      .tab-btn.active {
        color: #0984e3;
        border-bottom: 3px solid #0984e3;
        background-color: #f0f8ff;
      }
      
      .tab-content {
        display: none;
        padding: 10px 20px;
        justify-content: center;
        animation: fadeIn 0.3s ease-in-out;
      }
      .tab-content.active {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* =========================================
         3. 志工卡片
         ========================================= */
      .card {
        width: 100%;
        max-width: 360px;
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        position: relative;
        margin-bottom: 20px;
      }

      .card-cover {
        width: 100%;
        height: 150px;
        background-color: #c2dfff;
      }

      .card-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid rgb(94, 131, 252);
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        object-fit: cover;
        background: #fff;
      }

      .card-content {
        padding: 70px 20px 30px;
        text-align: center;
      }

      .card-title {
        font-size: 1.3em;
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .special {
        background: #ffeaa7;
        color: #2d3436;
        padding: 2px 10px 6px;
        border-radius: 10px;
        font-size: 0.8em;
      }

      .card-tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }

      .card-tags .tag {
        background-color: #e9f5ff;
        color: #007bff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
      }

      .card-text {
        margin-top: 10px;
        color: #636e72;
        line-height: 1.5;
      }

      /* 編輯模式樣式 */
      .edit-input, .edit-textarea {
        width: 90%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
      }
      .edit-btn {
        margin-top: 15px;
        background: #0984e3;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
      }
      .save-btn {
        background: #00b894;
        margin-right: 10px;
      }
      .cancel-btn {
        background: #b2bec3;
      }

      /* =========================================
         4. 日曆與 Modal 樣式
         ========================================= */
      .calendar-wrapper {
        width: 100%;
        max-width: 800px;
        background-color: #fff;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 20px;
        box-sizing: border-box;
      }
      .fc-toolbar-title { font-size: 1.5em !important; font-weight: bold; }
      .fc-button { font-size: 0.9em !important; }
      .hospital-event {
        background-color: #d63031 !important;
        border: none !important;
        color: white !important;
      }

      /* ----- 新增：Modal 樣式 ----- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* 半透明黑底 */
        z-index: 2000; /* 確保在最上層 */
        display: none; /* 預設隱藏 */
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .modal-overlay.show {
        display: flex;
        opacity: 1;
      }

      .modal-box {
        background: white;
        width: 90%;
        max-width: 400px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        overflow: hidden;
        transform: translateY(20px);
        transition: transform 0.3s ease;
      }

      .modal-overlay.show .modal-box {
        transform: translateY(0);
      }

      .modal-header {
        background-color: #f0f8ff;
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .modal-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        margin: 0;
      }

      .close-icon {
        cursor: pointer;
        font-size: 24px;
        color: #999;
        line-height: 1;
      }

      .modal-body {
        padding: 20px;
        font-size: 1em;
        color: #555;
        line-height: 1.6;
      }

      .modal-row {
        margin-bottom: 10px;
        display: flex;
        align-items: flex-start;
      }
      
      .modal-label {
        font-weight: bold;
        color: #0984e3;
        min-width: 50px;
        margin-right: 10px;
      }

      .modal-footer {
        padding: 15px;
        text-align: right;
        border-top: 1px solid #eee;
      }

      .modal-btn {
        background-color: #0984e3;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
      }

      /* 過去日期樣式（灰階化）並提示無法點選 */
      .calendar-wrapper .fc .fc-daygrid-day.my-past .fc-daygrid-day-frame {
         background: #fbfbfc !important;
         position: relative;
         pointer-events: none; /* 禁止點選整個格子（事件會被下方的規則放行） */
       }
       .calendar-wrapper .fc .fc-daygrid-day.my-past .fc-daygrid-day-number {
         color: #bdbfc2 !important;
       }
       /* 放行格內事件的互動 */
       .calendar-wrapper .fc .fc-daygrid-day.my-past .fc-daygrid-event,
       .calendar-wrapper .fc .fc-daygrid-day.my-past .fc-event {
         pointer-events: auto !important;
       }
       /* 額外提示樣式（可選） */
       .calendar-wrapper .fc .fc-daygrid-day.my-past.past-click-blocked {
         outline: 2px solid rgba(0,0,0,0.04);
       }

     /* 三時段事件顏色（用 classNames 一致套用） */
     .calendar-wrapper .fc .fc-daygrid-event.ev-morning,
     .calendar-wrapper .fc .fc-event.ev-morning {
       background-color: #4f8a8b !important;
       color: #fff !important;
     }
     .calendar-wrapper .fc .fc-daygrid-event.ev-afternoon,
     .calendar-wrapper .fc .fc-event.ev-afternoon {
       background-color: #74b9ff !important;
       color: #fff !important;
     }
     .calendar-wrapper .fc .fc-daygrid-event.ev-evening,
     .calendar-wrapper .fc .fc-event.ev-evening {
       background-color: #f6b93b !important;
       color: #222 !important;
     }
     /* 讓事件有圓角與內距 */
     .calendar-wrapper .fc .fc-daygrid-event .fc-event-main {
       border-radius: 10px !important;
       padding: 6px 10px !important;
       box-shadow: 0 4px 8px rgba(0,0,0,0.06) !important;
     }
    </style>
  </head>
  <body>

    <nav class="nav-1">
      <div>
        <h1 style="margin: 0; font-size: 28px">志工管理系統</h1>
      </div>
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span class="volunteer-area" style="display: flex; align-items: center; gap: 8px">
            <img id="volunteerAvatar" class="avatar" src="default-avatar.png" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #0984e3; display: none;" />
            <span id="volunteerName" style="cursor: pointer; font-size: 26px">未登入</span>
          </span>
        </h1>
      </div>
    </nav>

    <div class="tab-container">
      <div class="tab-btn active" onclick="switchTab('info')">志工資訊</div>
      <div class="tab-btn" onclick="switchTab('calendar')">預約紀錄</div>
    </div>

    <section id="tab-info" class="tab-content active">
      <div class="card">
        <div class="card-cover"></div>
        <img class="card-avatar" src="https://i.pravatar.cc/150?img=32" alt="頭像" />
        
        <div class="card-content">
          <div id="viewMode">
            <h2 class="card-title">
              <span id="view-name">王小明</span>
              <span id="view-special" class="special">醫護證照</span>
            </h2>
            <div id="view-tags" class="card-tags">
              <span class="tag">親切</span>
              <span class="tag">細心</span>
              <span class="tag">熱心助人</span>
            </div>
            <p id="view-text" class="card-text">擁有豐富的醫院志工經驗，熱愛幫助他人。</p>
            <button class="edit-btn" onclick="toggleEdit(true)">✏️ 編輯資料</button>
          </div>

          <div id="editMode" style="display: none;">
            <label style="color:#888; font-size:0.8em;">姓名</label>
            <input type="text" id="input-name" class="edit-input" value="王小明">
            <label style="color:#888; font-size:0.8em;">特殊稱號</label>
            <input type="text" id="input-special" class="edit-input" value="醫護證照">
            <label style="color:#888; font-size:0.8em;">標籤</label>
            <input type="text" id="input-tags" class="edit-input" value="親切, 細心, 熱心助人">
            <label style="color:#888; font-size:0.8em;">自我介紹</label>
            <textarea id="input-text" class="edit-textarea" rows="4">擁有豐富的醫院志工經驗，熱愛幫助他人。</textarea>
            <div style="margin-top: 10px;">
              <button class="edit-btn save-btn" onclick="saveData()">儲存</button>
              <button class="edit-btn cancel-btn" onclick="toggleEdit(false)">取消</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-calendar" class="tab-content">
      <div class="calendar-wrapper">
        <div id="calendar"></div>
      </div>
    </section>

    <div id="eventModal" class="modal-overlay" onclick="closeModalOnOverlay(event)">
      <div class="modal-box">
        <div class="modal-header">
          <div class="modal-title" id="m-title">標題</div>
          <span class="close-icon" onclick="closeModal()">×</span>
        </div>
        <div class="modal-body">
          <div class="modal-row">
            <span class="modal-label">時間:</span>
            <span id="m-time"></span>
          </div>
          <div class="modal-row" id="row-location">
            <span class="modal-label">地點:</span>
            <span id="m-location"></span>
          </div>
          <div class="modal-row" id="row-elder">
            <span class="modal-label">長者:</span>
            <span id="m-elder"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-btn" onclick="closeModal()">關閉</button>
        </div>
      </div>
    </div>

    <script>
      let calendar; 

      document.addEventListener("DOMContentLoaded", function () {
        try {
          const calendarEl = document.getElementById("calendar");
          const currentYear = new Date().getFullYear();

          calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            initialDate: `${currentYear}-01-12`,
            locale: "zh-tw",
            height: 'auto',
            headerToolbar: {
              left: "prev,next",
              center: "title",
              right: "today"
            },
            events: [
              {
                title: "亞東醫院 (陪伴就醫)",
                start: `${currentYear}-01-12T10:00:00`,
                end: `${currentYear}-01-12T12:00:00`,
                classNames: ['hospital-event'],
                extendedProps: {
                  location: "亞東醫院",
                  elder: "林奶奶"
                }
              },
              {
                title: "社區關懷 (家訪)",
                start: `${currentYear}-01-20T14:00:00`,
                color: "#0984e3",
                extendedProps: {
                  location: "板橋區中正路",
                  elder: "張爺爺"
                }
              },
              {
                title: "衛生所 (打疫苗)",
                start: `${currentYear}-02-05T09:30:00`,
                color: "#00b894",
                extendedProps: {
                  location: "板橋衛生所",
                  elder: "自己"
                }
              }
            ],
            // 修改這裡：原本是 alert，現在改成呼叫 showModal
            eventClick: function(info) {
               showModal(info);
            },
           // 在日格掛載時標記過去日格（給 CSS 使用）
           dayCellDidMount: function(arg) {
             try {
               const today = new Date();
               today.setHours(0,0,0,0);
               const cellDate = new Date(arg.date);
               cellDate.setHours(0,0,0,0);
               if (cellDate < today) {
                 arg.el.classList.add('my-past');
                 arg.el.setAttribute('aria-disabled','true');
               }
             } catch (err) { /* ignore */ }
           },
           // 點日期 → 顯示三時段選單（但禁止過去日期）
           dateClick: function(info) {
             const clicked = new Date(info.dateStr + 'T00:00:00');
             const today = new Date(); today.setHours(0,0,0,0);
             if (clicked < today) return; // 過去日期不處理
             showTimeSlotModal(info.dateStr);
           }
          });
 
          calendar.render();
         
          /* ----- 新增：點日排三時段 modal 函式 ----- */
          function showTimeSlotModal(dateStr) {
            // 建 overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay show';
            overlay.style.zIndex = 3000;
            overlay.innerHTML = `
              <div class="modal-box" style="max-width:420px;padding:18px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                  <h3 style="margin:0">新增可服務時段 — ${dateStr}</h3>
                  <span style="cursor:pointer;font-size:20px;" id="slotClose">×</span>
                </div>
                <div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
                  <button class="slot-select" data-time="09:00" data-class="ev-morning" style="padding:8px 12px;border-radius:8px;border:none;background:#4f8a8b;color:#fff;cursor:pointer;">上午</button>
                  <button class="slot-select" data-time="14:00" data-class="ev-afternoon" style="padding:8px 12px;border-radius:8px;border:none;background:#74b9ff;color:#fff;cursor:pointer;">下午</button>
                  <button class="slot-select" data-time="18:00" data-class="ev-evening" style="padding:8px 12px;border-radius:8px;border:none;background:#f6b93b;color:#222;cursor:pointer;">晚上</button>
                </div>
                <div style="text-align:center;color:#666;margin-bottom:10px;">或選擇自訂時間</div>
                <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px;">
                  <input id="customSlotTime" type="time" style="padding:8px;border:1px solid #ddd;border-radius:6px;" />
                  <select id="customSlotClass" style="padding:8px;border-radius:6px;border:1px solid #ddd;">
                    <option value="ev-morning">上午</option>
                    <option value="ev-afternoon">下午</option>
                    <option value="ev-evening">晚上</option>
                  </select>
                </div>
                <div style="text-align:right;">
                  <button id="slotCancel" style="padding:8px 12px;border-radius:8px;border:none;background:#aaa;color:#fff;cursor:pointer;margin-right:8px;">取消</button>
                  <button id="slotConfirm" style="padding:8px 12px;border-radius:8px;border:none;background:#0984e3;color:#fff;cursor:pointer;">新增</button>
                </div>
              </div>
            `;
            document.body.appendChild(overlay);

            // 元件參考
            const timeInput = overlay.querySelector('#customSlotTime');
            const classSelect = overlay.querySelector('#customSlotClass');

            // 關閉
            overlay.querySelector('#slotClose').addEventListener('click', () => overlay.remove());
            overlay.querySelector('#slotCancel').addEventListener('click', () => overlay.remove());

            // 點快速時段：只填入 time picker 與選標籤，並標示被選取的按鈕，讓使用者可以再調整
            overlay.querySelectorAll('.slot-select').forEach(btn => {
              btn.addEventListener('click', () => {
                const time = btn.dataset.time;
                const cls = btn.dataset.class;
                timeInput.value = time;
                classSelect.value = cls;
                // 樣式標示選中
                overlay.querySelectorAll('.slot-select').forEach(b => b.style.opacity = '0.6');
                btn.style.opacity = '1';
              });
            });

            // 確認自訂時間 / 新增：使用 timeInput 與 classSelect 的值建立事件
            overlay.querySelector('#slotConfirm').addEventListener('click', () => {
              const t = timeInput.value;
              const cls = classSelect.value || 'ev-morning';
              if (!t) { alert('請選擇時間或點選上方時段'); return; }
              const dt = new Date(`${dateStr}T${t}:00`);
              if (dt.getTime() <= Date.now()) { alert('無法新增已過的時段'); return; }
              calendar.addEvent({
                title: `可服務 ${t}`,
                start: dt.toISOString(),
                allDay: false,
                classNames: [cls],
                extendedProps: { note: '排班 (自訂)' }
              });
              overlay.remove();
            });
          }
         
          initLiffAndSetProfile();
        } catch (err) {
          console.error('初始化錯誤:', err);
          alert('初始化發生錯誤，請打開開發者工具 (F12) 查看 console，並將錯誤訊息貼給我。\n\n錯誤訊息：' + (err && err.message ? err.message : err));
        }
      });

      // --- Modal 相關函式 ---
      function showModal(info) {
        const event = info.event;
        const props = event.extendedProps;
        
        // 1. 填入標題
        document.getElementById('m-title').innerText = event.title;
        
        // 2. 填入時間 (格式化一下)
        const timeStr = event.start.toLocaleString('zh-TW', { 
            month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' 
        });
        document.getElementById('m-time').innerText = timeStr;

        // 3. 填入地點 (如果有)
        const locRow = document.getElementById('row-location');
        if(props.location) {
            document.getElementById('m-location').innerText = props.location;
            locRow.style.display = 'flex';
        } else {
            locRow.style.display = 'none';
        }

        // 4. 填入長者 (如果有)
        const elderRow = document.getElementById('row-elder');
        if(props.elder) {
            document.getElementById('m-elder').innerText = props.elder;
            elderRow.style.display = 'flex';
        } else {
            elderRow.style.display = 'none';
        }

        // 5. 顯示 Modal (透過 CSS class 控制)
        const modal = document.getElementById('eventModal');
        modal.classList.add('show');
      }

      function closeModal() {
        const modal = document.getElementById('eventModal');
        modal.classList.remove('show');
      }

      // 點擊半透明黑底時也要關閉，但點擊內容盒子不能關閉
      function closeModalOnOverlay(e) {
        if (e.target.id === 'eventModal') {
            closeModal();
        }
      }

      // --- 分頁切換 ---
      function switchTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        if (tabName === 'info') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        if (tabName === 'calendar') document.querySelectorAll('.tab-btn')[1].classList.add('active');

        document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');

        if (tabName === 'calendar' && calendar) {
          setTimeout(() => { calendar.updateSize(); }, 50);
        }
      }

      // --- 編輯功能 ---
      function toggleEdit(showEdit) {
        if (showEdit) {
          document.getElementById('input-name').value = document.getElementById('view-name').innerText;
          document.getElementById('input-special').value = document.getElementById('view-special').innerText;
          document.getElementById('input-text').value = document.getElementById('view-text').innerText;
          
          const tags = Array.from(document.querySelectorAll('#view-tags .tag'))
                            .map(tag => tag.innerText).join(', ');
          document.getElementById('input-tags').value = tags;

          document.getElementById('viewMode').style.display = 'none';
          document.getElementById('editMode').style.display = 'block';
        } else {
          document.getElementById('viewMode').style.display = 'block';
          document.getElementById('editMode').style.display = 'none';
        }
      }

      function saveData() {
        document.getElementById('view-name').innerText = document.getElementById('input-name').value;
        document.getElementById('view-special').innerText = document.getElementById('input-special').value;
        document.getElementById('view-text').innerText = document.getElementById('input-text').value;

        const tagsStr = document.getElementById('input-tags').value;
        const tagsArr = tagsStr.split(',').map(t => t.trim()).filter(t => t);
        const tagsContainer = document.getElementById('view-tags');
        tagsContainer.innerHTML = ''; 
        tagsArr.forEach(tagText => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.innerText = tagText;
          tagsContainer.appendChild(span);
        });

        toggleEdit(false);
      }

      // --- LIFF ---
      const LIFF_ID = "2008228534-R8763A2n";
      const avatarEl = document.getElementById("volunteerAvatar");
      const nameEl = document.getElementById("volunteerName");

      async function initLiffAndSetProfile() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            nameEl.innerText = "未登入";
            avatarEl.style.display = "none";
            return;
          }
          const profile = await liff.getProfile();
          nameEl.innerText = profile.displayName || "志工";
          if (profile.pictureUrl) {
            avatarEl.src = profile.pictureUrl;
            avatarEl.style.display = "inline-block";
          } else {
            avatarEl.style.display = "none";
          }
        } catch (err) {
          console.error("LIFF init error:", err);
        }
      }

      nameEl.addEventListener("click", () => {
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
        }
      });
    </script>
  </body>
</html>