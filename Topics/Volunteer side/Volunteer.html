<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>志工管理系統 Volunteer Dashboard</title>

    <!-- FullCalendar CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        background: #f7f9fb;
        margin: 0;
        padding: 0;
      }

      .dashboard {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 30px;
        padding: 30px;
      }

      /* 志工卡片 */
      .card {
        width: 340px;
        background: #ffffff;
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        position: relative;
      }

      .card-cover {
        width: 100%;
        height: 150px;
        background-color: #c2dfff;
      }

      .card-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 3px solid rgb(94, 131, 252);
        position: absolute;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        object-fit: cover;
      }

      .card-content {
        padding: 70px 20px 40px;
        text-align: center;
      }

      .card-title {
        font-size: 1.3em;
        margin-top: 20px; /* 調整靠近頭像 */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .special {
        background: #ffeaa7;
        color: #2d3436;
        padding: 2px 10px 6px;
        border-radius: 10px;
        font-size: 0.8em;
      }

      .card-tags {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 8px;
      }

      .card-tags .tag {
        background-color: #e9f5ff;
        color: #007bff;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
      }

      .card-text {
        margin-top: 10px;
        color: #636e72;
      }

      /* 日曆 */
      .calendar-container {
        flex-grow: 1;
        min-width: 400px;
        max-width: 800px;
        background-color: #fff;
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      /* 調整 FullCalendar 工具列：標題在上、按鈕在下 */
      .calendar-container .fc-toolbar {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 8px !important;
      }
      /* 每個 chunk 置中顯示（左/中/右皆置中），並讓按鈕區自動換行 */
      .calendar-container .fc-toolbar .fc-toolbar-chunk {
        width: 100% !important;
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
      }
      /* 主要優先把中間 chunk（通常包含 title）排到最前面 */
      .calendar-container .fc-toolbar .fc-toolbar-chunk.fc-toolbar-chunk-center,
      .calendar-container .fc-toolbar .fc-toolbar-chunk:nth-child(2) {
        order: -2 !important;
      }
      /* 確保左右 chunk（按鈕）在下方 */
      .calendar-container .fc-toolbar .fc-toolbar-chunk.fc-toolbar-chunk-left,
      .calendar-container .fc-toolbar .fc-toolbar-chunk.fc-toolbar-chunk-right {
        order: 1 !important;
      }
      .calendar-container .fc-toolbar .fc-toolbar-title,
      .calendar-container .fc-toolbar h2 {
        font-size: 28px !important;
        margin: 0 !important;
        font-weight: 700 !important;
      }
      /* 按鈕群集中顯示並小幅間距 */
      .calendar-container .fc-toolbar .fc-button,
      .calendar-container .fc-toolbar .fc-button-group > * {
        margin: 0 6px;
      }
      /* 小螢幕下按鈕允許換行 */
      @media (max-width: 600px) {
        .calendar-container .fc-toolbar .fc-toolbar-chunk {
          padding: 0 8px;
        }
        .calendar-container .fc-toolbar .fc-button-group {
          flex-wrap: wrap;
          gap: 6px;
        }
        .calendar-container .fc-toolbar h2 { font-size: 20px; }
      }

      /* ===== 調整 FullCalendar 事件樣式（與其他頁面一致） ===== */
    .calendar-container .fc .fc-daygrid-event,
    .calendar-container .fc .fc-daygrid-event-harness {
      border-radius: 10px !important;
      overflow: visible;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      border: none !important;
      background: transparent !important;
    }
    /* 隱藏小圓點 */
    .calendar-container .fc .fc-daygrid-event .fc-event-dot { display: none !important; }

    /* 讓時間與標題換行顯示 */
    .calendar-container .fc .fc-daygrid-event .fc-event-main {
      padding: 8px 12px !important;
      font-weight: 600;
      display: flex !important;
      flex-direction: column !important; /* 由直向排列：時間在上、標題在下 */
      align-items: flex-start !important;
      gap: 4px !important;
      border-radius: 10px !important;
      box-sizing: border-box;
      white-space: normal !important; /* 允許換行 */
      line-height: 1.1;
    }

    .calendar-container .fc .fc-daygrid-event .fc-event-time {
      display: block !important;
      color: rgba(255,255,255,0.95) !important;
      font-weight: 700 !important;
      font-size: 0.95em !important;
      margin: 0 !important;
    }
    .calendar-container .fc .fc-daygrid-event .fc-event-title {
      display: block !important;
      color: inherit !important;
      margin: 0 !important;
      font-size: 1em !important;
    }

    /* 針對自定義 class 強制套用背景色與文字色（確保所有情境一致） */
    .calendar-container .fc .fc-daygrid-event.ev-morning .fc-event-main,
    .calendar-container .fc .fc-daygrid-event.ev-morning {
      background-color: #4f8a8b !important;
      color: #fff !important;
    }
    .calendar-container .fc .fc-daygrid-event.ev-afternoon .fc-event-main,
    .calendar-container .fc .fc-daygrid-event.ev-afternoon {
      background-color: #74b9ff !important;
      color: #fff !important;
    }
    .calendar-container .fc .fc-daygrid-event.ev-evening .fc-event-main,
    .calendar-container .fc .fc-daygrid-event.ev-evening {
      background-color: #f6b93b !important;
      color: #222 !important;
    }
    .calendar-container .fc .fc-daygrid-event.ev-custom .fc-event-main,
    .calendar-container .fc .fc-daygrid-event.ev-custom {
      background-color: #6c5ce7 !important;
      color: #fff !important;
    }

    /* 小螢幕微調 */
    @media (max-width: 480px) {
      .calendar-container .fc .fc-daygrid-event .fc-event-main {
        padding: 6px 10px !important;
        font-size: 13px;
      }
      .calendar-container .fc .fc-daygrid-event .fc-event-time {
        font-size: 12px !important;
      }
    }

      /* 彈窗 */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .modal {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      }
      .modal button {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .modal .confirm {
        background: #4a90e2;
        color: white;
      }
      .modal .cancel {
        background: #aaa;
        color: white;
      }

      /* 導覽列 */
      .nav-1 {
        display: flex; /* 水平排列內容 */
        /* font-weight: 500;*/
        align-items: center; /* 垂直置中 */
        justify-content: space-between; /* 兩端對齊：左/右 */
        padding: 10px 25px; /* 右側保留內距，左側移除讓內容靠近頁邊 */
        position: sticky; /* 滾動時吸附上方 */
        top: 0; /* 吸附頂部 */
        z-index: 1001; /* 保證在其他元素之上 */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        left: 0;
        right: 0;
        color: black;
        background-color: white;
        box-sizing: border-box; /* 確保padding不會超出寬度 */
        border-bottom: 1px solid #ddd; /* 建議加這行讓導覽列更明顯 */
      }

      @media screen and (max-width: 768px) {
        .dashboard {
          flex-direction: column;
          align-items: center;
        }
        .calendar-container {
          width: 95%;
        }
      }
    </style>
  </head>
  <body>
    <!-- 導覽列 -->
    <nav class="nav-1">
      <div>
        <h1 style="margin: 0; font-size: 28px">志工管理系統</h1>
      </div>

      <!-- 已移除：改用 FullCalendar toolbar 的 custom button（會顯示在 Today 旁） -->
      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <img
              id="volunteerAvatar"
              class="avatar"
              src="default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <span
              id="volunteerName"
              title="點此以 Line 登入"
              style="cursor: pointer; font-size: 26px"
              >未登入</span
            >
          </span>
        </h1>
      </div>
    </nav>

    <section class="dashboard">
      <!-- 志工資訊卡 -->
      <div class="card">
        <div class="card-cover"></div>
        <img
          class="card-avatar"
          src="https://i.pravatar.cc/150?img=32"
          alt="頭像"
        />
        <div class="card-content">
          <h2 class="card-title">
            <span id="cardName">王小明</span>
            <span class="special">醫護證照</span>
          </h2>
          <div class="card-tags">
            <span class="tag">親切</span>
            <span class="tag">細心</span>
            <span class="tag">熱心助人</span>
          </div>
          <p class="card-text">擁有豐富的醫院志工經驗，熱愛幫助他人。</p>
        </div>
      </div>

      <!-- 日曆 -->
      <div class="calendar-container">
        <div id="calendar"></div>
      </div>
    </section>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const calendarEl = document.getElementById("calendar");

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          initialDate: "2025-10-01",
          selectable: true,
          locale: "zh-tw",
          // 把 custom button 加到 left，會顯示在 today 旁
          headerToolbar: {
            left: "prev,next today viewUpcoming",
            center: "title",
            right: "",
          },
          customButtons: {
            viewUpcoming: {
              text: "即將陪伴",
              click: function () {
                // showUpcomingElders 為檔案中已宣告的函式（function 宣告會被 hoist）
                showUpcomingElders();
              },
            },
          },
           // 點日期直接開啟時段選擇
           dateClick: function (info) {
             showTimeSlotModal(info.dateStr);
           },
           // 點事件可取消（單筆）
           eventClick: function (info) {
             if (confirm(`確定要取消 ${info.event.startStr} 的服務時段嗎？`)) {
               info.event.remove();
               alert("❌ 已取消該服務時段");
             }
           },
           // 初始不載入範例事件（已移除預設顯示）
           events: [],
         });
 
        calendar.render();
 
        // 立即移除頁面上可能已存在的預設範例事件（保險做法）
        // 如果未來要改成只移除特定日期，請修改 datesToRemove 陣列
        (function clearSampleEvents() {
          const datesToRemove = ["2025-10-10", "2025-10-15"];
          calendar.getEvents().forEach(ev => {
            if (datesToRemove.includes(ev.startStr)) ev.remove();
          });
        })();
 
        // 新增：點日期時開啟時段選擇，並新增可服務事件
        function showTimeSlotModal(dateStr) {
          const overlay = document.createElement('div');
          overlay.className = 'modal-overlay';
          overlay.innerHTML = `
            <div class="modal" style="max-width:480px;width:92%;text-align:center;">
              <h3 style="margin-top:0">選擇 ${dateStr} 的時段與時間</h3>
              <div style="display:flex;gap:8px;justify-content:center;margin:12px 0;">
                <button class="slot-btn" data-time="09:00" data-label="上午" style="padding:8px 12px;border-radius:8px;border:none;background:#4f8a8b;color:#fff;cursor:pointer;">上午</button>
                <button class="slot-btn" data-time="13:00" data-label="下午" style="padding:8px 12px;border-radius:8px;border:none;background:#74b9ff;color:#fff;cursor:pointer;">下午</button>
                <button class="slot-btn" data-time="18:00" data-label="晚上" style="padding:8px 12px;border-radius:8px;border:none;background:#f6b93b;color:#222;cursor:pointer;">晚上</button>
              </div>
              <div style="margin-top:8px;color:#666;font-size:13px;">或直接輸入具體時間：</div>
              <input id="slotTime" type="time" style="width:60%;padding:8px;margin:8px auto;border:1px solid #ddd;border-radius:6px;display:block;"/>
              <div style="margin-top:8px;color:#666;font-size:13px;">備註（選填）</div>
              <input id="slotNote" type="text" placeholder="例如：家訪、診間陪同" style="width:86%;padding:8px;margin:8px auto;border:1px solid #ddd;border-radius:6px;display:block;"/>
              <div style="text-align:right;margin-top:10px;">
                <button class="confirm" style="padding:8px 12px;border-radius:8px;border:none;background:#0984e3;color:#fff;cursor:pointer;">確認新增</button>
                <button class="cancel" style="padding:8px 12px;border-radius:8px;border:none;background:#aaa;color:#fff;cursor:pointer;margin-left:8px;">取消</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          // 按鈕選預設時間會填入 time input 並加上視覺狀態
          overlay.querySelectorAll('.slot-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const t = btn.dataset.time;
              document.getElementById('slotTime').value = t;
              // 樣式標示選中
              overlay.querySelectorAll('.slot-btn').forEach(b => b.style.opacity = '0.6');
              btn.style.opacity = '1';
            });
          });

          // 取消按鈕
          overlay.querySelector('.cancel').addEventListener('click', () => overlay.remove());

          // 確認新增：有時間則建立含時間事件，否則建立全天事件
          overlay.querySelector('.confirm').addEventListener('click', () => {
            const timeVal = document.getElementById('slotTime').value;
            const note = document.getElementById('slotNote').value.trim();
            if (!timeVal) {
              // 全日（使用 ev-custom 類或你要的類別）
              calendar.addEvent({
                title: `可服務（全天）${note ? ' - ' + note : ''}`,
                start: dateStr,
                allDay: true,
                classNames: ['ev-custom']
              });
              alert(`✅ 已新增 ${dateStr} 的全天時段`);
            } else {
              // 組成當地 ISO datetime
              const iso = `${dateStr}T${timeVal}:00`;
              // 根據預設時段選色，可改成更動態映射
              let cls = 'ev-custom';
              if (timeVal.startsWith('09') || timeVal < '12:00') cls = 'ev-morning';
              else if (timeVal >= '12:00' && timeVal < '17:00') cls = 'ev-afternoon';
              else cls = 'ev-evening';

              calendar.addEvent({
                title: `可服務 ${timeVal}${note ? ' - ' + note : ''}`,
                start: iso,
                allDay: false,
                classNames: [cls]
              });
              alert(`✅ 已新增 ${dateStr} ${timeVal} 的時段`);
            }
             overlay.remove();
           });

          // 點遮罩背景也關閉
          overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        }

        // 綁定「查看即將陪伴」按鈕
        const viewBtn = document.getElementById('viewUpcomingBtn');
        if (viewBtn) viewBtn.addEventListener('click', showUpcomingElders);

        // 顯示未來事件（即將陪伴）modal（改成可點進去填寫看診資訊）
        function showUpcomingElders() {
          const events = calendar
            .getEvents()
            .filter((ev) => ev.start && ev.start.getTime() > Date.now())
            .sort((a, b) => a.start - b.start);

          const overlay = document.createElement("div");
          overlay.className = "modal-overlay";
          const listHtml = events.length
            ? events
                .map((ev) => {
                  const dt = ev.start.toLocaleString();
                  const title = ev.title || "未命名";
                  const elder =
                    ev.extendedProps?.elder_name || ev.extendedProps?.elder || "";
                  // 每列加 data-id，整列可點
                  return `<tr class="upcoming-row" data-id="${ev.id}" style="cursor:pointer;">
                            <td style="padding:8px 12px;border-bottom:1px solid #eee;">${title}</td>
                            <td style="padding:8px 12px;border-bottom:1px solid #eee;">${dt}</td>
                            <td style="padding:8px 12px;border-bottom:1px solid #eee;">${elder}</td>
                            <td style="padding:8px 12px;border-bottom:1px solid #eee;">
                              <button class="detail-btn" data-id="${ev.id}" style="padding:6px 10px;border-radius:6px;border:none;background:#0984e3;color:#fff;cursor:pointer;">填寫看診</button>
                            </td>
                          </tr>`;
                })
                .join("")
            : `<tr><td colspan="4" style="padding:18px;text-align:center;color:#666;">目前沒有即將的陪伴行程</td></tr>`;

          overlay.innerHTML = `
            <div class="modal" style="max-width:820px;width:92%;">
              <h3 style="margin-top:0">即將陪伴的行程</h3>
              <div style="max-height:420px;overflow:auto;margin-bottom:12px;">
                <table style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr style="background:#f5f7fb;">
                      <th style="text-align:left;padding:10px 12px;">標題</th>
                      <th style="text-align:left;padding:10px 12px;">日期時間</th>
                      <th style="text-align:left;padding:10px 12px;">長者</th>
                      <th style="text-align:left;padding:10px 12px;">操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${listHtml}
                  </tbody>
                </table>
              </div>
              <div style="text-align:right;">
                <button class="close-modal" style="padding:8px 12px;border-radius:8px;border:none;background:#aaa;color:#fff;cursor:pointer;">關閉</button>
              </div>
            </div>
          `;
          document.body.appendChild(overlay);

          // 點整列或按「填寫看診」都會打開看診表單
          overlay.querySelectorAll(".upcoming-row").forEach((row) => {
            row.addEventListener("click", (e) => {
              const id = row.dataset.id;
              const ev = calendar.getEventById(id);
              if (!ev) return alert("找不到該行程");
              showClinicForm(ev, overlay);
            });
          });
          overlay.querySelectorAll(".detail-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.stopPropagation(); // 防止觸發列的 click 雙重執行
              const id = btn.dataset.id;
              const ev = calendar.getEventById(id);
              if (!ev) return alert("找不到該行程");
              showClinicForm(ev, overlay);
            });
          });

          overlay.querySelector(".close-modal").addEventListener("click", () =>
            overlay.remove()
          );
          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) overlay.remove();
          });
        }

        // 打開看診資訊填寫表單（modal），儲存到 localStorage（key = clinic_{eventId}）
        function showClinicForm(ev, parentOverlay = null) {
          const saved = localStorage.getItem("clinic_" + ev.id);
          const prev = saved ? JSON.parse(saved) : {};
          const overlay = document.createElement("div");
          overlay.className = "modal-overlay";
          overlay.innerHTML = `
            <div class="modal" style="max-width:720px;width:92%;text-align:left;">
              <h3 style="margin-top:0">看診資訊 — ${ev.title || ""}</h3>
              <div style="margin-bottom:8px;color:#555;">
                <strong>長者：</strong> ${ev.extendedProps?.elder_name || ev.extendedProps?.elder || ""}
                <br/>
                <strong>時間：</strong> ${ev.start ? ev.start.toLocaleString() : ""}
              </div>
              <form id="clinicForm" style="display:flex;flex-direction:column;gap:8px;">
                <label>主訴 / 診斷：<input type="text" name="diagnosis" value="${(prev.diagnosis||"")}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;"/></label>
                <label>用藥/處置：<input type="text" name="meds" value="${(prev.meds||"")}" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;"/></label>
                <label>備註：<textarea name="notes" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;" rows="4">${(prev.notes||"")}</textarea></label>
                <div style="text-align:right;margin-top:6px;">
                  <button type="button" class="save-clinic" style="padding:8px 12px;border-radius:8px;border:none;background:#0984e3;color:#fff;cursor:pointer;">儲存</button>
                  <button type="button" class="cancel-clinic" style="padding:8px 12px;border-radius:8px;border:none;background:#aaa;color:#fff;cursor:pointer;margin-left:8px;">取消</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(overlay);

          const modal = overlay.querySelector(".modal");
          overlay.querySelector(".save-clinic").addEventListener("click", () => {
            const form = overlay.querySelector("#clinicForm");
            const diagnosis = form.diagnosis.value.trim();
            const meds = form.meds.value.trim();
            const notes = form.notes.value.trim();
            const payload = {
              elder: ev.extendedProps?.elder_name || ev.extendedProps?.elder || "",
              datetime: ev.start ? ev.start.toISOString() : "",
              diagnosis,
              meds,
              notes,
              savedAt: new Date().toISOString(),
            };
            localStorage.setItem("clinic_" + ev.id, JSON.stringify(payload));
            // （可同時把 summary 放回 event.extendedProps）
            try { ev.setExtendedProp && ev.setExtendedProp("clinicInfo", payload); } catch (err) {}
            alert("✅ 已儲存看診資訊");
            overlay.remove();
            // 若原本的 upcoming modal 傳入了 parentOverlay，保留它；否則無操作
            if (parentOverlay) {} 
          });

          overlay.querySelector(".cancel-clinic").addEventListener("click", () => {
            overlay.remove();
          });

          overlay.addEventListener("click", (e) => {
            if (e.target === overlay) overlay.remove();
          });
        }
      });

      /* ==============================
   ✅ LIFF 初始化
   ============================== */
      const LIFF_ID = "2008228534-R8763A2n";
      const avatarEl = document.getElementById("volunteerAvatar");
      const nameEl = document.getElementById("volunteerName");

      async function initLiffAndSetProfile() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            nameEl.innerText = "未登入";
            avatarEl.style.display = "none";
            return;
          }

          const profile = await liff.getProfile();
          nameEl.innerText = profile.displayName || "志工";
          if (profile.pictureUrl) {
            avatarEl.src = profile.pictureUrl;
            avatarEl.style.display = "inline-block";
          } else {
            avatarEl.style.display = "none";
          }
        } catch (err) {
          console.error("LIFF init error:", err);
        }
      }

      avatarEl.addEventListener("click", () => {
        if (liff.isLoggedIn()) {
          window.location.href = "index.html";
        } else {
          liff.login({
            redirectUri:
              "https://tute582.github.io/Topics/Login-or-register/index.html",
          });
        }
      });

      nameEl.addEventListener("click", () => {
        if (!liff.isLoggedIn()) {
          liff.login({
            redirectUri:
              "https://tute582.github.io/Topics/Login-or-register/index.html",
          });
        } else {
          alert("已登入：" + (nameEl.innerText || "志工"));
        }
      });

      initLiffAndSetProfile();
    </script>
  </body>
</html>