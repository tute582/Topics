<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡€å£“ç´€éŒ„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* =========================
       å…¨åŸŸèˆ‡ç‰ˆé¢ï¼ˆèª¿æ•´ç‚ºéŸ¿æ‡‰å¼ç‚ºä¸»ï¼‰
       ========================= */
    body {
      font-family: "Arial", sans-serif;
      background: #ffffff; /* æ”¹ç‚ºèˆ‡çœ‹è¨ºè³‡è¨Šä¸€è‡´çš„ç™½è‰²èƒŒæ™¯ */
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ä¿æŒ readonly æ¬„ä½ç™½åº• */
    input[readonly], textarea[readonly], input[readonly]:not([type="checkbox"]) {
      background-color: white;
      cursor: default;
    }

    .input-container { margin-top: 15px; }
    .search-container { margin-bottom: 30px; }

    h1 { margin-top: 5px; margin-bottom: 5px; }

    /* è®“è¡¨å–®ä»¥å¯¬åº¦é™åˆ¶ä¸¦ç½®ä¸­ï¼Œæ‰‹æ©Ÿæ™‚ç¸®æ”¾ */
    form {
      width: 100%;
      max-width: 820px; /* æœ€å¤§å¯¬åº¦ï¼Œè¼ƒå¤§è¢å¹•ä¸æœƒå¤ªå¯¬ */
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      border: 1px solid #aaa;
      margin: 12px auto 20px; /* æ”¹ç‚ºç½®ä¸­ (auto) */
      box-sizing: border-box;
    }

    /* è®“é é¢ä¸­çš„ç‰¹å®šæ¨™é¡Œé å·¦å°é½Šä¸¦èˆ‡è¡¨å–®/è¡¨æ ¼å¯¬åº¦ä¸€è‡´ */
    .title {
      margin: 5px 0;
      font-size: 26px;
      box-sizing: border-box;
    }

    /* å°è¦½åˆ— / volunteer area */
    .nav-1{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      position: sticky;
      top: 0;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      width: 100%;
      color: black;
      background-color: white;
      box-sizing: border-box;
      border-bottom: 1px solid #eee;
    }
    .volunteer-area { display:flex; align-items:center; gap:8px; }
    .volunteer-area .avatar {
      width:36px; height:36px; border-radius:50%; object-fit:cover;
      border:1px solid #ddd; display:inline-block;
    }
    .volunteer-area #volunteerName {
      cursor: default;
      padding: 4px 8px;
      border-radius: 6px;
      background: transparent;
      font-size: 18px;
    }

    /* form row */
    .form-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .form-row label {
      width: 140px;
      min-width: 100px;
      text-align: left;
      font-weight: 600;
    }
    .form-row input {
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .primary-btn { width: 160px; padding: 8px 12px; }
    input { margin: 5px; padding: 6px; border-radius: 6px; border: 1px solid #ccc; }

    button {
      background-color: #4a90e2;
      color: white;
      margin: 0 10px 0 0;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background-color: #3a78c6; }
    button.advice-button { 
      padding: 6px 12px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
    }

    button:disabled { background-color: #ccc; }

    #advice-output { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
    #advice-text { min-height: 50px; background-color: #f9f9f9; padding: 10px; border-radius: 4px; }
    .error { color: red; }
    .loading { color: gray; }

    /* ==============================
       è¡¨æ ¼å®¹å™¨ï¼ˆcalendar é¢¨æ ¼ï¼‰
       ============================== */
    .allTable-div {
      width: 100%;
      max-width: 820px; /* èˆ‡ form ç›¸åŒå¯¬åº¦ï¼Œä¿æŒå·¦å³å°é½Š */
      margin: 5px auto; /* ç½®ä¸­ */
      -webkit-overflow-scrolling: touch;
      border: 1px solid #aaa;
      border-radius: 16px;
      background-color: white;
      display: block;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 0;
    }
    .allTable-div table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      min-width: 720px; /* æ¡Œæ©Ÿä¸Šè¡¨æ ¼æœ€å°å¯¬åº¦ï¼Œæ‰‹æ©Ÿæ™‚æœƒè§£é™¤æœ€å°å¯¬åº¦ */
      box-sizing: border-box;
      background: transparent;
      margin: 0;
      border: none;
    }
    .allTable-div th, .allTable-div td {
      padding: 12px 10px;
      text-align: center;
      border: 1px solid #ddd;
      white-space: nowrap;
      font-size: 14px;
      background: transparent;
    }
    .allTable-div th { background-color: #fafafa; position: sticky; top: 0; z-index: 2; }
    .allTable-div tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .allTable-div tbody tr:nth-child(odd)  { background-color: #ffffff; }

    .delete-btn {
      background-color: #e74c3c;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .delete-btn:hover { background-color: #c0392b; }

    /* åœ–è¡¨å®¹å™¨èª¿æ•´ç‚ºéŸ¿æ‡‰å¼ */
    .chart-container {
      width: 100%;
      max-width: 820px;
      margin: 8px auto 30px;
      box-sizing: border-box;
      padding: 0 12px;
    }
    canvas {
      margin-top: 12px;
      background: #f3f0f0;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #aaa;
      width: 100% !important;
      height: auto !important;
      display: block;
    }

    .div-b {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      box-sizing: border-box;
      padding: 0 16px;
    }

    /* ç„¡è³‡æ–™æç¤º */
    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
      display: none; /* ç”± JS æ§åˆ¶é¡¯ç¤º */
    }

    /* ==============================
       éŸ¿æ‡‰å¼æ–·é»ï¼ˆä¾æ“šè¦–çª—å¯¬åº¦èª¿æ•´ï¼‰
       ============================== */
    @media (max-width: 1024px) {
      .form-row label { width: 120px; }
      .volunteer-area #volunteerName { font-size: 16px; }
    }

    /* èª¿æ•´ï¼šèˆ‡çœ‹è¨ºè³‡è¨Šä¸€è‡´çš„éŸ¿æ‡‰å¼è¦å‰‡ */
    @media (max-width: 768px) {
      form { width: 95%; padding: 16px; }
      .form-row { gap: 8px; }
      .form-row label { width: 110px; font-size: 20px; }
      .primary-btn { width: 140px; }
      /* ä¿ç•™è¡¨æ ¼æœ€å°å¯¬åº¦ï¼Œè®“æ‰‹æ©Ÿä¸Šå¯å·¦å³æ»‘å‹•ï¼ˆä¸è¦æŠŠ min-width è¨­ç‚º 0ï¼‰ */
      .allTable-div {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .allTable-div table { 
        min-width: 720px; /* ä¿æŒè¼ƒå¯¬ï¼Œè§¸ç™¼å®¹å™¨æ°´å¹³æ²å‹• */
        width: auto;
      }
      .allTable-div th, .allTable-div td { padding: 10px; font-size: 16px; white-space: nowrap; }
      .volunteer-area .avatar { width:30px; height:30px; }
      .volunteer-area #volunteerName { font-size: 14px; }
      /* åœ–è¡¨é«˜åº¦é™åˆ¶ï¼Œé¿å…éé«˜ */
      canvas { height: 220px !important; max-height: 320px; }
      input, button { font-size: 16px; padding: 10px; }
    }

    @media (max-width: 420px) {
      .form-row label { width: 100%; }
      .form-row { flex-direction: column; align-items: stretch; }
      .primary-btn { width: 100%; }
      .volunteer-area .avatar { display: none; } /* æ¥µå°è¢å¹•éš±è—é ­åƒ */
      .volunteer-area #volunteerName { font-size: 13px; }
      /* æ‰‹æ©Ÿç‰ˆï¼šå¢åŠ  canvas å…§é‚Šè·èˆ‡è¼ƒé«˜é«˜åº¦ï¼Œè®“åœ–ä¾‹/åº§æ¨™ä¸è¢«æ“ å£“ */
      .chart-container { padding: 8px 14px; }
      canvas {
        height: 240px !important;
        max-height: 360px;
        padding: 16px !important;
        margin-top: 18px;
      }
      /* åŒæ¨£ä¿ç•™æœ€å°å¯¬åº¦ä»¥å•Ÿç”¨å·¦å³æ»¾å‹• */
      .allTable-div {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .allTable-div table { min-width: 720px; width: auto; }
      .allTable-div th, .allTable-div td { font-size: 13px; padding: 8px; white-space: nowrap; }
      input[type="number"], input[type="date"] { font-size: 15px; padding: 8px; }
    }

   /* æ—¥æœŸç¯„åœé¸æ“‡å™¨ä¸»è¦å€å¡Š */
.range-picker-wrap {
  display: grid;
  grid-template-columns: 1fr; /* æ¨™é¡Œåœ¨ä¸Šã€æ¬„ä½åœ¨ä¸‹ */
  align-items: center;
  gap: 12px;
  width: 100%;
  box-sizing: border-box;
}

/* åŒ…å« input + å¿«æ·æŒ‰éˆ•åˆ— */
.range-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  width: 100%;
}

/* å¿«æ·æŒ‰éˆ•åˆ— */
.range-picker-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
  margin-left: 0;
}

/* æ—¥æœŸè¼¸å…¥æ¡† */
.range-controls input#viewRange {
  flex: 1 1 auto;
  min-width: 220px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #fff;
  box-sizing: border-box;
}

/* é˜²æ­¢ input å¤ªå¯¬æŠŠé é¢æ’çˆ† */
.range-controls input#viewRange {
  flex: 0 0 280px;
  min-width: 160px;
  max-width: 100%;
}

/* æ‰‹æ©Ÿ/å°è¢å¹•ï¼šæ¬„ä½å‚ç›´æ’åˆ—ã€é¿å…è·‘ç‰ˆ */
@media (max-width: 600px) {
  .range-picker-wrap {
    grid-template-columns: 1fr;
    align-items: stretch;
  }

  .range-picker-wrap label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .range-controls {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .range-picker-actions {
    justify-content: flex-start;
  }

  .range-controls input#viewRange {
    width: 100%;
    min-width: 0;
  }
}

/* å¿«æ·æŒ‰éˆ•æ¨£å¼ */
.range-quick-btn {
  background: #f6f8fa;
  border: 1px solid #dfe4e8;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  color: #222;
  transition: background .12s, color .12s, box-shadow .12s;
}

/* JS åŠ ä¸Š active æ™‚çš„æ¨£å¼ */
.range-quick-btn.active {
  background: #4a90e2;
  color: #fff;
  border-color: #3a78c6;
  box-shadow: 0 2px 6px rgba(74,144,226,0.18);
}

.range-quick-btn:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(74,144,226,0.12);
}


/* ============================================================
   ğŸ“± Flatpickr æ‰‹æ©Ÿç‰ˆè·‘ç‰ˆä¿®æ­£ï¼ˆæœ€é—œéµï¼‰
   ============================================================ */
@media (max-width: 420px) {
  .flatpickr-calendar {
    transform: none !important;
    transform-origin: top left !important;

    width: calc(100% - 32px) !important;  /* æ»¿ç‰ˆ but ä¿ç•™å·¦å³é‚Šè· */
    max-width: none !important;

    left: 16px !important;
    right: 16px !important;

    box-sizing: border-box !important;
    border-radius: 10px !important;
    font-size: 14px !important;
    z-index: 9999 !important;
  }

  .flatpickr-calendar.open {
    left: 16px !important;
    right: 16px !important;
  }

  .flatpickr-innerContainer {
    padding: 8px !important;
  }

  .flatpickr-months,
  .flatpickr-month,
  .flatpickr-weekdays {
    padding: 6px 8px !important;
  }

  .flatpickr-days {
    padding: 6px !important;
    max-height: 320px;
    overflow-y: auto;
  }

  .flatpickr-day,
  .flatpickr-weekday {
    padding: 6px 8px !important;
    height: 36px !important;
    line-height: 36px !important;
    min-width: auto !important;
  }
}
  /* èª¿æ•´å¤–è§€æ›´åƒä½ æˆªåœ–çš„ç‰ˆæœ¬ */
    .flatpickr-input {
        width: 260px;
        padding: 8px 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* åŠ ä¸Š calendar icon */
    .date-range-wrapper {
        position: relative;
        display: inline-block;
    }

    .date-range-wrapper::before {
        content: "ğŸ“…";
        position: absolute;
        left: 8px;
        top: 8px;
        font-size: 18px;
        pointer-events: none;
    }

    /* è®“æ–‡å­—ä¸è¦è¢« icon å£“ä½ */
    .date-range-input {
        padding-left: 32px;
    }

  </style>
  <!-- flatpickr æ—¥æœŸç¯„åœé¸æ“‡å™¨ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- flatpickr ç¹é«”ä¸­æ–‡èªç³» -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
  
</head>
<body>
  <!-- å°è¦½åˆ— -->
  <nav class="nav-1" >
    <div>
      <h1 style="margin:0; font-size: 28px;">è¡€å£“ç´€éŒ„</h1>
    </div>

    <div style="display:flex; align-items:center;">
      <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥" style="cursor:pointer; font-size: 26px;">è¼‰å…¥ä¸­</span>
      </span>
      </h1>
    </div>
  </nav>

  <div class="div-b">
    <h1 class="title">è¼¸å…¥å…§å®¹</h1>
    <form id="bpForm">
      <div class="form-row">
        <label for="date">æ—¥æœŸï¼š</label>
        <input type="date" id="date" required>
      </div>
      <div class="form-row">
        <label for="time">æ™‚é–“ï¼š</label>
        <input type="time" id="time" required>
      </div>
      <div class="form-row">
        <label for="systolic">æ”¶ç¸®å£“ï¼ˆé«˜å£“ï¼‰ï¼š</label>
        <input type="number" id="systolic" placeholder="ä¾‹å¦‚ 120" required>
      </div>
      <div class="form-row">
        <label for="diastolic">èˆ’å¼µå£“ï¼ˆä½å£“ï¼‰ï¼š</label>
        <input type="number" id="diastolic" placeholder="ä¾‹å¦‚ 80" required>
      </div>
      <div style="display:flex;justify-content:flex-start;">
        <button id="submit" type="submit" class="primary-btn">æ–°å¢ç´€éŒ„</button>
        <button id="advice-button">ç”¢ç”Ÿ AI å»ºè­°</button>
      </div>
      <p style="font-size: 12px; color: #555;">
        <strong>å…è²¬è²æ˜ï¼š</strong>æœ¬ç«™æä¾›çš„ AI å»ºè­°åƒ…ä¾›åƒè€ƒï¼Œä¸èƒ½å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚æ‰€æœ‰å¥åº·æ±ºç­–ï¼Œè«‹å‹™å¿…è«®è©¢æ‚¨çš„é†«ç”Ÿæˆ–å°ˆæ¥­é†«ç™‚äººå“¡ã€‚
    </p>
    </form>

    

    <!-- é¡¯ç¤ºæ§åˆ¶ï¼šæ—¥æœŸç¯„åœï¼ˆåˆä½µé–‹å§‹/çµæŸï¼‰èˆ‡å¿«æ·é¸é … -->
    <div id="viewControls" style="max-width:820px;margin:8px auto 4px;padding:0 ; display:none;">
      <div class="range-picker-wrap">
        <h2 class="title" style="font-size:20px; margin:6px 0;">æ—¥æœŸç¯„åœï¼š</h2>

        <div class="range-controls" style="flex-direction:column; align-items:stretch; gap:8px;">
          <div class="date-range-wrapper" style="width:100%;">
            <input id="dateRange" class="date-range-input" placeholder="é–‹å§‹æ—¥æœŸ - çµæŸæ—¥æœŸ" style="width:100%;"/>
          </div>

          <!-- å¿«æ·é¸æ“‡ç§»åˆ°ä¸‹æ–¹ï¼Œè¡Œç‚ºèˆ‡å¤–è§€åœ¨çª„è¢å¹•æ™‚æœƒè‡ªå‹•æ›è¡Œ -->
          <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
            <label for="rangeSelect" style="font-weight:600; margin:0;">å¿«é€Ÿé¸æ“‡ç¯„åœï¼š</label>
            <!-- æ”¹ç‚ºå·¦å³æŒ‰éˆ• + é¡¯ç¤ºæ¨™ç±¤ -->
            <button id="rangePrev" class="range-quick-btn" type="button" aria-label="ä¸Šä¸€å€‹ç¯„åœ" style="padding:6px 10px;">â€¹</button>
            <span id="rangeLabel" style="min-width:160px; display:inline-block; text-align:center; padding:8px; border:1px solid #ccc; border-radius:6px; background:#fff;">æœ€è¿‘ 7 å¤©</span>
            <button id="rangeNext" class="range-quick-btn" type="button" aria-label="ä¸‹ä¸€å€‹ç¯„åœ" style="padding:6px 10px;">â€º</button>
          </div>
        </div>

        <!-- æ–°å¢ï¼šç„¡è³‡æ–™æ™‚é¡¯ç¤ºçš„è¨Šæ¯ï¼ˆé è¨­éš±è—ï¼‰ -->
        <div id="no-record-msg" class="no-record" style="display:none;">ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>
      </div>
    </div>
    <!-- ä¸‹é¢é€™æ®µåŠ ä¸Š id ä¸¦é è¨­éš±è— -->
    <div id="viewNote" style="max-width:820px;margin:0 auto;padding:0 0 8px;color:#666;font-size:13px; display:none;">
      é è¨­é¡¯ç¤ºæœ€è¿‘ 7 å¤©ï¼ˆåŒ…å«çµæŸæ—¥ï¼‰ï¼Œå¯è‡ªè¡Œèª¿æ•´çµæŸæ—¥èˆ‡å¤©æ•¸ã€‚
    </div>

    <div class="allTable-div">
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ/æ™‚é–“</th>
            <th>æ”¶ç¸®å£“</th>
            <th>ç‹€æ…‹</th>
            <th>èˆ’å¼µå£“</th>
            <th>ç‹€æ…‹</th>
            <th>åˆªé™¤</th>
          </tr>
        </thead>
        <tbody id="recordTable"></tbody>
      </table>
    </div>
  </div>
   <!-- AI å»ºè­°å€å¡Šï¼šæ˜ç¢ºæ”¾åœ¨ range-picker-wrap å…§ï¼Œä½æ–¼æŒ‰éˆ•ä¸‹æ–¹ -->
        <div id="advice-output" style="max-width:820px;margin:8px auto;padding:0 16px 12px;">
          <h2 class="title" style="font-size:20px; margin:6px 0;">AI å»ºè­°ï¼š</h2>
          <p id="advice-text"></p>
        </div>
  <div class="chart-container">
    <canvas id="bpChart" width="380" height="250"></canvas>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // LIFF åˆå§‹åŒ–èˆ‡ä½¿ç”¨è€…è³‡è¨Š
    let liffProfile = null;
    const form = document.getElementById("bpForm");
    const table = document.getElementById("recordTable");
    const ctx = document.getElementById("bpChart").getContext("2d");
    const chartContainer = document.querySelector('.chart-container');
    const tableContainer = document.querySelector('.allTable-div');
    const noRecordMsg = document.getElementById('no-record-msg');
    let userId = null;

    // åˆå§‹éš±è—è¡¨æ ¼èˆ‡åœ–è¡¨ï¼ˆç”± renderTable/ renderChart æ§åˆ¶ï¼‰
    if (chartContainer) chartContainer.style.display = 'none';
    if (tableContainer) tableContainer.style.display = 'none';
    if (noRecordMsg) noRecordMsg.style.display = 'none';

    // è¼‰å…¥ç´€éŒ„
    let records = []; // å…¨éƒ¨ç´€éŒ„ä¾†æº
    let viewEndDateStr = null; // yyyy-mm-dd æˆ– null(è¡¨ç¤ºä»Šå¤©)
    // é è¨­æ”¹ç‚º null => é¡¯ç¤ºæ‰€æœ‰è³‡æ–™ï¼ˆä¸ä»¥å›ºå®šå¤©æ•¸éæ¿¾ï¼‰
    let viewDays = null;
    let chart;
    // å…¨åŸŸ flatpickr å¯¦ä¾‹ï¼Œè®“ applyQuick èˆ‡å…¶ä»–å‡½å¼éƒ½èƒ½å­˜å–ä¸¦æ›´æ–°æ—¥æ›†é¡¯ç¤º
    let fp = null;
    // ä½¿ç”¨è€…æ˜¯å¦ä¸»å‹•é¸å–ç¯„åœï¼ˆé»äº†å¿«æ·éµæˆ–åœ¨ flatpickr ä¸Šé¸å–ï¼‰â€” è‹¥ç‚º trueï¼Œä¿æŒç¯„åœæ§åˆ¶æ¬„ä½é¡¯ç¤º
    let userSelectedRange = false;



    
     //supabase
    document.getElementById("submit").addEventListener("click", saveEdit);
    async function saveEdit() {
      if (!currentEditEventId) {
        alert("ç„¡æ•ˆç·¨è¼¯äº‹ä»¶");
        return;
      }
      
      const eventId = currentEditEventId;
      const idx = records.findIndex(r => r.eventId === eventId);
      if (idx === -1) return alert("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");

        const date = document.getElementById("editDate").value;
        const time = document.getElementById("editTime").value;
        const systolic = Number(document.getElementById("systolic").value);
        const diastolic = Number(document.getElementById("diastolic").value);

        // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆä½¿ç”¨è¡€å£“æ¬„ä½è€Œéæœªå®šç¾©çš„ schedule_noteï¼‰
        if (!date || !time || isNaN(systolic) || isNaN(diastolic)) {
          alert("è«‹è¼¸å…¥å®Œæ•´ä¸”æœ‰æ•ˆçš„è³‡æ–™ï¼");
          return;
        }

        const schedule_time = `${date} ${time}:00`;

        const url = `https://supabase-api-six.vercel.app/bloodPressre/${userId}/${eventId}`;
        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ schedule_time, systolic, diastolic })
          });
          if (!response.ok) throw new Error('æ›´æ–°å¤±æ•—');
          alert("æ›´æ–°æˆåŠŸï¼");
          closeEditModal();
          loadRecords(); // é‡æ–°è¼‰å…¥è³‡æ–™
        } catch (error) {
          console.error('Error updating schedule:', error);
          alert("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        }
    }
    // Supabase config - replace with your values
    const COST_SUPABASE_URL = 'https://rygawaqskvijgaciinzc.supabase.co';
    let sb = null;
    try {
      if (!COST_SUPABASE_URL.includes('your-project')) {
        sb = supabase.createClient(COST_SUPABASE_URL, SUPABASE_ANON_KEY);
        console.debug('Supabase client ready');
      } else {
        console.debug('Supabase not configured; using localStorage only');
      }
    } catch (e) { console.warn('supabase init failed', e); sb = null; }

    // å„ªå…ˆå¾ Supabase è®€å–ï¼Œå¤±æ•—å‰‡ fallback åˆ° localStorage
    (async function loadRecords() {
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').select('*').order('recorded_time', { ascending: true });
          if (!error && data) {
            records = data.map(r => ({
              uuid: r.uuid,
              elder_user_id: r.elder_user_id,
              elder_name: r.elder_name,
              systolic: r.systolic,
              diastolic: r.diastolic,
              recorded_time: r.recorded_time,
              status: getStatus(r.systolic, r.diastolic),
              created_at: r.created_at
            }));
            initViewControlsAndRender();
            return;
          }
        } catch (e) { console.warn('fetch from supabase failed', e); }
      }
      // fallback: localStorage
      const local = JSON.parse(localStorage.getItem('bloodPressureRecords')) || [];
      records = local.map(r => ({
        uuid: r.uuid || null,
        systolic: r.systolic,
        diastolic: r.diastolic,
        recorded_time: r.date || r.recorded_time || '',
        status: r.status || getStatus(r.systolic, r.diastolic)
      }));
      initViewControlsAndRender();
    })();

    // åˆå§‹åŒ–æ—¥æœŸç¯„åœæ§åˆ¶ï¼ˆä½¿ç”¨ flatpickr rangeï¼‰ä¸¦ render
    function initViewControlsAndRender() {
      const viewControlsEl = document.getElementById('viewControls');
      const viewNoteEl = document.getElementById('viewNote');
      // ä¿®æ­£ id ç‚ºå¯¦éš› input idï¼šdateRange
      const viewRangeEl = document.getElementById('dateRange');
      const quickBtns = document.querySelectorAll('.range-quick-btn');

      // è¨ˆç®—é è¨­çµæŸæ—¥ï¼ˆä»Šå¤©ï¼‰èˆ‡é–‹å§‹æ—¥ï¼ˆæœ€è¿‘ viewDaysï¼‰
      const today = new Date();
      const endStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      viewEndDateStr = endStr;

      // flatpickr åˆå§‹åŒ–ï¼ˆrange æ¨¡å¼ï¼‰ â€” ä½¿ç”¨å…¨åŸŸ fp è®Šæ•¸
      const rangeSelect = document.getElementById('rangeSelect');
      if (viewRangeEl && typeof flatpickr === 'function') {
        // å¦‚æœ viewDays æ˜¯æ•¸å­—ï¼Œä½¿ç”¨æœ€è¿‘ viewDays ç‚ºé è¨­ï¼›è‹¥ viewDays ç‚º null => å˜—è©¦ä½¿ç”¨è³‡æ–™çš„æœ€å°/æœ€å¤§æ—¥æœŸä½œç‚ºé è¨­ç¯„åœï¼ˆé¡¯ç¤ºã€Œæ‰€æœ‰ã€ï¼‰
        let defaultDateArray = null;
        if (typeof viewDays === 'number' && viewDays > 0) {
          const start = new Date();
          start.setDate(today.getDate() - (viewDays - 1));
          const startStr = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;
          defaultDateArray = [startStr, endStr];
        } else { // viewDays === null => è¨­å®šç‚º records çš„ min/maxï¼ˆè‹¥æœ‰è³‡æ–™ï¼‰
          if (records && records.length) {
            const times = records.filter(r => r.recorded_time).map(r => new Date(r.recorded_time));
            if (times.length) {
              const minD = new Date(Math.min.apply(null, times));
              const maxD = new Date(Math.max.apply(null, times));
              const sStr = `${minD.getFullYear()}-${String(minD.getMonth()+1).padStart(2,'0')}-${String(minD.getDate()).padStart(2,'0')}`;
              const eStr = `${maxD.getFullYear()}-${String(maxD.getMonth()+1).padStart(2,'0')}-${String(maxD.getDate()).padStart(2,'0')}`;
              defaultDateArray = [sStr, eStr];
              // update viewEndDateStr to max date so other parts reflect the full range
              viewEndDateStr = eStr;
            }
          }
        }
        const fpOptions = {
          locale: "zh_tw",
           mode: "range",
           dateFormat: "Y/m/d",
           onChange: function(selectedDates, dateStr, instance) {
             // å¦‚æœä½¿ç”¨è€…æ¸…é™¤é¸å–ï¼Œå›å¾©ç‚ºæœªä¸»å‹•é¸å–ï¼Œä¸¦é¡¯ç¤ºé è¨­ï¼ˆå…¨éƒ¨æˆ–åŸå…ˆè¨­å®šï¼‰
            if (!selectedDates || selectedDates.length === 0) {
              userSelectedRange = false;
              viewDays = null;
              viewEndDateStr = null;
              renderTable();
              renderChart();
              return;
            }
            userSelectedRange = true;
             const s = selectedDates[0];
             const e = selectedDates[1] || selectedDates[0];
             const y1 = s.getFullYear(), m1 = String(s.getMonth()+1).padStart(2,'0'), d1 = String(s.getDate()).padStart(2,'0');
             const y2 = e.getFullYear(), m2 = String(e.getMonth()+1).padStart(2,'0'), d2 = String(e.getDate()).padStart(2,'0');
             const startIso = `${y1}-${m1}-${d1}`;
             const endIso = `${y2}-${m2}-${d2}`;
             viewEndDateStr = endIso;
             const diff = Math.round((e - s) / (1000 * 60 * 60 * 24)) + 1;
             viewDays = diff;
             if (document.getElementById('viewStartDate')) document.getElementById('viewStartDate').value = startIso;
             renderTable();
             renderChart();
             // ä½¿ç”¨è€…åœ¨ flatpickr é¸å–ç¯„åœæ™‚ï¼Œæ¸…é™¤ä¸‹æ‹‰å¿«é€Ÿé¸å–®çš„é¸å–ï¼ˆè¡¨ç¤ºè‡ªè¨‚ç¯„åœï¼‰
             if (rangeSelect) rangeSelect.value = "";
            }
          };
        if (defaultDateArray) fpOptions.defaultDate = defaultDateArray;
        // æŒ‡æ´¾åˆ°å…¨åŸŸ fpï¼Œè®“ applyQuick å¯å‘¼å« fp.setDate(...) ä¸¦è§¸ç™¼ onChange
        fp = flatpickr(viewRangeEl, fpOptions);
      }

      // å¿«æ·/ä¸‹æ‹‰é¸å–®äº‹ä»¶è™•ç†ï¼ˆæœ€è¿‘7/30ã€æœ¬æœˆã€ä¸Šå€‹æœˆï¼‰
      function applyQuick(rangeKey) {
        const t = new Date();
        let s, e;
        if (rangeKey === '7' || rangeKey === '30') {
          const days = parseInt(rangeKey, 10);
          e = new Date();
          s = new Date();
          s.setDate(e.getDate() - (days - 1));
        } else if (rangeKey === 'thisMonth') {
          s = new Date(t.getFullYear(), t.getMonth(), 1);
          e = new Date(t.getFullYear(), t.getMonth() + 1, 0);
        } else if (rangeKey === 'lastMonth') {
          s = new Date(t.getFullYear(), t.getMonth() - 1, 1);
          e = new Date(t.getFullYear(), t.getMonth(), 0);
        } else {
          // default fallback: æœ€è¿‘ viewDays
          e = new Date();
          s = new Date();
          s.setDate(e.getDate() - (viewDays - 1));
        }
        // set flatpickr é¸å–
        if (fp) {
          fp.setDate([s, e], true, "Y-m-d");
          // æ›´æ–°æŒ‰éˆ•æ¨™ç±¤é¡¯ç¤ºç‚ºå°æ‡‰åç¨±
          const opt = quickOptions.find(o => o.key === rangeKey);
          if (opt) {
            currentQuickIndex = quickOptions.indexOf(opt);
            if (rangeLabel) rangeLabel.textContent = opt.label;
          }
         } else {
          // fallback: æ‰‹å‹•è¨­å®šå…¨åŸŸè®Šæ•¸
          const y1 = s.getFullYear(), m1 = String(s.getMonth()+1).padStart(2,'0'), d1 = String(s.getDate()).padStart(2,'0');
          const y2 = e.getFullYear(), m2 = String(e.getMonth()+1).padStart(2,'0'), d2 = String(e.getDate()).padStart(2,'0');
          viewEndDateStr = `${y2}-${m2}-${d2}`;
          viewDays = Math.round((e - s) / (1000 * 60 * 60 * 24)) + 1;
          renderTable(); renderChart();
        }
      }

      // æ”¹ç‚ºå·¦å³æŒ‰éˆ•åˆ‡æ›ï¼ˆrangePrev / rangeNext / rangeLabelï¼‰
      const rangePrev = document.getElementById('rangePrev');
      const rangeNext = document.getElementById('rangeNext');
      const rangeLabel = document.getElementById('rangeLabel');
      const quickOptions = [
        { key: '7', label: 'æœ€è¿‘ 7 å¤©' },
        { key: '30', label: 'æœ€è¿‘ 30 å¤©' },
        { key: 'thisMonth', label: 'æœ¬æœˆ' },
        { key: 'lastMonth', label: 'ä¸Šå€‹æœˆ' }
      ];
      let currentQuickIndex = 0;

      function updateRangeLabel() {
        if (rangeLabel) rangeLabel.textContent = quickOptions[currentQuickIndex].label;
      }

      if (rangePrev) rangePrev.addEventListener('click', () => {
        currentQuickIndex = (currentQuickIndex - 1 + quickOptions.length) % quickOptions.length;
        userSelectedRange = true;
        applyQuick(quickOptions[currentQuickIndex].key);
        updateRangeLabel();
      });
      if (rangeNext) rangeNext.addEventListener('click', () => {
        currentQuickIndex = (currentQuickIndex + 1) % quickOptions.length;
        userSelectedRange = true;
        applyQuick(quickOptions[currentQuickIndex].key);
        updateRangeLabel();
      });

      // è‹¥ viewDays ç‚ºæ•¸å­—ï¼Œå˜—è©¦é¸æ“‡å°æ‡‰çš„ quick optionï¼ˆè‡ªå‹•å¥—ç”¨ï¼‰
      if (typeof viewDays === 'number') {
        const mapping = { '7': 7, '30': 30 };
        // match by days æˆ– thisMonth/lastMonth åˆ¤æ–·
        const idx = quickOptions.findIndex(o => (o.key === String(viewDays)) || (o.key === 'thisMonth' && viewDays === 'thisMonth'));
        if (idx >= 0) {
          currentQuickIndex = idx;
          updateRangeLabel();
          applyQuick(quickOptions[currentQuickIndex].key);
        }
      }

      // ç•¶ä½¿ç”¨è€…åœ¨ flatpickr ä¸Šè‡ªè¨‚ç¯„åœæ™‚ï¼Œé¡¯ç¤ºã€Œè‡ªè¨‚ç¯„åœã€
      if (typeof flatpickr === 'function' && fp) {
        // å·²åœ¨ fpOptions.onChange è£¡é¢è™•ç†ï¼Œä½†è‹¥éœ€è¦é¡å¤–é¡¯ç¤ºæ¨™ç±¤ä¹Ÿå¯åœ¨æ­¤ç›£è½
        // åœ¨ onChange è£¡é¢æ¸…é™¤å¿«é€Ÿé¸æ“‡çš„é¡¯ç¤ºï¼š
        const originalOnChange = fp.config.onChange;
        // already handled in fpOptions.onChange above: set rangeLabel to 'è‡ªè¨‚ç¯„åœ'
      }

      // è¨ˆç®—åˆæ¬¡é¡¯ç¤ºæ˜¯å¦æœ‰è³‡æ–™ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºæ§åˆ¶å€å¡Š
      const viewRecords = getViewRecords(viewDays, viewEndDateStr);
      const hasViewRecords = Array.isArray(viewRecords) && viewRecords.length > 0;
      // è‹¥ä½¿ç”¨è€…ä¸»å‹•é¸å–ç¯„åœï¼ˆuserSelectedRangeï¼‰ï¼Œä»ä¿ç•™æ§åˆ¶æ¬„ä½å¯è¦‹
      if (viewControlsEl) viewControlsEl.style.display = (hasViewRecords || userSelectedRange) ? 'flex' : 'none';
      if (viewNoteEl) viewNoteEl.style.display = hasViewRecords ? '' : 'none';
      if (!hasViewRecords) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }
      renderTable();
      renderChart();
    }

    // è¨ˆç®—é–‹å§‹æ—¥å­—ä¸² (yyyy-mm-dd) : çµ¦å®šé¡¯ç¤ºå¤©æ•¸èˆ‡çµæŸæ—¥(yyyy-mm-dd æˆ– null)
    function computeStartDateString(days, endDateStrLocal) {
      const end = endDateStrLocal ? new Date(endDateStrLocal + 'T23:59:59.999') : new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (days - 1));
      const y = start.getFullYear();
      const m = String(start.getMonth() + 1).padStart(2, '0');
      const d = String(start.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // å–å¾—è¦é¡¯ç¤ºçš„ view è³‡æ–™ï¼ˆå«åŸå§‹ç´¢å¼• _allIndexï¼‰
    function getViewRecords(days = 7, endDateStrLocal = viewEndDateStr) {
      // è‹¥ days ç‚º null => é¡¯ç¤ºæ‰€æœ‰è³‡æ–™ï¼ˆä¸éæ¿¾ï¼‰
      if (days === null || typeof days === 'undefined') {
        return records
          .map((r, idx) => ({ ...r, _allIndex: idx }))
          .filter(r => r.recorded_time) // åªé¡¯ç¤ºæœ‰æ™‚é–“çš„ç´€éŒ„
          .sort((a, b) => new Date(a.recorded_time) - new Date(b.recorded_time));
      }
      const end = endDateStrLocal ? new Date(endDateStrLocal + 'T23:59:59.999') : new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (days - 1));
      return records
        .map((r, idx) => ({ ...r, _allIndex: idx }))
        .filter(r => {
          if (!r.recorded_time) return false;
          const d = new Date(r.recorded_time);
          return d >= start && d <= end;
        })
        .sort((a, b) => new Date(a.recorded_time) - new Date(b.recorded_time));
    }

    // æ–°å¢ç´€éŒ„
    form.onsubmit = async (e) => {
      e.preventDefault();
      const dateVal = document.getElementById("date").value;
      const timeVal = document.getElementById("time") ? document.getElementById("time").value : '';
      const systolic = parseInt(document.getElementById("systolic").value);
      const diastolic = parseInt(document.getElementById("diastolic").value);
 
      const status = getStatus(systolic, diastolic);
      // è‹¥æœ‰æ™‚é–“æ¬„ä½å‰‡åˆä½µç‚º yyyy-mm-ddThh:mm ä»¥ä¿ç•™ä½¿ç”¨è€…è¼¸å…¥æ™‚é–“
      let recorded_time;
      if (dateVal) {
        if (timeVal) {
          recorded_time = new Date(`${dateVal}T${timeVal}`).toISOString();
        } else {
          recorded_time = new Date(dateVal).toISOString();
        }
      } else {
        recorded_time = new Date().toISOString();
      }

      // ä½¿ç”¨ LIFF æä¾›çš„ userIdï¼ˆè‹¥æœªç™»å…¥å‰‡ fallback ç‚º 'local-user'ï¼‰
      const volunteerNameEl = document.getElementById('volunteerName');
      const payload = {
        elder_user_id: userId || 'local-user',
        elder_name: volunteerNameEl ? volunteerNameEl.innerText : null,
        systolic: systolic,
        diastolic: diastolic,
        pulse: null,
        recorded_time: recorded_time,
        remarks: null
      };

      // Optimistically add åˆ°å…¨éƒ¨ recordsï¼Œä¸¦ persistï¼Œå† renderï¼ˆview æœƒè‡ªå‹•éæ¿¾ï¼‰
      const tempRecord = { uuid: null, systolic, diastolic, recorded_time, status };
      records.push(tempRecord);
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }
      renderTable();
      renderChart();

      // try to save to supabase async
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').insert([payload]).select();
          if (error) throw error;
          if (data && data[0]) {
            const saved = data[0];
            records[records.length - 1] = {
              uuid: saved.uuid,
              systolic: saved.systolic,
              diastolic: saved.diastolic,
              recorded_time: saved.recorded_time,
              status: getStatus(saved.systolic, saved.diastolic),
              created_at: saved.created_at
            };
            try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { /* ignore */ }
            renderTable(); renderChart();
          }
        } catch (err) {
          console.warn('save to supabase failed', err);
        }
      }

      form.reset();
      // é‡è¨­ç‚ºé è¨­æ—¥æœŸèˆ‡æ™‚é–“ï¼Œé¿å…ä½¿ç”¨è€…æ¯æ¬¡éƒ½è¦è¨­å®š
      setDefaultDateTime();
    };

    // è¡€å£“ç‹€æ…‹åˆ¤æ–·
    function getStatus(systolic, diastolic) {
      if (systolic < 90 || diastolic < 60) return "åä½";
      if (systolic > 140 || diastolic > 90) return "åé«˜";
      return "æ­£å¸¸";
    }

    // è¡¨æ ¼é¡¯ç¤ºï¼šåªé¡¯ç¤ºçµæŸæ—¥å¾€å‰ viewDays çš„è³‡æ–™
    function renderTable() {
      const viewControlsEl = document.getElementById('viewControls');
      const viewNoteEl = document.getElementById('viewNote');

      // å…ˆå–å¾—ç›®å‰ viewï¼ˆä¾ viewDays èˆ‡ viewEndDateStrï¼‰ï¼Œç”¨æ­¤åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºæ§åˆ¶å€
      const view = getViewRecords(viewDays, viewEndDateStr);
      const hasViewRecords = Array.isArray(view) && view.length > 0;
      // è‹¥ä½¿ç”¨è€…ä¸»å‹•é¸å–ç¯„åœï¼ˆuserSelectedRangeï¼‰ï¼Œä»ä¿ç•™æ§åˆ¶æ¬„ä½å¯è¦‹
      if (viewControlsEl) viewControlsEl.style.display = (hasViewRecords || userSelectedRange) ? 'flex' : 'none';
      if (viewNoteEl) viewNoteEl.style.display = hasViewRecords ? '' : 'none';

      // è‹¥ view æ²¡è³‡æ–™ï¼Œéš±è—è¡¨æ ¼èˆ‡åœ–è¡¨ä¸¦é¡¯ç¤ºç„¡è³‡æ–™è¨Šæ¯
      table.innerHTML = "";
      if (!hasViewRecords) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }
      // æœ‰è³‡æ–™æ™‚éš±è—ã€Œç„¡è³‡æ–™ã€è¨Šæ¯ä¸¦é¡¯ç¤ºè¡¨æ ¼/åœ–è¡¨ï¼ˆviewNote å·²åœ¨ä¸Šæ–¹è™•ç†ï¼‰
      if (noRecordMsg) noRecordMsg.style.display = 'none';
      if (tableContainer) tableContainer.style.display = '';
      if (chartContainer) chartContainer.style.display = '';

      view.forEach((r) => {
        let dateTimeStr = '';
        if (r.recorded_time) {
          const d = new Date(r.recorded_time);
          // æ—¥æœŸèˆ‡æ™‚é–“åŒæ¨£æ ¼å¼é¡¯ç¤ºï¼ˆåŒå­—ç´šï¼ŒåŒæ¨£æ¨£å¼ï¼‰
          const datePart = d.toLocaleDateString();
          const timePart = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          dateTimeStr = `${datePart} ${timePart}`;
        }
        const row = `
          <tr data-idx="${r._allIndex}">
            <td>${dateTimeStr}</td>
            <td>${r.systolic}</td>
            <td>${r.status}</td>
            <td>${r.diastolic}</td>
            <td>${r.status}</td>
            <td><button class="delete-btn" onclick="deleteRecord(${r._allIndex})">åˆªé™¤</button></td>
          </tr>`;
        table.innerHTML += row;
      });
    }

    // åˆªé™¤ç´€éŒ„
    async function deleteRecord(index) {
      const rec = records[index];
      if (sb && rec && rec.uuid) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').delete().eq('uuid', rec.uuid);
          if (error) throw error;
          console.debug('deleted from supabase', data);
        } catch (e) { console.warn('supabase delete failed', e); }
      }
      records.splice(index, 1);
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }
      renderTable();
      renderChart();
    }

    // ç¹ªè£½åœ–è¡¨ï¼ˆåªç”¨ view è³‡æ–™ï¼‰
    function renderChart() {
      const view = getViewRecords(viewDays, viewEndDateStr);
      if (!view || view.length === 0) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        return;
      }
      if (chartContainer) chartContainer.style.display = '';

      const labels = view.map(r => r.recorded_time ? new Date(r.recorded_time).toLocaleDateString() : '');
      const systolicData = view.map(r => Number(r.systolic) || 0);
      const diastolicData = view.map(r => Number(r.diastolic) || 0);

      if (chart) chart.destroy();

      const bandSystolicLower = labels.map(() => 90);
      const bandSystolicUpper = labels.map(() => 140);
      const bandDiastolicLower = labels.map(() => 60);
      const bandDiastolicUpper = labels.map(() => 90);

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æ”¶ç¸®å£“æ­£å¸¸ä¸‹é™',
              data: bandSystolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(144, 238, 144, 0.5)'
            },
            {
              label: 'æ”¶ç¸®å£“æ­£å¸¸ä¸Šé™',
              data: bandSystolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(144, 238, 144, 0.5)',
              fill: '-1'
            },
            {
              label: 'èˆ’å¼µå£“æ­£å¸¸ä¸‹é™',
              data: bandDiastolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255, 190, 159, 0.7)'
            },
            {
              label: 'èˆ’å¼µå£“æ­£å¸¸ä¸Šé™',
              data: bandDiastolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255, 190, 159, 0.7)',
              fill: '-1'
            },
            {
              label: "æ”¶ç¸®å£“ (é«˜å£“)",
              data: systolicData,
              borderColor: "rgb(255, 99, 132)",
              backgroundColor: 'rgba(255,99,132,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            },
            {
              label: "èˆ’å¼µå£“ (ä½å£“)",
              data: diastolicData,
              borderColor: "rgb(54, 162, 235)",
              backgroundColor: 'rgba(54,162,235,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, /* å…è¨± container æ§åˆ¶é«˜åº¦ */
          layout: {
            // èª¿æ•´åœ–è¡¨å››å‘¨å…§é‚Šè·ä»¥å¢åŠ é–“è·æ„Ÿ
            padding: { left: 14, right: 14, top: 12, bottom: 12 }
          },
          plugins: {
            legend: { position: "top", labels: { padding: 12 } },
            title: { display: true, text: "è¡€å£“è®ŠåŒ–åœ–", padding: { top: 6, bottom: 6 } }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: "mmHg" },
              ticks: { padding: 8 }, // y è»¸åˆ»åº¦èˆ‡è»¸ç·šå¢åŠ é–“è·
              grid: { drawOnChartArea: true, tickLength: 6 }
            },
            x: {
              title: { display: true, text: "æ—¥æœŸ" },
              ticks: {
                padding: 8,       // x è»¸åˆ»åº¦èˆ‡åœ–è¡¨ä¿æŒé–“è·
                maxRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              },
              grid: { drawOnChartArea: false } // è®“ x è»¸æ ¼ç·šä¸å¹²æ“¾è³‡æ–™å€åŸŸ
            }
          },
          interaction: { mode: 'index', intersect: false },
          elements: { point: { radius: 4 }, line: { tension: 0.2 } }
        }
      });

      // å°‡éŸ¿æ‡‰å¼é¸é …æŠ½æˆå…¨åŸŸå‡½å¼ï¼ˆrenderChart èˆ‡ resize å…±ç”¨ï¼‰
      function applyResponsiveChartOptions(ch) {
        if (!ch) return;
        const w = window.innerWidth;
        // æ‰‹æ©Ÿæ¥µå°ï¼šä¿ç•™åœ–ä¾‹ä½†èª¿æ•´ box èˆ‡ paddingï¼Œæå‡ canvas é«˜åº¦
        if (w <= 420) {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'start';
          ch.options.plugins.legend.labels.boxWidth = 12;
          ch.options.plugins.title.display = true;
          ch.options.plugins.title.padding = { top: 4, bottom: 4 };
          ch.options.elements.point.radius = 2;
          ch.options.layout.padding = { left: 12, right: 12, top: 10, bottom: 12 };
          ch.options.scales.x.ticks.maxRotation = 25;
          ctx.canvas.style.height = '240px';
        }
        // å¹³æ¿/ä¸­ç­‰ï¼šä¸­ç­‰é–“è·
        else if (w <= 768) {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'center';
          ch.options.plugins.legend.labels.boxWidth = 14;
          ch.options.plugins.title.display = true;
          ch.options.elements.point.radius = 3;
          ch.options.layout.padding = { left: 14, right: 14, top: 10, bottom: 12 };
          ch.options.scales.x.ticks.maxRotation = 35;
          ctx.canvas.style.height = '280px';
        }
        // æ¡Œæ©Ÿï¼šè¼ƒå¤§é–“è·
        else {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'center';
          ch.options.plugins.legend.labels.boxWidth = 16;
          ch.options.plugins.title.display = true;
          ch.options.elements.point.radius = 4;
          ch.options.layout.padding = { left: 18, right: 18, top: 14, bottom: 14 };
          ch.options.scales.x.ticks.maxRotation = 45;
          ctx.canvas.style.height = '320px';
        }
        try { ch.update(); } catch (e) { /* ignore */ }
      }

      // ç«‹å³æ‡‰ç”¨ä¸¦åœ¨ resize æ™‚æ›´æ–°ï¼ˆdebounce å·²åœ¨å¤–å±¤è™•ç†ï¼‰
      applyResponsiveChartOptions(chart);

      // expose for resize handler (attach to global so onResize can call it if needed)
      window.applyResponsiveChartOptions = applyResponsiveChartOptions;
    }
    /* ==============================
   âœ… LIFF åˆå§‹åŒ–
   ============================== */
    const LIFF_ID = "2008484068-DEJL7363";
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");

    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "æœªç™»å…¥";
          avatarEl.style.display = "none";
          userId = null;
          return;
        }

        const profile = await liff.getProfile();
        nameEl.innerText = profile.displayName || "å¿—å·¥";
        userId = profile.userId;
        userName = profile.displayName;
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    avatarEl.addEventListener("click", () => {
      if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
        // å·²ç™»å…¥å‰‡å‰å¾€è¨»å†Šé é¢
        window.location.href = "../../Login-or-register/index.html";
      } else if (typeof liff !== 'undefined' && liff.login) {
        // æœªç™»å…¥ï¼šè§¸ç™¼ LIFF ç™»å…¥
        liff.login({ redirectUri: window.location.href });
      } else {
        // fallback
        alert('ç„¡æ³•ä½¿ç”¨ LINE ç™»å…¥');
      }
    });

    nameEl.addEventListener("click", () => {
      if (typeof liff !== 'undefined' && liff.isLoggedIn && !liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
      }
    });

    initLiffAndSetProfile();

    /* -----------------------------
       è¦–çª—å¤§å°è®ŠåŒ–ï¼šé‡æ–°èª¿æ•´åœ–è¡¨èˆ‡ä»‹é¢
       ----------------------------- */
    function debounce(fn, delay = 120) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    const onResize = debounce(() => {
      // è‹¥æœ‰ chart å‰‡è«‹ Chart.js é‡æ–°èª¿æ•´
      if (chart) {
        try { 
          // é‡æ–°å¥—ç”¨éŸ¿æ‡‰å¼é¸é …ä¸¦èª¿æ•´å¤§å°
          if (typeof window.applyResponsiveChartOptions === 'function') {
            window.applyResponsiveChartOptions(chart);
          }
          chart.resize(); 
        } catch (e) { /* ignore */ }
      }
    }, 150);

    window.addEventListener('resize', onResize);
    // åˆå§‹ä¸€æ¬¡èª¿æ•´ï¼ˆç¢ºä¿è¼‰å…¥æ™‚æ­£ç¢ºï¼‰
    window.addEventListener('load', onResize);

    // æ–°å¢ï¼šå°‡æ—¥æœŸæ¬„ä½é è¨­ç‚ºä»Šå¤©ï¼ˆæ¸›å°‘ä½¿ç”¨è€…æ“ä½œï¼‰
    function setDefaultDateTime() {
      const dateEl = document.getElementById('date');
      const timeEl = document.getElementById('time');
      if (dateEl) {
        const t = new Date();
        const y = t.getFullYear();
        const m = String(t.getMonth() + 1).padStart(2, '0');
        const d = String(t.getDate()).padStart(2, '0');
        dateEl.value = `${y}-${m}-${d}`;
      }
      if (timeEl) {
        const t2 = new Date();
        const hh = String(t2.getHours()).padStart(2, '0');
        const mm = String(t2.getMinutes()).padStart(2, '0');
        timeEl.value = `${hh}:${mm}`;
      }
    }
    
    //--------------------------------------
    // 1. å®šç¾©æ‚¨çš„å¾Œç«¯ API ç¶²å€
    //--------------------------------------
        // ï¼ï¼é‡è¦ï¼ï¼é€™å¿…é ˆæŒ‡å‘æ‚¨åœ¨ç¬¬ 1 éƒ¨åˆ†é‹è¡Œçš„ Node.js ä¼ºæœå™¨
        const BACKEND_API_URL = "https://supabase-api-six.vercel.app/getAdvice";

        // 2. ç²å– DOM å…ƒç´ 
        const adviceButton = document.getElementById('advice-button');
        const adviceText = document.getElementById('advice-text');

        // 3. ç¶å®šé»æ“Šäº‹ä»¶
        adviceButton.addEventListener('click', getAIAdvice);

        async function getAIAdvice() {
            adviceText.innerHTML = "AI å»ºè­°ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...";
            adviceText.className = "loading";
            adviceButton.disabled = true; // é˜²æ­¢é‡è¤‡é»æ“Š

            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        elder_user_id: userId
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json(); // è§£æ JSON å›æ‡‰

                // 6. é¡¯ç¤º AI å»ºè­°
                adviceText.innerHTML = data.advice; // é¡¯ç¤ºå¾Œç«¯å‚³ä¾†çš„å»ºè­°
                adviceText.className = ""; // æ¸…é™¤æ¨£å¼

            } catch (error) {
                // 7. è™•ç†éŒ¯èª¤
                console.error('API å‘¼å«å¤±æ•—:', error);
                adviceText.innerHTML = `ç„¡æ³•å–å¾—å»ºè­°ï¼š${error.message}`;
                adviceText.className = "error";
            } finally {
                // 8. ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œéƒ½æ¢å¾©æŒ‰éˆ•
                adviceButton.disabled = false;
            }
        }
        // å·²åœ¨ initViewControlsAndRender å…§åˆå§‹åŒ– flatpickr (å­˜æ–¼å…¨åŸŸ fp)ï¼Œ
        // å› æ­¤ç§»é™¤é‡è¤‡çš„ flatpickr("#dateRange", ...) åˆå§‹åŒ–ã€‚
  </script>
</body>
</html>