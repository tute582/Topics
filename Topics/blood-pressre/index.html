<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡€å£“ç´€éŒ„</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* =========================
       å…¨åŸŸèˆ‡ç‰ˆé¢ï¼ˆèª¿æ•´ç‚ºéŸ¿æ‡‰å¼ç‚ºä¸»ï¼‰
       ========================= */
    body {
      font-family: "Arial", sans-serif;
      background: #ffffff; 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ä¿æŒ readonly æ¬„ä½ç™½åº• */
    input[readonly], textarea[readonly], input[readonly]:not([type="checkbox"]) {
      background-color: white;
      cursor: default;
    }

    .input-container { margin-top: 15px; }
    .search-container { margin-bottom: 30px; }

    h1 { margin-top: 5px; margin-bottom: 5px; }

    /* è®“è¡¨å–®ä»¥å¯¬åº¦é™åˆ¶ä¸¦ç½®ä¸­ï¼Œæ‰‹æ©Ÿæ™‚ç¸®æ”¾ */
    form {
      width: 100%;
      max-width: 820px; 
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      border: 1px solid #aaa;
      margin: 12px auto 20px; 
      box-sizing: border-box;
    }

    .title {
      margin: 5px 0;
      font-size: 26px;
      box-sizing: border-box;
    }

    /* å°è¦½åˆ— / volunteer area */
    .nav-1{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      position: sticky;
      top: 0;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      width: 100%;
      color: black;
      background-color: white;
      box-sizing: border-box;
      border-bottom: 1px solid #eee;
    }
    .volunteer-area { display:flex; align-items:center; gap:8px; }
    .volunteer-area .avatar {
      width:36px; height:36px; border-radius:50%; object-fit:cover;
      border:1px solid #ddd; display:inline-block;
    }
    .volunteer-area #volunteerName {
      cursor: default;
      padding: 4px 8px;
      border-radius: 6px;
      background: transparent;
      font-size: 18px;
    }

    /* form row */
    .form-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .form-row label {
      width: 140px;
      min-width: 100px;
      text-align: left;
      font-weight: 600;
    }
    
    /* é€šç”¨ Input æ¨£å¼ */
    .form-row input,
    .picker-display {
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      min-height: 38px; /* ç¢ºä¿é«˜åº¦ä¸€è‡´ */
      box-sizing: border-box;
    }

    /* --- [é—œéµæ–°å¢] æ—¥æœŸèˆ‡æ™‚é–“é¸æ“‡å™¨å°ˆç”¨æ¨£å¼ (Picker Hack) --- */
    .picker-wrapper {
        position: relative;
        flex: 1 1 auto; /* è®“å®ƒåœ¨ flex ä½ˆå±€ä¸­è‡ªå‹•ä¼¸å±• */
        display: flex;
    }

    /* æ›¿èº«ï¼šè² è²¬é¡¯ç¤º formatted text */
    .picker-display {
        display: flex;
        align-items: center;
        margin: 0; /* é‡ç½® margin */
        width: 100%;
        overflow: hidden;
        color: #888; /* é è¨­ç‚ºæ·ºç°ï¼Œç­‰åˆ°æœ‰å€¼æ‰è®Šæ·± */
    }

    /* çœŸèº«ï¼šé€æ˜ï¼Œè“‹åœ¨æœ€ä¸Šé¢ */
    .real-picker-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0; /* å®Œå…¨é€æ˜ */
        z-index: 10; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        cursor: pointer;
        -webkit-appearance: none;
    }

    /* æ–°å¢ï¼šæŒ‡å®šåªæœ‰æ—¥æœŸåˆ—åœ¨çª„è¢å¹•ä¹Ÿç¶­æŒæ©«å‘æ’åˆ— */
    .form-row.date-row {
      flex-wrap: nowrap;
      align-items: center;
    }
    .form-row.date-row label {
      width: auto;
      min-width: 80px;
      margin-right: 8px;
      text-align: left;
    }

    /* æ–°å¢ï¼šæ™‚é–“åˆ—ä¿æŒæ©«å‘æ’åˆ— */
    .form-row.time-row {
      flex-wrap: nowrap;
      align-items: center;
    }
    .form-row.time-row label {
      width: auto;
      min-width: 80px;
      margin-right: 8px;
      text-align: left;
    }

    .primary-btn { width: 160px; padding: 8px 12px; }

    button {
      background-color: #4a90e2;
      color: white;
      margin: 0 10px 0 0;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background-color: #3a78c6; }
    button.advice-button { 
      padding: 6px 12px; 
      background-color: #007bff; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
    }

    button:disabled { background-color: #ccc; }

    #advice-output { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
    #advice-text { min-height: 50px; background-color: #f9f9f9; padding: 10px; border-radius: 4px; }
    .error { color: red; }
    .loading { color: gray; }

    /* ==============================
       è¡¨æ ¼å®¹å™¨ï¼ˆcalendar é¢¨æ ¼ï¼‰
       ============================== */
    .allTable-div {
      width: 100%;
      max-width: 820px; 
      margin: 5px auto; 
      -webkit-overflow-scrolling: touch;
      border: 1px solid #aaa;
      border-radius: 16px;
      background-color: white;
      display: block;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 0;
    }
    .allTable-div table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      min-width: 720px; 
      box-sizing: border-box;
      background: transparent;
      margin: 0;
      border: none;
    }
    .allTable-div th, .allTable-div td {
      padding: 12px 10px;
      text-align: center;
      border: 1px solid #ddd;
      white-space: nowrap;
      font-size: 14px;
      background: transparent;
    }
    .allTable-div th { background-color: #fafafa; position: sticky; top: 0; z-index: 2; }
    .allTable-div tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .allTable-div tbody tr:nth-child(odd)  { background-color: #ffffff; }

    .delete-btn {
      background-color: #e74c3c;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .delete-btn:hover { background-color: #c0392b; }

    /* åœ–è¡¨å®¹å™¨èª¿æ•´ç‚ºéŸ¿æ‡‰å¼ */
    .chart-container {
      width: 100%;
      max-width: 820px;
      margin: 8px auto 30px;
      box-sizing: border-box;
      padding: 0 12px;
    }
    canvas {
      margin-top: 12px;
      background: #f3f0f0;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #aaa;
      width: 100% !important;
      height: auto !important;
      display: block;
    }

    .div-b {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      box-sizing: border-box;
      padding: 0 16px;
    }

    /* ç„¡è³‡æ–™æç¤º */
    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
      display: none; 
    }

    /* ==============================
       éŸ¿æ‡‰å¼æ–·é»
       ============================== */
    @media (max-width: 1024px) {
      .form-row label { width: 120px; }
      .volunteer-area #volunteerName { font-size: 16px; }
    }

    @media (max-width: 768px) {
      form { width: 95%; padding: 16px; }
      .form-row { gap: 8px; }
      .form-row label { width: 110px; font-size: 20px; }
      .primary-btn { width: 140px; }
      
      .allTable-div {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .allTable-div table { 
        min-width: 720px; 
        width: auto;
      }
      .allTable-div th, .allTable-div td { padding: 10px; font-size: 16px; white-space: nowrap; }
      .volunteer-area .avatar { width:30px; height:30px; }
      .volunteer-area #volunteerName { font-size: 14px; }
      
      canvas { height: 220px !important; max-height: 320px; }
      input, button, .picker-display { font-size: 16px; }
    }

    @media (max-width: 420px) {
      .form-row label { width: 100%; }
      .form-row { flex-direction: column; align-items: stretch; }
      
      .form-row.date-row { flex-direction: row !important; align-items: center !important; }
      .form-row.time-row { flex-direction: row !important; align-items: center !important; }
      .form-row.date-row label { width: auto !important; }
      .form-row.time-row label { width: auto !important; }
      .primary-btn { width: 100%; }
      .volunteer-area .avatar { display: none; } 
      .volunteer-area #volunteerName { font-size: 13px; }
      
      .chart-container { padding: 8px 14px; }
      canvas {
        height: 240px !important;
        max-height: 360px;
        padding: 16px !important;
        margin-top: 18px;
      }
      
      .allTable-div {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .allTable-div table { min-width: 720px; width: auto; }
      .allTable-div th, .allTable-div td { font-size: 13px; padding: 8px; white-space: nowrap; }
      input[type="number"] { font-size: 15px; padding: 8px; }
    }

   /* æ—¥æœŸç¯„åœé¸æ“‡å™¨ä¸»è¦å€å¡Š */
.range-picker-wrap {
  display: grid;
  grid-template-columns: 1fr; 
  align-items: center;
  gap: 12px;
  width: 100%;
  box-sizing: border-box;
}

.range-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  width: 100%;
}

.range-picker-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
  margin-left: 0;
}

.range-controls input#viewRange {
  flex: 1 1 auto;
  min-width: 220px;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #fff;
  box-sizing: border-box;
}

.range-controls input#viewRange {
  flex: 0 0 280px;
  min-width: 160px;
  max-width: 100%;
}

@media (max-width: 600px) {
  .range-picker-wrap {
    grid-template-columns: 1fr;
    align-items: stretch;
  }

  .range-picker-wrap label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
  }

  .range-controls {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .range-picker-actions {
    justify-content: flex-start;
  }

  .range-controls input#viewRange {
    width: 100%;
    min-width: 0;
  }
}

.range-quick-btn {
  background: #f6f8fa;
  border: 1px solid #dfe4e8;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  color: #222;
  transition: background .12s, color .12s, box-shadow .12s;
}

.range-quick-btn.active {
  background: #4a90e2;
  color: #fff;
  border-color: #3a78c6;
  box-shadow: 0 2px 6px rgba(74,144,226,0.18);
}

.range-quick-btn:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(74,144,226,0.12);
}

@media (max-width: 420px) {
  .flatpickr-calendar {
    transform: none !important;
    transform-origin: top left !important;

    width: calc(100% - 32px) !important;  
    max-width: none !important;

    left: 16px !important;
    right: 16px !important;

    box-sizing: border-box !important;
    border-radius: 10px !important;
    font-size: 14px !important;
    z-index: 9999 !important;
  }

  .flatpickr-calendar.open {
    left: 16px !important;
    right: 16px !important;
  }

  .flatpickr-innerContainer {
    padding: 8px !important;
  }

  .flatpickr-months,
  .flatpickr-month,
  .flatpickr-weekdays {
    padding: 6px 8px !important;
  }

  .flatpickr-days {
    padding: 6px !important;
    max-height: 320px;
    overflow-y: auto;
  }

  .flatpickr-day,
  .flatpickr-weekday {
    padding: 6px 8px !important;
    height: 36px !important;
    line-height: 36px !important;
    min-width: auto !important;
  }
}

    .flatpickr-input {
        width: 260px;
        padding: 8px 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .date-range-wrapper {
        position: relative;
        display: inline-block;
    }

    .date-range-wrapper::before {
        content: "ğŸ“…";
        position: absolute;
        left: 8px;
        top: 8px;
        font-size: 18px;
        pointer-events: none;
    }

    .date-range-input {
        padding-left: 32px;
    }

  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
  
</head>
<body>
  <nav class="nav-1" >
    <div>
      <h1 style="margin:0; font-size: 28px;">è¡€å£“ç´€éŒ„</h1>
    </div>

    <div style="display:flex; align-items:center;">
      <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥" style="cursor:pointer; font-size: 26px;">è¼‰å…¥ä¸­</span>
      </span>
      </h1>
    </div>
  </nav>

  <div class="div-b">
    <h1 class="title">è¼¸å…¥å…§å®¹</h1>
    <form id="bpForm">
      
      <div class="form-row date-row">
        <label for="date">æ—¥æœŸï¼š</label>
        <div class="picker-wrapper">
            <div id="dateDisplay" class="picker-display"></div>
            <input type="date" id="date" class="real-picker-input" required>
        </div>
      </div>

      <div class="form-row time-row">
        <label for="time">æ™‚é–“ï¼š</label>
        <div class="picker-wrapper">
            <div id="timeDisplay" class="picker-display"></div>
            <input type="time" id="time" class="real-picker-input" required>
        </div>
      </div>

      <div class="form-row">
        <label for="systolic">æ”¶ç¸®å£“ï¼ˆé«˜å£“ï¼‰ï¼š</label>
        <input type="number" id="systolic" placeholder="ä¾‹å¦‚ 120" required>
      </div>
      <div class="form-row">
        <label for="diastolic">èˆ’å¼µå£“ï¼ˆä½å£“ï¼‰ï¼š</label>
        <input type="number" id="diastolic" placeholder="ä¾‹å¦‚ 80" required>
      </div>
      <div style="display:flex;justify-content:flex-start;">
        <button id="submit" type="submit" class="primary-btn">æ–°å¢ç´€éŒ„</button>
        <button id="advice-button">ç”¢ç”Ÿ AI å»ºè­°</button>
      </div>
      <p style="font-size: 12px; color: #555;">
        <strong>å…è²¬è²æ˜ï¼š</strong>æœ¬ç«™æä¾›çš„ AI å»ºè­°åƒ…ä¾›åƒè€ƒï¼Œä¸èƒ½å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚æ‰€æœ‰å¥åº·æ±ºç­–ï¼Œè«‹å‹™å¿…è«®è©¢æ‚¨çš„é†«ç”Ÿæˆ–å°ˆæ¥­é†«ç™‚äººå“¡ã€‚
    </p>
    </form>

    <div id="viewControls" style="max-width:820px;margin:8px auto 4px;padding:0 ; display:none;">
      <div class="range-picker-wrap">
        <h2 class="title" style="font-size:20px; margin:6px 0;">æ—¥æœŸç¯„åœï¼š</h2>

        <div class="range-controls" style="flex-direction:column; align-items:stretch; gap:8px;">
          <div class="date-range-wrapper" style="width:100%;">
            <input id="dateRange" class="date-range-input" placeholder="é–‹å§‹æ—¥æœŸ - çµæŸæ—¥æœŸ" style="width:100%;"/>
          </div>

          <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
            <label for="rangeSelect" style="font-weight:600; margin:0;">å¿«é€Ÿé¸æ“‡ç¯„åœï¼š</label>
            <button id="rangePrev" class="range-quick-btn" type="button" aria-label="ä¸Šä¸€å€‹ç¯„åœ" style="padding:6px 10px;">â€¹</button>
            <span id="rangeLabel" style="min-width:160px; display:inline-block; text-align:center; padding:8px; border:1px solid #ccc; border-radius:6px; background:#fff;">æœ€è¿‘ 7 å¤©</span>
            <button id="rangeNext" class="range-quick-btn" type="button" aria-label="ä¸‹ä¸€å€‹ç¯„åœ" style="padding:6px 10px;">â€º</button>
          </div>
        </div>

        <div id="no-record-msg" class="no-record" style="display:none;">ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>
      </div>
    </div>
    <div id="viewNote" style="max-width:820px;margin:0 auto;padding:0 0 8px;color:#666;font-size:13px; display:none;">
      é è¨­é¡¯ç¤ºæœ€è¿‘ 7 å¤©ï¼ˆåŒ…å«çµæŸæ—¥ï¼‰ï¼Œå¯è‡ªè¡Œèª¿æ•´çµæŸæ—¥èˆ‡å¤©æ•¸ã€‚
    </div>

    <div class="allTable-div">
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ/æ™‚é–“</th>
            <th>æ”¶ç¸®å£“</th>
            <th>ç‹€æ…‹</th>
            <th>èˆ’å¼µå£“</th>
            <th>ç‹€æ…‹</th>
            <th>åˆªé™¤</th>
          </tr>
        </thead>
        <tbody id="recordTable"></tbody>
      </table>
    </div>
  </div>
   <div id="advice-output" style="max-width:820px;margin:8px auto;padding:0 16px 12px;">
          <h2 class="title" style="font-size:20px; margin:6px 0;">AI å»ºè­°ï¼š</h2>
          <p id="advice-text"></p>
        </div>
  <div class="chart-container">
    <canvas id="bpChart" width="380" height="250"></canvas>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // LIFF åˆå§‹åŒ–èˆ‡ä½¿ç”¨è€…è³‡è¨Š
    let liffProfile = null;
    const form = document.getElementById("bpForm");
    const table = document.getElementById("recordTable");
    const ctx = document.getElementById("bpChart").getContext("2d");
    const chartContainer = document.querySelector('.chart-container');
    const tableContainer = document.querySelector('.allTable-div');
    const noRecordMsg = document.getElementById('no-record-msg');
    let userId = null;

    // [æ–°å¢] åˆå§‹åŒ–æ—¥æœŸèˆ‡æ™‚é–“é¸æ“‡å™¨
    initDateTimePickers();

    // åˆå§‹éš±è—è¡¨æ ¼èˆ‡åœ–è¡¨
    if (chartContainer) chartContainer.style.display = 'none';
    if (tableContainer) tableContainer.style.display = 'none';
    if (noRecordMsg) noRecordMsg.style.display = 'none';

    // è¼‰å…¥ç´€éŒ„
    let records = []; 
    let viewEndDateStr = null; 
    let viewDays = null;
    let chart;
    let fp = null;
    let userSelectedRange = false;

    // [æ–°å¢] æ—¥æœŸèˆ‡æ™‚é–“é¸æ“‡å™¨ç›£è½
    function initDateTimePickers() {
        const dateInput = document.getElementById("date");
        dateInput.addEventListener("input", function() {
            updateDateDisplay(this.value, "dateDisplay");
        });

        const timeInput = document.getElementById("time");
        timeInput.addEventListener("input", function() {
            updateTimeDisplay(this.value, "timeDisplay");
        });
    }

    // æ›´æ–°æ—¥æœŸé¡¯ç¤º
    function updateDateDisplay(dateValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);
        if (!dateValue) {
            displayEl.textContent = ""; // è‹¥ç„¡å€¼ï¼Œé¡¯ç¤ºç©ºç™½
            displayEl.style.color = "#888";
            return;
        }
        const [year, month, day] = dateValue.split('-');
        displayEl.textContent = `${year} å¹´ ${month} æœˆ ${day} æ—¥`;
        displayEl.style.color = "#222"; // æœ‰å€¼è®Šæ·±è‰²
    }

    // æ›´æ–°æ™‚é–“é¡¯ç¤º
    function updateTimeDisplay(timeValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);
        if (!timeValue) {
            displayEl.textContent = ""; // è‹¥ç„¡å€¼ï¼Œé¡¯ç¤ºç©ºç™½
            displayEl.style.color = "#888";
            return;
        }
        const [hourStr, minuteStr] = timeValue.split(':');
        let hour = parseInt(hourStr);
        let period = "ä¸Šåˆ";
        if (hour >= 12) {
            period = "ä¸‹åˆ";
            if (hour > 12) hour -= 12;
        }
        if (hour === 0) hour = 12;
        const formattedHour = hour.toString().padStart(2, '0');
        displayEl.textContent = `${period} ${formattedHour}:${minuteStr}`;
        displayEl.style.color = "#222";
    }

     //supabase & Edit logic placeholder
    document.getElementById("submit").addEventListener("click", saveEdit);
    async function saveEdit() {
      if (!currentEditEventId) return;
      // (Existing logic)
    }
    
    const COST_SUPABASE_URL = 'https://rygawaqskvijgaciinzc.supabase.co';
    let sb = null;
    try {
      if (!COST_SUPABASE_URL.includes('your-project')) {
        sb = supabase.createClient(COST_SUPABASE_URL, SUPABASE_ANON_KEY);
        console.debug('Supabase client ready');
      } else {
        console.debug('Supabase not configured; using localStorage only');
      }
    } catch (e) { console.warn('supabase init failed', e); sb = null; }

    (async function loadRecords() {
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').select('*').order('recorded_time', { ascending: true });
          if (!error && data) {
            records = data.map(r => ({
              uuid: r.uuid,
              elder_user_id: r.elder_user_id,
              elder_name: r.elder_name,
              systolic: r.systolic,
              diastolic: r.diastolic,
              recorded_time: r.recorded_time,
              status: getStatus(r.systolic, r.diastolic),
              created_at: r.created_at
            }));
            initViewControlsAndRender();
            return;
          }
        } catch (e) { console.warn('fetch from supabase failed', e); }
      }
      const local = JSON.parse(localStorage.getItem('bloodPressureRecords')) || [];
      records = local.map(r => ({
        uuid: r.uuid || null,
        systolic: r.systolic,
        diastolic: r.diastolic,
        recorded_time: r.date || r.recorded_time || '',
        status: r.status || getStatus(r.systolic, r.diastolic)
      }));
      initViewControlsAndRender();
    })();

    function initViewControlsAndRender() {
      const viewControlsEl = document.getElementById('viewControls');
      const viewNoteEl = document.getElementById('viewNote');
      const viewRangeEl = document.getElementById('dateRange');
      const quickBtns = document.querySelectorAll('.range-quick-btn');

      const today = new Date();
      const endStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      viewEndDateStr = endStr;

      const rangeSelect = document.getElementById('rangeSelect');
      if (viewRangeEl && typeof flatpickr === 'function') {
        let defaultDateArray = null;
        if (typeof viewDays === 'number' && viewDays > 0) {
          const start = new Date();
          start.setDate(today.getDate() - (viewDays - 1));
          const startStr = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;
          defaultDateArray = [startStr, endStr];
        } else { 
          if (records && records.length) {
            const times = records.filter(r => r.recorded_time).map(r => new Date(r.recorded_time));
            if (times.length) {
              const minD = new Date(Math.min.apply(null, times));
              const maxD = new Date(Math.max.apply(null, times));
              const sStr = `${minD.getFullYear()}-${String(minD.getMonth()+1).padStart(2,'0')}-${String(minD.getDate()).padStart(2,'0')}`;
              const eStr = `${maxD.getFullYear()}-${String(maxD.getMonth()+1).padStart(2,'0')}-${String(maxD.getDate()).padStart(2,'0')}`;
              defaultDateArray = [sStr, eStr];
              viewEndDateStr = eStr;
            }
          }
        }
        const fpOptions = {
          locale: "zh_tw",
           mode: "range",
           dateFormat: "Y/m/d",
           onChange: function(selectedDates, dateStr, instance) {
            if (!selectedDates || selectedDates.length === 0) {
              userSelectedRange = false;
              viewDays = null;
              viewEndDateStr = null;
              renderTable();
              renderChart();
              return;
            }
            userSelectedRange = true;
             const s = selectedDates[0];
             const e = selectedDates[1] || selectedDates[0];
             const y1 = s.getFullYear(), m1 = String(s.getMonth()+1).padStart(2,'0'), d1 = String(s.getDate()).padStart(2,'0');
             const y2 = e.getFullYear(), m2 = String(e.getMonth()+1).padStart(2,'0'), d2 = String(e.getDate()).padStart(2,'0');
             const startIso = `${y1}-${m1}-${d1}`;
             const endIso = `${y2}-${m2}-${d2}`;
             viewEndDateStr = endIso;
             const diff = Math.round((e - s) / (1000 * 60 * 60 * 24)) + 1;
             viewDays = diff;
             if (document.getElementById('viewStartDate')) document.getElementById('viewStartDate').value = startIso;
             renderTable();
             renderChart();
             if (rangeSelect) rangeSelect.value = "";
            }
         };
        if (defaultDateArray) fpOptions.defaultDate = defaultDateArray;
        fp = flatpickr(viewRangeEl, fpOptions);
      }

      function applyQuick(rangeKey) {
        const t = new Date();
        let s, e;
        if (rangeKey === '7' || rangeKey === '30') {
          const days = parseInt(rangeKey, 10);
          e = new Date();
          s = new Date();
          s.setDate(e.getDate() - (days - 1));
        } else if (rangeKey === 'thisMonth') {
          s = new Date(t.getFullYear(), t.getMonth(), 1);
          e = new Date(t.getFullYear(), t.getMonth() + 1, 0);
        } else if (rangeKey === 'lastMonth') {
          s = new Date(t.getFullYear(), t.getMonth() - 1, 1);
          e = new Date(t.getFullYear(), t.getMonth(), 0);
        } else {
          e = new Date();
          s = new Date();
          s.setDate(e.getDate() - (viewDays - 1));
        }
        if (fp) {
          fp.setDate([s, e], true, "Y-m-d");
          const opt = quickOptions.find(o => o.key === rangeKey);
          if (opt) {
            currentQuickIndex = quickOptions.indexOf(opt);
            if (rangeLabel) rangeLabel.textContent = opt.label;
          }
         } else {
          const y1 = s.getFullYear(), m1 = String(s.getMonth()+1).padStart(2,'0'), d1 = String(s.getDate()).padStart(2,'0');
          const y2 = e.getFullYear(), m2 = String(e.getMonth()+1).padStart(2,'0'), d2 = String(e.getDate()).padStart(2,'0');
          viewEndDateStr = `${y2}-${m2}-${d2}`;
          viewDays = Math.round((e - s) / (1000 * 60 * 60 * 24)) + 1;
          renderTable(); renderChart();
        }
      }

      const rangePrev = document.getElementById('rangePrev');
      const rangeNext = document.getElementById('rangeNext');
      const rangeLabel = document.getElementById('rangeLabel');
      const quickOptions = [
        { key: '7', label: 'æœ€è¿‘ 7 å¤©' },
        { key: '30', label: 'æœ€è¿‘ 30 å¤©' },
        { key: 'thisMonth', label: 'æœ¬æœˆ' },
        { key: 'lastMonth', label: 'ä¸Šå€‹æœˆ' }
      ];
      let currentQuickIndex = 0;

      function updateRangeLabel() {
        if (rangeLabel) rangeLabel.textContent = quickOptions[currentQuickIndex].label;
      }

      if (rangePrev) rangePrev.addEventListener('click', () => {
        currentQuickIndex = (currentQuickIndex - 1 + quickOptions.length) % quickOptions.length;
        userSelectedRange = true;
        applyQuick(quickOptions[currentQuickIndex].key);
        updateRangeLabel();
      });
      if (rangeNext) rangeNext.addEventListener('click', () => {
        currentQuickIndex = (currentQuickIndex + 1) % quickOptions.length;
        userSelectedRange = true;
        applyQuick(quickOptions[currentQuickIndex].key);
        updateRangeLabel();
      });

      if (typeof viewDays === 'number') {
        const mapping = { '7': 7, '30': 30 };
        const idx = quickOptions.findIndex(o => (o.key === String(viewDays)) || (o.key === 'thisMonth' && viewDays === 'thisMonth'));
        if (idx >= 0) {
          currentQuickIndex = idx;
          updateRangeLabel();
          applyQuick(quickOptions[currentQuickIndex].key);
        }
      }

      const viewRecords = getViewRecords(viewDays, viewEndDateStr);
      const hasViewRecords = Array.isArray(viewRecords) && viewRecords.length > 0;
      if (viewControlsEl) viewControlsEl.style.display = (hasViewRecords || userSelectedRange) ? 'flex' : 'none';
      if (viewNoteEl) viewNoteEl.style.display = hasViewRecords ? '' : 'none';
      if (!hasViewRecords) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }
      renderTable();
      renderChart();
    }

    function computeStartDateString(days, endDateStrLocal) {
      const end = endDateStrLocal ? new Date(endDateStrLocal + 'T23:59:59.999') : new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (days - 1));
      const y = start.getFullYear();
      const m = String(start.getMonth() + 1).padStart(2, '0');
      const d = String(start.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function getViewRecords(days = 7, endDateStrLocal = viewEndDateStr) {
      if (days === null || typeof days === 'undefined') {
        return records
          .map((r, idx) => ({ ...r, _allIndex: idx }))
          .filter(r => r.recorded_time) 
          .sort((a, b) => new Date(a.recorded_time) - new Date(b.recorded_time));
      }
      const end = endDateStrLocal ? new Date(endDateStrLocal + 'T23:59:59.999') : new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (days - 1));
      return records
        .map((r, idx) => ({ ...r, _allIndex: idx }))
        .filter(r => {
          if (!r.recorded_time) return false;
          const d = new Date(r.recorded_time);
          return d >= start && d <= end;
        })
        .sort((a, b) => new Date(a.recorded_time) - new Date(b.recorded_time));
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const dateVal = document.getElementById("date").value;
      const timeVal = document.getElementById("time") ? document.getElementById("time").value : '';
      const systolic = parseInt(document.getElementById("systolic").value);
      const diastolic = parseInt(document.getElementById("diastolic").value);
 
      const status = getStatus(systolic, diastolic);
      let recorded_time;
      if (dateVal) {
        if (timeVal) {
          recorded_time = new Date(`${dateVal}T${timeVal}`).toISOString();
        } else {
          recorded_time = new Date(dateVal).toISOString();
        }
      } else {
        recorded_time = new Date().toISOString();
      }

      const volunteerNameEl = document.getElementById('volunteerName');
      const payload = {
        elder_user_id: userId || 'local-user',
        elder_name: volunteerNameEl ? volunteerNameEl.innerText : null,
        systolic: systolic,
        diastolic: diastolic,
        pulse: null,
        recorded_time: recorded_time,
        remarks: null
      };

      const tempRecord = { uuid: null, systolic, diastolic, recorded_time, status };
      records.push(tempRecord);
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }
      renderTable();
      renderChart();

      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').insert([payload]).select();
          if (error) throw error;
          if (data && data[0]) {
            const saved = data[0];
            records[records.length - 1] = {
              uuid: saved.uuid,
              systolic: saved.systolic,
              diastolic: saved.diastolic,
              recorded_time: saved.recorded_time,
              status: getStatus(saved.systolic, saved.diastolic),
              created_at: saved.created_at
            };
            try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { /* ignore */ }
            renderTable(); renderChart();
          }
        } catch (err) {
          console.warn('save to supabase failed', err);
        }
      }

      // è¡¨å–®é€å‡ºå¾Œï¼šé‡ç½®è¡¨å–®ä¸¦æ¸…ç©ºé¡¯ç¤º
      form.reset();
      clearInputs(); 
    };

    // [æ–°å¢] æ¸…ç©ºè¼¸å…¥èˆ‡é¡¯ç¤º
    function clearInputs() {
        document.getElementById('date').value = '';
        document.getElementById('time').value = '';
        document.getElementById('systolic').value = '';
        document.getElementById('diastolic').value = '';
        
        // æ¸…ç©ºå‡é¡¯ç¤ºæ¡†æ–‡å­—
        document.getElementById("dateDisplay").textContent = "";
        document.getElementById("timeDisplay").textContent = "";
    }

    function getStatus(systolic, diastolic) {
      if (systolic < 90 || diastolic < 60) return "åä½";
      if (systolic > 140 || diastolic > 90) return "åé«˜";
      return "æ­£å¸¸";
    }

    function renderTable() {
      const viewControlsEl = document.getElementById('viewControls');
      const viewNoteEl = document.getElementById('viewNote');

      const view = getViewRecords(viewDays, viewEndDateStr);
      const hasViewRecords = Array.isArray(view) && view.length > 0;
      if (viewControlsEl) viewControlsEl.style.display = (hasViewRecords || userSelectedRange) ? 'flex' : 'none';
      if (viewNoteEl) viewNoteEl.style.display = hasViewRecords ? '' : 'none';

      table.innerHTML = "";
      if (!hasViewRecords) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }
      if (noRecordMsg) noRecordMsg.style.display = 'none';
      if (tableContainer) tableContainer.style.display = '';
      if (chartContainer) chartContainer.style.display = '';

      view.forEach((r) => {
        let dateTimeStr = '';
        if (r.recorded_time) {
          const d = new Date(r.recorded_time);
          const datePart = d.toLocaleDateString();
          const timePart = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          dateTimeStr = `${datePart} ${timePart}`;
        }
        const row = `
          <tr data-idx="${r._allIndex}">
            <td>${dateTimeStr}</td>
            <td>${r.systolic}</td>
            <td>${r.status}</td>
            <td>${r.diastolic}</td>
            <td>${r.status}</td>
            <td><button class="delete-btn" onclick="deleteRecord(${r._allIndex})">åˆªé™¤</button></td>
          </tr>`;
        table.innerHTML += row;
      });
    }

    async function deleteRecord(index) {
      const rec = records[index];
      if (sb && rec && rec.uuid) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').delete().eq('uuid', rec.uuid);
          if (error) throw error;
          console.debug('deleted from supabase', data);
        } catch (e) { console.warn('supabase delete failed', e); }
      }
      records.splice(index, 1);
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }
      renderTable();
      renderChart();
    }

    function renderChart() {
      const view = getViewRecords(viewDays, viewEndDateStr);
      if (!view || view.length === 0) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        return;
      }
      if (chartContainer) chartContainer.style.display = '';

      const labels = view.map(r => r.recorded_time ? new Date(r.recorded_time).toLocaleDateString() : '');
      const systolicData = view.map(r => Number(r.systolic) || 0);
      const diastolicData = view.map(r => Number(r.diastolic) || 0);

      if (chart) chart.destroy();

      const bandSystolicLower = labels.map(() => 90);
      const bandSystolicUpper = labels.map(() => 140);
      const bandDiastolicLower = labels.map(() => 60);
      const bandDiastolicUpper = labels.map(() => 90);

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: 'æ”¶ç¸®å£“æ­£å¸¸ä¸‹é™',
              data: bandSystolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(144, 238, 144, 0.5)'
            },
            {
              label: 'æ”¶ç¸®å£“æ­£å¸¸ä¸Šé™',
              data: bandSystolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(144, 238, 144, 0.5)',
              fill: '-1'
            },
            {
              label: 'èˆ’å¼µå£“æ­£å¸¸ä¸‹é™',
              data: bandDiastolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255, 190, 159, 0.7)'
            },
            {
              label: 'èˆ’å¼µå£“æ­£å¸¸ä¸Šé™',
              data: bandDiastolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255, 190, 159, 0.7)',
              fill: '-1'
            },
            {
              label: "æ”¶ç¸®å£“ (é«˜å£“)",
              data: systolicData,
              borderColor: "rgb(255, 99, 132)",
              backgroundColor: 'rgba(255,99,132,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            },
            {
              label: "èˆ’å¼µå£“ (ä½å£“)",
              data: diastolicData,
              borderColor: "rgb(54, 162, 235)",
              backgroundColor: 'rgba(54,162,235,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, 
          layout: {
            padding: { left: 14, right: 14, top: 12, bottom: 12 }
          },
          plugins: {
            legend: { position: "top", labels: { padding: 12 } },
            title: { display: true, text: "è¡€å£“è®ŠåŒ–åœ–", padding: { top: 6, bottom: 6 } }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: "mmHg" },
              ticks: { padding: 8 }, 
              grid: { drawOnChartArea: true, tickLength: 6 }
            },
            x: {
              title: { display: true, text: "æ—¥æœŸ" },
              ticks: {
                padding: 8,    
                maxRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              },
              grid: { drawOnChartArea: false } 
            }
          },
          interaction: { mode: 'index', intersect: false },
          elements: { point: { radius: 4 }, line: { tension: 0.2 } }
        }
      });

      function applyResponsiveChartOptions(ch) {
        if (!ch) return;
        const w = window.innerWidth;
        if (w <= 420) {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'start';
          ch.options.plugins.legend.labels.boxWidth = 12;
          ch.options.plugins.title.display = true;
          ch.options.plugins.title.padding = { top: 4, bottom: 4 };
          ch.options.elements.point.radius = 2;
          ch.options.layout.padding = { left: 12, right: 12, top: 10, bottom: 12 };
          ch.options.scales.x.ticks.maxRotation = 25;
          ctx.canvas.style.height = '240px';
        }
        else if (w <= 768) {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'center';
          ch.options.plugins.legend.labels.boxWidth = 14;
          ch.options.plugins.title.display = true;
          ch.options.elements.point.radius = 3;
          ch.options.layout.padding = { left: 14, right: 14, top: 10, bottom: 12 };
          ch.options.scales.x.ticks.maxRotation = 35;
          ctx.canvas.style.height = '280px';
        }
        else {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'center';
          ch.options.plugins.legend.labels.boxWidth = 16;
          ch.options.plugins.title.display = true;
          ch.options.elements.point.radius = 4;
          ch.options.layout.padding = { left: 18, right: 18, top: 14, bottom: 14 };
          ch.options.scales.x.ticks.maxRotation = 45;
          ctx.canvas.style.height = '320px';
        }
        try { ch.update(); } catch (e) { /* ignore */ }
      }

      applyResponsiveChartOptions(chart);
      window.applyResponsiveChartOptions = applyResponsiveChartOptions;
    }
    
    const LIFF_ID = "2008484068-DEJL7363";
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");

    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "æœªç™»å…¥";
          avatarEl.style.display = "none";
          userId = null;
          // setDefaultDateTime(); // å·²ç§»é™¤è‡ªå‹•å¡«å…¥
          return;
        }

        const profile = await liff.getProfile();
        nameEl.innerText = profile.displayName || "å¿—å·¥";
        userId = profile.userId;
        userName = profile.displayName;
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }
        
        // setDefaultDateTime(); // å·²ç§»é™¤è‡ªå‹•å¡«å…¥
        
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    avatarEl.addEventListener("click", () => {
      if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
        window.location.href = "../../Login-or-register/index.html";
      } else if (typeof liff !== 'undefined' && liff.login) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert('ç„¡æ³•ä½¿ç”¨ LINE ç™»å…¥');
      }
    });

    nameEl.addEventListener("click", () => {
      if (typeof liff !== 'undefined' && liff.isLoggedIn && !liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
      }
    });

    initLiffAndSetProfile();

    function debounce(fn, delay = 120) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    const onResize = debounce(() => {
      if (chart) {
        try { 
          if (typeof window.applyResponsiveChartOptions === 'function') {
            window.applyResponsiveChartOptions(chart);
          }
          chart.resize(); 
        } catch (e) { /* ignore */ }
      }
    }, 150);

    window.addEventListener('resize', onResize);
    window.addEventListener('load', onResize);
    
    const BACKEND_API_URL = "https://supabase-api-six.vercel.app/getAdvice";
    const adviceButton = document.getElementById('advice-button');
    const adviceText = document.getElementById('advice-text');

    adviceButton.addEventListener('click', getAIAdvice);

    async function getAIAdvice() {
        adviceText.innerHTML = "AI å»ºè­°ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...";
        adviceText.className = "loading";
        adviceButton.disabled = true; 

        try {
            const response = await fetch(BACKEND_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    elder_user_id: userId
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
            }

            const data = await response.json(); 
            adviceText.innerHTML = data.advice; 
            adviceText.className = ""; 

        } catch (error) {
            console.error('API å‘¼å«å¤±æ•—:', error);
            adviceText.innerHTML = `ç„¡æ³•å–å¾—å»ºè­°ï¼š${error.message}`;
            adviceText.className = "error";
        } finally {
            adviceButton.disabled = false;
        }
    }
  </script>
</body>
</html>