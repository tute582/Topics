<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¡€å£“ç´€éŒ„</title>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>

  <style>
    /* =========================================
       1. å…¨åŸŸèˆ‡åŸºç¤è¨­å®š (Global & Reset)
       ========================================= */
    body {
      font-family: "Arial", sans-serif;
      background: #ffffff; 
      margin: 0; padding: 0;
      box-sizing: border-box;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* ä¿æŒå”¯è®€æ¬„ä½ç‚ºç™½åº• (è¦†è“‹ç€è¦½å™¨é è¨­ç°åº•) */
    input[readonly], textarea[readonly] {
      background-color: white; cursor: default;
    }

    /* =========================================
       2. å°è¦½åˆ— (Navigation)
       ========================================= */
    .nav-1 {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 18px; position: sticky; top: 0; z-index: 1001;
      width: 100%; background-color: white;
      border-bottom: 1px solid #eee;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    
    /* å¿—å·¥é ­åƒèˆ‡åç¨±å€åŸŸ */
    .volunteer-area { display: flex; align-items: center; gap: 8px; }
    .volunteer-area .avatar {
      width: 36px; height: 36px; border-radius: 50%; 
      object-fit: cover; border: 1px solid #ddd; display: inline-block;
    }
    .volunteer-area #volunteerName {
      cursor: default; padding: 4px 8px; border-radius: 6px;
      background: transparent; font-size: 18px;
    }

    /* =========================================
       3. è¡¨å–®èˆ‡è¼¸å…¥å€ (Form & Inputs)
       ========================================= */
    .div-b {
      width: 100%; max-width: 900px; margin: 0 auto;
      box-sizing: border-box; padding: 0 16px;
    }

    form {
      width: 100%; max-width: 820px;
      background: #fff; padding: 30px;
      border-radius: 12px; border: 1px solid #aaa;
      margin: 12px auto 20px;
    }

    .title { margin: 5px 0; font-size: 26px; }

    /* è¡¨å–®åˆ—è¨­å®š */
    .form-row {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 12px; flex-wrap: wrap;
    }
    .form-row label {
      width: 140px; min-width: 100px; text-align: left; font-weight: 600;
    }
    
    /* è¼¸å…¥æ¡†é€šç”¨æ¨£å¼ */
    .form-row input, .picker-display {
      flex: 1 1 auto; min-width: 0; padding: 8px;
      border-radius: 6px; border: 1px solid #ccc;
      background: #fff; min-height: 38px;
    }

    /* --- [é—œéµæ¨£å¼] Picker Hack: è‡ªå®šç¾©æ—¥æœŸ/æ™‚é–“é¡¯ç¤º --- */
    .picker-wrapper {
      position: relative; flex: 1 1 auto; display: flex;
    }
    /* é¡¯ç¤ºå±¤ (å‡çš„ inputï¼Œè² è²¬é¡¯ç¤ºæ ¼å¼åŒ–æ–‡å­—) */
    .picker-display {
      display: flex; align-items: center; margin: 0; width: 100%;
      overflow: hidden; color: #888; /* é è¨­æ·ºç° */
    }
    /* äº’å‹•å±¤ (çœŸçš„ inputï¼Œé€æ˜ä¸¦è¦†è“‹åœ¨ä¸Šæ–¹) */
    .real-picker-input {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0; z-index: 10; cursor: pointer; -webkit-appearance: none;
    }

    /* æ—¥æœŸèˆ‡æ™‚é–“åˆ—çš„ç‰¹æ®Šæ’åˆ— (å¼·åˆ¶ä¸æ›è¡Œ) */
    .form-row.date-row, .form-row.time-row { flex-wrap: nowrap; align-items: center; }
    .form-row.date-row label, .form-row.time-row label { width: auto; min-width: 80px; margin-right: 8px; }

    /* æŒ‰éˆ•æ¨£å¼ */
    button {
      background-color: #4a90e2; color: white; margin: 0 10px 0 0;
      padding: 6px 12px; border: none; border-radius: 8px; cursor: pointer;
    }
    button:hover { background-color: #3a78c6; }
    button:disabled { background-color: #ccc; }
    
    /* AI å»ºè­°å€å¡Š */
    #advice-output { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
    #advice-text { min-height: 50px; background-color: #f9f9f9; padding: 10px; border-radius: 4px; }
    .error { color: red; } .loading { color: gray; }

    /* =========================================
       4. æ—¥æœŸç¯„åœé¸æ“‡å™¨ (Range Picker)
       ========================================= */
    .range-picker-wrap {
      display: grid; grid-template-columns: 1fr; gap: 12px; width: 100%;
    }
    .range-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    
    .date-range-wrapper { position: relative; display: inline-block; width: 100%; }
    .date-range-wrapper::before {
      content: "ğŸ“…"; position: absolute; left: 8px; top: 8px; font-size: 18px; pointer-events: none;
    }
    .date-range-input { padding-left: 32px; width: 100%; padding: 8px 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }

    .range-quick-btn {
      background: #f6f8fa; border: 1px solid #dfe4e8; padding: 6px 10px;
      border-radius: 6px; cursor: pointer; color: #222;
    }
    .range-quick-btn.active { background: #4a90e2; color: #fff; border-color: #3a78c6; }

    /* =========================================
       5. è³‡æ–™è¡¨æ ¼èˆ‡åœ–è¡¨ (Table & Chart)
       ========================================= */
    .allTable-div {
      width: 100%; max-width: 820px; margin: 5px auto;
      -webkit-overflow-scrolling: touch;
      border: 1px solid #aaa; border-radius: 16px;
      background-color: white; display: block; overflow-x: auto; padding: 0;
    }
    .allTable-div table {
      width: 100%; border-collapse: collapse; min-width: 720px; margin: 0;
    }
    .allTable-div th, .allTable-div td {
      padding: 12px 10px; text-align: center; border: 1px solid #ddd; white-space: nowrap; font-size: 14px;
    }
    .allTable-div th { background-color: #fafafa; position: sticky; top: 0; z-index: 2; }
    .allTable-div tbody tr:nth-child(even) { background-color: #f9f9f9; }

    .delete-btn {
      background-color: #e74c3c; padding: 4px 8px; border-radius: 6px; border: none; color: white; cursor: pointer;
    }

    /* åœ–è¡¨ RWD è¨­å®š */
    .chart-container {
      width: 100%; max-width: 820px; margin: 8px auto 30px; padding: 0 12px;
    }
    canvas {
      margin-top: 12px; background: #f3f0f0; padding: 10px;
      border-radius: 12px; border: 1px solid #aaa;
      width: 100% !important; height: auto !important; display: block;
    }

    .no-record { text-align: center; color: #888; font-size: 18px; margin: 20px 0; display: none; }

    /* =========================================
       6. éŸ¿æ‡‰å¼è¨­è¨ˆ (RWD Breakpoints)
       ========================================= */
    @media (max-width: 768px) {
      form { width: 95%; padding: 16px; }
      .form-row label { width: 110px; font-size: 20px; }
      canvas { height: 220px !important; max-height: 320px; }
    }

    @media (max-width: 420px) {
      .form-row { flex-direction: column; align-items: stretch; }
      /* æ—¥æœŸæ™‚é–“åœ¨æ‰‹æ©Ÿç‰ˆå¼·åˆ¶æ©«å‘ */
      .form-row.date-row, .form-row.time-row { flex-direction: row !important; }
      .form-row.date-row label, .form-row.time-row label { width: auto !important; }
      
      .chart-container { padding: 8px 14px; }
      canvas { height: 240px !important; padding: 16px !important; }
      
      /* Flatpickr æ‰‹æ©Ÿç‰ˆæ¨£å¼ä¿®æ­£ */
      .flatpickr-calendar { width: calc(100% - 32px) !important; left: 16px !important; right: 16px !important; }
    }
  </style>
</head>
<body>

  <nav class="nav-1">
    <div><h1 style="margin:0; font-size: 28px;">è¡€å£“ç´€éŒ„</h1></div>
    <div style="display:flex; align-items:center;">
      <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area">
        <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar">
        <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥">è¼‰å…¥ä¸­</span>
      </span>
      </h1>
    </div>
  </nav>

  <div class="div-b">
    <h1 class="title">è¼¸å…¥å…§å®¹</h1>
    
    <form id="bpForm">
      <div class="form-row date-row">
        <label for="date">æ—¥æœŸï¼š</label>
        <div class="picker-wrapper">
            <div id="dateDisplay" class="picker-display"></div>
            <input type="date" id="date" class="real-picker-input" required>
        </div>
      </div>

      <div class="form-row time-row">
        <label for="time">æ™‚é–“ï¼š</label>
        <div class="picker-wrapper">
            <div id="timeDisplay" class="picker-display"></div>
            <input type="time" id="time" class="real-picker-input" required>
        </div>
      </div>

      <div class="form-row">
        <label for="systolic">æ”¶ç¸®å£“ï¼ˆé«˜å£“ï¼‰ï¼š</label>
        <input type="number" id="systolic" placeholder="ä¾‹å¦‚ 120" required>
      </div>
      <div class="form-row">
        <label for="diastolic">èˆ’å¼µå£“ï¼ˆä½å£“ï¼‰ï¼š</label>
        <input type="number" id="diastolic" placeholder="ä¾‹å¦‚ 80" required>
      </div>
      
      <div style="display:flex;justify-content:flex-start;">
        <button id="submit" type="submit" class="primary-btn">æ–°å¢ç´€éŒ„</button>
        <button id="advice-button" type="button">ç”¢ç”Ÿ AI å»ºè­°</button>
      </div>
      <p style="font-size: 12px; color: #555;">
        <strong>å…è²¬è²æ˜ï¼š</strong>æœ¬ç«™æä¾›çš„ AI å»ºè­°åƒ…ä¾›åƒè€ƒï¼Œä¸èƒ½å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·ã€‚æ‰€æœ‰å¥åº·æ±ºç­–ï¼Œè«‹å‹™å¿…è«®è©¢æ‚¨çš„é†«ç”Ÿæˆ–å°ˆæ¥­é†«ç™‚äººå“¡ã€‚
      </p>
    </form>

    <div id="viewControls" style="max-width:820px;margin:8px auto 4px;padding:0 ; display:none;">
      <div class="range-picker-wrap">
        <h2 class="title" style="font-size:20px; margin:6px 0;">æ—¥æœŸç¯„åœï¼š</h2>
        <div class="range-controls" style="flex-direction:column; align-items:stretch; gap:8px;">
          <div class="date-range-wrapper" style="width:100%;">
            <input id="dateRange" class="date-range-input" placeholder="é–‹å§‹æ—¥æœŸ - çµæŸæ—¥æœŸ" style="width:100%;"/>
          </div>
          <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
            <label for="rangeSelect" style="font-weight:600; margin:0;">å¿«é€Ÿé¸æ“‡ç¯„åœï¼š</label>
            <button id="rangePrev" class="range-quick-btn" type="button">â€¹</button>
            <span id="rangeLabel" style="min-width:160px; display:inline-block; text-align:center; padding:8px; border:1px solid #ccc; border-radius:6px; background:#fff;">æœ€è¿‘ 7 å¤©</span>
            <button id="rangeNext" class="range-quick-btn" type="button">â€º</button>
          </div>
        </div>
        <div id="no-record-msg" class="no-record" style="display:none;">ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>
      </div>
    </div>
    <div id="viewNote" style="max-width:820px;margin:0 auto;padding:0 0 8px;color:#666;font-size:13px; display:none;">
      é è¨­é¡¯ç¤ºæœ€è¿‘ 7 å¤©ï¼ˆåŒ…å«çµæŸæ—¥ï¼‰ï¼Œå¯è‡ªè¡Œèª¿æ•´çµæŸæ—¥èˆ‡å¤©æ•¸ã€‚
    </div>

    <div class="allTable-div">
      <table>
        <thead>
          <tr>
            <th>æ—¥æœŸ/æ™‚é–“</th>
            <th>æ”¶ç¸®å£“</th>
            <th>ç‹€æ…‹</th>
            <th>èˆ’å¼µå£“</th>
            <th>ç‹€æ…‹</th>
            <th>åˆªé™¤</th>
          </tr>
        </thead>
        <tbody id="recordTable"></tbody>
      </table>
    </div>
  </div>

  <div id="advice-output" style="max-width:820px;margin:8px auto;padding:0 16px 12px;">
    <h2 class="title" style="font-size:20px; margin:6px 0;">AI å»ºè­°ï¼š</h2>
    <p id="advice-text"></p>
  </div>

  <div class="chart-container">
    <canvas id="bpChart" width="380" height="250"></canvas>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script>
    /* =================================================================
       1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š
       ================================================================= */
    const LIFF_ID = "2008484068-DEJL7363"; // æ›¿æ›ç‚ºæ‚¨çš„ LIFF ID

    // DOM å…ƒç´ 
    const form = document.getElementById("bpForm");
    const table = document.getElementById("recordTable");
    const ctx = document.getElementById("bpChart").getContext("2d");
    const chartContainer = document.querySelector('.chart-container');
    const tableContainer = document.querySelector('.allTable-div');
    const noRecordMsg = document.getElementById('no-record-msg');
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");

    // ç‹€æ…‹è®Šæ•¸
    let userId = "";
    let userName = null;
    let liffProfile = null;
    let records = []; 
    let viewEndDateStr = null; 
    let viewDays = null;
    let chart;
    let fp = null; // Flatpickr å¯¦ä¾‹
    let userSelectedRange = false;

    // åˆå§‹åŒ– UI ç‹€æ…‹ (éš±è—è¡¨æ ¼èˆ‡åœ–è¡¨)
    if (chartContainer) chartContainer.style.display = 'none';
    if (tableContainer) tableContainer.style.display = 'none';
    if (noRecordMsg) noRecordMsg.style.display = 'none';

    // åˆå§‹åŒ–è‡ªå®šç¾©æ—¥æœŸ/æ™‚é–“é¸æ“‡å™¨
    initDateTimePickers();

    /* =================================================================
       2. LIFF åˆå§‹åŒ– (LIFF Integration)
       èªªæ˜ï¼šé€£æ¥ LINEï¼Œå–å¾— User ID èˆ‡ Profile
       ================================================================= */
    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "æœªç™»å…¥";
          avatarEl.style.display = "none";
          return;
        }

        const profile = await liff.getProfile();
        userId = profile.userId;
        userName = profile.displayName;
        console.log("LIFF Profile userId:", userId, "userName:", userName);

        nameEl.innerText = profile.displayName || "å¿—å·¥";
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    // ç¶å®š LIFF ç™»å…¥äº‹ä»¶
    avatarEl.addEventListener("click", () => {
      if (typeof liff !== 'undefined' && liff.isLoggedIn && liff.isLoggedIn()) {
        window.location.href = "../../Login-or-register/index.html";
      } else if (typeof liff !== 'undefined' && liff.login) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert('ç„¡æ³•ä½¿ç”¨ LINE ç™»å…¥');
      }
    });

    nameEl.addEventListener("click", () => {
      if (typeof liff !== 'undefined' && liff.isLoggedIn && !liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
      }
    });

    initLiffAndSetProfile();

    /* =================================================================
       3. è³‡æ–™åˆå§‹åŒ– (SupabaseAPI)
       ================================================================= */
    // [Read] è¼‰å…¥è³‡æ–™å‡½å¼ (IIFE)
    (async function loadRecords() {
      // call supabase GET API
      const GET_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/bloodPressre/${userId}`  //å–å¾—æŸä½é•·è€…è¡€å£“ç´€éŒ„
      try {
        const response = await fetch(GET_SUPABASE_API_URL);
        const result = await response.json();

        if (result.success && Array.isArray(result.data)) {
          console.log("API loaded data:", result.data);

          // è½‰æ›æ ¼å¼ â†’ ä½ çš„ records é™£åˆ—æ ¼å¼
          records = result.data.map(r => ({
            uuid: r.uuid,
            elder_user_id: r.elder_user_id,
            elder_name: r.elder_name,
            systolic: r.systolic,
            diastolic: r.diastolic,
            recorded_time: r.recorded_time,
            status: getStatus(r.systolic, r.diastolic),
            created_at: r.created_at,
            remarks: r.remarks,
            pulse: r.pulse,
            event_id: r.event_id
          }));

          initViewControlsAndRender();
          return;
        } else {
          console.warn("API did not return success", result);
        }
      } catch (e) {
        console.error("Fetch API error:", e);
      }
    })();

    /* =================================================================
       4. UI äº’å‹•é‚è¼¯ï¼šPicker Hack & View Controls
       ================================================================= */
    // æ—¥æœŸæ™‚é–“é¸æ“‡å™¨åˆå§‹åŒ–
    function initDateTimePickers() {
        const dateInput = document.getElementById("date");
        dateInput.addEventListener("input", function() {
            updateDateDisplay(this.value, "dateDisplay");
        });

        const timeInput = document.getElementById("time");
        timeInput.addEventListener("input", function() {
            updateTimeDisplay(this.value, "timeDisplay");
        });
    }

    // æ›´æ–°æ—¥æœŸé¡¯ç¤ºæ–‡å­—
    function updateDateDisplay(dateValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);
        if (!dateValue) {
            displayEl.textContent = ""; 
            displayEl.style.color = "#888";
            return;
        }
        const [year, month, day] = dateValue.split('-');
        displayEl.textContent = `${year} å¹´ ${month} æœˆ ${day} æ—¥`;
        displayEl.style.color = "#222";
    }

    // æ›´æ–°æ™‚é–“é¡¯ç¤ºæ–‡å­—
    function updateTimeDisplay(timeValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);
        if (!timeValue) {
            displayEl.textContent = ""; 
            displayEl.style.color = "#888";
            return;
        }
        const [hourStr, minuteStr] = timeValue.split(':');
        let hour = parseInt(hourStr);
        let period = "ä¸Šåˆ";
        if (hour >= 12) {
            period = "ä¸‹åˆ";
            if (hour > 12) hour -= 12;
        }
        if (hour === 0) hour = 12;
        const formattedHour = hour.toString().padStart(2, '0');
        displayEl.textContent = `${period} ${formattedHour}:${minuteStr}`;
        displayEl.style.color = "#222";
    }

    // åˆå§‹åŒ–è¦–åœ–æ§åˆ¶å™¨ (æ—¥æœŸç¯„åœç¯©é¸)
    function initViewControlsAndRender() {
      const viewControlsEl = document.getElementById('viewControls');
      const viewNoteEl = document.getElementById('viewNote');
      const viewRangeEl = document.getElementById('dateRange');
      
      // é è¨­é¡¯ç¤ºæœ€è¿‘ 7 å¤©
      const today = new Date();
      const endStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      viewEndDateStr = endStr;

      // Flatpickr è¨­å®š
      if (viewRangeEl && typeof flatpickr === 'function') {
        let defaultDateArray = null;
        
        // è‹¥ records æœ‰è³‡æ–™ï¼Œé è¨­é¸å–å…¨éƒ¨ç¯„åœï¼Œæˆ–æ ¹æ“šé‚è¼¯èª¿æ•´
        if (records && records.length) {
            const times = records.filter(r => r.recorded_time).map(r => new Date(r.recorded_time));
            if (times.length) {
              const maxD = new Date(Math.max.apply(null, times));
              // è‹¥è³‡æ–™ä¸­æœ‰æ›´æ™šçš„æ—¥æœŸï¼Œæ›´æ–°çµæŸæ—¥
              const eStr = `${maxD.getFullYear()}-${String(maxD.getMonth()+1).padStart(2,'0')}-${String(maxD.getDate()).padStart(2,'0')}`;
              viewEndDateStr = eStr; 
            }
        }

        // è¨­å®š Flatpickr
        fp = flatpickr(viewRangeEl, {
          locale: "zh_tw",
          mode: "range",
          dateFormat: "Y/m/d",
          onChange: function(selectedDates, dateStr, instance) {
            if (!selectedDates || selectedDates.length === 0) {
              userSelectedRange = false; viewDays = null; viewEndDateStr = null;
              renderTable(); renderChart();
              return;
            }
            userSelectedRange = true;
            const s = selectedDates[0];
            const e = selectedDates[1] || selectedDates[0];
            // è¨ˆç®—å¤©æ•¸å·®
            viewDays = Math.round((e - s) / (1000 * 60 * 60 * 24)) + 1;
            
            const y2 = e.getFullYear(), m2 = String(e.getMonth()+1).padStart(2,'0'), d2 = String(e.getDate()).padStart(2,'0');
            viewEndDateStr = `${y2}-${m2}-${d2}`;
            
            renderTable();
            renderChart();
          }
        });
      }

      // å¿«é€Ÿé¸æ“‡æŒ‰éˆ•é‚è¼¯ (7å¤©, 30å¤©, æœ¬æœˆ...)
      const quickOptions = [
        { key: '7', label: 'æœ€è¿‘ 7 å¤©' },
        { key: '30', label: 'æœ€è¿‘ 30 å¤©' },
        { key: 'thisMonth', label: 'æœ¬æœˆ' },
        { key: 'lastMonth', label: 'ä¸Šå€‹æœˆ' }
      ];
      let currentQuickIndex = 0; // é è¨­ "æœ€è¿‘ 7 å¤©"

      function applyQuick(rangeKey) {
        const t = new Date();
        let s, e;
        if (rangeKey === '7' || rangeKey === '30') {
          const days = parseInt(rangeKey, 10);
          e = new Date();
          s = new Date();
          s.setDate(e.getDate() - (days - 1));
        } else if (rangeKey === 'thisMonth') {
          s = new Date(t.getFullYear(), t.getMonth(), 1);
          e = new Date(t.getFullYear(), t.getMonth() + 1, 0);
        } else if (rangeKey === 'lastMonth') {
          s = new Date(t.getFullYear(), t.getMonth() - 1, 1);
          e = new Date(t.getFullYear(), t.getMonth(), 0);
        }
        
        if (fp) {
          fp.setDate([s, e], true, "Y-m-d");
          const opt = quickOptions.find(o => o.key === rangeKey);
          if (opt) {
             currentQuickIndex = quickOptions.indexOf(opt);
             document.getElementById('rangeLabel').textContent = opt.label;
          }
        }
      }

      // ç¶å®šå¿«é€Ÿåˆ‡æ›æŒ‰éˆ•
      document.getElementById('rangePrev').addEventListener('click', () => {
        currentQuickIndex = (currentQuickIndex - 1 + quickOptions.length) % quickOptions.length;
        applyQuick(quickOptions[currentQuickIndex].key);
      });
      document.getElementById('rangeNext').addEventListener('click', () => {
        currentQuickIndex = (currentQuickIndex + 1) % quickOptions.length;
        applyQuick(quickOptions[currentQuickIndex].key);
      });

      // åˆæ¬¡æ¸²æŸ“æª¢æŸ¥
      const viewRecords = getViewRecords(viewDays, viewEndDateStr);
      const hasViewRecords = Array.isArray(viewRecords) && viewRecords.length > 0;
      if (viewControlsEl) viewControlsEl.style.display = (hasViewRecords || userSelectedRange) ? 'flex' : 'none';
      if (viewNoteEl) viewNoteEl.style.display = hasViewRecords ? '' : 'none';
      
      if (!hasViewRecords) {
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }
      
      // åˆæ¬¡åŸ·è¡Œé è¨­ (æœ€è¿‘ 7 å¤©)
      applyQuick('7'); 
    }

    /* =================================================================
       5. è³‡æ–™ CRUD åŠŸèƒ½ (Create, Delete)
       ================================================================= */
    
    // [Create] è¡¨å–®é€å‡º
    form.onsubmit = async (e) => {
      e.preventDefault();
      const dateVal = document.getElementById("date").value;
      const timeVal = document.getElementById("time") ? document.getElementById("time").value : '';
      const systolic = parseInt(document.getElementById("systolic").value);
      const diastolic = parseInt(document.getElementById("diastolic").value);
      const status = getStatus(systolic, diastolic);

      // çµ„åˆæ™‚é–“å­—ä¸²
      let recorded_time;
      if (dateVal) {
        recorded_time = timeVal ? new Date(`${dateVal}T${timeVal}`).toISOString() : new Date(dateVal).toISOString();
      } else {
        recorded_time = new Date().toISOString();
      }

      const volunteerNameEl = document.getElementById('volunteerName');
      const payload = {
        elder_user_id: userId,
        elder_name: userName,
        systolic: systolic,
        diastolic: diastolic,
        recorded_time: recorded_time
      };

      // å…ˆå¯«å…¥å‰ç«¯è®“ UI å³æ™‚åæ‡‰
      const tempRecord = { uuid: null, systolic, diastolic, recorded_time, status };
      records.push(tempRecord);
      renderTable();
      renderChart();

      //Call Supabase POST API
      const POST_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/bloodPressre` 
      try {
        const response = await fetch(POST_SUPABASE_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success && result.data) {
          const saved = result.data;

          // æ›´æ–° records æœ€å¾Œä¸€ç­†ï¼ˆå‰›æ’å…¥çš„ï¼‰
          records[records.length - 1] = {
            uuid: saved.uuid,
            elder_user_id: saved.elder_user_id,
            elder_name: saved.elder_name,
            systolic: saved.systolic,
            diastolic: saved.diastolic,
            recorded_time: saved.recorded_time,
            status: getStatus(saved.systolic, saved.diastolic),
            created_at: saved.created_at,
            remarks: saved.remarks || null,
            pulse: saved.pulse || null,
            event_id: saved.event_id || null
          };

          renderTable();
          renderChart();
        } else {
          console.warn("å¾Œç«¯å›æ‡‰éŒ¯èª¤ï¼š", result);
        }

      } catch (err) {
        console.error("API POST éŒ¯èª¤ï¼š", err);
      }

      // é‡ç½®è¡¨å–®
      form.reset();
      clearInputs(); 
    };

    // æ¸…ç©ºè¼¸å…¥æ¬„ä½èˆ‡é¡¯ç¤ºæ–‡å­—
    function clearInputs() {
        document.getElementById('date').value = '';
        document.getElementById('time').value = '';
        document.getElementById('systolic').value = '';
        document.getElementById('diastolic').value = '';
        document.getElementById("dateDisplay").textContent = "";
        document.getElementById("timeDisplay").textContent = "";
    }

    // [Delete] åˆªé™¤ç´€éŒ„
    async function deleteRecord(event_id) {
      const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡€å£“ç´€éŒ„å—ï¼Ÿ");
      if (!ok) return;

      // call Supabase DELETE API
      try {
        const DELETE_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/bloodPressre/${userId}/${event_id}` 
        const response = await fetch(DELETE_SUPABASE_API_URL, { method: "DELETE" });

      } catch (err) {
        console.error("API DELETE éŒ¯èª¤ï¼š", err);
      }
      // å¾ records ç§»é™¤
      const newRecords = records.filter(r => r.event_id !== event_id);
      records = newRecords;

      renderTable();
      renderChart();
    }

    /* =================================================================
       6. è¼”åŠ©å‡½å¼èˆ‡é‚è¼¯
       ================================================================= */
    
    // åˆ¤æ–·è¡€å£“ç‹€æ…‹
    function getStatus(systolic, diastolic) {
      if (systolic < 90 || diastolic < 60) return "åä½";
      if (systolic > 140 || diastolic > 90) return "åé«˜";
      return "æ­£å¸¸";
    }

    // å–å¾—ç›®å‰ç¯©é¸ç¯„åœå…§çš„ç´€éŒ„
    function getViewRecords(days = 7, endDateStrLocal = viewEndDateStr) {
      if (days === null || typeof days === 'undefined') {
        // è‹¥ç„¡å¤©æ•¸é™åˆ¶ï¼Œé¡¯ç¤ºå…¨éƒ¨
        return records.map((r, idx) => ({ ...r, _allIndex: idx }))
          .filter(r => r.recorded_time) 
          .sort((a, b) => new Date(a.recorded_time) - new Date(b.recorded_time));
      }
      // è¨ˆç®—é–‹å§‹æ—¥æœŸ
      const end = endDateStrLocal ? new Date(endDateStrLocal + 'T23:59:59.999') : new Date();
      const start = new Date(end);
      start.setDate(end.getDate() - (days - 1));
      start.setHours(0,0,0,0); // è¨­å®šç‚ºç•¶å¤©èµ·å§‹

      return records
        .map((r, idx) => ({ ...r, _allIndex: idx }))
        .filter(r => {
          if (!r.recorded_time) return false;
          const d = new Date(r.recorded_time);
          return d >= start && d <= end;
        })
        .sort((a, b) => new Date(a.recorded_time) - new Date(b.recorded_time));
    }

    /* =================================================================
       7. è¦–è¦ºåŒ–æ¸²æŸ“ (Table & Chart)
       ================================================================= */
    
    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      const viewControlsEl = document.getElementById('viewControls');
      const viewNoteEl = document.getElementById('viewNote');
      const view = getViewRecords(viewDays, viewEndDateStr);
      const hasViewRecords = Array.isArray(view) && view.length > 0;

      // æ§åˆ¶ UI é¡¯ç¤º
      if (viewControlsEl) viewControlsEl.style.display = (hasViewRecords || userSelectedRange) ? 'flex' : 'none';
      if (viewNoteEl) viewNoteEl.style.display = hasViewRecords ? '' : 'none';

      table.innerHTML = "";
      if (!hasViewRecords) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }
      
      if (noRecordMsg) noRecordMsg.style.display = 'none';
      if (tableContainer) tableContainer.style.display = '';
      if (chartContainer) chartContainer.style.display = '';

      // ç”¢ç”Ÿè¡¨æ ¼è¡Œ
      view.forEach((r) => {
        let dateTimeStr = '';
        if (r.recorded_time) {
          const d = new Date(r.recorded_time);
          const datePart = d.toLocaleDateString();
          const timePart = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          dateTimeStr = `${datePart} ${timePart}`;
        }
        const row = `
          <tr data-idx="${r._allIndex}">
            <td>${dateTimeStr}</td>
            <td>${r.systolic}</td>
            <td>${r.status}</td>
            <td>${r.diastolic}</td>
            <td>${r.status}</td>
            <td><button class="delete-btn" onclick="deleteRecord('${r.event_id}')">åˆªé™¤</button></td>
          </tr>`;
        table.innerHTML += row;
      });
    }

    // æ¸²æŸ“ Chart.js åœ–è¡¨
    function renderChart() {
      const view = getViewRecords(viewDays, viewEndDateStr);
      if (!view || view.length === 0) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        return;
      }
      if (chartContainer) chartContainer.style.display = '';

      const labels = view.map(r => r.recorded_time ? new Date(r.recorded_time).toLocaleDateString() : '');
      const systolicData = view.map(r => Number(r.systolic) || 0);
      const diastolicData = view.map(r => Number(r.diastolic) || 0);

      if (chart) chart.destroy();

      // æ­£å¸¸ç¯„åœåƒè€ƒç·šè³‡æ–™
      const bandSystolicLower = labels.map(() => 90);
      const bandSystolicUpper = labels.map(() => 140);
      const bandDiastolicLower = labels.map(() => 60);
      const bandDiastolicUpper = labels.map(() => 90);

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            // èƒŒæ™¯è‰²å¸¶å€å¡Š (æ­£å¸¸ç¯„åœ)
            { label: 'æ”¶ç¸®å£“æ­£å¸¸ä¸‹é™', data: bandSystolicLower, borderWidth: 0, pointRadius: 0, backgroundColor: 'rgba(144, 238, 144, 0.5)' },
            { label: 'æ”¶ç¸®å£“æ­£å¸¸ä¸Šé™', data: bandSystolicUpper, borderWidth: 0, pointRadius: 0, backgroundColor: 'rgba(144, 238, 144, 0.5)', fill: '-1' },
            { label: 'èˆ’å¼µå£“æ­£å¸¸ä¸‹é™', data: bandDiastolicLower, borderWidth: 0, pointRadius: 0, backgroundColor: 'rgba(255, 190, 159, 0.7)' },
            { label: 'èˆ’å¼µå£“æ­£å¸¸ä¸Šé™', data: bandDiastolicUpper, borderWidth: 0, pointRadius: 0, backgroundColor: 'rgba(255, 190, 159, 0.7)', fill: '-1' },
            // å¯¦éš›æ•¸æ“šç·š
            { label: "æ”¶ç¸®å£“ (é«˜å£“)", data: systolicData, borderColor: "rgb(255, 99, 132)", backgroundColor: 'rgba(255,99,132,0.12)', tension: 0.2, fill: false, pointRadius: 3 },
            { label: "èˆ’å¼µå£“ (ä½å£“)", data: diastolicData, borderColor: "rgb(54, 162, 235)", backgroundColor: 'rgba(54,162,235,0.12)', tension: 0.2, fill: false, pointRadius: 3 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          layout: { padding: { left: 14, right: 14, top: 12, bottom: 12 } },
          plugins: {
            legend: { position: "top", labels: { padding: 12 } },
            title: { display: true, text: "è¡€å£“è®ŠåŒ–åœ–", padding: { top: 6, bottom: 6 } }
          },
          scales: {
            y: { beginAtZero: false, title: { display: true, text: "mmHg" } },
            x: { title: { display: true, text: "æ—¥æœŸ" }, ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 10 } }
          }
        }
      });
      
      // å¥—ç”¨éŸ¿æ‡‰å¼åœ–è¡¨è¨­å®š
      applyResponsiveChartOptions(chart);
    }

    // åœ–è¡¨éŸ¿æ‡‰å¼èª¿æ•´é‚è¼¯ (æ ¹æ“šè¢å¹•å¯¬åº¦èª¿æ•´å­—é«”ã€Padding)
    function applyResponsiveChartOptions(ch) {
        if (!ch) return;
        const w = window.innerWidth;
        if (w <= 420) {
          ch.options.plugins.legend.labels.boxWidth = 12;
          ch.options.scales.x.ticks.maxRotation = 25;
          ctx.canvas.style.height = '240px';
        } else if (w <= 768) {
          ch.options.plugins.legend.labels.boxWidth = 14;
          ch.options.scales.x.ticks.maxRotation = 35;
          ctx.canvas.style.height = '280px';
        } else {
          ctx.canvas.style.height = '320px';
        }
        try { ch.update(); } catch (e) {}
    }

    // ç›£è½è¦–çª—å¤§å°æ”¹è®Šä»¥é‡ç¹ªåœ–è¡¨ (Debounce é˜²æŠ–å‹•)
    function debounce(fn, delay = 120) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      };
    }
    const onResize = debounce(() => {
      if (chart) {
        applyResponsiveChartOptions(chart);
        chart.resize();
      }
    }, 150);
    window.addEventListener('resize', onResize);

    /* =================================================================
       8. AI å»ºè­°åŠŸèƒ½
       ================================================================= */
    const adviceButton = document.getElementById('advice-button');
    const adviceText = document.getElementById('advice-text');

    adviceButton.addEventListener('click', getAIAdvice);

    async function getAIAdvice() {
        adviceText.innerHTML = "AI å»ºè­°ç”¢ç”Ÿä¸­ï¼Œè«‹ç¨å€™...";
        adviceText.className = "loading";
        adviceButton.disabled = true; 
      
        try {
            const BACKEND_API_URL = "https://supabase-api-six.vercel.app/getAdvice"; // AI å»ºè­° API
            const response = await fetch(BACKEND_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ elder_user_id: userId })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
            }

            const data = await response.json(); 
            adviceText.innerHTML = data.advice; 
            adviceText.className = ""; 

        } catch (error) {
            console.error('API å‘¼å«å¤±æ•—:', error);
            adviceText.innerHTML = `ç„¡æ³•å–å¾—å»ºè­°ï¼š${error.message}`;
            adviceText.className = "error";
        } finally {
            adviceButton.disabled = false;
        }
    }
  </script>
</body>
</html>