<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>血壓紀錄</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    /* =========================
       全域與版面（調整為響應式為主）
       ========================= */
    body {
      font-family: "Arial", sans-serif;
      background: #ffffff; /* 改為與看診資訊一致的白色背景 */
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* 保持 readonly 欄位白底 */
    input[readonly], textarea[readonly], input[readonly]:not([type="checkbox"]) {
      background-color: white;
      cursor: default;
    }

    .input-container { margin-top: 15px; }
    .search-container { margin-bottom: 30px; }

    h1 { margin-top: 5px; margin-bottom: 5px; }

    /* 讓表單以寬度限制並置中，手機時縮放 */
    form {
      width: 100%;
      max-width: 820px; /* 最大寬度，較大螢幕不會太寬 */
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      border: 1px solid #aaa;
      margin: 12px auto 20px; /* 改為置中 (auto) */
      box-sizing: border-box;
    }

    /* 讓頁面中的特定標題靠左對齊並與表單/表格寬度一致 */
    .title {
      margin: 5px 0;
      font-size: 26px;
      box-sizing: border-box;
    }

    /* 導覽列 / volunteer area */
    .nav-1{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      position: sticky;
      top: 0;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      width: 100%;
      color: black;
      background-color: white;
      box-sizing: border-box;
      border-bottom: 1px solid #eee;
    }
    .volunteer-area { display:flex; align-items:center; gap:8px; }
    .volunteer-area .avatar {
      width:36px; height:36px; border-radius:50%; object-fit:cover;
      border:1px solid #ddd; display:inline-block;
    }
    .volunteer-area #volunteerName {
      cursor: default;
      padding: 4px 8px;
      border-radius: 6px;
      background: transparent;
      font-size: 18px;
    }

    /* form row */
    .form-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .form-row label {
      width: 140px;
      min-width: 100px;
      text-align: left;
      font-weight: 600;
    }
    .form-row input {
      flex: 1 1 auto;
      min-width: 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .primary-btn { width: 160px; padding: 8px 12px; }
    input { margin: 5px; padding: 6px; border-radius: 6px; border: 1px solid #ccc; }

    button {
      background-color: #4a90e2;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #3a78c6; }

    /* ==============================
       表格容器（calendar 風格）
       ============================== */
    .allTable-div {
      width: 100%;
      max-width: 820px; /* 與 form 相同寬度，保持左右對齊 */
      margin: 5px auto; /* 置中 */
      -webkit-overflow-scrolling: touch;
      border: 1px solid #aaa;
      border-radius: 16px;
      background-color: white;
      display: block;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 0;
    }
    .allTable-div table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      min-width: 720px; /* 桌機上表格最小寬度，手機時會解除最小寬度 */
      box-sizing: border-box;
      background: transparent;
      margin: 0;
      border: none;
    }
    .allTable-div th, .allTable-div td {
      padding: 12px 10px;
      text-align: center;
      border: 1px solid #ddd;
      white-space: nowrap;
      font-size: 14px;
      background: transparent;
    }
    .allTable-div th { background-color: #fafafa; position: sticky; top: 0; z-index: 2; }
    .allTable-div tbody tr:nth-child(even) { background-color: #f9f9f9; }
    .allTable-div tbody tr:nth-child(odd)  { background-color: #ffffff; }

    .delete-btn {
      background-color: #e74c3c;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      padding: 4px 8px;
    }
    .delete-btn:hover { background-color: #c0392b; }

    /* 圖表容器調整為響應式 */
    .chart-container {
      width: 100%;
      max-width: 820px;
      margin: 8px auto 30px;
      box-sizing: border-box;
      padding: 0 12px;
    }
    canvas {
      margin-top: 12px;
      background: #f3f0f0;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #aaa;
      width: 100% !important;
      height: auto !important;
      display: block;
    }

    .div-b {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      box-sizing: border-box;
      padding: 0 16px;
    }

    /* 無資料提示 */
    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
      display: none; /* 由 JS 控制顯示 */
    }

    /* ==============================
       響應式斷點（依據視窗寬度調整）
       ============================== */
    @media (max-width: 1024px) {
      .form-row label { width: 120px; }
      .volunteer-area #volunteerName { font-size: 16px; }
    }

    /* 調整：與看診資訊一致的響應式規則 */
    @media (max-width: 768px) {
      form { width: 95%; padding: 16px; }
      .form-row { gap: 8px; }
      .form-row label { width: 110px; font-size: 20px; }
      .primary-btn { width: 140px; }
      /* 手機上移除表格強制最小寬度，允許寬度收縮並顯示橫向捲動 */
      .allTable-div table { min-width: 0; width: 100%; }
      .allTable-div th, .allTable-div td { padding: 10px; font-size: 16px; white-space: normal; }
      .volunteer-area .avatar { width:30px; height:30px; }
      .volunteer-area #volunteerName { font-size: 14px; }
      /* 圖表高度限制，避免過高 */
      canvas { height: 220px !important; max-height: 320px; }
      input, button { font-size: 16px; padding: 10px; }
    }

    @media (max-width: 420px) {
      .form-row label { width: 100%; }
      .form-row { flex-direction: column; align-items: stretch; }
      .primary-btn { width: 100%; }
      .volunteer-area .avatar { display: none; } /* 極小螢幕隱藏頭像 */
      .volunteer-area #volunteerName { font-size: 13px; }
      /* 手機版：增加 canvas 內邊距與較高高度，讓圖例/座標不被擠壓 */
      .chart-container { padding: 8px 14px; }
      canvas {
        height: 240px !important;
        max-height: 360px;
        padding: 16px !important;
        margin-top: 18px;
      }
      .allTable-div table { min-width: 0; width: 100%; }
      .allTable-div th, .allTable-div td { font-size: 13px; padding: 8px; white-space: normal; }
      input[type="number"], input[type="date"] { font-size: 15px; padding: 8px; }
    }
  </style>
</head>
<body>
  <!-- 導覽列 -->
  <nav class="nav-1" >
    <div>
      <h1 style="margin:0; font-size: 28px;">血壓紀錄</h1>
    </div>

    <div style="display:flex; align-items:center;">
      <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="點此以 Line 登入" style="cursor:pointer; font-size: 26px;">載入中</span>
      </span>
      </h1>
    </div>
  </nav>

  <div class="div-b">
    <h1 class="title">輸入內容</h1>
    <form id="bpForm">
      <div class="form-row">
        <label for="date">日期：</label>
        <input type="date" id="date" required>
      </div>
      <div class="form-row">
        <label for="systolic">收縮壓（高壓）：</label>
        <input type="number" id="systolic" required>
      </div>
      <div class="form-row">
        <label for="diastolic">舒張壓（低壓）：</label>
        <input type="number" id="diastolic" required>
      </div>
      <div style="display:flex;justify-content:flex-start;">
        <button type="submit" class="primary-btn">新增紀錄</button>
      </div>
    </form>

    <!-- 新增：無資料時顯示的訊息（預設隱藏） -->
    <div id="no-record-msg" class="no-record">目前尚未有紀錄</div>

    <div class="allTable-div">
      <table>
        <thead>
          <tr>
            <th>日期</th>
            <th>收縮壓</th>
            <th>舒張壓</th>
            <th>狀態</th>
            <th>刪除</th>
          </tr>
        </thead>
        <tbody id="recordTable"></tbody>
      </table>
    </div>
  </div>
   
  <div class="chart-container">
    <canvas id="bpChart" width="380" height="250"></canvas>
  </div>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // LIFF 全部移除 — 改用本機/預設使用者資訊
    let liffProfile = null; // 保留變數名稱供兼容（不使用 LIFF）
    const form = document.getElementById("bpForm");
    const table = document.getElementById("recordTable");
    const ctx = document.getElementById("bpChart").getContext("2d");
    const chartContainer = document.querySelector('.chart-container');
    const tableContainer = document.querySelector('.allTable-div');
    const noRecordMsg = document.getElementById('no-record-msg');

    // 初始隱藏表格與圖表（由 renderTable/ renderChart 控制）
    if (chartContainer) chartContainer.style.display = 'none';
    if (tableContainer) tableContainer.style.display = 'none';
    if (noRecordMsg) noRecordMsg.style.display = 'none';

    // 載入紀錄
    let records = [];
    let chart;

    // Supabase config - replace with your values
    const SUPABASE_URL = 'https://rygawaqskvijgaciinzc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5Z2F3YXFza3ZpamdhY2lpbnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTU2OTEsImV4cCI6MjA3NDk5MTY5MX0.6NKKuzDkHd0Pkxm9uYoODmkpEVw6wHYuf_SFV9M9af4';
    let sb = null;
    try {
      if (!SUPABASE_URL.includes('your-project')) {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.debug('Supabase client ready');
      } else {
        console.debug('Supabase not configured; using localStorage only');
      }
    } catch (e) { console.warn('supabase init failed', e); sb = null; }

    // 優先從 Supabase 讀取，失敗則 fallback 到 localStorage
    (async function loadRecords() {
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').select('*').order('recorded_time', { ascending: true });
          if (!error && data) {
            records = data.map(r => ({
              uuid: r.uuid,
              elder_user_id: r.elder_user_id,
              elder_name: r.elder_name,
              systolic: r.systolic,
              diastolic: r.diastolic,
              recorded_time: r.recorded_time,
              status: getStatus(r.systolic, r.diastolic),
              created_at: r.created_at
            }));
            renderTable();
            renderChart();
            return;
          }
        } catch (e) { console.warn('fetch from supabase failed', e); }
      }
      // fallback: localStorage
      const local = JSON.parse(localStorage.getItem('bloodPressureRecords')) || [];
      records = local.map(r => ({
        uuid: r.uuid || null,
        systolic: r.systolic,
        diastolic: r.diastolic,
        recorded_time: r.date || r.recorded_time || '',
        status: r.status || getStatus(r.systolic, r.diastolic)
      }));
      renderTable();
      renderChart();
    })();

    // 新增紀錄
    form.onsubmit = async (e) => {
      e.preventDefault();
      const dateVal = document.getElementById("date").value;
      const systolic = parseInt(document.getElementById("systolic").value);
      const diastolic = parseInt(document.getElementById("diastolic").value);

      const status = getStatus(systolic, diastolic);
      const recorded_time = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();

      // 使用本機預設使用者資訊 (已移除 LINE)
      const volunteerNameEl = document.getElementById('volunteerName');
      const payload = {
        elder_user_id: 'local-user',
        elder_name: volunteerNameEl ? volunteerNameEl.innerText : null,
        systolic: systolic,
        diastolic: diastolic,
        pulse: null,
        recorded_time: recorded_time,
        remarks: null
      };

      // Optimistically add to UI
      const tempRecord = { uuid: null, systolic, diastolic, recorded_time, status };
      records.push(tempRecord);
      renderTable();
      renderChart();

      // persist locally
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }

      // try to save to supabase async
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').insert([payload]).select();
          if (error) throw error;
          if (data && data[0]) {
            const saved = data[0];
            records[records.length - 1] = {
              uuid: saved.uuid,
              systolic: saved.systolic,
              diastolic: saved.diastolic,
              recorded_time: saved.recorded_time,
              status: getStatus(saved.systolic, saved.diastolic),
              created_at: saved.created_at
            };
            try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { /* ignore */ }
            renderTable(); renderChart();
          }
        } catch (err) {
          console.warn('save to supabase failed', err);
        }
      }

      form.reset();
    };

    // 血壓狀態判斷
    function getStatus(systolic, diastolic) {
      if (systolic < 90 || diastolic < 60) return "偏低";
      if (systolic > 140 || diastolic > 90) return "偏高";
      return "正常";
    }

    // 表格顯示
    function renderTable() {
      table.innerHTML = "";
      if (!records || records.length === 0) {
        // 無資料：隱藏表格與圖表，顯示訊息
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
        if (noRecordMsg) noRecordMsg.style.display = 'block';
        return;
      }

      // 有資料：顯示表格與圖表容器，隱藏無資料訊息
      if (noRecordMsg) noRecordMsg.style.display = 'none';
      if (tableContainer) tableContainer.style.display = '';
      if (chartContainer) chartContainer.style.display = '';

      records.forEach((r, i) => {
        const dateStr = r.recorded_time ? (new Date(r.recorded_time)).toLocaleDateString() : '';
        const idAttr = r.uuid ? `data-uuid="${r.uuid}"` : `data-idx="${i}"`;
        const row = `
          <tr ${idAttr}>
            <td>${dateStr}</td>
            <td>${r.systolic}</td>
            <td>${r.diastolic}</td>
            <td>${r.status}</td>
            <td><button class="delete-btn" onclick="deleteRecord(${i})">刪除</button></td>
          </tr>`;
        table.innerHTML += row;
      });
    }

    // 刪除紀錄
    async function deleteRecord(index) {
      const rec = records[index];
      if (sb && rec && rec.uuid) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').delete().eq('uuid', rec.uuid);
          if (error) throw error;
          console.debug('deleted from supabase', data);
        } catch (e) { console.warn('supabase delete failed', e); }
      }
      records.splice(index, 1);
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }
      renderTable();
      renderChart();
    }

    // 繪製圖表
    function renderChart() {
      if (!records || records.length === 0) {
        if (chart) { chart.destroy(); chart = null; }
        if (chartContainer) chartContainer.style.display = 'none';
        return;
      }
      if (chartContainer) chartContainer.style.display = '';

      const labels = records.map(r => r.recorded_time ? new Date(r.recorded_time).toLocaleDateString() : '');
      const systolicData = records.map(r => Number(r.systolic) || 0);
      const diastolicData = records.map(r => Number(r.diastolic) || 0);

      if (chart) chart.destroy();

      const bandSystolicLower = labels.map(() => 90);
      const bandSystolicUpper = labels.map(() => 140);
      const bandDiastolicLower = labels.map(() => 60);
      const bandDiastolicUpper = labels.map(() => 90);

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: '收縮壓正常下限',
              data: bandSystolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(144, 238, 144, 0.5)'
            },
            {
              label: '收縮壓正常上限',
              data: bandSystolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(144, 238, 144, 0.5)',
              fill: '-1'
            },
            {
              label: '舒張壓正常下限',
              data: bandDiastolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255, 190, 159, 0.7)'
            },
            {
              label: '舒張壓正常上限',
              data: bandDiastolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255, 190, 159, 0.7)',
              fill: '-1'
            },
            {
              label: "收縮壓 (高壓)",
              data: systolicData,
              borderColor: "rgb(255, 99, 132)",
              backgroundColor: 'rgba(255,99,132,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            },
            {
              label: "舒張壓 (低壓)",
              data: diastolicData,
              borderColor: "rgb(54, 162, 235)",
              backgroundColor: 'rgba(54,162,235,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, /* 允許 container 控制高度 */
          layout: {
            // 調整圖表四周內邊距以增加間距感
            padding: { left: 14, right: 14, top: 12, bottom: 12 }
          },
          plugins: {
            legend: { position: "top", labels: { padding: 12 } },
            title: { display: true, text: "血壓變化圖", padding: { top: 6, bottom: 6 } }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: "mmHg" },
              ticks: { padding: 8 }, // y 軸刻度與軸線增加間距
              grid: { drawOnChartArea: true, tickLength: 6 }
            },
            x: {
              title: { display: true, text: "日期" },
              ticks: {
                padding: 8,       // x 軸刻度與圖表保持間距
                maxRotation: 45,
                autoSkip: true,
                maxTicksLimit: 10
              },
              grid: { drawOnChartArea: false } // 讓 x 軸格線不干擾資料區域
            }
          },
          interaction: { mode: 'index', intersect: false },
          elements: { point: { radius: 4 }, line: { tension: 0.2 } }
        }
      });

      // 將響應式選項抽成全域函式（renderChart 與 resize 共用）
      function applyResponsiveChartOptions(ch) {
        if (!ch) return;
        const w = window.innerWidth;
        // 手機極小：保留圖例但調整 box 與 padding，提升 canvas 高度
        if (w <= 420) {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'start';
          ch.options.plugins.legend.labels.boxWidth = 12;
          ch.options.plugins.title.display = true;
          ch.options.plugins.title.padding = { top: 4, bottom: 4 };
          ch.options.elements.point.radius = 2;
          ch.options.layout.padding = { left: 12, right: 12, top: 10, bottom: 12 };
          ch.options.scales.x.ticks.maxRotation = 25;
          ctx.canvas.style.height = '240px';
        }
        // 平板/中等：中等間距
        else if (w <= 768) {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'center';
          ch.options.plugins.legend.labels.boxWidth = 14;
          ch.options.plugins.title.display = true;
          ch.options.elements.point.radius = 3;
          ch.options.layout.padding = { left: 14, right: 14, top: 10, bottom: 12 };
          ch.options.scales.x.ticks.maxRotation = 35;
          ctx.canvas.style.height = '280px';
        }
        // 桌機：較大間距
        else {
          ch.options.plugins.legend.position = 'top';
          ch.options.plugins.legend.align = 'center';
          ch.options.plugins.legend.labels.boxWidth = 16;
          ch.options.plugins.title.display = true;
          ch.options.elements.point.radius = 4;
          ch.options.layout.padding = { left: 18, right: 18, top: 14, bottom: 14 };
          ch.options.scales.x.ticks.maxRotation = 45;
          ctx.canvas.style.height = '320px';
        }
        try { ch.update(); } catch (e) { /* ignore */ }
      }

      // 立即應用並在 resize 時更新（debounce 已在外層處理）
      applyResponsiveChartOptions(chart);
    }
    /* ==============================
   ✅ LIFF 初始化
   ============================== */
    const LIFF_ID = "2008228534-ke2nMaoZ";
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");

    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "未登入";
          avatarEl.style.display = "none";
          return;
        }

        const profile = await liff.getProfile();
        nameEl.innerText = profile.displayName || "志工";
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    avatarEl.addEventListener("click", () => {
      if (liff.isLoggedIn()) {
        // 已登入則前往註冊頁面
        window.location.href = "註冊頁面.html";
      } else {
        // 未登入：以當前頁面為 redirectUri，桌機/平板開啟也能回到此頁面
        liff.login({ redirectUri: window.location.href });
      }
    });

    nameEl.addEventListener("click", () => {
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert("已登入：" + (nameEl.innerText || "志工"));
      }
    });

    initLiffAndSetProfile();

    /* -----------------------------
       視窗大小變化：重新調整圖表與介面
       ----------------------------- */
    function debounce(fn, delay = 120) {
      let t;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    const onResize = debounce(() => {
      // 若有 chart 則請 Chart.js 重新調整
      if (chart) {
        try { 
          // 重新套用響應式選項並調整大小
          if (typeof applyResponsiveChartOptions === 'function') {
            applyResponsiveChartOptions(chart);
          }
          chart.resize(); 
        } catch (e) { /* ignore */ }
      }
    }, 150);

    window.addEventListener('resize', onResize);
    // 初始一次調整（確保載入時正確）
    window.addEventListener('load', onResize);
  </script>
</body>
</html>
