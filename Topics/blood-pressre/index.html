<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>血壓紀錄系統</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background: #f4f6f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 0;
    }
    h1 { color: #333; }
    /* 導覽列樣式（從 record-information 複製） */
    .nav-1{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 25px;
      position: sticky;
      top: 0;
      z-index: 1001;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 100%;
      left: 0;
      right: 0;
      color: black;
      background-color: white;
      box-sizing: border-box;
      border-bottom: 1px solid #ddd;
    }
    .volunteer-area { display:flex; align-items:center; gap:8px; }
    .volunteer-area .avatar {
      width:36px; height:36px; border-radius:50%; object-fit:cover;
      border:1px solid #ddd; display:inline-block;
    }
    .volunteer-area #volunteerName {
      cursor: default;
      padding: 4px 8px;
      border-radius: 6px;
      background: transparent;
      font-size: 20px;
    }
    .volunteer-area button { padding:4px 8px; border-radius:6px; font-size:14px; }
    form {
      width: 80%;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    /* form row: label + input aligned */
    .form-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .form-row label {
      width: 140px;
      min-width: 100px;
      text-align: left;
      font-weight: 600;
    }
    .form-row input {
      flex: 1 1 auto;
      min-width: 0; /* ensure flex children can shrink */
      padding: 8px;
    }
    .primary-btn {
      width: 160px;
      padding: 8px 12px;
    }
    input {
      margin: 5px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #4a90e2;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #4a90e2; }

  table {
    width: 80%;
    border-collapse: separate;
    border-spacing: 0;
    box-sizing: border-box;
    overflow: hidden;
    border-radius: 20px;
    border: 1px solid #aaa;
  }
    th {
      background-color: #f2f2f2;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }

    th, td {
      border: none;
      padding: 10px;
      text-align: center;
    }

    .delete-btn {
      background-color: #e74c3c;
      border: none;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      padding: 3px 8px;
    }
    .delete-btn:hover { background-color: #c0392b; }
    .chart-container {
      width: 80%;
      max-width: 900px;
      margin: 10px auto;
      box-sizing: border-box;
    }
    canvas {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      width: 100% !important;
      height: 50% !important;
    }

  </style>
</head>
<body>
  <!-- 導覽列 -->
  <nav class="nav-1" >
    <div>
      <h1 style="margin:0; font-size: 28px;">血壓紀錄系統</h1>
    </div>

    <div style="display:flex; align-items:center;">
      <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="點此以 Line 登入" style="cursor:pointer; font-size: 26px;">載入中</span>
      </span>
      </h1>
    </div>
  </nav>

  <form id="bpForm">
    <div class="form-row">
      <label for="date">日期：</label>
      <input type="date" id="date" required>
    </div>
    <div class="form-row">
      <label for="systolic">收縮壓（高壓）：</label>
      <input type="number" id="systolic" required>
    </div>
    <div class="form-row">
      <label for="diastolic">舒張壓（低壓）：</label>
      <input type="number" id="diastolic" required>
    </div>
    <div style="display:flex;justify-content:flex-start;">
      <button type="submit" class="primary-btn">新增紀錄</button>
    </div>
  </form>

  <table>
    <thead>
      <tr>
        <th>日期</th>
        <th>收縮壓</th>
        <th>舒張壓</th>
        <th>狀態</th>
        <th>刪除</th>
      </tr>
    </thead>
    <tbody id="recordTable"></tbody>
  </table>

  <div class="chart-container">
    <canvas id="bpChart" width="380" height="250"></canvas>
  </div>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // LIFF 全部移除 — 改用本機/預設使用者資訊
    let liffProfile = null; // 保留變數名稱供兼容（不使用 LIFF）
    const form = document.getElementById("bpForm");
    const table = document.getElementById("recordTable");
    const ctx = document.getElementById("bpChart").getContext("2d");

    // 載入紀錄
    let records = [];
    let chart;

    // Supabase config - replace with your values
    const SUPABASE_URL = 'https://rygawaqskvijgaciinzc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5Z2F3YXFza3ZpamdhY2lpbnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTU2OTEsImV4cCI6MjA3NDk5MTY5MX0.6NKKuzDkHd0Pkxm9uYoODmkpEVw6wHYuf_SFV9M9af4';
    let sb = null;
    try {
      if (!SUPABASE_URL.includes('your-project')) {
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.debug('Supabase client ready');
      } else {
        console.debug('Supabase not configured; using localStorage only');
      }
    } catch (e) { console.warn('supabase init failed', e); sb = null; }

    // 優先從 Supabase 讀取，失敗則 fallback 到 localStorage
    (async function loadRecords() {
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').select('*').order('recorded_time', { ascending: true });
          if (!error && data) {
            records = data.map(r => ({
              uuid: r.uuid,
              elder_user_id: r.elder_user_id,
              elder_name: r.elder_name,
              systolic: r.systolic,
              diastolic: r.diastolic,
              recorded_time: r.recorded_time,
              status: getStatus(r.systolic, r.diastolic),
              created_at: r.created_at
            }));
            renderTable();
            renderChart();
            return;
          }
        } catch (e) { console.warn('fetch from supabase failed', e); }
      }
      // fallback: localStorage
      const local = JSON.parse(localStorage.getItem('bloodPressureRecords')) || [];
      records = local.map(r => ({
        uuid: r.uuid || null,
        systolic: r.systolic,
        diastolic: r.diastolic,
        recorded_time: r.date || r.recorded_time || '',
        status: r.status || getStatus(r.systolic, r.diastolic)
      }));
      renderTable();
      renderChart();
    })();

    // 新增紀錄
    form.onsubmit = async (e) => {
      e.preventDefault();
      const dateVal = document.getElementById("date").value;
      const systolic = parseInt(document.getElementById("systolic").value);
      const diastolic = parseInt(document.getElementById("diastolic").value);

      const status = getStatus(systolic, diastolic);
      const recorded_time = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();

      // 使用本機預設使用者資訊 (已移除 LINE)
      const volunteerNameEl = document.getElementById('volunteerName');
      const payload = {
        elder_user_id: 'local-user',
        elder_name: volunteerNameEl ? volunteerNameEl.innerText : null,
        systolic: systolic,
        diastolic: diastolic,
        pulse: null,
        recorded_time: recorded_time,
        remarks: null
      };

      // Optimistically add to UI
      const tempRecord = { uuid: null, systolic, diastolic, recorded_time, status };
      records.push(tempRecord);
      renderTable();
      renderChart();

      // persist locally
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }

      // try to save to supabase async
      if (sb) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').insert([payload]).select();
          if (error) throw error;
          if (data && data[0]) {
            const saved = data[0];
            records[records.length - 1] = {
              uuid: saved.uuid,
              systolic: saved.systolic,
              diastolic: saved.diastolic,
              recorded_time: saved.recorded_time,
              status: getStatus(saved.systolic, saved.diastolic),
              created_at: saved.created_at
            };
            try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { /* ignore */ }
            renderTable(); renderChart();
          }
        } catch (err) {
          console.warn('save to supabase failed', err);
        }
      }

      form.reset();
    };

    // 血壓狀態判斷
    function getStatus(systolic, diastolic) {
      if (systolic < 90 || diastolic < 60) return "偏低";
      if (systolic > 140 || diastolic > 90) return "偏高";
      return "正常";
    }

    // 表格顯示
    function renderTable() {
      table.innerHTML = "";
      records.forEach((r, i) => {
        const dateStr = r.recorded_time ? (new Date(r.recorded_time)).toLocaleDateString() : '';
        const idAttr = r.uuid ? `data-uuid="${r.uuid}"` : `data-idx="${i}"`;
        const row = `
          <tr ${idAttr}>
            <td>${dateStr}</td>
            <td>${r.systolic}</td>
            <td>${r.diastolic}</td>
            <td>${r.status}</td>
            <td><button class="delete-btn" onclick="deleteRecord(${i})">刪除</button></td>
          </tr>`;
        table.innerHTML += row;
      });
    }

    // 刪除紀錄
    async function deleteRecord(index) {
      const rec = records[index];
      if (sb && rec && rec.uuid) {
        try {
          const { data, error } = await sb.from('blood_pressure_records').delete().eq('uuid', rec.uuid);
          if (error) throw error;
          console.debug('deleted from supabase', data);
        } catch (e) { console.warn('supabase delete failed', e); }
      }
      records.splice(index, 1);
      try { localStorage.setItem('bloodPressureRecords', JSON.stringify(records)); } catch (e) { console.error(e); }
      renderTable();
      renderChart();
    }

    // 繪製圖表
    function renderChart() {
      const labels = records.map(r => r.recorded_time ? new Date(r.recorded_time).toLocaleDateString() : '');
      const systolicData = records.map(r => Number(r.systolic) || 0);
      const diastolicData = records.map(r => Number(r.diastolic) || 0);

      if (chart) chart.destroy();

      const bandSystolicLower = labels.map(() => 90);
      const bandSystolicUpper = labels.map(() => 140);
      const bandDiastolicLower = labels.map(() => 60);
      const bandDiastolicUpper = labels.map(() => 90);

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: '收縮壓正常下限',
              data: bandSystolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255,99,132,0.06)'
            },
            {
              label: '收縮壓正常上限',
              data: bandSystolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(255,99,132,0.06)',
              fill: '-1'
            },
            {
              label: '舒張壓正常下限',
              data: bandDiastolicLower,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(54,162,235,0.06)'
            },
            {
              label: '舒張壓正常上限',
              data: bandDiastolicUpper,
              borderWidth: 0,
              pointRadius: 0,
              backgroundColor: 'rgba(54,162,235,0.06)',
              fill: '-1'
            },
            {
              label: "收縮壓 (高壓)",
              data: systolicData,
              borderColor: "rgb(255, 99, 132)",
              backgroundColor: 'rgba(255,99,132,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            },
            {
              label: "舒張壓 (低壓)",
              data: diastolicData,
              borderColor: "rgb(54, 162, 235)",
              backgroundColor: 'rgba(54,162,235,0.12)',
              tension: 0.2,
              fill: false,
              pointRadius: 3,
              order: 5
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: {
              display: true,
              text: "血壓變化圖"
            }
          },
          scales: {
            y: { beginAtZero: false, title: { display: true, text: "mmHg" } },
            x: { title: { display: true, text: "日期" } }
          }
        }
      });
    }
    /* ==============================
   ✅ LIFF 初始化
   ============================== */
    const LIFF_ID = "2008228534-ke2nMaoZ";
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");

    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "載入中";
          avatarEl.style.display = "none";
          return;
        }

        const profile = await liff.getProfile();
        nameEl.innerText = profile.displayName || "志工";
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    avatarEl.addEventListener("click", () => {
      if (liff.isLoggedIn()) {
        window.location.href = "註冊頁面.html";
      } else {
        liff.login({
          redirectUri: "https://tute582.github.io/Topics/Topics/record-information/註冊頁面.html"
        });
      }
    });

    nameEl.addEventListener("click", () => {
      if (!liff.isLoggedIn()) {
        liff.login({
          redirectUri: "https://tute582.github.io/Topics/Topics/record-information/註冊頁面.html"
        });
      } else {
        alert("已登入：" + (nameEl.innerText || "志工"));
      }
    });

    initLiffAndSetProfile();
  </script>
</body>
</html>
