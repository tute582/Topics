<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è¡Œäº‹æ›†</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼å‡ç´š --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #fcfcfc; color: #333; }
        
        .nav-1 { display: flex; align-items: center; justify-content: space-between; padding: 15px 25px; background: #fff; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 1001; }
        .avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #4a90e2; object-fit: cover; }
        #volunteerName { font-size: 20px; font-weight: bold; }
        
        .container { padding: 15px; max-width: 1000px; margin: 0 auto; }
        #calendar-container { background: white; padding: 10px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: #4a90e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 32px; box-shadow: 0 6px 15px rgba(74,144,226,0.4); cursor: pointer; z-index: 999; border: none; }

        /* å½ˆçª—è¨­è¨ˆ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { 
            background: #fff; width: 92%; max-width: 420px; margin: 40px auto; 
            padding: 30px 20px 20px; border-radius: 24px; position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .close-btn { 
            position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; 
            background: #eee; border-radius: 50%; border: none; font-size: 18px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* è¡¨å–®å…ƒç´ å‡ç´š */
        label { display: block; font-weight: bold; font-size: 16px; margin: 12px 0 6px 5px; color: #555; }
        input[type="text"], input[type="date"], input[type="time"], select { 
            width: 100%; padding: 12px; border-radius: 12px; 
            border: 2px solid #efefef; font-size: 16px; background: #fafafa;
            transition: all 0.3s;
        }
        input:focus { border-color: #4a90e2; outline: none; background: #fff; }

        /* å¿«é€Ÿå¡«å¯«æ¨™ç±¤ */
        .tag-container { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .tag-btn { 
            padding: 6px 14px; background: #fff; border: 1.5px solid #4a90e2; 
            border-radius: 50px; color: #4a90e2; font-size: 14px; cursor: pointer;
        }
        .tag-btn:active { background: #4a90e2; color: #fff; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-save { background: #4a90e2; color: white; border: none; padding: 14px; border-radius: 14px; font-size: 18px; font-weight: bold; width: 100%; cursor: pointer; }
        .btn-delete { background: #fff; color: #f37a7a; border: none; padding: 10px; font-weight: bold; cursor: pointer; }

        /* ç•¶æ—¥è¡Œç¨‹åˆ—è¡¨æ¨£å¼ */
        .event-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; cursor: pointer; }
        .event-time { font-weight: bold; color: #4a90e2; margin-right: 15px; font-size: 16px; }
        .event-info { flex: 1; }
        .event-title { font-weight: bold; font-size: 16px; }
        .event-note { font-size: 13px; color: #999; }
    </style>
</head>
<body>
    <nav class="nav-1">
        <h1>è¡Œäº‹æ›†</h1>
        <div class="volunteer-area" onclick="handleLoginClick()" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <span id="volunteerName">è¼‰å…¥ä¸­</span>
            <img id="volunteerAvatar" class="avatar" src="" style="display:none;">
        </div>
    </nav>

    <div class="container">
        <div id="calendar-container"><div id="calendar"></div></div>
        <div style="margin-top: 25px; text-align: center;">
            <button type="button" onclick="goToHistory()" style="background: #ffa502; border: none; border-radius: 50px; color: white; padding: 12px 40px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(255,165,2,0.3);">
                æª¢è¦–éå¾€ç´€éŒ„
            </button>
        </div>
    </div>

    <button class="fab" id="fabAdd">+</button>

    <div id="dataModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal('dataModal')">âœ•</button>
        <h2 id="modalTitle" style="text-align: center; margin-bottom: 15px;">æ–°å¢è¡Œç¨‹</h2>
        
        <form id="dataForm">
            <label>ğŸ“… æ—¥æœŸ</label>
            <input type="date" id="date" required>
            
            <label>â° æ™‚é–“</label>
            <input type="time" id="time" required>
            
            <label>ğŸ“ è¡Œç¨‹å…§å®¹</label>
            <div class="tag-container" style="margin-bottom: 10px;">
                <button type="button" class="tag-btn" onclick="quickFill('çœ‹é†«ç”ŸğŸ¥')">çœ‹é†«ç”Ÿ</button>
                <button type="button" class="tag-btn" onclick="quickFill('é ˜è—¥ğŸ’Š')">é ˜è—¥</button>
                <button type="button" class="tag-btn" onclick="quickFill('è²·æ±è¥¿ğŸ›’')">è²·æ±è¥¿</button>
                <button type="button" class="tag-btn" onclick="quickFill('é‹å‹•ğŸƒ')">é‹å‹•</button>
            </div>
            <input type="text" id="event" placeholder="é™25å­—" maxlength="25">
            
            <label>ğŸ’¡ å‚™è¨»</label>
            <input type="text" id="note" placeholder="é™25å­—" maxlength="25">
            
            <label>ğŸ”„ é‡è¤‡</label>
            <select id="repeat">
                <option value="none">ä¸é‡è¤‡</option>
                <option value="daily">æ¯å¤©</option>
                <option value="weekly">æ¯é€±</option>
                <option value="monthly">æ¯æœˆ</option>
                <option value="yearly">æ¯å¹´</option>
            </select>

            <label>ğŸ”” æé†’é¡å‹</label>
            <select id="reminder">
                <option value="none">ç„¡</option>
                <option value="0min">ç•¶ä¸‹æé†’</option>
                <option value="30min">30åˆ†é˜å‰</option>
                <option value="1h">1å°æ™‚å‰</option>
                <option value="day">1å¤©å‰</option>
            </select>
            
            <button type="button" class="btn-save" id="saveBtn" style="margin-top: 25px;">å„²å­˜è¡Œç¨‹</button>
            
            <div style="text-align: center; margin-top: 15px;">
                <button type="button" id="deleteBtn" style="background:none; border:none; color:#f37a7a; font-weight:bold; cursor:pointer; display:none;">åˆªé™¤æ­¤è¡Œç¨‹</button>
            </div>
        </form>
    </div>
</div>

    <div id="dayViewModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('dayViewModal')">âœ•</button>
            <h3 id="dayViewTitle" style="margin-bottom: 20px; border-left: 5px solid #4a90e2; padding-left: 10px;"></h3>
            <div id="dayEventList" style="max-height: 350px; overflow-y: auto;"></div>
            <button type="button" class="btn-save" onclick="openAddFromDayView()" style="margin-top: 20px; background: #4a90e2;">+ åœ¨æ­¤æ—¥æ–°å¢</button>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008484068-Kp57RrAr"; 
        let userId = "U10243a4b528760aad0d03a51d13c2e4c"; 
        let userName = "";
        let calendar;
        let isEditing = false;
        let currentEventId = null;
        let selectedDateStr = ""; 

        // å¿«é€Ÿå¡«å¯«åŠŸèƒ½
        function quickFill(text) {
            const input = document.getElementById("event");
            input.value = text;
            input.focus();
        }

        function goToHistory() { window.location.href = 'history.html'; }

        function handleLoginClick() {
            if (!liff.isLoggedIn()) {
                liff.login({ redirectUri: window.location.href });
            } else if (confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                liff.logout();
                window.location.reload();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
                dateClick: (info) => openDayView(info.dateStr),
                eventClick: (info) => {
                    info.jsEvent.stopPropagation();
                    openModal(true, info.event);
                }
            });
            calendar.render();
            initLiff();
        });

        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    userName = profile.displayName;
                    document.getElementById("volunteerName").innerText = userName;
                    if (profile.pictureUrl) {
                        const avatar = document.getElementById("volunteerAvatar");
                        avatar.src = profile.pictureUrl;
                        avatar.style.display = "inline-block";
                    }
                } else {
                    document.getElementById("volunteerName").innerText = "æœªç™»å…¥";
                }
                loadRecords();
            } catch (err) { console.error(err); loadRecords(); }
        }

        function getFutureDate(daysAdd, timeStr) {
            const date = new Date();
            date.setDate(date.getDate() + daysAdd);
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd} ${timeStr}`;
        }

        async function loadRecords() {
            try {
                // ä¿ç•™æ‚¨çš„ 20 ç­†å‡è³‡æ–™
                const fakeData = [
                    { event_id: '1', schedule_note: 'è‡ºå¤§é†«é™¢å›è¨º', schedule_time: getFutureDate(0, '09:00'), remark: 'è¨˜å¾—å¸¶å¥ä¿å¡', repeat: 'none', reminder_method: 'day' },
                    { event_id: '2', schedule_note: 'å¾©å¥æ²»ç™‚', schedule_time: getFutureDate(3, '14:30'), remark: 'å·¦è‚©ç†±æ•·', repeat: 'weekly', reminder_method: '1h' },
                    { event_id: '3', schedule_note: 'çœ¼ç§‘æª¢æŸ¥', schedule_time: getFutureDate(15, '10:00'), remark: 'å®šæœŸè¿½è¹¤ç™½å…§éšœ', repeat: 'none', reminder_method: 'day' },
                    { event_id: '4', schedule_note: 'é ˜æ…¢æ€§è™•æ–¹ç®‹', schedule_time: getFutureDate(20, '09:30'), remark: 'å»æ¨“ä¸‹è—¥å±€', repeat: 'monthly', reminder_method: 'day' },
                    { event_id: '5', schedule_note: 'è·Ÿå­«å­è¦–è¨Š', schedule_time: getFutureDate(1, '20:00'), remark: 'ç”¨LINEæ‰“é›»è©±', repeat: 'weekly', reminder_method: '30min' },
                    { event_id: '6', schedule_note: 'è€å‹èšé¤', schedule_time: getFutureDate(5, '11:30'), remark: 'åœ¨æµ·éœ¸ç‹', repeat: 'none', reminder_method: 'day' },
                    { event_id: '7', schedule_note: 'ç¤¾å€æ­Œå”±ç­', schedule_time: getFutureDate(8, '14:00'), remark: 'ç·´å”±è€æ­Œ', repeat: 'weekly', reminder_method: '1h' },
                    { event_id: '8', schedule_note: 'å®¶åº­èšæœƒ', schedule_time: getFutureDate(12, '18:00'), remark: 'å…’å­ä¸€å®¶å›ä¾†', repeat: 'none', reminder_method: 'day' },
                    { event_id: '9', schedule_note: 'å…¬åœ’æ•£æ­¥', schedule_time: getFutureDate(0, '16:30'), remark: 'ç´„è€æä¸€èµ·', repeat: 'daily', reminder_method: 'none' },
                    { event_id: '10', schedule_note: 'è¶…å¸‚è²·èœ', schedule_time: getFutureDate(2, '08:30'), remark: 'è²·é›è›‹ã€ç‰›å¥¶ã€æ°´æœ', repeat: 'none', reminder_method: 'none' },
                    { event_id: '11', schedule_note: 'æ›¸æ³•èª²', schedule_time: getFutureDate(6, '14:00'), remark: 'ç¤¾å€ä¸­å¿ƒ2æ¨“', repeat: 'weekly', reminder_method: '1h' },
                    { event_id: '12', schedule_note: 'å‰ªé ­é«®', schedule_time: getFutureDate(10, '10:30'), remark: 'é ç´„å°ç¾è¨­è¨ˆå¸«', repeat: 'none', reminder_method: '1h' },
                    { event_id: '13', schedule_note: 'å€’åƒåœ¾', schedule_time: getFutureDate(1, '19:00'), remark: 'åˆ†é¡å›æ”¶æ—¥', repeat: 'weekly', reminder_method: '0min' },
                    { event_id: '14', schedule_note: 'ç¹³æ°´é›»è²»', schedule_time: getFutureDate(4, '09:00'), remark: 'å»è¶…å•†ç¹³', repeat: 'monthly', reminder_method: 'day' },
                    { event_id: '15', schedule_note: 'éŠ€è¡Œè¾¦äº‹', schedule_time: getFutureDate(9, '13:30'), remark: 'åˆ·å­˜æ‘º', repeat: 'none', reminder_method: 'none' },
                    { event_id: '16', schedule_note: 'ä¿®æ°´é¾é ­', schedule_time: getFutureDate(18, '15:00'), remark: 'å¸«å‚…æœƒä¾†', repeat: 'none', reminder_method: '1h' },
                    { event_id: '17', schedule_note: 'é‡è¡€å£“', schedule_time: getFutureDate(0, '08:00'), remark: 'è¨˜éŒ„åœ¨ç­†è¨˜æœ¬', repeat: 'daily', reminder_method: 'none' },
                    { event_id: '18', schedule_note: 'æœç”¨ç¶­ä»–å‘½', schedule_time: getFutureDate(0, '12:30'), remark: 'é£¯å¾Œåƒ', repeat: 'daily', reminder_method: 'none' },
                    { event_id: '19', schedule_note: 'å¹´åº¦å¥åº·æª¢æŸ¥', schedule_time: getFutureDate(25, '08:00'), remark: 'å‰æ™šè¦ç©ºè…¹', repeat: 'yearly', reminder_method: 'day' },
                    { event_id: '20', schedule_note: 'è—¥å¸«è«®è©¢', schedule_time: getFutureDate(22, '10:00'), remark: 'è©¢å•ä¿å¥é£Ÿå“', repeat: 'none', reminder_method: 'day' }
                ];

                const now = new Date();
                const events = fakeData
                    .filter(item => new Date(item.schedule_time) >= now)
                    .map(item => ({
                        id: item.event_id,
                        title: item.schedule_note,
                        start: item.schedule_time.replace(' ', 'T'),
                        extendedProps: { note: item.remark, repeat: item.repeat, reminder: item.reminder_method || "none" }
                    }));

                calendar.removeAllEvents();
                calendar.addEventSource(events);
            } catch (e) { console.error(e); }
        }

        function openDayView(dateStr) {
            selectedDateStr = dateStr;
            const titleEl = document.getElementById('dayViewTitle');
            const listEl = document.getElementById('dayEventList');
            titleEl.innerText = `${dateStr} è¡Œç¨‹ä¸€è¦½`;
            listEl.innerHTML = ''; 

            const dayEvents = calendar.getEvents().filter(e => {
                const d = e.start;
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` === dateStr;
            }).sort((a, b) => a.start - b.start);

            if (dayEvents.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">æœ¬æ—¥å°šç„¡å®‰æ’è¡Œç¨‹</div>';
            } else {
                dayEvents.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.innerHTML = `
                        <span class="event-time">${e.start.toTimeString().substring(0, 5)}</span>
                        <div class="event-info">
                            <div class="event-title">${e.title}</div>
                            <div class="event-note">${e.extendedProps.note || ''}</div>
                        </div>
                        <span style="color:#ccc;">â¯</span>
                    `;
                    item.onclick = () => { closeModal('dayViewModal'); openModal(true, e); };
                    listEl.appendChild(item);
                });
            }
            document.getElementById('dayViewModal').style.display = 'block';
        }

        function openAddFromDayView() { closeModal('dayViewModal'); openModal(false, selectedDateStr); }

        document.getElementById("saveBtn").onclick = async function() {
            const payload = {
                elder_user_id: userId, elder_name: userName,
                schedule_time: `${document.getElementById("date").value} ${document.getElementById("time").value}`,
                schedule_note: document.getElementById("event").value,
                remark: document.getElementById("note").value,
                repeat: document.getElementById("repeat").value,
                reminder_method: document.getElementById("reminder").value 
            };
            const url = isEditing ? `https://supabase-api-six.vercel.app/schedules/elder/${userId}/${currentEventId}` : "https://supabase-api-six.vercel.app/schedules";
            const res = await fetch(url, { method: isEditing ? "PATCH" : "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            if (res.ok) { closeModal('dataModal'); loadRecords(); }
        };

        document.getElementById("deleteBtn").onclick = async function() {
            if (!confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
            const res = await fetch(`https://supabase-api-six.vercel.app/schedules/elder/${userId}/${currentEventId}`, { method: "DELETE" });
            if (res.ok) { closeModal('dataModal'); loadRecords(); }
        };

        function openModal(editMode, data) {
            isEditing = editMode;
            document.getElementById("dataModal").style.display = "block";
            document.getElementById("deleteBtn").style.display = editMode ? "inline-block" : "none";
            document.getElementById("modalTitle").innerText = editMode ? "ç·¨è¼¯è¡Œç¨‹" : "æ–°å¢è¡Œç¨‹";
            
            if (editMode) {
                currentEventId = data.id;
                const d = data.start;
                document.getElementById("date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                document.getElementById("time").value = d.toTimeString().substring(0,5);
                document.getElementById("event").value = data.title;
                document.getElementById("note").value = data.extendedProps.note || "";
                document.getElementById("repeat").value = data.extendedProps.repeat || "none";
                document.getElementById("reminder").value = data.extendedProps.reminder || "none";
            } else {
                document.getElementById("dataForm").reset();
                if (typeof data === 'string') document.getElementById("date").value = data;
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        document.getElementById("fabAdd").onclick = () => openModal(false);
        
        // é»æ“ŠèƒŒæ™¯é—œé–‰
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = "none";
            }
        };
    </script>
</body>
</html>