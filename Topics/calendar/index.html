<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>行事曆</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f9fb; 
            color: #222; 
            padding-bottom: 80px;
        }
        
        /* --- 導覽列 --- */
        .nav-1 { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 12px 20px; background: #fff; border-bottom: 1px solid #ddd; 
            position: sticky; top: 0; z-index: 1001; 
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            height: 60px;
        }
        .nav-1 h1 { font-size: 20px; margin: 0; }
        
        /* 修改 cursor 讓使用者知道可以點擊 */
        .volunteer-area {
            display: flex; align-items: center; gap: 8px; 
            max-width: 50%;
        }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #0984e3; display: none; cursor: pointer; }
        #volunteerName { 
            font-size: 16px; font-weight: bold; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer;
        }
        
        .container { 
            max-width: 1200px; width: 100%; margin: 0 auto; 
            background: #ffffff; padding: 20px 0 40px 0; 
            min-height: calc(100vh - 60px);
        }

        #calendar-container { background: #ffffff; padding: 0 10px; }

        /* --- FullCalendar Header --- */
        .fc-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 5px; margin-bottom: 20px !important;
        }
        .fc-toolbar-title { font-size: 1.25em !important; font-weight: bold; color: #2c3e50; }
        .fc-button {
            padding: 8px 12px !important; font-size: 0.95em !important;
            border-radius: 8px !important; font-weight: bold !important;
        }
        .fc-button-active { background-color: #2c3e50 !important; border-color: #2c3e50 !important; }
        .fc-theme-standard .fc-scrollgrid { border: none !important; }
        .fc-theme-standard td, .fc-theme-standard th { border: none !important; border-bottom: 1px solid #f0f0f0 !important; }
        
        .fc-daygrid-day-top {
            display: flex !important; justify-content: center !important; 
            flex-direction: row !important; padding-top: 8px !important; padding-bottom: 4px !important;
        }
        .fc-daygrid-day-number { font-size: 15px; color: #555; text-decoration: none !important; }
        .fc-daygrid-day-frame { min-height: 110px !important; padding-bottom: 5px; }

        .fc-daygrid-event { 
            background-color: #79f2c0 !important; border: none !important; border-radius: 4px !important; 
            color: #2c3e50 !important; padding: 3px 6px !important; margin: 2px 4px 2px 4px !important; 
            font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; 
        }
        .fc-daygrid-more-link {
            display: block; text-align: center; font-weight: 900; font-size: 20px; 
            color: #aaa !important; text-decoration: none !important; line-height: 16px; 
            margin-top: 4px; cursor: pointer; padding-bottom: 5px;
        }

        .fab { position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px; background: #4a90e2; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; z-index: 999; }
        
        /* Modal & Form Styling */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 2000; overflow-y: auto; }
        .modal-content { background: #fff; width: 90%; max-width: 420px; margin: 50px auto; padding: 25px 20px 25px; border-radius: 16px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        .close-btn { position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; background-color: #f37a7a; color: white; border-radius: 50%; border: none; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- 優化標籤樣式 --- */
        label { 
            display: flex; align-items: center; font-weight: 600; 
            margin-bottom: 6px; margin-top: 15px; 
            color: #444; font-size: 15px; 
        }
        
        label i {
            margin-right: 10px; width: 24px; text-align: center;
            color: #666; font-size: 16px;
        }

        input[type="text"], input[type="date"], input[type="time"], select { 
            width: 100%; padding: 12px 12px; margin: 0; 
            border-radius: 10px; border: 1px solid #ddd; 
            font-size: 16px; background-color: #fdfdfd;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none; border-color: #4a90e2; background-color: #fff;
        }
        
        .event-item { padding: 12px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; cursor: pointer; overflow: hidden; }
        .event-time { font-weight: bold; color: #4a90e2; margin-right: 12px; min-width: 50px; flex-shrink: 0; }
        .event-info { flex: 1; min-width: 0; }
        .event-title { font-size: 16px; color: #333; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .event-note { font-size: 14px; color: #888; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .btn { padding: 12px; border: none; border-radius: 12px; color: #fff; cursor: pointer; font-size: 16px; width: 100%; margin-top: 25px; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold; }
        #saveBtn { background: #4a90e2; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3); }
        #deleteBtn { background: #ff7675; box-shadow: 0 4px 10px rgba(255, 118, 117, 0.3); }
    </style>
</head>
<body>
    <nav class="nav-1">
        <h1>行事曆</h1>
        <div class="volunteer-area">
            <img id="volunteerAvatar" class="avatar" src="" alt="avatar" />
            <span id="volunteerName">載入中</span>
        </div>
    </nav>

    <div class="container">
        <div id="calendar-container"><div id="calendar"></div></div>
    </div>

    <div class="fab" id="fabAdd"><i class="fas fa-plus"></i></div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('dataModal')"><i class="fas fa-times"></i></button>
            <h3 id="modalTitle" style="margin-bottom:10px; font-size: 1.3em;">新增行程</h3>
            <form id="dataForm">
                <label><i class="fa-regular fa-calendar-days"></i> 日期</label>
                <input type="date" id="date" required>
                
                <label><i class="fa-regular fa-clock"></i> 時間</label>
                <input type="time" id="time" required>
                
                <label><i class="fa-solid fa-pen"></i> 行程內容</label>
                <input type="text" id="event" placeholder="例如：看醫生 (限 25 字)" maxlength="25">
                
                <label><i class="fa-regular fa-comment-dots"></i> 備註</label>
                <input type="text" id="note" placeholder="備註事項 (限 25 字)" maxlength="25">
                
                <label><i class="fa-solid fa-rotate"></i> 重複</label>
                <select id="repeat">
                    <option value="none">不重複</option>
                    <option value="daily">每天</option>
                    <option value="weekly">每週</option>
                    <option value="monthly">每月</option>
                    <option value="yearly">每年</option>
                </select>
                
                <label><i class="fa-regular fa-bell"></i> 提醒類型</label>
                <select id="reminder">
                    <option value="none">無</option>
                    <option value="0min">當下提醒</option>
                    <option value="30min">30 分鐘前</option>
                    <option value="1h">1 小時前</option>
                    <option value="day">1 天前</option>
                </select>
                
                <div style="display: flex; gap: 15px;">
                    <button type="button" class="btn" id="saveBtn" style="flex: 1;"><i class="fas fa-check"></i> 儲存</button>
                    <button type="button" class="btn" id="deleteBtn" style="flex: 1; display:none;"><i class="fas fa-trash-alt"></i> 刪除</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dayViewModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('dayViewModal')"><i class="fas fa-times"></i></button>
            <h3 id="dayViewTitle" style="margin-bottom: 15px; border-bottom: 2px solid #4a90e2; padding-bottom: 10px;"></h3>
            <div id="dayEventList" style="max-height: 300px; overflow-y: auto;"></div>
            <div style="margin-top: 15px;">
                <button type="button" class="btn" onclick="openAddFromDayView()" style="background: #4a90e2; width: 100%;">
                    <i class="fas fa-plus-circle"></i> 在此日新增
                </button>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008484068-Kp57RrAr"; 
        let userId = ""; 
        let userName = ""; 
        let identify = ""; // [新增] 用來儲存身分 (志工/長者)
        let calendar, isEditing = false, currentEventId = null, selectedDateStr = "";
        
        // 基礎 API 路徑 (用來做 CRUD 行程)
        const SCHEDULE_API_URL = "https://supabase-api-six.vercel.app/schedules";
        // 驗證 API 路徑 (用來確認身分)
        const IDENTIFY_API_BASE = "https://supabase-api-six.vercel.app/identify";

        document.addEventListener('DOMContentLoaded', function() {
            // (Calendar 初始化保持不變)
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', 
                locale: 'zh-tw', 
                height: 'auto', 
                headerToolbar: { 
                    left: 'prev,next', 
                    center: 'title', 
                    right: 'dayGridMonth,listMonth' 
                },
                buttonText: {
                    dayGridMonth: '月曆',
                    listMonth: '列表顯示',
                    today: '今天'
                },
                dayHeaderFormat: { weekday: 'narrow' },
                dayCellContent: (arg) => arg.dayNumberText.replace('日', ''),
                titleFormat: function(info) {
                    const date = info.date.marker;
                    return `${date.getFullYear()}年 ${date.getMonth() + 1}月`;
                },
                dayMaxEvents: 2, 
                moreLinkContent: '...', 
                moreLinkClick: function(info) {
                    const dateStr = info.date.toISOString().split('T')[0];
                    openDayView(dateStr);
                    return 'none'; 
                },
                dateClick: (info) => openDayView(info.dateStr),
                eventClick: (info) => openModal(true, info.event)
            });
            calendar.render();
            initLiff();
        });

        async function initLiff() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                // [新增] 取得 DOM 元素
                const avatarEl = document.getElementById("volunteerAvatar");
                const nameEl = document.getElementById("volunteerName");

                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userId = profile.userId; 
                    userName = profile.displayName; 
                    nameEl.innerText = userName;
                    if (profile.pictureUrl) {
                        avatarEl.src = profile.pictureUrl; 
                        avatarEl.style.display = "inline-block";
                    }

                    // [新增] 呼叫 API 確認身分 (取得 identify)
                    try {
                        const idRes = await fetch(`${IDENTIFY_API_BASE}/${userId}`);
                        const idData = await idRes.json();
                        if(idData.success) {
                            identify = idData.role; // 例如 "志工" 或 "長者"
                            console.log("使用者身分:", identify);
                        }
                    } catch(e) {
                        console.error("身分驗證失敗", e);
                    }

                    // 載入行程
                    loadRecords();

                } else {
                    nameEl.innerText = "未登入";
                    // 若未登入，點擊時會由下方的 EventListener 觸發登入
                }

                //大頭貼跳傳頁面設定
                avatarEl &&
                    avatarEl.addEventListener("click", () => {
                    if (liff.isLoggedIn()) {
                        localStorage.setItem("fromPage", "calendar");
                        switch (identify) {
                        case "志工":
                            window.location.href =
                            "../../Login-or-register/志工資料顯示.html";
                            break;
                        case "長者":
                            window.location.href =
                            "../../Login-or-register/長輩資料顯示.html";
                            break;
                        default:
                            // "未註冊" 或 undefined 都導往登入
                            window.location.href = "../../Login-or-register/index.html";
                        }
                    } else {
                        liff.login({ redirectUri: window.location.href });
                    }
                    });

                nameEl &&
                    nameEl.addEventListener("click", () => {
                    if (!liff.isLoggedIn()) {
                        liff.login({ redirectUri: window.location.href });
                    } else {
                        alert("已登入：" + (nameEl.innerText || "使用者"));
                    }
                    });
            } catch (err) { 
                console.error("LIFF error", err); 
            }
        }

        async function loadRecords() {
            try {
                const res = await fetch(`${SCHEDULE_API_URL}/elder/${userId}`);
                const result = await res.json();
                if (result.success && Array.isArray(result.data)) {
                    const events = result.data.map(item => ({
                        id: item.event_id,
                        title: item.schedule_note,
                        start: item.schedule_time, 
                        extendedProps: {
                            note: item.remark,
                            repeat: item.repeat,
                            reminder: item.reminder_method
                        }
                    }));
                    calendar.removeAllEvents(); 
                    calendar.addEventSource(events);
                }
            } catch (e) { console.error(e); }
        }

        // (CRUD 操作保持不變，注意 API URL 變數名稱修正為 SCHEDULE_API_URL)
        document.getElementById("saveBtn").onclick = async function() {
            const dateVal = document.getElementById("date").value;
            const timeVal = document.getElementById("time").value;
            if(!dateVal || !timeVal) { alert("請填寫日期時間"); return; }
            const scheduleTime = `${dateVal}T${timeVal}`; 

            const payload = {
                schedule_time: scheduleTime,
                schedule_note: document.getElementById("event").value,
                remark: document.getElementById("note").value,
                repeat: document.getElementById("repeat").value,
                reminder_method: document.getElementById("reminder").value 
            };

            let url, method;
            if (isEditing) {
                url = `${SCHEDULE_API_URL}/elder/${userId}/${currentEventId}`;
                method = "PATCH";
            } else {
                url = SCHEDULE_API_URL;
                method = "POST";
                payload.elder_user_id = userId;
                payload.elder_name = userName; 
            }

            try {
                const res = await fetch(url, { 
                    method: method, 
                    headers: { "Content-Type": "application/json" }, 
                    body: JSON.stringify(payload) 
                });
                if (res.ok) { 
                    alert(isEditing ? "更新成功" : "新增成功"); 
                    closeModal('dataModal'); 
                    loadRecords(); 
                } else { alert("儲存失敗"); }
            } catch (err) { alert("連線錯誤"); }
        };

        document.getElementById("deleteBtn").onclick = async function() {
            if (!confirm("確定刪除？")) return;
            const url = `${SCHEDULE_API_URL}/elder/${userId}/${currentEventId}`;
            try {
                const res = await fetch(url, { method: "DELETE" });
                if (res.ok) { alert("已刪除"); closeModal('dataModal'); loadRecords(); }
            } catch (err) { alert("連線錯誤"); }
        };

        // (其他 UI 函式保持不變)
        function openDayView(dateStr) {
            selectedDateStr = dateStr;
            const listEl = document.getElementById('dayEventList');
            const dateParts = dateStr.split('-');
            const formattedDate = `${dateParts[0]}年${dateParts[1]}月${dateParts[2]}日`;
            
            document.getElementById('dayViewTitle').innerText = formattedDate;
            listEl.innerHTML = ''; 
            const dayEvents = calendar.getEvents().filter(e => {
                if (!e.start) return false;
                const d = e.start;
                const eStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                return eStr === dateStr;
            }).sort((a, b) => a.start - b.start);

            if (dayEvents.length === 0) {
                listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">本日無行程</div>';
            } else {
                dayEvents.forEach(e => {
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    const timeStr = e.start.toTimeString().substring(0, 5);
                    item.innerHTML = `
                        <span class="event-time">${timeStr}</span>
                        <div class="event-info">
                            <div class="event-title">${e.title || '(無標題)'}</div>
                            <div class="event-note">${e.extendedProps.note || ""}</div>
                        </div>`;
                    item.onclick = () => { closeModal('dayViewModal'); openModal(true, e); };
                    listEl.appendChild(item);
                });
            }
            document.getElementById('dayViewModal').style.display = 'block';
        }

        function openAddFromDayView() { closeModal('dayViewModal'); openModal(false, selectedDateStr); }
        function closeModal(modalId) { document.getElementById(modalId).style.display = "none"; }
        function openModal(editMode, data) {
            isEditing = editMode; 
            document.getElementById("dataModal").style.display = "block";
            document.getElementById("deleteBtn").style.display = editMode ? "block" : "none";
            document.getElementById("modalTitle").innerText = editMode ? "編輯行程" : "新增行程";
            
            if (editMode) {
                currentEventId = data.id; 
                const d = data.start;
                if(d) {
                    document.getElementById("date").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    document.getElementById("time").value = d.toTimeString().substring(0,5);
                }
                document.getElementById("event").value = data.title;
                document.getElementById("note").value = data.extendedProps.note || "";
                document.getElementById("repeat").value = data.extendedProps.repeat || "none";
                document.getElementById("reminder").value = data.extendedProps.reminder || "none";
            } else {
                document.getElementById("dataForm").reset();
                if (typeof data === 'string') document.getElementById("date").value = data;
            }
        }
        document.getElementById("fabAdd").onclick = () => openModal(false);
    </script>
</body>
</html>