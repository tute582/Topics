<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¡Œäº‹æ›†</title>
  <style>
  /* å…¨åŸŸè¨­å®š */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: "Arial", sans-serif;
    padding: 0;
    background: #ffffff;
    color: #222;
  }

  /* å°è¦½åˆ— */
  .nav-1{
    display:flex; 
    align-items:center; 
    justify-content:space-between;
    padding:10px 25px; 
    position:sticky; 
    top:0; 
    z-index:1001;
    width:100%; 
    background:#fff; 
    border-bottom:1px solid #ddd;
  }

  h1{ 
    margin:0; 
    font-size:28px; }

  h2{ 
    margin:5px 0; 
    font-size:24px; 
    display:inline-block;
    padding: 0 5px;
    }

  h3{ 
    margin:0; 
    text-align:center; 
    font-size:20px; }

  /* èª¿æ•´ï¼šè®“è¡¨å–®èˆ‡è¡¨æ ¼å·¦å³å°é½Šä¸¦ç§»é™¤ table å›ºå®š min-width */
  .div-b {
    width:100%; 
    max-width:800px; 
    margin: 0; 
    padding: 0 20px 0;
  }

  form {
    margin: 10px 0; /* ç§»é™¤å·¦å³ 18px å¤–è·ï¼Œæ”¹ç”¨å®¹å™¨å…§è·å°é½Š */
    padding: 18px; 
    border-radius:16px; 
    background:#fff;
    border:1px solid #ccc;
  }

  label { 
    display:block; 
    margin-top:0; 
    font-size:20px; }

  input[type="text"], input[type="date"], input[type="time"], textarea,
  #editModal input, #editModal textarea {
    width:100%; 
    padding:8px; 
    margin-top:6px; 
    margin: 5 0 15px;
    border-radius:8px; 
    border:1px solid #ccc;
    font-size:16px; 
    background:#fff;
  }

  .btn {
    margin-top:12px; padding:10px 18px; border:none; border-radius:12px; color:#fff; cursor:pointer;
    font-size:16px;
  }
  #addBtn{ background:#4a90e2; } #historyBtn{ background:#f39c12; margin-left:8px; }

  /* è¡¨æ ¼å®¹å™¨ï¼šå¯æ©«å‘æ»¾å‹•ï¼Œä¸¦åœ¨ç„¡è³‡æ–™æ™‚éš±è—ï¼ˆJS æ§åˆ¶é¡¯ç¤ºï¼‰ */
  .allTable-div, .table-container {
    width:100%; 
    margin:10px 0 17px 0; 
    overflow-x:auto; 
    overflow-y: auto;
    -webkit-overflow-scrolling:touch;
    border: none; /* â† æ”¹æˆæ²’æœ‰å¤–æ¡†ç·š */
    border-radius:20px; 
    background:white;
    display:none;
    padding: none; /* èˆ‡ form å…§è·ä¸€è‡´ï¼Œè®“å…§å®¹åˆ—å°é½Š */
    box-sizing: border-box;
  }

  .allTable-div table, table {
    width:100%; 
    border-collapse:collapse; 
    min-width:800px; /* â† æ”¹ç‚º 800pxï¼Œçª„è¢å¹•æœƒå‡ºç¾æ©«å‘æ²å‹•ï¼Œèˆ‡çœ‹è¨ºè³‡è¨Šä¸€è‡´ */
    font-size:14px;
    background:transparent;
  }

  th, td {
    padding:10px; 
    text-align:center; 
    border:1px solid #e6e6e6; 
    white-space:nowrap;
  }
  th { 
    background:#f9f9f9; 
    position:sticky; 
    top:0; 
    z-index:2; }

  tbody tr:nth-child(even){ background:#f9f9f9; }
  tbody tr:nth-child(odd){ background:#fff; }

  /* è¡¨æ ¼åœ“è§’è™•ç†ç”±å¤–å±¤å®¹å™¨è² è²¬ */
  .allTable-div thead tr th:first-child { border-top-left-radius:14px; }
  .allTable-div thead tr th:last-child { border-top-right-radius:14px; }
  .allTable-div tbody tr:last-child td:first-child { border-bottom-left-radius:14px; }
  .allTable-div tbody tr:last-child td:last-child { border-bottom-right-radius:14px; }

  /* Modal å…±ç”¨æ¨£å¼ */
  #editModal, #historyModal, #pastModal {
    display:none; 
    position:fixed; 
    top:0; left:0; 
    width:100%; 
    height:100%;
    background:rgba(0,0,0,0.5); 
    z-index:1000;
  }
  #editModal > div, #historyModal > div, #pastModal > div {
    background:#fff; 
    width:420px; 
    max-width:calc(100% - 40px);
    margin:80px auto; 
    padding:18px; 
    border-radius:12px; 
    position:relative;
    box-sizing:border-box; 
    max-height:calc(100vh - 120px); 
    overflow-y:auto;
  }
  .close-btn { position:absolute; 
    top:10px; right:10px; 
    background:transparent; 
    border:none; font-size:26px; 
    cursor:pointer; color:#666; }
    
  .close-btn:hover{ color:#000; }

  /* æŒ‰éˆ•æ¨£å¼ï¼ˆModalï¼‰ */
  #saveEditBtn, #deleteEditBtn {
    margin-top:10px; font-size:16px; padding:8px 15px;
    border-radius:10px; border:none; cursor:pointer;
  }
  #saveEditBtn { background-color:#4a90e2; color:white; }
  #saveEditBtn:hover { background-color:#357abd; }
  #deleteEditBtn { background-color:#f37a7a; color:white; }
  #deleteEditBtn:hover { background-color:#d94a4a; }

  .but-ans { padding:6px 10px; border-radius:8px; border:none; cursor:pointer; background:#61aaf3; color:#fff; }

    .record-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
    }

  /* volunteer area */
  .volunteer-area { display:flex; align-items:center; gap:8px; }
  .volunteer-area .avatar { width:36px; height:36px; border-radius:50%; object-fit:cover; border:1px solid #ddd; display:none; }
  .volunteer-area #volunteerName { cursor:pointer; padding:4px 8px; border-radius:6px; font-size:18px; }

  /* å°è¢å¹•éŸ¿æ‡‰å¼ */
  @media (max-width: 768px) {
    .div-b { 
      padding: 20px; 
      max-width:100%; }

    form { padding:14px; }

    input[type="text"], input[type="date"], input[type="time"], textarea { 
      padding:10px; 
      border-radius:10px; }
    .allTable-div table { min-width:0; width:100%; } /* åœ¨æ‰‹æ©Ÿä¸Šå…è¨±è¡¨æ ¼ç¸®æ”¾ä¸¦å‡ºç¾æ©«å‘æ»¾å‹• */
    th, td { padding:10px 8px;  white-space:normal; }
    .btn, button { padding:10px 14px;  }
    
    
  }

  /* æ›´çª„è¢å¹•å¾®èª¿ */
  @media (max-width: 600px) {
    .btn { padding:8px 12px; }
    #editModal > div, #historyModal > div, #pastModal > div { margin:60px auto; padding:12px; }
    .volunteer-area .avatar { width:32px; height:32px; }
  }
  </style>
</head>
<body>
  <nav class="nav-1">
    <div> 
  <h1 style="margin: 0; font-size: 28px;">è¡Œäº‹æ›†</h1>
    </div>
    <div style="display:flex; align-items:center;">
    <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥" style="cursor:pointer; font-size: 26px;">è¼‰å…¥ä¸­</span>
      </span>
    </h1>
  </div>
  </nav>
  <div class="div-b">
    <h2>è¼¸å…¥å…§å®¹</h2>
    <form id="dataForm" onsubmit="return false;">
      <label>æ—¥æœŸ</label>
      <input type="date" id="date" placeholder="ä¾‹å¦‚(ä¾‹ï¼š2025-10-02)" />
      <label>æ™‚é–“</label>
      <input type="time" id="time" placeholder="ä¾‹å¦‚ï¼š09:00" />
      <label>è¡Œç¨‹å…§å®¹</label>
      <input type="text" maxlength="25"  id="event" placeholder="é™25å­—"/>
      <label>å‚™è¨»</label>
      <input type="text"  maxlength="25"  id="note" placeholder="é™25å­—"/>
      
      <!-- æ–°å¢ï¼šé‡è¤‡ / æé†’æ–¹å¼ ä¸‹æ‹‰é¸å–® -->
      <label>é‡è¤‡</label>
      <select id="repeat" style="width:100%; padding:8px; margin:5px 0 15px; border-radius:8px; border:1px solid #ccc; font-size:16px;">
        <option value="none">ä¸é‡è¤‡</option>
        <option value="daily">æ¯å¤©</option>
        <option value="weekly">æ¯é€±</option>
        <option value="monthly">æ¯æœˆ</option>
        <option value="yearly">æ¯å¹´</option>
      </select>

      <label>æé†’é¡å‹</label>
      <select id="reminder" style="width:100%; padding:8px; margin:5px 0 15px; border-radius:8px; border:1px solid #ccc; font-size:16px;">
        <option value="none">ç„¡</option>
          <option value="0min">ç•¶ä¸‹æé†’</option>
          <option value="30min">30åˆ†é˜å‰</option>
          <option value="1h">1å°æ™‚å‰</option>
          <option value="day">1å¤©å‰</option>
      </select>

      <button type="button" class="btn" id="addBtn">æ–°å¢</button>
      <button type="button" class="btn" id="historyBtn">æª¢è¦–éå¾€ç´€éŒ„</button>
    </form>
  
    <h2>å³å°‡åˆ°ä¾†çš„è¡Œç¨‹</h2>

    <!-- æ–°å¢ï¼šç„¡è³‡æ–™æ™‚é¡¯ç¤ºçš„è¨Šæ¯ -->
    <div id="no-record-msg" class="no-record" >ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>

    <!-- æ‰€æœ‰è³‡æ–™çš„è¡¨æ ¼ -->
    <div class="allTable-div">
      <table id="allTable">
        <thead>
          <tr>
          <th>æ—¥æœŸ</th>
          <th>æ™‚é–“</th>
          <th>è¡Œç¨‹å…§å®¹</th>
          <th>å‚™è¨»</th>
          <th>é‡è¤‡</th>
          <th>æé†’é¡å‹</th>
          <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ç·¨è¼¯ç”¨ Modal -->
  <div id="editModal">
    <div>
      <button id="closeEditModalBtn" class="close-btn" type="button">&times;</button>

      <h3>ç·¨è¼¯è¡Œç¨‹</h3>
      <form id="editForm" onsubmit="return false;">
        <label>æ—¥æœŸ</label>
        <input type="date" id="editDate" /><br />
        <label>æ™‚é–“</label>
        <input type="time" id="editTime" /><br />
        <label>è¡Œç¨‹å…§å®¹</label>
        <input type="text" id="editEvent" /><br />
        <label>å‚™è¨»</label>
        <input type="text" id="editNote" /><br />

        <!-- æ–°å¢ï¼šç·¨è¼¯ç”¨çš„é‡è¤‡ / æé†’æ–¹å¼ -->
        <label>é‡è¤‡</label>
        <select id="editRepeat" style="width:100%; padding:8px; margin:5px 0 15px; border-radius:8px; border:1px solid #ccc; font-size:16px;">
          <option value="none">ä¸é‡è¤‡</option>
          <option value="daily">æ¯å¤©</option>
          <option value="weekly">æ¯é€±</option>
          <option value="monthly">æ¯æœˆ</option>
          <option value="yearly">æ¯å¹´</option>
        </select>

        <label>æé†’é¡å‹</label>
        <select id="editReminder" style="width:100%; padding:8px; margin:5px 0 15px; border-radius:8px; border:1px solid #ccc; font-size:16px;">
          <option value="none">ç„¡</option>
          <option value="0min">ç•¶ä¸‹æé†’</option>
          <option value="30min">30åˆ†é˜å‰</option>
          <option value="1h">1å°æ™‚å‰</option>
          <option value="day">1å¤©å‰</option>
        </select>

        <div class="edit-actions">
          <button type="button" id="saveEditBtn">å„²å­˜ä¿®æ”¹</button>
          <button type="button" id="deleteEditBtn">åˆªé™¤</button>
        </div>
      </form>
    </div>
  </div>

  <!-- éå¾€ç´€éŒ„ Modal -->
  <div id="historyModal" style="display:none;">
    <div>
      <button id="closeHistoryModalBtn" class="close-btn" type="button">&times;</button>
      <h3>éå¾€ç´€éŒ„</h3>
      <div id="historyContent"></div>
    </div>
  </div>

  <!-- æ–°å¢ï¼šéå»æ™‚é–“æç¤º Modal -->
  <div id="pastModal" style="display:none;">
    <div>
      <button id="closePastModalBtn" class="close-btn" type="button">&times;</button>
      <h3>æ³¨æ„ â€” éå»çš„æ™‚é–“</h3>
      <p id="pastModalMessage" style="text-align:center; font-size:16px; margin-top:8px;"></p>
      <div style="text-align:center; margin-top:12px;">
        <button id="openHistoryFromPast" class="btn" style="background:#f39c12; color:#fff;">å‰å¾€æª¢è¦–éå¾€ç´€éŒ„</button>
      </div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ---- å…¨åŸŸè®Šæ•¸å®£å‘Š ----------------------------------------------------------------------------
    const bodyEl = document.body;
    const LIFF_ID = '2008484068-Kp57RrAr';
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");
    let userId = "";
    let userName ="";
    let records = "";
    let currentEditEventId = null;
    //åŸ·è¡ŒLIFFåˆå§‹åŒ–
    initLiffAndSetProfile();

    // ---- åˆå§‹åŒ–è¨­å®š ----------------------------------------------------------------------------
    //LIFF åˆå§‹åŒ–è¨­å®š
    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "æœªç™»å…¥";
          avatarEl.style.display = "none";
          return;
        }
        
        // âœ… å–å¾— LIFF profile
        const profile = await liff.getProfile();
        userId = profile.userId;
        userName = profile.displayName;
        console.log("LIFF Profile userId:", userId, "userName:", userName);

        // âœ… å–å¾— accessTokenï¼ˆå¯å‚³å›å¾Œç«¯ï¼‰
        const accessToken = liff.getAccessToken();
        console.log("accessToken:", accessToken);

        // âœ… è§£æ ID Tokenï¼ˆåŒ…å« LINE Login userIdï¼‰
        const decoded = liff.getDecodedIDToken();
        console.log("Decoded ID Token:", decoded);

        // âœ… é¡¯ç¤ºç•«é¢
        nameEl.innerText = profile.displayName || "å¿—å·¥";
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }

        //åŸ·è¡Œè³‡æ–™å…§å®¹åˆå§‹åŒ–
        loadRecords();
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    //ç•¶é ­åƒè¢«é»é¸
    avatarEl.addEventListener("click", () => {
      if (liff.isLoggedIn()) {
        // å·²ç™»å…¥å‰‡é€²å…¥è¨»å†Šé é¢ï¼ˆå¯æ”¹ç‚ºéœ€è¦çš„é é¢è·¯å¾‘ï¼‰
        window.location.href = "../../Login-or-register/index.html";
      } else {
        // ä½¿ç”¨ç•¶å‰é é¢ä½œç‚º redirectUriï¼Œé©ç”¨æ¡Œæ©Ÿ/å¹³æ¿/æ‰‹æ©Ÿ
        liff.login({ redirectUri: window.location.href });
      }
    });

    //ç•¶ä½¿ç”¨è€…åç¨±è¢«é»é¸
    nameEl.addEventListener("click", () => {
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
      }
    });

    //å­˜å–è³‡æ–™åº«"æŸä½é•·è€…"è¡Œç¨‹è³‡æ–™
    async function loadRecords() {
      try {
        const GET_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/schedules/elder/${userId}`;
        const response =await fetch(GET_SUPABASE_API_URL);
        const result =await response.json();
        console.log("è¡Œäº‹æ›†å–å¾—çš„Recordè¡Œç¨‹è³‡æ–™JSONï¼š/n",result);
        // å‡è¨­ API å›å‚³æ ¼å¼å¦‚é¡Œ
        const data = result.data || [];

        // è½‰æ›ç‚ºåŸæœ¬ records æ ¼å¼
        records = data.map(item => {
          const [date, timeFull] = item.schedule_time.split("T");
          const time = timeFull.substring(0, 5); // HH:mm å–å‰ 5 ç¢¼
          return {
            uuid: item.uuid,
            date: date,
            time: time,
            scheduleNote: item.schedule_note,
            elderName: item.elder_name,
            eventId: item.event_id,
            remark: item.remark,
            isReminded: item.is_reminded,
            repeat: item.repeat || 'none',
            reminderMethod: item.reminder_method || 'none'
          };
        });
        renderAllTable();
      } catch (error) {
        console.error("è¼‰å…¥è¡Œç¨‹è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
      }
    }

    // å–å¾—ç¾åœ¨æ™‚é–“
    function nowDate() { return new Date(); }

    // è§£ææ—¥æœŸæ™‚é–“
    function parseDateTime(dateStr, timeStr) {
      return new Date(`${dateStr}T${timeStr}:00`);
    }

    // æ ¼å¼åŒ–é¡¯ç¤ºï¼šé‡è¤‡ã€æé†’
    function formatRepeat(val) {
      switch ((val||'').toString()) {
        case 'daily': return 'æ¯å¤©';
        case 'weekly': return 'æ¯é€±';
        case 'monthly': return 'æ¯æœˆ';
        case 'yearly': return 'æ¯å¹´';
        case 'none': default: return 'ä¸é‡è¤‡';
      }
    }

    function formatReminder(val) {
      if (!val) return 'ç„¡';
      switch (val.toString()) {
        case '5min': return '5 åˆ†é˜å‰';
        case '10min': return '10 åˆ†é˜å‰';
        case '15min': return '15 åˆ†é˜å‰';
        case '30min': return '30 åˆ†é˜å‰';
        case '1h': return '1 å°æ™‚å‰';
        case '2h': return '2 å°æ™‚å‰';
        case 'day': return '1 å¤©å‰';
        case '2day': return '2 å¤©å‰';
        case 'week': return '1 é€±å‰';
        case 'none': default: return 'ç„¡';
      }
    }
    // æ¸²æŸ“æœªä¾†è¡Œç¨‹
    async function renderAllTable() {
      const tbody = document.querySelector("#allTable tbody");
      tbody.innerHTML = "";
      const now = nowDate();
      const noRecordEl = document.getElementById("no-record-msg");

      const tableWrapper = document.querySelector(".allTable-div");
      const tableEl = document.getElementById("allTable");
      const theadEl = tableEl.querySelector("thead");

      const upcomingRecords = records
        .filter(r => parseDateTime(r.date, r.time) >= now)
        .sort((a, b) => parseDateTime(a.date, a.time) - parseDateTime(b.date, b.time));

      if (upcomingRecords.length > 0) {
        tableWrapper.style.display = "block";
        tableEl.style.display = "table";
        theadEl.style.display = "table-header-group";
        if (noRecordEl) noRecordEl.style.display = "none";
      } else {
        document.getElementById("allTable").style.display = "none";
        if (noRecordEl) noRecordEl.style.display = "block";
      }

      upcomingRecords.forEach(record => {
        const repeatLabel = formatRepeat(record.repeat || record.repeat || 'none');
        const reminderLabel = formatReminder(record.reminderMethod || record.reminder || 'none');
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${record.date}</td>
          <td>${record.time}</td>
          <td>${escapeHtml(record.scheduleNote)}</td>
          <td>${escapeHtml(record.remark)}</td>
          <td>${escapeHtml(repeatLabel)}</td>
          <td>${escapeHtml(reminderLabel)}</td>
          <td><button data-id="${record.eventId}" class="but-ans edit-btn">ç·¨è¼¯</button></td>
        `;
      });

      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const eventId  = btn.getAttribute('data-id');
          openEditModalById(eventId);
        });
      });
    }

    // ---- è¡Œäº‹æ›†åŠŸèƒ½ ----------------------------------------------------------------------------
    // æ–°å¢
    document.getElementById("addBtn").addEventListener("click", async () => {
      const date = document.getElementById("date").value;
      const time = document.getElementById("time").value;
      const event = document.getElementById("event").value.trim();
      const note = document.getElementById("note").value.trim();
      const repeat = document.getElementById("repeat").value;
      const reminder = document.getElementById("reminder").value;

      if (!date || !time || !event) { 
        alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ï¼");
        return; 
      }

      const dt = parseDateTime(date, time);
      const now = nowDate();

      // è¡¨æ ¼é‡è£½
      document.getElementById("dataForm").reset();

      // --- POST åˆ°è³‡æ–™åº« ---
      let newEventId = null;   // æ–°å¢çš„ event_id

      try {
        const payload = {
          elder_user_id: userId,
          elder_name: userName,
          schedule_time: `${date} ${time}`,
          schedule_note: event,
          remark: note,
          repeat:repeat,
          reminder_method: reminder
        };

        const res = await fetch("https://supabase-api-six.vercel.app/schedules", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (!res.ok) {
          if (result.message == "ç¼ºå°‘é•·è€…ID") {
            console.error("âŒ ä¸Šå‚³å¤±æ•—:", result);
            alert("âš ï¸ è«‹é»æ“Šå³ä¸Šæ–¹[æœªç™»å…¥]ï¼Œç™»å…¥æ‚¨çš„LINEå¸³è™Ÿï¼Œç¢ºä¿è³‡æ–™æº–ç¢ºè¢«ä¿å­˜");
            return;
          }
          console.error("âŒ ä¸Šå‚³å¤±æ•—:", result);
          alert("âš ï¸ ä¸Šå‚³è³‡æ–™ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯ç¹«æœå‹™çª—å£ç¢ºèªï¼Œè¬è¬!");
          return;
        }

        console.log("ğŸ‰ æ–°å¢æˆåŠŸ", result);

        newEventId = result?.data?.event_id; // â† å¾ API å›å‚³å–å¾— eventId
        if (!newEventId) console.warn("âš  ç„¡æ³•å–å¾— event_id");

        // --- é‡è¦ï¼šä¸ GETï¼Œç›´æ¥ push åˆ°è¨˜æ†¶é«” ---
        records.push({
          eventId: newEventId,
          date,
          time,
          scheduleNote: event,
          remark: note,
          repeat:repeat,
          reminderMethod: reminder
        });

        renderAllTable(); // ç›´æ¥æ¸²æŸ“å³å¯ï¼

        // --- éå»æ™‚é–“è™•ç† ---
        if (dt < now) {
          const msgEl = document.getElementById("pastModalMessage");
          msgEl.textContent = `æ‚¨è¼¸å…¥çš„è³‡æ–™ (${date} ${time} - ${event}) å·²æ­¸åˆ°éå¾€ç´€éŒ„ã€‚`;
          document.getElementById("pastModal").style.display = "block";
          bodyEl.classList.add("modal-open");
        }
      } catch (err) {
        console.error("âŒ Supabase éŒ¯èª¤:", err);
        alert("âš ï¸ ç„¡æ³•é€£ç·šè³‡æ–™åº«");
        return;
      }
    });

    // é—œé–‰ç·¨è¼¯å½ˆçª—
    document.getElementById("closeEditModalBtn").addEventListener("click", () => {
      document.getElementById("editModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
    });

    // æ‰“é–‹ç·¨è¼¯ modalï¼ˆé€é event_idï¼‰
    function openEditModalById(eventId) {
      currentEditEventId = eventId;
      const idx = records.findIndex(r => r.eventId === eventId);
      if (idx === -1) return alert('æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™');

      const record = records[idx];

      document.getElementById("editDate").value = record.date;
      document.getElementById("editTime").value = record.time;
      document.getElementById("editEvent").value = record.scheduleNote;
      document.getElementById("editNote").value = record.remark;
      document.getElementById("editRepeat").value = record.repeat || 'none';
      document.getElementById("editReminder").value = record.reminderMethod || 'none';

      document.getElementById("editModal").style.display = "block";
      bodyEl.classList.add('modal-open');
    

      // åˆªé™¤
      document.getElementById("deleteEditBtn").onclick = async () => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œç¨‹å—ï¼Ÿ")) return;

        // ğŸ“Œ æ­£ç¢º Delete API URL
        const DELETE_API_URL =
          `https://supabase-api-six.vercel.app/schedules/elder/${userId}/${eventId}`;

        try {
          const res = await fetch(DELETE_API_URL, {
            method: "DELETE"
          });

          const result = await res.json();
          console.log("DELETE çµæœï¼š", result);

          if (!res.ok) {
            alert("åˆªé™¤å¤±æ•—: " + (result.message || res.status));
            return;
          }

          // ğŸ“Œ æˆåŠŸæ‰å¾å‰ç«¯ç§»é™¤
          records.splice(idx, 1);

          document.getElementById("editModal").style.display = "none";
          bodyEl.classList.remove('modal-open');

          await renderAllTable();
          alert("åˆªé™¤æˆåŠŸï¼");

        } catch (err) {
          console.error("DELETE Errorï¼š", err);
          alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
      };
    }

    // å„²å­˜ç·¨è¼¯
    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);
    async function saveEdit() {
      if (!currentEditEventId) {
        alert("ç„¡æ•ˆç·¨è¼¯äº‹ä»¶");
        return;
      }
      
      const eventId = currentEditEventId;
      const idx = records.findIndex(r => r.eventId === eventId);
      if (idx === -1) return alert("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");

      const date = document.getElementById("editDate").value;
      const time = document.getElementById("editTime").value;
      const schedule_note = document.getElementById("editEvent").value.trim();
      const remark = document.getElementById("editNote").value.trim();
      const repeat = document.getElementById("editRepeat").value;
      const reminder_method = document.getElementById("editReminder").value;

      if (!date || !time || !schedule_note) {
        alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ï¼");
        return;
      }

      const schedule_time = `${date} ${time}:00`;

      const url = `https://supabase-api-six.vercel.app/schedules/elder/${userId}/${eventId}`;

      const body = {
        schedule_time,
        schedule_note,
        remark,
        repeat,
        reminder_method
      };

      try {
        const res = await fetch(url, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const result = await res.json();
        console.log("æ›´æ–°çµæœï¼š", result);

        if (!res.ok) {
          alert("æ›´æ–°å¤±æ•—ï¼š" + (result.message || res.status));
          return;
        }

        // æ›´æ–°å‰ç«¯
        records[idx].date = date;
        records[idx].time = time;
        records[idx].scheduleNote = schedule_note;
        records[idx].remark = remark;
        records[idx].repeat = repeat;
        records[idx].reminderMethod = reminder_method;

        document.getElementById("editModal").style.display = "none";
        bodyEl.classList.remove("modal-open");

        await renderAllTable();
        alert("æ›´æ–°æˆåŠŸï¼");
      } catch (err) {
        console.error("PATCH Errorï¼š", err);
        alert("æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤");
      }
    }

    // é—œé–‰éå¾€ç´€éŒ„
    document.getElementById("closeHistoryModalBtn").addEventListener("click", () => {
      document.getElementById("historyModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
      renderAllTable();
    });

    // æª¢è¦–éå¾€ç´€éŒ„ï¼ˆModalï¼‰
    document.getElementById("historyBtn").addEventListener("click", () => {
      const now = new Date();
      const pastRecords = records
        .filter(record => parseDateTime(record.date, record.time) < now)
        .sort((a, b) => parseDateTime(b.date, b.time) - parseDateTime(a.date, a.time));

      const historyContent = document.getElementById("historyContent");
      historyContent.innerHTML = '';

      if (pastRecords.length === 0) {
        historyContent.innerHTML = '<p style="text-align:center;">ç›®å‰æ²’æœ‰éå¾€ç´€éŒ„</p>';
      } else {
        const tableWrapper = document.createElement('div');
        tableWrapper.style.display = "block";
        tableWrapper.className = 'allTable-div';
        tableWrapper.style.margin = '10px auto';

        const table = document.createElement('table');
        table.id = 'historyTable';

        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>æ—¥æœŸ</th>
            <th>æ™‚é–“</th>
            <th>è¡Œç¨‹å…§å®¹</th>
            <th>å‚™è¨»</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        pastRecords.forEach(record => {
          const tr = document.createElement('tr');

          const tdDate = document.createElement('td');
          tdDate.textContent = record.date;
          tr.appendChild(tdDate);

          const tdTime = document.createElement('td');
          tdTime.textContent = record.time;
          tr.appendChild(tdTime);

          const tdEvent = document.createElement('td');
          tdEvent.textContent = record.scheduleNote;
          tr.appendChild(tdEvent);

          const tdNote = document.createElement('td');
          tdNote.textContent = record.remark;
          tr.appendChild(tdNote);

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        historyContent.appendChild(tableWrapper);
      }

      document.getElementById("historyModal").style.display = "block";
      bodyEl.classList.add('modal-open');
      const mainWrapper = document.querySelector('.allTable-div');
      mainWrapper.style.display = 'none';
    });

    // éå»æ™‚é–“æç¤º Modal çš„æŒ‰éˆ•è™•ç†
    document.getElementById("openHistoryFromPast").addEventListener("click", () => {
      // é—œé–‰æç¤º Modalï¼Œé–‹å•Ÿéå¾€ç´€éŒ„ Modalï¼ˆé‡ç”¨ç¾æœ‰ handlerï¼‰
      document.getElementById("pastModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
      document.getElementById("historyBtn").click();
    });

    // æ–°å¢ï¼šéå»æ™‚é–“æç¤º Modal çš„å‰å‰é—œé–‰æŒ‰éˆ•
    document.getElementById("closePastModalBtn").addEventListener("click", () => {
      document.getElementById("pastModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
      renderAllTable();
    });

    // å°å·¥å…·ï¼šç°¡å–®çš„ escapeï¼Œé¿å…æ’å…¥ html
    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
