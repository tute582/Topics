<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <title>行事曆</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f7f9fb;
            color: #222;
            padding-bottom: 80px; 
        }

        /* --- 導覽列 --- */
        .nav-1 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: #ffffff;
            border-bottom: 1px solid #dddddd;
            position: sticky;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            height: 75px;
        }

        .nav-1 h1 {
            font-size: 28px !important;
            font-weight: bold;
            color: #222;
            margin: 0;
        }

        .volunteer-area {
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 60%;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #0984e3;
            display: none; 
            cursor: pointer;
        }

        #volunteerName {
            font-size: 26px !important;
            font-weight: bold;
            color: #222;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        /* --- 主容器 --- */
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: #ffffff;
            padding: 20px 0 40px 0;
            min-height: calc(100vh - 75px);
        }

        #calendar-container {
            background: #ffffff;
            padding: 0 10px;
        }

        /* --- FullCalendar 樣式客製化 --- */
        .fc-theme-standard .fc-scrollgrid {
            border: none !important;
        }

        .fc-theme-standard td, .fc-theme-standard th {
            border-left: none !important;
            border-right: none !important;
            border-top: none !important;
            border-bottom: 1px solid #f0f0f0 !important;
        }

        .fc .fc-toolbar {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 0 !important;
            margin-bottom: 20px !important;
            width: 100% !important;
            flex-wrap: nowrap !important; 
        }

        .fc .fc-toolbar-chunk {
            display: flex !important;
            align-items: center !important;
        }

        .fc-button {
            margin: 0 4px !important;
            border-radius: 8px !important;
        }

        .fc .fc-button-group {
            display: inline-flex !important;
            vertical-align: middle !important;
            gap: 0 !important;
        }

        .fc .fc-button-group > .fc-button:not(:first-child) {
            margin-left: -1px !important;
            border-top-left-radius: 0 !important;
            border-bottom-left-radius: 0 !important;
        }

        .fc .fc-button-group > .fc-button:not(:last-child) {
            border-top-right-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
        }

        .fc .fc-button-group > .fc-button:first-child {
            border-top-left-radius: 10px !important;
            border-bottom-left-radius: 10px !important;
        }

        .fc .fc-button-group > .fc-button:last-child {
            border-top-right-radius: 10px !important;
            border-bottom-right-radius: 10px !important;
        }

        @media (max-width: 480px) {
            .fc .fc-toolbar-title {
                font-size: 1.0em !important;
                margin: 0 2px !important;
            }
            .fc-button {
                padding: 6px 8px !important;
                font-size: 14px !important;
                margin: 0 2px !important;
            }
            .fc .fc-toolbar-chunk:nth-child(2) {
                gap: 2px !important;
            }
        }

        .fc .fc-toolbar-chunk:nth-child(1) { flex: 0 0 auto !important; }
        .fc .fc-toolbar-chunk:nth-child(2) { flex: 1 1 auto !important; justify-content: center !important; gap: 4px !important; }
        .fc .fc-toolbar-chunk:nth-child(3) { flex: 0 0 auto !important; justify-content: flex-end !important; }

        .fc-toolbar-title {
            font-size: 1.15em !important;
            font-weight: bold;
            color: #2c3e50;
            white-space: nowrap !important;
            margin: 0 !important;
            order: 2; 
        }

        .fc-prev-button { order: 1 !important; }
        .fc-next-button { order: 3 !important; }

        .fc-button-primary {
            background-color: #ffffff !important;
            color: #2c3e50 !important;
            border: 1px solid #dcdde1 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            font-weight: bold !important;
            margin: 0 !important;
        }

        .fc-button-active {
            background-color: #2c3e50 !important;
            color: #ffffff !important;
            border-color: #2c3e50 !important;
        }

        .fc-button:focus, .fc-button:active {
            box-shadow: none !important;
        }

        .fc-daygrid-day-top {
            display: flex !important;
            justify-content: center !important;
            padding-top: 8px !important;
        }

        .fc-daygrid-day-number {
            font-size: 15px;
            color: #555;
            text-decoration: none !important;
        }

        .fc-daygrid-day-frame {
            min-height: 110px !important;
        }

        .fc-day-today {
            background-color: #fffde7 !important;
        }

        /* --- 修復的核心 CSS --- */
        .fc-daygrid-event {
            background-color: #79f2c0 !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 4px 6px !important; 
            margin: 2px 1px !important;
            display: flex !important;
            align-items: center !important;
            min-height: 28px !important;
            overflow: hidden !important;
            /* 強制限制寬度，防止跨日長條擠出格子 */
            max-width: 98% !important; 
            box-sizing: border-box !important;
        }

        .fc-event-time {
            font-weight: bold !important;
            margin-right: 4px !important;
            flex-shrink: 0 !important;
            font-size: 12px !important;
            color: #3b82f6 !important;
        }

        .fc-event-title {
            font-size: 14px !important;
            font-weight: 600 !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            flex-grow: 1 !important;
            min-width: 0 !important;
            color: #3b82f6 !important;
        }

        .fc-daygrid-more-link {
            font-size: 13px !important;
            font-weight: bold !important;
            color: #222 !important;
            padding-left: 5px !important;
            text-decoration: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center; 
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            width: 92%;
            max-width: 400px;
            padding: 20px;
            border-radius: 16px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .close-btn {
            position: absolute;
            top: 12px; right: 12px;
            width: 30px; height: 30px;
            background-color: #f37a7a;
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        label {
            display: flex;
            align-items: center;
            font-weight: 600;
            margin-bottom: 6px;
            margin-top: 15px;
            color: #444;
            font-size: 15px;
        }

        label i { margin-right: 6px; width: 20px; text-align: center; }

        input[type="text"], input[type="date"], input[type="time"], select {
            width: 100%;
            height: 48px; 
            padding: 0 12px; 
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 16px;
            background-color: #fdfdfd;
            -webkit-appearance: none; 
        }

        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after {
            content: '\25BC';
            font-size: 12px;
            color: #888;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .btn {
            padding: 14px;
            border: none;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
        }

        #saveBtn { background: #4a90e2; }
        #deleteBtn { background: #ff7675; }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 55px;
            height: 55px;
            background: #4a90e2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 999;
        }

        .event-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .event-time {
            font-weight: bold;
            color: #4a90e2;
            margin-right: 12px;
            min-width: 55px;
            font-size: 16px;
        }
        
        .event-title-list { font-size: 16px; color: #333; }
    </style>
</head>
<body>

    <nav class="nav-1">
        <h1>行事曆</h1>
        <div class="volunteer-area">
            <img id="volunteerAvatar" class="avatar" src="" alt="avatar" />
            <span id="volunteerName">載入中</span>
        </div>
    </nav>

    <div class="container">
        <div id="calendar-container">
            <div id="calendar"></div>
        </div>
    </div>

    <div class="fab" id="fabAdd">
        <i class="fas fa-plus"></i>
    </div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('dataModal')"><i class="fas fa-times"></i></button>
            <h3 id="modalTitle" style="text-align: center; color: #2c3e50;">新增行程</h3>
            <form id="dataForm">
                <label><i class="fa-regular fa-calendar-days"></i> 日期</label>
                <input type="date" id="date" required>
                <label><i class="fa-regular fa-clock"></i> 時間</label>
                <input type="time" id="time" required>
                <label><i class="fa-solid fa-pen"></i> 行程內容</label>
                <input type="text" id="event" placeholder="例如：看醫生(限25字)" maxlength="25">
                <label><i class="fa-regular fa-comment-dots"></i> 備註</label>
                <input type="text" id="note" placeholder="備註事項(限25字)" maxlength="25">
                <label><i class="fa-solid fa-rotate"></i> 重複</label>
                <div class="select-wrapper">
                    <select id="repeat">
                        <option value="none">不重複</option>
                        <option value="daily">每天</option>
                        <option value="weekly">每週</option>
                        <option value="monthly">每月</option>
                        <option value="yearly">每年</option>
                    </select>
                </div>
                <label><i class="fa-regular fa-bell"></i> 提醒類型</label>
                <div class="select-wrapper">
                    <select id="reminder">
                        <option value="none">無</option>
                        <option value="0min">當下提醒</option>
                        <option value="30min">30 分鐘前</option>
                        <option value="1h">1 小時前</option>
                        <option value="day">1 天前</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button type="button" class="btn" id="saveBtn" style="flex: 1;"><i class="fas fa-check"></i> 儲存</button>
                    <button type="button" class="btn" id="deleteBtn" style="flex: 1; display:none;"><i class="fas fa-trash-alt"></i> 刪除</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dayViewModal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('dayViewModal')"><i class="fas fa-times"></i></button>
            <h3 id="dayViewTitle" style="text-align: center; border-bottom: 2px solid #4a90e2; padding-bottom: 10px; color: #2c3e50;"></h3>
            <div id="dayEventList" style="max-height: 300px; overflow-y: auto;"></div>
            <div style="margin-top: 15px;">
                <button type="button" class="btn" onclick="openAddFromDayView()" style="background: #4a90e2; width: 100%;">
                    <i class="fas fa-plus-circle"></i> 在此日新增
                </button>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008484068-Kp57RrAr"; 
        const SCHEDULE_API_URL = "https://supabase-api-six.vercel.app/schedules";
        const IDENTIFY_API_BASE = "https://supabase-api-six.vercel.app/identify";

        let userId = "";
        let userName = "";
        let identify = ""; 
        let calendar;
        let isEditing = false;
        let currentEventId = null;
        let selectedDateStr = "";

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'zh-tw',
                height: 'auto',
                // --- 重要修復：深夜行程處理邏輯 ---
                nextDayThreshold: '24:00:00', // 即使是 23:59 也不要判定為跨日
                displayEventEnd: false,       // 隱藏結束時間，避免 00:00 觸發跨日顯示樣式
                // -----------------------------
                headerToolbar: {
                    left: 'today',
                    center: 'prev title next',
                    right: 'dayGridMonth,listMonth'
                },
                buttonText: { 
                    today: '今天', 
                    dayGridMonth: '月曆', 
                    listMonth: '列表' 
                },
                dayHeaderFormat: { weekday: 'narrow' },
                dayCellContent: function(arg) { return arg.dayNumberText.replace('日', ''); },
                titleFormat: function(info) { 
                    return info.date.marker.getFullYear() + ' 年 ' + (info.date.marker.getMonth() + 1) + ' 月'; 
                },
                dayMaxEvents: 2,
                eventTimeFormat: { hour: '2-digit', minute: '2-digit', meridiem: false, hour12: false },
                moreLinkText: function(n) { return "+ " + n + " 更多"; },
                moreLinkClick: function(info) { openDayView(info.date.toISOString().split('T')[0]); return 'none'; },
                dateClick: function(info) { openDayView(info.dateStr); },
                eventClick: function(info) {
                    info.jsEvent.stopPropagation();
                    openModal(true, info.event);
                },
                // 強制將跨日判定產生的 class 移除，維持單格顯示
                eventDidMount: function(info) {
                    if (info.view.type === 'dayGridMonth') {
                        info.el.classList.remove('fc-h-event', 'fc-daygrid-block-event');
                        info.el.classList.add('fc-daygrid-dot-event');
                    }
                }
            });
            calendar.render();
            initLiffAndSetProfile();
        });

        async function initLiffAndSetProfile() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userId = profile.userId;
                userName = profile.displayName;
                document.getElementById("volunteerName").innerText = userName;
                if (profile.pictureUrl) {
                    const avatarEl = document.getElementById("volunteerAvatar");
                    avatarEl.src = profile.pictureUrl;
                    avatarEl.style.display = "inline-block";
                }
                const res = await fetch(`${IDENTIFY_API_BASE}/${userId}`);
                const result = await res.json();
                if (!result.success) {
                    alert("首次使用需先完成個人資料註冊");
                    window.location.href = "../../Login-or-register/index.html";
                } else {
                    identify = result.role;
                    loadRecords();
                }
            } catch (err) { console.error("LIFF 初始化錯誤:", err); }
        }

        async function loadRecords() {
            try {
                const res = await fetch(`${SCHEDULE_API_URL}/elder/${userId}`);
                const result = await res.json();
                if (result.success && Array.isArray(result.data)) {
                    const events = result.data.map(item => ({
                        id: item.event_id,
                        title: item.schedule_note,
                        start: item.schedule_time,
                        allDay: false, // 強制標記為非整天事件
                        extendedProps: { 
                            note: item.remark, 
                            repeat: item.repeat, 
                            reminder: item.reminder_method 
                        }
                    }));
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                }
            } catch (e) { console.error("載入行程失敗:", e); }
        }

        document.getElementById("saveBtn").onclick = async function() {
            const dateVal = document.getElementById("date").value;
            const timeVal = document.getElementById("time").value;
            if (!dateVal || !timeVal) { alert("請填寫日期與時間"); return; }
            const payload = {
                schedule_time: `${dateVal}T${timeVal}`,
                schedule_note: document.getElementById("event").value,
                remark: document.getElementById("note").value,
                repeat: document.getElementById("repeat").value,
                reminder_method: document.getElementById("reminder").value,
                elder_user_id: userId,
                elder_name: userName
            };
            let url = isEditing ? `${SCHEDULE_API_URL}/elder/${userId}/${currentEventId}` : SCHEDULE_API_URL;
            let method = isEditing ? "PATCH" : "POST";
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (res.ok) { closeModal('dataModal'); loadRecords(); } else { alert("儲存失敗"); }
            } catch (err) { alert("連線失敗"); }
        };

        document.getElementById("deleteBtn").onclick = async function() {
            if (!confirm("確定要刪除這條行程嗎？")) return;
            try {
                const res = await fetch(`${SCHEDULE_API_URL}/elder/${userId}/${currentEventId}`, { method: "DELETE" });
                if (res.ok) { closeModal('dataModal'); loadRecords(); }
            } catch (err) { alert("刪除失敗"); }
        };

        function openDayView(dateStr) {
            selectedDateStr = dateStr;
            const listEl = document.getElementById('dayEventList');
            const parts = dateStr.split('-');
            document.getElementById('dayViewTitle').innerText = `${parts[0]} 年 ${parts[1]} 月 ${parts[2]} 日`;
            listEl.innerHTML = '';
            const dayEvents = calendar.getEvents().filter(e => {
                const d = e.start.getFullYear() + '-' + String(e.start.getMonth() + 1).padStart(2, '0') + '-' + String(e.start.getDate()).padStart(2, '0');
                return d === dateStr;
            });
            if (dayEvents.length === 0) {
                listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">本日無行程</div>';
            } else {
                dayEvents.sort((a, b) => a.start - b.start).forEach(e => {
                    const timeStr = e.start.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' });
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.innerHTML = `<span class="event-time">${timeStr}</span><span class="event-title-list">${e.title}</span>`;
                    item.onclick = () => { closeModal('dayViewModal'); openModal(true, e); };
                    listEl.appendChild(item);
                });
            }
            document.getElementById('dayViewModal').style.display = 'flex';
        }

        function openModal(editMode, data) {
            isEditing = editMode;
            document.getElementById("dataModal").style.display = "flex";
            document.getElementById("deleteBtn").style.display = editMode ? "block" : "none";
            document.getElementById("modalTitle").innerText = editMode ? "編輯行程" : "新增行程";
            if (editMode) {
                currentEventId = data.id;
                const d = data.start;
                document.getElementById("date").value = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                const hh = String(d.getHours()).padStart(2, '0');
                const mm = String(d.getMinutes()).padStart(2, '0');
                document.getElementById("time").value = `${hh}:${mm}`;
                document.getElementById("event").value = data.title;
                document.getElementById("note").value = data.extendedProps.note || "";
                document.getElementById("repeat").value = data.extendedProps.repeat || "none";
                document.getElementById("reminder").value = data.extendedProps.reminder || "none";
            } else {
                document.getElementById("dataForm").reset();
                if (typeof data === 'string') {
                    document.getElementById("date").value = data;
                } else {
                    const now = new Date();
                    document.getElementById("date").value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                }
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = "none"; }
        function openAddFromDayView() { closeModal('dayViewModal'); openModal(false, selectedDateStr); }
        document.getElementById("fabAdd").onclick = () => openModal(false);
    </script>
</body>
</html>