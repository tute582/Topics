<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¡Œäº‹æ›†</title>
  <style>
    /* =========================================
       1. å…¨åŸŸè¨­å®š (Global Reset)
       ========================================= */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Arial", sans-serif;
      padding: 0;
      background: #ffffff;
      color: #222;
    }

    /* =========================================
       2. å°è¦½åˆ—æ¨£å¼ (Navigation)
       ========================================= */
    .nav-1 {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 10px 25px; 
      position: sticky; 
      top: 0; 
      z-index: 1001;
      width: 100%; 
      background: #fff; 
      border-bottom: 1px solid #ddd;
    }

    .nav-1 h1 { margin: 0; font-size: 28px; }

    /* å¿—å·¥é ­åƒå€åŸŸ */
    .volunteer-area { display: flex; align-items: center; gap: 8px; }
    .volunteer-area .avatar { 
      width: 36px; height: 36px; 
      border-radius: 50%; object-fit: cover; 
      border: 1px solid #ddd; display: none; 
    }
    .volunteer-area #volunteerName { 
      cursor: pointer; padding: 4px 8px; 
      border-radius: 6px; font-size: 18px; 
    }

    /* =========================================
       3. ä¸»è¦å…§å®¹å®¹å™¨ (Main Container)
       ========================================= */
    .div-b {
      width: 100%; 
      /*max-width: 800px; */
      margin: 15px 0 0 0; 
      padding: 0 25px 0;
    }

    h2 { margin: 5px 0; font-size: 24px; display: inline-block; padding: 0 5px; }
    h3 { margin: 0; text-align: center; font-size: 20px; }

    /* =========================================
       4. è¡¨å–®æ¨£å¼ (Forms & Inputs)
       ========================================= */
    form {
      margin: 10px 0; 
      padding: 18px; 
      border-radius: 16px; 
      background: #fff;
      border: 1px solid #ccc;
    }

    label { display: block; margin-top: 0; font-size: 20px; }

    /* é€šç”¨è¼¸å…¥æ¡† */
    input[type="text"], textarea,
    .picker-display, /* è®“è‡ªå®šç¾©é¡¯ç¤ºæ¡†å…±ç”¨æ¨£å¼ */
    #editModal input[type="text"], #editModal textarea {
      width: 100%; 
      padding: 8px; 
      margin: 5px 0 15px;
      border-radius: 10px; 
      border: 1px solid #ccc;
      font-size: 16px; 
      background: #fff;
      min-height: 40px; 
      box-sizing: border-box;
    }

    /* ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    select {
      width: 100%; 
      padding: 8px; 
      margin: 5px 0 15px; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
      font-size: 16px;
    }

    /* --- [é—œéµæ¨£å¼] æ—¥æœŸèˆ‡æ™‚é–“é¸æ“‡å™¨ Hack --- 
       åŸç†ï¼šç”¨ä¸€å€‹æ¼‚äº®çš„ .picker-display é¡¯ç¤ºæ–‡å­—ï¼Œ
       ç„¶å¾ŒæŠŠåŸç”Ÿçš„ input (type=date/time) è®Šé€æ˜è“‹åœ¨ä¸Šé¢ï¼Œ
       è®“ä½¿ç”¨è€…é»æ“Šæ™‚è§¸ç™¼åŸç”Ÿé¸å–®ï¼Œä½†è¦–è¦ºä¸Šä¿æŒä¸€è‡´ã€‚
    */
    .picker-wrapper {
      position: relative;
      width: 100%;
      margin-top: 6px;
      margin-bottom: 15px;
    }

    /* é¡¯ç¤ºå±¤ï¼šè² è²¬é¡¯ç¤ºæ ¼å¼åŒ–å¾Œçš„æ–‡å­— */
    .picker-display {
      display: flex;
      align-items: center;
      margin-top: 0;
      height: 40px;
      overflow: hidden;
      color: #888;
    }

    /* =========================================
      [æ–°å¢] æ—¥æœŸèˆ‡æ™‚é–“çš„åœ–ç¤ºè¨­å®š
      èªªæ˜ï¼šå› ç‚º input è®Šé€æ˜äº†ï¼Œæˆ‘å€‘è¦æŠŠåœ–ç¤ºç•«åœ¨åº•ä¸‹çš„ display div ä¸Š
      ========================================= */

    /* æ—¥æœŸåœ–ç¤º (æ—¥æ›† SVG) */
    #dateDisplay {
        background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' fill='none' stroke='%23888' stroke-width='1.6'/%3E%3Cline x1='16' y1='2' x2='16' y2='6' stroke='%23888' stroke-width='1.6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6' stroke='%23888' stroke-width='1.6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10' stroke='%23888' stroke-width='1.6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center; /* é å³å°é½Š */
        background-size: 20px 20px; /* åœ–ç¤ºå¤§å° */
        padding-right: 40px; /* å³é‚Šç•™å‡ºç©ºé–“çµ¦ iconï¼Œé¿å…æ–‡å­—è“‹åˆ° */
    }

    /* æ™‚é–“åœ–ç¤º (æ™‚é˜ SVG) */
    #timeDisplay {
        background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='9' fill='none' stroke='%23888' stroke-width='1.6'/%3E%3Cpath d='M12 7v6l4 2' stroke='%23888' stroke-width='1.6' stroke-linecap='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px 20px;
        padding-right: 40px;
    }
    /* äº’å‹•å±¤ï¼šé€æ˜çš„åŸç”Ÿè¼¸å…¥æ¡†ï¼Œå±¤ç´šæœ€é«˜ */
    .real-picker-input {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      opacity: 0; /* é€æ˜ */
      z-index: 10;
      cursor: pointer;
      -webkit-appearance: none;
    }
    
    /* å”¯è®€æ¨¡å¼ */
    input[readonly], textarea[readonly], .picker-display.readonly-mode {
      background-color: #f7f7f7;
      cursor: default;
      color: #555;
    }

    /* =========================================
       5. æŒ‰éˆ•æ¨£å¼ (Buttons)
       ========================================= */
    .btn {
      margin-top: 12px; padding: 10px 18px; 
      border: none; border-radius: 12px; 
      color: #fff; cursor: pointer; font-size: 16px;
    }
    #addBtn { background: #4a90e2; }
    #historyBtn { background: #f39c12; margin-left: 8px; }
    
    /* ç·¨è¼¯æŒ‰éˆ• (è¡¨æ ¼å…§) */
    .but-ans { 
      padding: 6px 10px; border-radius: 8px; 
      border: none; cursor: pointer; 
      background: #61aaf3; color: #fff; 
    }

    /* =========================================
       6. è¡¨æ ¼æ¨£å¼ (Tables)
   ========================================= */
    .allTable-div, .table-container {
      width: 100%; 
      margin: 10px 0 17px 0; 
      /* å®¹å™¨ä¿ç•™åœ“è§’èˆ‡é‚Šæ¡†ï¼Œå¯¦éš›æ²å‹•äº¤çµ¦å…§éƒ¨ .table-scroll */
      overflow: hidden;
      -webkit-overflow-scrolling: touch;
      
      /* --- é—œéµä¿®æ”¹ START --- */
      border: 1px solid #e6e6e6; /* å°‡é‚Šæ¡†è¨­å®šç§»åˆ°å®¹å™¨ä¸Š */
      border-radius: 14px;      /* å°‡åœ“è§’è¨­å®šç§»åˆ°å®¹å™¨ä¸Š */
      overflow: hidden;         /* ç¢ºä¿å…§å®¹è¢«è£åˆ‡ä»¥é¡¯ç¤ºåœ“è§’ */
      /* --- é—œéµä¿®æ”¹ END --- */

      background: white; 
      display: none; 
      padding: 0; 
      box-sizing: border-box;
    }

    /* å…§å±¤æ²å‹•å€å¡Šï¼šè² è²¬æ°´å¹³/å‚ç›´æ²å‹•ï¼Œä¸æœƒå½±éŸ¿å¤–å±¤åœ“è§’ */
    .allTable-div .table-scroll {
      width: 100%;
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      max-height: 420px; /* å¯è¦–å€é«˜åº¦ï¼Œè¶…éå°±å‚ç›´æ²å‹•ï¼›è¦–éœ€æ±‚èª¿æ•´ */
    }
    
    table { 
      width: 100%; /* è¡¨æ ¼é è¨­å¡«æ»¿çˆ¶å®¹å™¨ */
      border-collapse: collapse; 
      font-size: 14px; 
      background: transparent; 
    }
    
    /* ç¢ºä¿è¡¨æ ¼æœ‰æœ€å°å¯¬åº¦ä»¥è§¸ç™¼æ²å‹• (å·²ç§»é™¤ width: max-content;) */
    .allTable-div table { 
      min-width: 800px; 
    }

    th, td {
      padding: 10px; text-align: center; 
      border: 1px solid #e6e6e6; white-space: nowrap;
    }
    
    /* å›ºå®šè¡¨é ­ */
    th { background: #f9f9f9; position: sticky; top: 0; z-index: 2; }

    /* æ–‘é¦¬ç´‹ */
    tbody tr:nth-child(even) { background: #f9f9f9; }
    tbody tr:nth-child(odd) { background: #fff; }

    /* è¡¨æ ¼åœ“è§’è™•ç† */
    .allTable-div thead tr th:first-child { border-top-left-radius: 14px; }
    .allTable-div thead tr th:last-child { border-top-right-radius: 14px; }
    .allTable-div tbody tr:last-child td:first-child { 
        border-bottom-left-radius: 14px; 
        /* ç”±æ–¼ sticky header çš„å½±éŸ¿ï¼Œå»ºè­°ç§»é™¤æ­¤è™•çš„åœ“è§’ä»¥ä¿æŒä¸€è‡´æ€§ã€‚è‹¥å …æŒä¿ç•™ï¼Œè«‹ç¢ºä¿æ‰€æœ‰å–®å…ƒæ ¼éƒ½æœ‰é‚Šæ¡†ã€‚ */
    }
    .allTable-div tbody tr:last-child td:last-child { 
        border-bottom-right-radius: 14px; 
        /* åŒä¸Šï¼Œå»ºè­°ç§»é™¤æˆ–æ¸¬è©¦ç¢ºèªæ•ˆæœ */
    }

    .no-record { text-align: center; color: #888; font-size: 18px; margin: 20px 0; }

    /* =========================================
       7. å½ˆçª—æ¨£å¼ (Modals)
       ========================================= */
    #editModal, #historyModal, #pastModal {
      display: none; 
      position: fixed; top: 0; left: 0; 
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); 
      z-index: 1000;
    }
    
    /* å½ˆçª—å…§å®¹å€å¡Š */
    #editModal > div, #historyModal > div, #pastModal > div {
      background: #fff; 
      width: 420px; max-width: calc(100% - 40px);
      margin: 80px auto; padding: 18px; 
      border-radius: 12px; position: relative;
      box-sizing: border-box; 
      max-height: calc(100vh - 120px); overflow-y: auto;
    }

    .close-btn { 
      position: absolute; top: 10px; right: 10px; 
      background: transparent; border: none; 
      font-size: 26px; cursor: pointer; color: #666; 
    }
    .close-btn:hover { color: #000; }

    /* å½ˆçª—å…§æŒ‰éˆ• */
    #saveEditBtn, #deleteEditBtn {
      margin-top: 10px; font-size: 16px; padding: 8px 15px;
      border-radius: 10px; border: none; cursor: pointer;
    }
    #saveEditBtn { background-color: #4a90e2; color: white; }
    #saveEditBtn:hover { background-color: #357abd; }
    #deleteEditBtn { background-color: #f37a7a; color: white; }
    #deleteEditBtn:hover { background-color: #d94a4a; }

    /* =========================================
       8. éŸ¿æ‡‰å¼è¨­è¨ˆ (Responsive)
       ========================================= */
    @media (max-width: 768px) {
      .div-b { padding: 20px; max-width: 100%; }
      form { padding: 14px; }
      input[type="text"], textarea, .picker-display { padding: 10px; border-radius: 10px; }
      /* æ‰‹æ©Ÿç‰ˆè¡¨æ ¼å¯¬åº¦ */
      /*.allTable-div table { min-width: 0; width: 100%; } */
      th, td { padding: 10px 8px; }
      
      .btn, button { padding: 10px 14px; }
    }

    @media (max-width: 600px) {
      .btn { padding: 8px 12px; }
      #editModal > div, #historyModal > div, #pastModal > div { margin: 60px auto; padding: 12px; }
      .volunteer-area .avatar { width: 32px; height: 32px; }
    }
  </style>
</head>
<body>

  <nav class="nav-1">
    <div> 
      <h1 style="margin: 0; font-size: 28px;">è¡Œäº‹æ›†</h1>
    </div>
    <div style="display:flex; align-items:center;">
      <h1 style="margin:0; text-align:right;">
        <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
          <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar" 
               style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
          <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥" style="cursor:pointer; font-size: 26px;">è¼‰å…¥ä¸­</span>
        </span>
      </h1>
    </div>
  </nav>

  <div class="div-b">
    <h2>è¼¸å…¥å…§å®¹</h2>
    <form id="dataForm" onsubmit="return false;">
      
      <label>æ—¥æœŸ</label>
      <div class="picker-wrapper">
          <div id="dateDisplay" class="picker-display"></div> 
          <input type="date" id="date" class="real-picker-input" /> 
      </div>

      <label>æ™‚é–“</label>
      <div class="picker-wrapper">
          <div id="timeDisplay" class="picker-display"></div> 
          <input type="time" id="time" class="real-picker-input" /> 
      </div>
      
      <label>è¡Œç¨‹å…§å®¹</label>
      <input type="text" maxlength="25"  id="event" placeholder="é™25å­—"/>
      <label>å‚™è¨»</label>
      <input type="text"  maxlength="25"  id="note" placeholder="é™25å­—"/>
      
      <label>é‡è¤‡</label>
      <select id="repeat">
        <option value="none">ä¸é‡è¤‡</option>
        <option value="daily">æ¯å¤©</option>
        <option value="weekly">æ¯é€±</option>
        <option value="monthly">æ¯æœˆ</option>
        <option value="yearly">æ¯å¹´</option>
      </select>

      <label>æé†’é¡å‹</label>
      <select id="reminder">
        <option value="none">ç„¡</option>
        <option value="0min">ç•¶ä¸‹æé†’</option>
        <option value="30min">30åˆ†é˜å‰</option>
        <option value="1h">1å°æ™‚å‰</option>
        <option value="day">1å¤©å‰</option>
      </select>

      <button type="button" class="btn" id="addBtn">æ–°å¢</button>
      <button type="button" class="btn" id="historyBtn">æª¢è¦–éå¾€ç´€éŒ„</button>
    </form>
   
    <h2>å³å°‡åˆ°ä¾†çš„è¡Œç¨‹</h2>

    <div id="no-record-msg" class="no-record" >ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>

    <div class="allTable-div">
      <!-- table-scroll ä¿ç•™åœ“è§’å¤–æ¡†ä½†è®“è¡¨æ ¼å¯è‡ªç”±æ²å‹• -->
      <div class="table-scroll">
        <table id="allTable">
          <thead>
            <tr>
              <th>æ—¥æœŸ</th>
              <th>æ™‚é–“</th>
              <th>è¡Œç¨‹å…§å®¹</th>
              <th>å‚™è¨»</th>
              <th>é‡è¤‡</th>
              <th>æé†’é¡å‹</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="editModal">
    <div>
      <button id="closeEditModalBtn" class="close-btn" type="button">&times;</button>

      <h3>ç·¨è¼¯è¡Œç¨‹</h3>
      <form id="editForm" onsubmit="return false;">
        
        <label>æ—¥æœŸ</label>
        <div class="picker-wrapper">
            <div id="editDateDisplay" class="picker-display"></div>
            <input type="date" id="editDate" class="real-picker-input" />
        </div>

        <label>æ™‚é–“</label>
        <div class="picker-wrapper">
            <div id="editTimeDisplay" class="picker-display"></div>
            <input type="time" id="editTime" class="real-picker-input" />
        </div>

        <label>è¡Œç¨‹å…§å®¹</label>
        <input type="text" id="editEvent" /><br />
        <label>å‚™è¨»</label>
        <input type="text" id="editNote" /><br />

        <label>é‡è¤‡</label>
        <select id="editRepeat">
          <option value="none">ä¸é‡è¤‡</option>
          <option value="daily">æ¯å¤©</option>
          <option value="weekly">æ¯é€±</option>
          <option value="monthly">æ¯æœˆ</option>
          <option value="yearly">æ¯å¹´</option>
        </select>

        <label>æé†’é¡å‹</label>
        <select id="editReminder">
          <option value="none">ç„¡</option>
          <option value="0min">ç•¶ä¸‹æé†’</option>
          <option value="30min">30åˆ†é˜å‰</option>
          <option value="1h">1å°æ™‚å‰</option>
          <option value="day">1å¤©å‰</option>
        </select>

        <div class="edit-actions">
          <button type="button" id="saveEditBtn">å„²å­˜ä¿®æ”¹</button>
          <button type="button" id="deleteEditBtn">åˆªé™¤</button>
        </div>
      </form>
    </div>
  </div>

  <div id="historyModal" style="display:none;">
    <div>
      <button id="closeHistoryModalBtn" class="close-btn" type="button">&times;</button>
      <h3>éå¾€ç´€éŒ„</h3>
      <div id="historyContent"></div>
    </div>
  </div>

  <div id="pastModal" style="display:none;">
    <div>
      <button id="closePastModalBtn" class="close-btn" type="button">&times;</button>
      <h3>æ³¨æ„ â€” éå»çš„æ™‚é–“</h3>
      <p id="pastModalMessage" style="text-align:center; font-size:16px; margin-top:8px;"></p>
      <div style="text-align:center; margin-top:12px;">
        <button id="openHistoryFromPast" class="btn" style="background:#f39c12; color:#fff;">å‰å¾€æª¢è¦–éå¾€ç´€éŒ„</button>
      </div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  
  <script>
    // ==========================================
    // 1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š
    // ==========================================
    const bodyEl = document.body;
    const LIFF_ID = '2008484068-Kp57RrAr';
    const avatarEl = document.getElementById("volunteerAvatar");
    const nameEl = document.getElementById("volunteerName");
    
    // ç‹€æ…‹è®Šæ•¸
    let userId = "";
    let userName ="";
    let records = []; // å„²å­˜æ‰€æœ‰è¡Œç¨‹è³‡æ–™
    let currentEditEventId = null; // ç•¶å‰ç·¨è¼¯çš„ ID

    // ==========================================
    // 2. åˆå§‹åŒ–ç¨‹å¼
    // ==========================================
    
    // å•Ÿå‹•æ—¥æœŸæ™‚é–“é¸æ“‡å™¨é‚è¼¯ (Picker Hack)
    initDateTimePickers();

    // åŸ·è¡Œ LIFF åˆå§‹åŒ–
    initLiffAndSetProfile();

    // ==========================================
    // 3. å‡½æ•¸å®šç¾©ï¼šåˆå§‹åŒ–èˆ‡å·¥å…·
    // ==========================================

    /**
     * LIFF åˆå§‹åŒ–ä¸¦å–å¾—ä½¿ç”¨è€…è³‡è¨Š
     * è‹¥æœªç™»å…¥å‰‡éš±è—é ­åƒï¼Œè‹¥ç™»å…¥å‰‡è¼‰å…¥è³‡æ–™
     */
    async function initLiffAndSetProfile() {
      try {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          nameEl.innerText = "æœªç™»å…¥";
          avatarEl.style.display = "none";
          return;
        }
        
        const profile = await liff.getProfile();
        userId = profile.userId;
        userName = profile.displayName;
        console.log("LIFF Profile userId:", userId, "userName:", userName);

        nameEl.innerText = profile.displayName || "å¿—å·¥";
        if (profile.pictureUrl) {
          avatarEl.src = profile.pictureUrl;
          avatarEl.style.display = "inline-block";
        } else {
          avatarEl.style.display = "none";
        }

        // å–å¾—ä½¿ç”¨è€…è³‡æ–™å¾Œï¼Œé–‹å§‹è¼‰å…¥è¡Œç¨‹
        loadRecords();
      } catch (err) {
        console.error("LIFF init error:", err);
      }
    }

    /**
     * åˆå§‹åŒ–è‡ªå®šç¾©æ—¥æœŸ/æ™‚é–“é¸æ“‡å™¨
     * ç›£è½ input è®Šæ›´ï¼Œä¸¦åŒæ­¥æ›´æ–°é¡¯ç¤ºæ–‡å­— (Picker Hack)
     */
    function initDateTimePickers() {
        // ç¶å®šæ—¥æœŸ (æ–°å¢èˆ‡ç·¨è¼¯)
        ['date', 'editDate'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', function() {
                updateDateDisplay(this.value, id + 'Display');
            });
        });

        // ç¶å®šæ™‚é–“ (æ–°å¢èˆ‡ç·¨è¼¯)
        ['time', 'editTime'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', function() {
                updateTimeDisplay(this.value, id + 'Display');
            });
        });
    }

    // æ›´æ–°æ—¥æœŸé¡¯ç¤ºæ ¼å¼ (YYYY-MM-DD -> YYYY å¹´ MM æœˆ DD æ—¥)
    function updateDateDisplay(dateValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);
        if (!dateValue) {
            displayEl.textContent = "";
            displayEl.style.color = "#888";
            return;
        }
        const [year, month, day] = dateValue.split('-');
        displayEl.textContent = `${year} å¹´ ${month} æœˆ ${day} æ—¥`;
        displayEl.style.color = "#222";
    }

    // æ›´æ–°æ™‚é–“é¡¯ç¤ºæ ¼å¼ (HH:mm -> ä¸Šåˆ/ä¸‹åˆ HH:mm)
    function updateTimeDisplay(timeValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);
        if (!timeValue) {
            displayEl.textContent = "";
            displayEl.style.color = "#888";
            return;
        }
        const [hourStr, minuteStr] = timeValue.split(':');
        let hour = parseInt(hourStr);
        let period = "ä¸Šåˆ";
        if (hour >= 12) {
            period = "ä¸‹åˆ";
            if (hour > 12) hour -= 12;
        }
        if (hour === 0) hour = 12;
        const formattedHour = hour.toString().padStart(2, '0');
        displayEl.textContent = `${period} ${formattedHour}:${minuteStr}`;
        displayEl.style.color = "#222";
    }

    /**
     * å·¥å…·ï¼šHTML è·³è„«å­—å…ƒ (é˜²æ­¢ XSS)
     */
    function escapeHtml(unsafe) {
      return String(unsafe || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function nowDate() { return new Date(); }

    // è½‰æ›æ™‚é–“å­—ä¸²ç‚º Date ç‰©ä»¶
    function parseDateTime(dateStr, timeStr) {
      const t = normalizeTimeTo24(timeStr);
      return new Date(`${dateStr}T${t}:00`);
    }

    // ç¢ºä¿æ™‚é–“æ ¼å¼ç‚º 24 å°æ™‚åˆ¶ HH:mm
    function normalizeTimeTo24(timeStr) {
      if (!timeStr) return "";
      timeStr = String(timeStr).trim();
      const m = timeStr.match(/^(\d{1,2}):(\d{2})/);
      if (m) return timeStr.substring(0, 5);
      return timeStr; 
    }
    
    // æ ¼å¼åŒ–é‡è¤‡é¸é …é¡¯ç¤º
    function formatRepeat(val) {
      switch ((val||'').toString()) {
        case 'daily': return 'æ¯å¤©';
        case 'weekly': return 'æ¯é€±';
        case 'monthly': return 'æ¯æœˆ';
        case 'yearly': return 'æ¯å¹´';
        case 'none': default: return 'ä¸é‡è¤‡';
      }
    }

    // æ ¼å¼åŒ–æé†’é¸é …é¡¯ç¤º
    function formatReminder(val) {
      if (!val) return 'ç„¡';
      switch (val.toString()) {
        case '5min': return '5 åˆ†é˜å‰';
        case '10min': return '10 åˆ†é˜å‰';
        case '15min': return '15 åˆ†é˜å‰';
        case '30min': return '30 åˆ†é˜å‰';
        case '1h': return '1 å°æ™‚å‰';
        case '2h': return '2 å°æ™‚å‰';
        case 'day': return '1 å¤©å‰';
        case '2day': return '2 å¤©å‰';
        case 'week': return '1 é€±å‰';
        case 'none': default: return 'ç„¡';
      }
    }

    // ==========================================
    // 4. è³‡æ–™åº«ä¸²æ¥ (API)
    // ==========================================

    // [Read] è®€å–è¡Œç¨‹è³‡æ–™
    async function loadRecords() {
      try {
        const GET_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/schedules/elder/${userId}`;
        const response = await fetch(GET_SUPABASE_API_URL);
        const result = await response.json();
        console.log("è¡Œäº‹æ›†å–å¾—çš„Recordè¡Œç¨‹è³‡æ–™JSONï¼š\n", result);
        const data = result.data || [];

        // è³‡æ–™æ˜ å°„
        records = data.map(item => {
          const [date, timeFull] = item.schedule_time.split("T");
          const time = timeFull.substring(0, 5); 
          return {
            uuid: item.uuid,
            date: date,
            time: time,
            scheduleNote: item.schedule_note,
            elderName: item.elder_name,
            eventId: item.event_id,
            remark: item.remark,
            isReminded: item.is_reminded,
            repeat: item.repeat || 'none',
            reminderMethod: item.reminder_method || 'none'
          };
        });
        renderAllTable();
      } catch (error) {
        console.error("è¼‰å…¥è¡Œç¨‹è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
      }
    }

    // ==========================================
    // 5. UI æ¸²æŸ“é‚è¼¯
    // ==========================================

    /**
     * æ¸²æŸ“ä¸»åˆ—è¡¨ (åƒ…é¡¯ç¤ºæœªä¾†è¡Œç¨‹)
     */
    async function renderAllTable() {
      const tbody = document.querySelector("#allTable tbody");
      tbody.innerHTML = "";
      const now = nowDate();
      const noRecordEl = document.getElementById("no-record-msg");

      const tableWrapper = document.querySelector(".allTable-div");
      const tableEl = document.getElementById("allTable");
      const theadEl = tableEl.querySelector("thead");

      // éæ¿¾ä¸¦æ’åº (æœªä¾†æ™‚é–“)
      const upcomingRecords = records
        .filter(r => parseDateTime(r.date, r.time) >= now)
        .sort((a, b) => parseDateTime(a.date, a.time) - parseDateTime(b.date, b.time));

      if (upcomingRecords.length > 0) {
        tableWrapper.style.display = "block";
        tableEl.style.display = "table";
        theadEl.style.display = "table-header-group";
        if (noRecordEl) noRecordEl.style.display = "none";
      } else {
        document.getElementById("allTable").style.display = "none";
        if (noRecordEl) noRecordEl.style.display = "block";
      }

      upcomingRecords.forEach(record => {
        const repeatLabel = formatRepeat(record.repeat || 'none');
        const reminderLabel = formatReminder(record.reminderMethod || 'none');
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${record.date}</td>
          <td>${record.time}</td>
          <td>${escapeHtml(record.scheduleNote)}</td>
          <td>${escapeHtml(record.remark)}</td>
          <td>${escapeHtml(repeatLabel)}</td>
          <td>${escapeHtml(reminderLabel)}</td>
          <td><button data-id="${record.eventId}" class="but-ans edit-btn">ç·¨è¼¯</button></td>
        `;
      });

      // ç¶å®šç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
      document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const eventId  = btn.getAttribute('data-id');
          openEditModalById(eventId);
        });
      });
    }

    // ==========================================
    // 6. äº‹ä»¶ç›£è½ï¼šè¡¨å–®æ“ä½œ (æ–°å¢ã€ç·¨è¼¯ã€åˆªé™¤)
    // ==========================================

    // [Create] æ–°å¢è¡Œç¨‹
    document.getElementById("addBtn").addEventListener("click", async () => {
      const date = document.getElementById("date").value;
      let time = document.getElementById("time").value; 
      const event = document.getElementById("event").value.trim();
      const note = document.getElementById("note").value.trim();
      const repeat = document.getElementById("repeat").value;
      const reminder = document.getElementById("reminder").value;
      
      if (!date || !time || !event) { 
        alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ï¼");
        return; 
      }

      const dt = parseDateTime(date, time);
      const now = nowDate();

      // é‡ç½®è¡¨å–®èˆ‡é¡¯ç¤ºæ–‡å­—
      document.getElementById("dataForm").reset();
      document.getElementById("dateDisplay").textContent = "";
      document.getElementById("timeDisplay").textContent = "";

      // POST åˆ°è³‡æ–™åº«
      let newEventId = null;
      try {
        const payload = {
          elder_user_id: userId,
          elder_name: userName,
          schedule_time: `${date} ${time}`,
          schedule_note: event,
          remark: note,
          repeat: repeat,
          reminder_method: reminder
        };

        const res = await fetch("https://supabase-api-six.vercel.app/schedules", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();

        if (!res.ok) {
          if (result.message == "ç¼ºå°‘é•·è€…ID") {
            alert("âš ï¸ è«‹é»æ“Šå³ä¸Šæ–¹[æœªç™»å…¥]ï¼Œç™»å…¥æ‚¨çš„LINEå¸³è™Ÿï¼Œç¢ºä¿è³‡æ–™æº–ç¢ºè¢«ä¿å­˜");
            return;
          }
          console.error("âŒ ä¸Šå‚³å¤±æ•—:", result);
          alert("âš ï¸ ä¸Šå‚³è³‡æ–™ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯ç¹«æœå‹™çª—å£ç¢ºèªï¼Œè¬è¬!");
          return;
        }

        console.log("ğŸ‰ æ–°å¢æˆåŠŸ", result);
        newEventId = result?.data?.event_id; 
        if (!newEventId) console.warn("âš  ç„¡æ³•å–å¾— event_id");

        // æ›´æ–°å‰ç«¯è³‡æ–™
        records.push({
          eventId: newEventId,
          date, time,
          scheduleNote: event,
          remark: note,
          repeat: repeat,
          reminderMethod: reminder
        });

        renderAllTable();

        // è‹¥ç‚ºéå»æ™‚é–“ï¼Œé¡¯ç¤ºæç¤ºå½ˆçª—
        if (dt < now) {
          const msgEl = document.getElementById("pastModalMessage");
          msgEl.textContent = `æ‚¨è¼¸å…¥çš„è³‡æ–™ (${date} ${time} - ${event}) å·²æ­¸åˆ°éå¾€ç´€éŒ„ã€‚`;
          document.getElementById("pastModal").style.display = "block";
          bodyEl.classList.add("modal-open");
        }
      } catch (err) {
        console.error("âŒ Supabase éŒ¯èª¤:", err);
        alert("âš ï¸ ç„¡æ³•é€£ç·šè³‡æ–™åº«");
        return;
      }
    });

    // é–‹å•Ÿç·¨è¼¯ Modal
    function openEditModalById(eventId) {
      currentEditEventId = eventId;
      const idx = records.findIndex(r => r.eventId === eventId);
      if (idx === -1) return alert('æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™');

      const record = records[idx];
      const editDateEl = document.getElementById("editDate");
      const editTimeEl = document.getElementById("editTime");

      // å¡«å…¥è¡¨å–®è³‡æ–™
      editDateEl.value = record.date;
      editTimeEl.value = normalizeTimeTo24(record.time);
      
      // æ›´æ–°é¡¯ç¤ºæ–‡å­— (Picker Hack)
      updateDateDisplay(editDateEl.value, "editDateDisplay");
      updateTimeDisplay(editTimeEl.value, "editTimeDisplay");

      document.getElementById("editEvent").value = record.scheduleNote;
      document.getElementById("editNote").value = record.remark;
      document.getElementById("editRepeat").value = record.repeat || 'none';
      document.getElementById("editReminder").value = record.reminderMethod || 'none';
      
      document.getElementById("editModal").style.display = "block";
      bodyEl.classList.add('modal-open');
    
      // [Delete] ç¶å®šåˆªé™¤æŒ‰éˆ•
      document.getElementById("deleteEditBtn").onclick = async () => {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¡Œç¨‹å—ï¼Ÿ")) return;

        const DELETE_API_URL = `https://supabase-api-six.vercel.app/schedules/elder/${userId}/${eventId}`;

        try {
          const res = await fetch(DELETE_API_URL, { method: "DELETE" });
          const result = await res.json();
          console.log("DELETE çµæœï¼š", result);

          if (!res.ok) {
            alert("åˆªé™¤å¤±æ•—: " + (result.message || res.status));
            return;
          }

          records.splice(idx, 1); // ç§»é™¤è³‡æ–™
          document.getElementById("editModal").style.display = "none";
          bodyEl.classList.remove('modal-open');
          await renderAllTable();
          alert("åˆªé™¤æˆåŠŸï¼");
        } catch (err) {
          console.error("DELETE Errorï¼š", err);
          alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
      };
    }

    // [Update] å„²å­˜ç·¨è¼¯
    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);
    
    async function saveEdit() {
      if (!currentEditEventId) {
        alert("ç„¡æ•ˆç·¨è¼¯äº‹ä»¶");
        return;
      }
      
      const eventId = currentEditEventId;
      const idx = records.findIndex(r => r.eventId === eventId);
      if (idx === -1) return alert("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");

      const date = document.getElementById("editDate").value;
      const time = document.getElementById("editTime").value;
      const schedule_note = document.getElementById("editEvent").value.trim();
      const remark = document.getElementById("editNote").value.trim();
      const repeat = document.getElementById("editRepeat").value;
      const reminder_method = document.getElementById("editReminder").value;
      
      if (!date || !time || !schedule_note) {
        alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™ï¼");
        return;
      }

      const schedule_time = `${date} ${time}:00`;
      const url = `https://supabase-api-six.vercel.app/schedules/elder/${userId}/${eventId}`;

      const body = {
        schedule_time,
        schedule_note,
        remark,
        repeat,
        reminder_method
      };

      try {
        const res = await fetch(url, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        const result = await res.json();
        console.log("æ›´æ–°çµæœï¼š", result);

        if (!res.ok) {
          alert("æ›´æ–°å¤±æ•—ï¼š" + (result.message || res.status));
          return;
        }

        // æ›´æ–°å‰ç«¯æš«å­˜
        records[idx].date = date;
        records[idx].time = time;
        records[idx].scheduleNote = schedule_note;
        records[idx].remark = remark;
        records[idx].repeat = repeat;
        records[idx].reminderMethod = reminder_method;
        
        document.getElementById("editModal").style.display = "none";
        bodyEl.classList.remove("modal-open");

        await renderAllTable();
        alert("æ›´æ–°æˆåŠŸï¼");
      } catch (err) {
        console.error("PATCH Errorï¼š", err);
        alert("æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤");
      }
    }

    // ==========================================
    // 7. å…¶ä»–äº’å‹•äº‹ä»¶ (é ­åƒã€æ­·å²ç´€éŒ„ã€Modalé–‹é—œ)
    // ==========================================

    // é»æ“Šé ­åƒè·³è½‰
    avatarEl.addEventListener("click", () => {
      if (liff.isLoggedIn()) {
        window.location.href = "../../Login-or-register/index.html";
      } else {
        liff.login({ redirectUri: window.location.href });
      }
    });

    nameEl.addEventListener("click", () => {
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      } else {
        alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
      }
    });

    // é—œé–‰ç·¨è¼¯å½ˆçª—
    document.getElementById("closeEditModalBtn").addEventListener("click", () => {
      document.getElementById("editModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
    });

    // é—œé–‰éå¾€ç´€éŒ„
    document.getElementById("closeHistoryModalBtn").addEventListener("click", () => {
      document.getElementById("historyModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
      renderAllTable();
    });

    // æª¢è¦–éå¾€ç´€éŒ„æŒ‰éˆ•
    document.getElementById("historyBtn").addEventListener("click", () => {
      const now = new Date();
      const pastRecords = records
        .filter(record => parseDateTime(record.date, record.time) < now)
        .sort((a, b) => parseDateTime(b.date, b.time) - parseDateTime(a.date, a.time));

      const historyContent = document.getElementById("historyContent");
      historyContent.innerHTML = '';

      if (pastRecords.length === 0) {
        historyContent.innerHTML = '<p style="text-align:center;">ç›®å‰æ²’æœ‰éå¾€ç´€éŒ„</p>';
      } else {
        // å»ºç«‹å¤–å±¤å®¹å™¨ï¼ˆèˆ‡ä¸»è¡¨æ ¼ä¸€è‡´ï¼Œå…§å±¤ .table-scroll è² è²¬æ»¾å‹•ï¼‰
        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'allTable-div';
        tableWrapper.style.display = 'block';
        tableWrapper.style.margin = '10px auto';

        const scrollWrap = document.createElement('div');
        scrollWrap.className = 'table-scroll';

        const table = document.createElement('table');
        table.id = 'historyTable';

        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>æ—¥æœŸ</th>
            <th>æ™‚é–“</th>
            <th>è¡Œç¨‹å…§å®¹</th>
            <th>å‚™è¨»</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        pastRecords.forEach(record => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${record.date}</td>
            <td>${record.time}</td>
            <td>${escapeHtml(record.scheduleNote)}</td>
            <td>${escapeHtml(record.remark)}</td>
          `;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        scrollWrap.appendChild(table);
        tableWrapper.appendChild(scrollWrap);
        historyContent.appendChild(tableWrapper);
      }

      document.getElementById("historyModal").style.display = "block";
      bodyEl.classList.add('modal-open');
      const mainWrapper = document.querySelector('.allTable-div');
      if(mainWrapper) mainWrapper.style.display = 'none';
    });

    // éå»æ™‚é–“æç¤º Modal å…§æŒ‰éˆ•
    document.getElementById("openHistoryFromPast").addEventListener("click", () => {
      document.getElementById("pastModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
      document.getElementById("historyBtn").click();
    });

    document.getElementById("closePastModalBtn").addEventListener("click", () => {
      document.getElementById("pastModal").style.display = "none";
      bodyEl.classList.remove('modal-open');
      renderAllTable();
    });

  </script>
</body>
</html>