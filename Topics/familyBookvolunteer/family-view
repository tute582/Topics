<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>看診進度</title>

    <style>
      /* =========================================
          1. 基礎樣式 (沿用你原本的風格)
          ========================================= */
      body {
        font-family: "Arial", sans-serif;
        padding: 0;
        box-sizing: border-box;
        background-color: #f9f9f9;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* =========================================
          2. 導覽列與分頁
          ========================================= */
      .nav-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1001;
        width: 100%;
        padding: 10px 25px;
        background-color: white;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        color: black;
      }

      .volunteer-area {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .volunteer-area .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #0984e3;
        display: none;
      }

      .tab-nav {
        display: flex;
        padding: 0 25px;
        margin-top: 20px;
        border-bottom: 2px solid #ddd;
        background-color: #f9f9f9;
      }

      .tab-link {
        display: block;
        text-decoration: none;
        padding: 12px 24px;
        background-color: #e0e0e0;
        color: #666;
        font-size: 18px;
        font-weight: bold;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        border: 1px solid #ddd;
        border-bottom: none;
        margin-right: 5px;
        position: relative;
        top: 2px;
        transition: all 0.2s ease;
      }

      .tab-link.active {
        background-color: white;
        color: #4a90e2;
        border-bottom: 2px solid white;
        z-index: 1;
      }

      /* =========================================
          3. 新增：醫院資訊卡片
          ========================================= */
      .info-card {
        background: white;
        margin: 15px 25px 0 25px;
        padding: 15px;
        border-radius: 12px;
        border: 1px solid #eee;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 15px;
      }

      .info-label { color: #888; }
      .info-value { color: #333; font-weight: bold; }
      .wait-highlight { color: #e67e22; font-weight: bold; }

      /* =========================================
          4. 進度條樣式 (Timeline)
          ========================================= */
      .container {
        padding: 20px 25px;
        max-width: 600px;
        margin: 0 auto;
        background-color: white;
        border-radius: 0 0 20px 20px;
        min-height: 80vh;
      }

      .status-title {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
        font-size: 22px;
      }

      .timeline {
        position: relative;
        padding: 10px 0;
      }

      .timeline::before {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 30px;
        width: 4px;
        background: #eee;
        border-radius: 2px;
      }

      .timeline-item {
        position: relative;
        margin-bottom: 35px;
        padding-left: 70px;
        opacity: 0.4;
        transition: all 0.3s ease;
      }

      .timeline-marker {
        position: absolute;
        left: 17px;
        top: 0;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #fff;
        border: 4px solid #ccc;
        z-index: 2;
      }

      .timeline-content h3 { margin: 0; font-size: 19px; color: #555; }
      .timeline-content p { margin: 5px 0 0; font-size: 14px; color: #999; }

      .timeline-item.active { opacity: 1; }
      .timeline-item.active .timeline-marker { border-color: #4a90e2; background-color: #eaf4ff; }
      .timeline-item.current .timeline-marker {
        background-color: #4a90e2;
        border-color: #4a90e2;
        box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.3);
      }

      /* =========================================
          5. 志工控制區 (新增輸入框)
          ========================================= */
      .controls-area {
        margin-top: 30px;
        padding: 20px;
        background: #f0f7ff;
        border-radius: 15px;
        display: none; 
      }

      .input-group { margin-bottom: 10px; }
      .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
      .input-group input { 
        width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px;
      }

      .btn-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 15px;
      }

      .status-btn {
        padding: 10px;
        border: 1px solid #4a90e2;
        background-color: white;
        color: #4a90e2;
        border-radius: 8px;
        cursor: pointer;
      }

      .status-btn.active-btn {
        background-color: #4a90e2;
        color: white;
      }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div><h1 style="margin: 0; font-size: 24px">看診資訊</h1></div>
      <div class="volunteer-area">
        <img id="volunteerAvatar" class="avatar" src="" />
        <span id="volunteerName" style="font-size: 18px">載入中</span>
      </div>
    </nav>

    <div class="tab-nav">
      <a href="../record-information/index.html" class="tab-link">看診紀錄</a>
      <a href="#" class="tab-link active">看診進度</a>
    </div>

    <div class="info-card">
        <div class="info-row">
            <span class="info-label">看診醫院</span>
            <span class="info-value" id="disp_hospital">--</span>
        </div>
        <div class="info-row">
            <span class="info-label">醫生科別</span>
            <span class="info-value" id="disp_dept">--</span>
        </div>
        <div class="info-row">
            <span class="info-label">醫生名字</span>
            <span class="info-value" id="disp_doctor">--</span>
        </div>
        <div class="info-row">
            <span class="info-label">預計等候</span>
            <span class="wait-highlight" id="disp_wait">--</span>
        </div>
    </div>

    <div class="container">
      <div class="status-title">
        當前進度：<span id="currentStatusText" style="color: #4a90e2; font-weight: bold;">讀取中...</span>
      </div>

      <div class="timeline" id="timelineContainer">
        <div class="timeline-item" id="step-0">
          <div class="timeline-marker"></div>
          <div class="timeline-content"><h3>已到醫院</h3><p>長輩已抵達醫院現場</p></div>
        </div>
        <div class="timeline-item" id="step-1">
          <div class="timeline-marker"></div>
          <div class="timeline-content"><h3>等待看診</h3><p>已完成報到，於診間外候診</p></div>
        </div>
        <div class="timeline-item" id="step-2">
          <div class="timeline-marker"></div>
          <div class="timeline-content"><h3>看診中</h3><p>醫生正在進行診療</p></div>
        </div>
        <div class="timeline-item" id="step-3">
          <div class="timeline-marker"></div>
          <div class="timeline-content"><h3>看診結束</h3><p>診療結束，準備領藥</p></div>
        </div>
        <div class="timeline-item" id="step-4">
          <div class="timeline-marker"></div>
          <div class="timeline-content"><h3>等待拿藥</h3><p>批價完成，藥局等候領藥</p></div>
        </div>
      </div>

      <div class="controls-area" id="volunteerControls">
        <div style="font-weight: bold; margin-bottom: 10px; color: #0984e3;">更新門診資訊 (志工)</div>
        <div class="input-group">
            <label>醫院/科別/醫生/時間 (用逗號隔開)</label>
            <input type="text" id="infoInput" placeholder="醫院,科別,醫生,時間">
            <button onclick="saveHospInfo()" style="margin-top:5px; width:100%; padding:5px; background:#4a90e2; color:white; border:none; border-radius:4px;">更新基本資訊</button>
        </div>
        
        <div style="font-weight: bold; margin: 15px 0 5px 0; color: #0984e3;">更新看診狀態</div>
        <div class="btn-grid">
          <button class="status-btn" onclick="updateStatus(0)">已到醫院</button>
          <button class="status-btn" onclick="updateStatus(1)">等待看診</button>
          <button class="status-btn" onclick="updateStatus(2)">看診中</button>
          <button class="status-btn" onclick="updateStatus(3)">看診結束</button>
          <button class="status-btn" onclick="updateStatus(4)">等待拿藥</button>
        </div>
        <button onclick="resetStatus()" style="margin-top:15px; width:100%; background:none; border:1px solid #ccc; color:#999; padding:5px; border-radius:8px;">重置所有狀態</button>
      </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const LIFF_ID = "2008484068-qkydRNYN"; 
      const API_URL = "https://supabase-api-six.vercel.app"; 
      let userId = "";
      let userRole = ""; 
      const statusSteps = ["已到醫院", "等待看診", "看診中", "看診結束", "等待拿藥"];
      let currentStatusIndex = -1; 

      initLiff();

      async function initLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
              document.getElementById("volunteerName").innerText = "未登入";
              // 測試開發用：如果沒登入想看效果，可以解開下一行
              // checkUserRole("test_uid"); 
              return;
          }
          const profile = await liff.getProfile();
          userId = profile.userId;
          document.getElementById("volunteerName").innerText = profile.displayName;
          const avatarEl = document.getElementById("volunteerAvatar");
          if(profile.pictureUrl){
              avatarEl.src = profile.pictureUrl;
              avatarEl.style.display = "inline-block";
          }
          checkUserRole(userId);
        } catch (err) { console.error(err); }
      }

      function checkUserRole(uid) {
        fetch(`${API_URL}/identify/${uid}`)
          .then(res => res.json())
          .then(result => {
             if(result.success) {
                userRole = result.role;
                document.getElementById("volunteerControls").style.display = (userRole === "志工") ? "block" : "none";
                loadAllData();
             }
          })
          .catch(err => { 
              // 模擬測試：若API失敗可手動開啟
              document.getElementById("volunteerControls").style.display = "block";
              loadAllData(); 
          });
      }

      // 載入所有狀態與醫院資訊
      function loadAllData() {
        // 載入進度
        const savedIndex = localStorage.getItem("currentVisitStatus");
        currentStatusIndex = (savedIndex !== null) ? parseInt(savedIndex) : -1;
        
        // 載入醫院資訊
        const savedInfo = JSON.parse(localStorage.getItem("hospInfo") || '{"h":"台大醫院","d":"內科","n":"王醫生","w":"~剩15分鐘"}');
        document.getElementById("disp_hospital").innerText = savedInfo.h;
        document.getElementById("disp_dept").innerText = savedInfo.d;
        document.getElementById("disp_doctor").innerText = savedInfo.n;
        document.getElementById("disp_wait").innerText = savedInfo.w;

        renderTimeline();
      }

      function saveHospInfo() {
        const val = document.getElementById("infoInput").value;
        const parts = val.split(",");
        if(parts.length < 4) { alert("請輸入 醫院,科別,醫生,時間 (用逗號隔開)"); return; }
        const info = { h: parts[0], d: parts[1], n: parts[2], w: parts[3] };
        localStorage.setItem("hospInfo", JSON.stringify(info));
        loadAllData();
        alert("資訊已更新");
      }

      function renderTimeline() {
        const statusTextEl = document.getElementById("currentStatusText");
        statusTextEl.innerText = (currentStatusIndex === -1) ? "尚未開始" : statusSteps[currentStatusIndex];
        
        for (let i = 0; i < statusSteps.length; i++) {
            const el = document.getElementById(`step-${i}`);
            el.classList.remove("active", "current");
            if (i < currentStatusIndex) el.classList.add("active");
            else if (i === currentStatusIndex) el.classList.add("active", "current");
        }

        const btns = document.querySelectorAll(".status-btn");
        btns.forEach((btn, idx) => {
            btn.classList.toggle("active-btn", idx === currentStatusIndex);
        });
      }

      function updateStatus(newIndex) {
        if (confirm(`確定更新為「${statusSteps[newIndex]}」？`)) {
            currentStatusIndex = newIndex;
            localStorage.setItem("currentVisitStatus", currentStatusIndex);
            renderTimeline();
        }
      }
      
      function resetStatus() {
          localStorage.removeItem("currentVisitStatus");
          currentStatusIndex = -1;
          renderTimeline();
      }
    </script>
  </body>
</html>