<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>éš±ç§è³‡æ–™é®è”½å·¥å…· (UIå„ªåŒ–ç‰ˆ)</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        /* [ä¿®æ”¹] æ”¹ç‚ºé å·¦å°é½Š */
        text-align: left;
        overscroll-behavior: none;
      }

      .container {
        /* [ä¿®æ”¹] ç§»é™¤ max-width å’Œ margin: 0 autoï¼Œè®“å®ƒè‡ªç„¶é å·¦ä¸¦å¡«æ»¿ iframe */
        width: 100%;
        margin: 0;
      }

      /* --- å·¥å…·åˆ— (ä¸Šæ–¹) --- */
      .tools-bar {
        display: none;
        /* [ä¿®æ”¹] é å·¦æ’åˆ— */
        justify-content: flex-start;
        gap: 15px; /* å¢åŠ ä¸€é»é–“è· */
        align-items: center;
        margin-bottom: 5px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #ddd;
      }

      .tool-label {
        font-size: 14px;
        color: #555;
        font-weight: bold;
      }

      /* ç•«å¸ƒå®¹å™¨ */
      #canvas-container {
        width: 100%;
        overflow: hidden;
        border: 2px dashed #ccc;
        touch-action: none;
        display: none;
        background-color: #eee;
        margin-top: 10px;
      }

      canvas {
        max-width: 100%;
        height: auto;
        display: block;
        /* [ä¿®æ”¹] ç§»é™¤ margin: 0 auto (ç½®ä¸­)ï¼Œæ”¹ç‚ºé å·¦ */
        margin: 0;
        cursor: crosshair;
      }

      /* æŒ‰éˆ•æ¨£å¼ */
      .btn {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        transition: opacity 0.2s;
      }
      .btn:active {
        opacity: 0.8;
      }

      /* å¾©åŸæŒ‰éˆ• */
      #undoBtn {
        background-color: #ff9800;
        color: white;
        font-size: 14px;
        padding: 8px 15px;
      }
      #undoBtn:disabled {
        background-color: #e0e0e0;
        color: #999;
        cursor: not-allowed;
      }

      /* ç¢ºèªæŒ‰éˆ• */
      #confirmBtn {
        background-color: #4caf50;
        color: white;
        display: none;
        width: 100%;
        margin-top: 15px;
        padding: 15px;
        font-size: 18px;
        font-weight: bold;
      }

      /* æç¤ºæ–‡å­— */
      #hintText {
        display: none;
        color: #d9534f;
        margin: 15px 0;
        text-align: left; /* ä¿æŒé å·¦ */
        font-size: 14px;
        background: #fff5f5;
        padding: 10px;
        border-radius: 5px;
      }

      h2 {
        margin-top: 0;
        font-size: 20px; /* ç¨å¾®èª¿æ•´æ¨™é¡Œå¤§å°ä»¥é…åˆæ•´é«” */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>æ­¥é©Ÿ 1: ä¸Šå‚³ç…§ç‰‡</h2>
      <p style="color: #666; margin-bottom: 20px">
        ä¸Šå‚³çœ‹è¨ºå–® / è—¥è¢‹ï¼ˆæ‹ç…§æˆ–ç›¸ç°¿ï¼‰
      </p>

      <input type="file" id="imageInput" accept="image/*" />

      <div id="hintText">
        <strong>ğŸ’¡ æ­¥é©Ÿ 2: é®è”½å€‹è³‡</strong><br />
        è«‹ç›´æ¥åœ¨åœ–ç‰‡ä¸Šæ»‘å‹•æ‰‹æŒ‡ï¼Œå¡—é»‘<strong>å§“å</strong>èˆ‡<strong>èº«åˆ†è­‰è™Ÿ</strong>ã€‚
      </div>

      <div class="tools-bar" id="toolsBar">
        <span class="tool-label">ğŸ–Œï¸ å¡—æŠ¹é®è”½æ¨¡å¼</span>
        <button id="undoBtn" class="btn" disabled>â†º å¾©åŸä¸Šä¸€æ­¥</button>
      </div>

      <div id="canvas-container">
        <canvas id="imageCanvas"></canvas>
      </div>

      <button id="confirmBtn" class="btn">ç¢ºèªå®‰å…¨ï¼Œé€å‡ºè¾¨è­˜ â¤</button>

      <h3 style="margin-top: 30px; font-size: 14px; color: #999">
        (æ¸¬è©¦ç”¨) Base64 è¼¸å‡ºçµæœï¼š
      </h3>
      <textarea
        id="resultOutput"
        rows="3"
        style="width: 400px; font-size: 10px; color: #ccc"
        placeholder="ç­‰å¾…ç”Ÿæˆ..."
      ></textarea>
    </div>

    <script>
      const imageInput = document.getElementById("imageInput");
      const canvasContainer = document.getElementById("canvas-container");
      const canvas = document.getElementById("imageCanvas");
      const ctx = canvas.getContext("2d");

      // UI å…ƒç´ 
      const toolsBar = document.getElementById("toolsBar");
      const confirmBtn = document.getElementById("confirmBtn");
      const undoBtn = document.getElementById("undoBtn");
      const hintText = document.getElementById("hintText");
      const resultOutput = document.getElementById("resultOutput");

      // è®Šæ•¸è¨­å®š
      let isDrawing = false;
      let baseImage = null;

      // æ­·å²ç´€éŒ„ç³»çµ±
      let historyStrokes = [];
      let currentStroke = [];

      const brushSize = 35;
      const brushColor = "#000000";

      // --- 1. åœ–ç‰‡è¼‰å…¥ ---
      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            baseImage = img;
            historyStrokes = [];
            updateUndoButton();
            ctx.drawImage(img, 0, 0);

            hintText.style.display = "block";
            toolsBar.style.display = "flex";
            canvasContainer.style.display = "block";
            confirmBtn.style.display = "block";
            setupBrush();
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });

      function setupBrush() {
        ctx.strokeStyle = brushColor;
        ctx.lineWidth = brushSize;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
      }

      // --- 2. ç¹ªåœ–æ ¸å¿ƒé‚è¼¯ ---
      function getPos(e) {
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (clientX - rect.left) * scaleX,
          y: (clientY - rect.top) * scaleY,
        };
      }

      function startDrawing(e) {
        isDrawing = true;
        const pos = getPos(e);
        currentStroke = [pos];
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
      }

      function draw(e) {
        if (!isDrawing) return;
        const pos = getPos(e);
        currentStroke.push(pos);
        const lastPoint = currentStroke[currentStroke.length - 2];
        ctx.beginPath();
        ctx.moveTo(lastPoint.x, lastPoint.y);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        e.preventDefault();
      }

      function stopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;
        if (currentStroke.length > 0) {
          historyStrokes.push(currentStroke);
          updateUndoButton();
        }
      }

      // --- 3. é‡ç¹ªåŠŸèƒ½ (Undo) ---
      function redrawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (baseImage) {
          ctx.drawImage(baseImage, 0, 0);
        }
        setupBrush();
        historyStrokes.forEach((stroke) => {
          if (stroke.length === 0) return;
          ctx.beginPath();
          ctx.moveTo(stroke[0].x, stroke[0].y);
          stroke.forEach((point, index) => {
            if (index > 0) ctx.lineTo(point.x, point.y);
          });
          ctx.stroke();
        });
      }

      undoBtn.addEventListener("click", () => {
        if (historyStrokes.length === 0) return;
        historyStrokes.pop();
        redrawCanvas();
        updateUndoButton();
      });

      function updateUndoButton() {
        undoBtn.disabled = historyStrokes.length === 0;
        undoBtn.style.opacity = historyStrokes.length === 0 ? "0.5" : "1";
      }

      // äº‹ä»¶ç›£è½
      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      canvas.addEventListener("mouseout", stopDrawing);

      canvas.addEventListener("touchstart", startDrawing, { passive: false });
      canvas.addEventListener("touchmove", draw, { passive: false });
      canvas.addEventListener("touchend", stopDrawing);
      canvas.addEventListener("touchcancel", stopDrawing);

      // --- 4. ç¢ºèªè¼¸å‡º ---
      confirmBtn.addEventListener("click", () => {
        const base64Full = canvas.toDataURL("image/jpeg", 0.8);
        const base64Data = base64Full.split(",")[1];
        resultOutput.value = base64Data;
        console.log("Ready to send:", base64Data.substring(0, 30));
        alert("é®è”½å®Œæˆï¼è³‡æ–™å·²æº–å‚™å¥½å‚³é€çµ¦ AIã€‚");
      });
    </script>
  </body>
</html>
