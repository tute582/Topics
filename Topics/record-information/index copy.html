<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- 響應式，讓手機可正確縮放 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>看診資訊</title>

  <style>
    /* ==============================
       全域設定：版面與字體
       ============================== */
    body { 
      font-family: "Arial", sans-serif;
      padding: 0;
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .input-container, .search-container {
      margin-left: 25px;
      margin-right: 25px;
    }

    .input-container {
      margin-top: 15px;
    }

    .search-container {
      margin-bottom: 30px;
    }

    .title {
      margin: 5px 0;
      font-size: 26px;
    }

    /* 標題樣式 */
    h1 { 
      margin-top: 5px;
      margin-bottom: 5px;
      /*font-size: 42px; */ 
    }
    h2 { 
      margin-top: 5px;
      margin-bottom: 5px;
      font-size: 20px; 
      display: inline-block; }

    h3 { 
      margin: 0; 
      font-size: 16px; 
      color: #555; 
    }

    /* 表單外框樣式 */
    .input-container > form {
      width:100%; 
      margin: 10px 0;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 20px;
      box-sizing: border-box;
    }

    /* ==============================
       表格容器樣式
       ============================== */
    .table-container {
      width: 100%;
      margin: 5px ;
      /* 允許水平滾動，必要時顯示水平滾軸 */
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* 行動裝置平滑滾動 */
      /* 若希望在內容超出時總是顯示水平滾軸（某些系統會隱藏），可改用 overflow: auto; */
      /* max-height: 200px;  限制高度，超過出現滾輪 */
      border: 1px solid #aaa;
      border-radius: 20px;
      background-color: white;
      display: none; /* ✅ 一開始整個容器隱藏 */
    }

    /* 表格基本樣式 */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      /* 設定比容器寬，當容器較窄會出現橫向滾動 */
      min-width: 800px; 
      box-sizing: border-box;
    }
    
    /*#message {
      margin-top: 15px;
      font-weight: bold;
      color: #444;
    }*/

    th, td { 
      padding:10px; 
      text-align:center; 
      border: 1px solid #ddd;
      white-space: nowrap; /* 防止換行，配合橫向滾動 */
    }
    
    /* 行動裝置上仍可觸發橫向捲動（若想在窄螢幕降低 min-width 可用下面的設定） */
    @media (max-width: 600px) {
      table { min-width: 700px; }
    }

    /* 表頭固定 */
    th { 
      background-color:#f9f9f9; 
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* ==============================
       響應式設定（手機介面）
       ============================== */
    @media (max-width: 768px) {
    
      form { width: 95%; }
      /* 在手機上移除強制最小寬度 讓表格可縮放並出現橫向滾動 */
      table { min-width: 0; width:100%; }
      /* 調整輸入欄位字級與按鈕更適合手機 */
      input[type="text"], input[type="date"], input[type="time"], textarea { font-size:16px; padding:10px; }
      button { padding:12px 18px; font-size:16px; }
    }

    /* 表單輸入欄位樣式 */
    label{ 
      display:block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 20px;
    }

    input[type="text"], input[type="date"], input[type="time"],
    textarea {
      width:100% ;
      padding:8px;
      margin-top:5px;
      border-radius:10px;
      border:1px solid #888;
      font-size:14px;
      box-sizing:border-box;
      background-color: white; /* 主表單預設白底 */
      color: #222;
    }
    /* 若輸入欄位為 readonly，也保持白底（覆蓋瀏覽器預設灰底） */
    input[readonly], textarea[readonly], input[readonly]:not([type="checkbox"]) {
      background-color: white;
      cursor: default;
    }
    textarea { font-size:16px; }

    /* 按鈕樣式 */
    button {
      margin-top:15px; 
      padding:10px 20px; 
      border:none; 
      border-radius:10px;
      background-color:#4a90e2; color:white; 
      cursor:pointer; 
      font-size:20px;
    }
    button:hover { background-color:#357abd; }

    /* 表格列的交錯顏色 */
    .evenrowcolor{ background-color: #f9f9f9; }
    .oddrowcolor{ background-color: #ffffff; }

    /* ==============================
       Modal 編輯視窗樣式
       ============================== */
    #editModal {
      display:none;
      position:fixed; top:0; left:0;
      width:100%; height:100%;
      background-color:rgba(0,0,0,0.5);
      z-index:1000;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #editModal.show { display:block; opacity:1; }

    /* Modal 盒子：固定寬度但會在窄螢幕縮放；內容可垂直滾動 */
    #editModal > div {
      background:#fff;
      width:420px;
      max-width: calc(100% - 40px); /* 在小螢幕時自動縮小 */
      margin:80px auto;
      padding:20px 24px;
      border-radius:15px;
      position:relative;
      box-sizing: border-box;
      max-height: calc(100vh - 100px); /* 可見範圍內最大高度 */
      overflow-y: auto; /* 內容超出時顯示捲軸 */
      transform:translateY(-20px);
      transition:transform 0.3s ease;
    }
    #editModal.show > div { transform:translateY(0); }

    /* ==============================
       編輯視窗按鈕樣式
       ============================== */
    #cancelEditBtn {
      background:none;
      border:none;
      color:#555;
      font-size:20px;
      position:absolute;
      top:10px;
      right:10px;
      cursor:pointer;
      border-radius:5px;
      padding:5px 10px;
      transition: all 0.3s ease;
    }
    #cancelEditBtn:hover {
      background-color:#e74c3c; /* 紅色背景 */
      color:white;
      transform: scale(1.1);
    }

    /* 編輯按鈕 */
    #enterEditBtn {
      position:absolute; top:10px; right:10px;
      background-color:#f4b977; color:#333;
      border:none; border-radius:8px; padding:6px 12px; cursor:pointer;
      transition:all 0.3s ease;
    }
    #enterEditBtn:hover { background-color:#e0b557; }

    /* 儲存與刪除按鈕 */
    #saveEditBtn, #deleteEditBtn {
      margin-top:10px; font-size:16px; padding:8px 15px;
      border-radius:10px; border:none; cursor:pointer; display:none;
    }
    #saveEditBtn { background-color:#4a90e2; color:white; }
    #saveEditBtn:hover { background-color:#357abd; }
    #deleteEditBtn { background-color:#f37a7a; color:white; }
    #deleteEditBtn:hover { background-color:#d94a4a; }

    h3{ margin-top:0; text-align:center; }

    /* ==============================
       儲存提示視窗 (是否儲存變更)
       ============================== */
    #saveConfirmModal {
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background-color:rgba(0,0,0,0.5);
      z-index:2000;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #saveConfirmModal.show { display:block; opacity:1; }

    #saveConfirmModal > div {
      background:#fff;
      width:350px;
      margin:150px auto;
      padding:25px;
      border-radius:15px;
      text-align:center;
      transform:translateY(-20px);
      transition:transform 0.3s ease;
    }
    #saveConfirmModal.show > div { transform:translateY(0); }

    /* 提示視窗按鈕樣式 */
    #saveConfirmModal button {
      margin:10px;
      padding:8px 18px;
      font-size:16px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition: all 0.3s ease;
    }
    #confirmSaveBtn { background-color:#4a90e2; color:white; }
    #confirmSaveBtn:hover { background-color:#357abd; }

    #confirmDiscardBtn { background-color:#f37a7a; color:white; }
    #confirmDiscardBtn:hover { background-color:#d94a4a; }

    #continueEditBtn {
      background-color:#f2f2f2;
      color:white;
      font-size:15px;
    }
    #continueEditBtn:hover { background-color:#ffffff; }
    
    /* 導覽列 */
  .nav-1{
    display: flex;                 /* 水平排列內容 */
   /* font-weight: 500;*/
    align-items: center;           /* 垂直置中 */
    justify-content: space-between;/* 兩端對齊：左/右 */
    padding: 10px 25px;           /* 右側保留內距，左側移除讓內容靠近頁邊 */
    position: sticky;              /* 滾動時吸附上方 */
    top: 0;                        /* 吸附頂部 */
    z-index: 1001;                 /* 保證在其他元素之上 */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: 100%;
    left: 0;
    right: 0;
    color: black;
    background-color: white;
    box-sizing: border-box; /* 確保padding不會超出寬度 */
    border-bottom: 1px solid #ddd; /* 建議加這行讓導覽列更明顯 */
  }

  .record-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
    }


  /* volunteer area */
  .volunteer-area { display:flex; align-items:center; gap:8px; }
  .volunteer-area .avatar {
    width:36px; height:36px; border-radius:50%; object-fit:cover;
    border:1px solid #ddd; display:none;
  }
  /* 可點擊的登入區域樣式 */
  .volunteer-area #volunteerName {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    background: transparent;
  }
  .volunteer-area button { padding:4px 8px; border-radius:6px; font-size:14px; }
  </style>
</head>

<body>
<!-- ==============================
     頁面標題與表單
     ============================== -->
<!-- 導覽列 -->
<nav class="nav-1" >
  <div>
    <h1 style="margin:0; font-size: 28px;">看診資訊</h1>
  </div>

  <div style="display:flex; align-items:center;">
    <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="點此以 Line 登入" style="cursor:pointer; font-size: 26px;">載入中</span>
      </span>
    </h1>
  </div>
</nav>


<div class="input-container"> 
<h1 class="title" style="font-size: 24px;"> 輸入內容</h1>
<!-- 輸入表單區 -->
<form>
  <label>長輩姓名<input type="text" id="elderName"></label>
  <label>看診日期<input type="date" id="date"></label>
  <label>看診時間<input type="time" id="time"></label>
  <label>醫生姓名<input type="text" id="name"></label>
  <label>醫生科別
  <input type="text" id="department" list="departmentList">
  <datalist id="departmentList">
    <option value="內科"></option>
    <option value="外科"></option>
    <option value="小兒科"></option>
    <option value="婦產科"></option>
    <option value="耳鼻喉科"></option>
    <option value="眼科"></option>
    <option value="皮膚科"></option>
    <option value="骨科"></option>
    <option value="泌尿科"></option>
    <option value="神經內科"></option>
    <option value="精神科"></option>
    <option value="心臟內科"></option>
    <option value="胸腔內科"></option>
    <option value="胃腸肝膽科"></option>
    <option value="內分泌新陳代謝科"></option>
    <option value="復健科"></option>
    <option value="整形外科"></option>
    <option value="大腸直腸外科"></option>
    <option value="急診醫學科"></option>
    <option value="家庭醫學科"></option>
  </datalist>
</label>
    <label for="record">看診內容 <textarea id="record" rows="2"></textarea></label>
   

    <label for="note">備註<textarea id="note" rows="2"></textarea></label>
    
  
  <button type="button" onclick="addRow()">新增</button>
</form>
</div>

<div class="search-container"> 
<!-- 查詢標題 -->

<h1 class="title" style="font-size: 24px;">查詢</h1>

<!-- 新增：無資料時顯示的訊息 -->
<div id="no-record-msg" class="no-record">目前尚未有紀錄</div>

<!-- ==============================
     資料表格區域
     ============================== -->
<div class="table-container">
  <table id="dataTable">
    <thead>
    <tr>
      <th>長輩姓名</th>
      <th>看診日期</th>
      <th>看診時間</th>
      <th>醫生姓名</th>
      <th>醫生科別</th>
      <th>看診內容</th>
      <th>備註</th>
      <th>操作</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
  
</div>
</div>

<!-- ==============================
     編輯資料 Modal 視窗
     ============================== -->
<div id="editModal">
  <div>
    <button id="cancelEditBtn" title="按 Esc 或點我關閉">✖</button>
    <button id="enterEditBtn">編輯</button>

    <div style="display: flex; justify-content: center;">
  <h2>看診資訊</h2>
</div>
    <!-- 欄位資料 -->
    <label>長輩姓名<input type="text" id="editElderName" placeholder="長輩姓名" readonly></label>
    <label>日期<input type="date" id="editDate" readonly></label>
    <label>時間<input type="time" id="editTime" readonly></label>
    <label>醫生姓名<input type="text" id="editDoctorName" placeholder="請輸入醫生姓名" readonly>
    </label>
    <label>醫生科別
  <input type="text" id="editDepartment" list="editDepartmentList" placeholder="請選擇科別" readonly>
  <datalist id="editDepartmentList">
    <option value="內科"></option>
    <option value="外科"></option>
    <option value="小兒科"></option>
    <option value="婦產科"></option>
    <option value="耳鼻喉科"></option>
    <option value="眼科"></option>
    <option value="皮膚科"></option>
    <option value="骨科"></option>
    <option value="泌尿科"></option>
    <option value="神經內科"></option>
    <option value="精神科"></option>
    <option value="心臟內科"></option>
    <option value="胸腔內科"></option>
    <option value="胃腸肝膽科"></option>
    <option value="內分泌新陳代謝科"></option>
    <option value="復健科"></option>
    <option value="整形外科"></option>
    <option value="大腸直腸外科"></option>
    <option value="急診醫學科"></option>
    <option value="家庭醫學科"></option>
  </datalist>
  </label>
    <label>內容<textarea id="editRecord" rows="3" readonly></textarea></label>
    <label>備註<textarea id="editNote" rows="3" readonly></textarea></label>

    <!-- 儲存/刪除按鈕 -->
    <div style="text-align:center; margin-top:10px;">
      <button id="saveEditBtn">儲存</button>
      <button id="deleteEditBtn">刪除</button>
    </div>
  </div>
</div>

<!-- ==============================
     儲存確認提示視窗
     ============================== -->
<div id="saveConfirmModal">
  <div>
    <h3>此次修改需要儲存嗎？</h3>
    <p>若未儲存，變更的內容將會遺失。</p>
    <button id="confirmSaveBtn">儲存</button>
    <button id="continueEditBtn">繼續編輯</button>
    <button id="confirmDiscardBtn">放棄</button>
  </div>
</div>

<!-- ==============================
     JavaScript 程式區
     ============================== -->
<script>
/* 重要：把下面的 API_BASE 改成你的 Supabase REST endpoint 或你自己架的 proxy URL
   範例格式（Supabase REST）：
   const API_BASE = "https://your-project.supabase.co/rest/v1/consultations";

   如果你使用 Supabase 的 REST，通常需要 anon key 才能做寫入 (POST/PATCH/DELETE)。
   但你要求「不需要 API Key」，則請確認你的 endpoint 已經允許匿名存取或使用一個不需 key 的 proxy。
*/
const API_BASE = "https://supabase-api-six.vercel.app/consultations"; // <-- 這裡改成資料庫 URL

let editRowIndex = null;
let editRowId = null;
let isEditing = false;
let originalData = {};

function clearInputs() {
  ["elderName", "date", "time", "name", "department", "record", "note"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });
}

function updateNoRecordMessage() {
  const tbody = document.querySelector("#dataTable tbody");
  const hasRecords = tbody && tbody.rows.length > 0;
  document.querySelector(".table-container").style.display = hasRecords ? "block" : "none";
  document.getElementById("no-record-msg").style.display = hasRecords ? "none" : "block";
}

window.addEventListener("DOMContentLoaded", () => {
  loadData();
  updateNoRecordMessage();
});

/* 以 fetch 從後端取得資料，並用迴圈 (forEach) 建立表列 */
async function loadData() {
  try {
    const res = await fetch(API_BASE, { method: "GET", headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error(`讀取失敗：${res.status} ${res.statusText}`);
    const json = await res.json();

    // 支援兩種常見回傳格式：
    // 1) 直接回傳陣列       -> json 是 Array
    // 2) 包在 { success: true, data: [...] } -> json.data 是陣列
    const list = Array.isArray(json) ? json : (json && Array.isArray(json.data) ? json.data : []);
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    list.forEach(item => {
      const row = tbody.insertRow();
      // 嘗試幾種可能的欄位名稱，確保兼容不同 API
      const id = item.id ?? item.ID ?? item.Id ?? "";
      row.dataset.id = id;
      const elder = item.elderName ?? item.ElderName ?? item.name ?? "";
      const date = item.date ?? item.Date ?? "";
      const time = item.time ?? item.Time ?? "";
      const doctor = item.doctorName ?? item.DoctorName ?? "";
      const dept = item.department ?? item.Department ?? "";
      const record = item.record ?? item.Record ?? "";
      const note = item.note ?? item.Note ?? "";

      row.insertCell(0).innerText = elder;
      row.insertCell(1).innerText = date;
      row.insertCell(2).innerText = time;
      row.insertCell(3).innerText = doctor;
      row.insertCell(4).innerText = dept;
      row.insertCell(5).innerText = record;
      row.insertCell(6).innerText = note;

      const actionCell = row.insertCell(7);
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.innerText = "編輯";
      editBtn.style.padding = "6px 10px";
      editBtn.onclick = () => openEditModal(row);
      actionCell.appendChild(editBtn);
    });

    altRows && altRows("dataTable");
    updateNoRecordMessage();
  } catch (err) {
    console.error("loadData error:", err);
    alert("讀取資料失敗，詳情請看 console");
  }
}

/* 新增：POST 到後端（請確保 API 支援 POST /consultations） */
async function addRow() {
  const elderName = document.getElementById("elderName").value.trim();
  const date = document.getElementById("date").value.trim();
  const time = document.getElementById("time").value.trim();
  if (!date || !time) { alert("請輸入日期與時間！"); return; }
  const doctorName = document.getElementById("name").value.trim();
  const department = document.getElementById("department").value.trim();
  const record = document.getElementById("record").value.trim();
  const note = document.getElementById("note").value.trim();

  const payload = { elderName, date, time, doctorName, department, record, note };

  try {
    const res = await fetch(API_BASE, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
        // 如果你後端需要 API key，把它放在這裡（但你說不需要）
        // "apikey": "YOUR_ANON_KEY"
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const text = await res.text().catch(()=>"");
      throw new Error(`新增失敗 ${res.status} ${res.statusText} ${text}`);
    }
    await loadData();
    clearInputs();
    alert("已新增並同步到資料庫 ✅");
  } catch (err) {
    console.error("addRow error:", err);
    alert("新增失敗，請查看 console（可能為 CORS 或 URL 錯誤）");
  }
}

/* open edit modal（從表格列讀值） */
function openEditModal(row) {
  editRowIndex = row.rowIndex;
  editRowId = row.dataset.id || null;
  const fields = ["ElderName","Date","Time","DoctorName","Department","Record","Note"];
  fields.forEach((f,i) => {
    const el = document.getElementById("edit" + f);
    if (el) {
      el.value = row.cells[i].innerText || "";
      originalData[f] = el.value;
    }
  });
  setReadOnly(false);
  const modal = document.getElementById("editModal");
  modal.style.display = "block";
  setTimeout(()=> modal.classList.add("show"), 10);
  document.querySelector(".nav-1").style.display = "none";
}

function setReadOnly(readOnly) {
  document.querySelectorAll("#editModal input, #editModal textarea").forEach(el => {
    el.readOnly = readOnly;
    el.style.backgroundColor = readOnly ? "#f7f7f7" : "white";
  });
  document.getElementById("saveEditBtn").style.display = readOnly ? "none" : "inline-block";
  document.getElementById("deleteEditBtn").style.display = readOnly ? "none" : "inline-block";
  document.getElementById("enterEditBtn").style.display = readOnly ? "inline-block" : "none";
  isEditing = !readOnly;
}

document.getElementById("enterEditBtn").onclick = () => setReadOnly(false);

/* 儲存：PATCH（注意：若你使用 Supabase REST，PATCH 的 URL 可能需改為 query style） */
document.getElementById("saveEditBtn").onclick = async () => {
  if (!editRowId) { alert("找不到該筆資料的 id，無法更新"); return; }
  const payload = {
    elderName: document.getElementById("editElderName").value.trim(),
    date: document.getElementById("editDate").value.trim(),
    time: document.getElementById("editTime").value.trim(),
    doctorName: document.getElementById("editDoctorName").value.trim(),
    department: document.getElementById("editDepartment").value.trim(),
    record: document.getElementById("editRecord").value.trim(),
    note: document.getElementById("editNote").value.trim()
  };

  try {
    // 通常 REST API 更新的路徑可能是 API_BASE/{id}，若使用 Supabase REST 則可能需要 ?id=eq.<id>
    const url = `${API_BASE}/${encodeURIComponent(editRowId)}`; // 若不符合你的 API，請修改此行
    const res = await fetch(url, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error("更新失敗 " + res.status);
    await loadData();
    alert("資料已更新 ✅");
    closeModal();
  } catch (err) {
    console.error("saveEdit error:", err);
    alert("更新失敗，請查看 console");
  }
};

/* 刪除 */
document.getElementById("deleteEditBtn").onclick = async () => {
  if (!editRowId) { alert("找不到該筆資料的 id，無法刪除"); return; }
  if (!confirm("確定刪除此筆資料？")) return;
  try {
    const url = `${API_BASE}/${encodeURIComponent(editRowId)}`; // 若使用 Supabase REST，改為 `${API_BASE}?id=eq.${editRowId}`
    const res = await fetch(url, { method: "DELETE" });
    if (!res.ok) throw new Error("刪除失敗 " + res.status);
    await loadData();
    alert("資料已刪除 ✅");
    closeModal();
  } catch (err) {
    console.error("delete error:", err);
    alert("刪除失敗，請查看 console");
  }
};

function hasChanges() {
  return ["ElderName","Date","Time","DoctorName","Department","Record","Note"].some(
    f => document.getElementById("edit" + f).value !== originalData[f]
  );
}

function tryCloseModal() {
  if (isEditing && hasChanges()) showSaveConfirmModal();
  else closeModal();
}

function closeModal() {
  const modal = document.getElementById("editModal");
  modal.classList.remove("show");
  setTimeout(()=> modal.style.display = "none", 300);
  setReadOnly(true);
  document.querySelector(".nav-1").style.display = "flex";
}

document.getElementById("cancelEditBtn").onclick = tryCloseModal;
document.addEventListener("keydown", e => { if (e.key === "Escape") tryCloseModal(); });

/* 儲存確認 modal 綁定 */
document.getElementById("confirmSaveBtn").onclick = () => { document.getElementById("saveEditBtn").click(); closeSaveConfirmModal(); };
document.getElementById("confirmDiscardBtn").onclick = () => { closeSaveConfirmModal(); closeModal(); };
document.getElementById("continueEditBtn").onclick = () => closeSaveConfirmModal();

function showSaveConfirmModal() {
  const m = document.getElementById("saveConfirmModal");
  m.style.display = "block"; setTimeout(()=> m.classList.add("show"), 10);
}
function closeSaveConfirmModal() {
  const m = document.getElementById("saveConfirmModal");
  m.classList.remove("show"); setTimeout(()=> m.style.display = "none", 300);
}

/* LIFF 與其他既有程式碼略...（不變） */
</script>

</body>
</html>
