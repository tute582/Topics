<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>çœ‹è¨ºè³‡è¨Š</title>

    <style>
      /* =========================================
          1. åŸºç¤è¨­å®šèˆ‡é…è‰²
          ========================================= */
      body {
        font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
        padding: 0;
        margin: 0;
        background-color: #f0f4f8;
        color: #333;
      }

      /* =========================================
       2. é ‚éƒ¨å°è¦½åˆ—
       ========================================= */
      .nav-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1001;
        width: 100%;
        padding: 10px 25px;
        background-color: white;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        color: black;
      }

      .volunteer-area {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .volunteer-area .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #ddd;
        display: none;
      }

      .volunteer-area #volunteerName {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        background: transparent;
      }

      .volunteer-area button {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 14px;
        margin-top: 0;
      }


      /* =========================================
          2. åˆ†é å°è¦½åˆ— (Tabs)
          ========================================= */
      .tab-nav {
        display: flex;
        padding: 0 20px;
        background-color: #ffffff;
        border-bottom: 2px solid #ddd;
        margin-bottom: 15px;
      }

      .tab-link {
        flex: 1;
        text-align: center;
        text-decoration: none;
        padding: 15px 0;
        font-size: 18px;
        font-weight: bold;
        color: #666;
        border-bottom: 4px solid transparent;
        transition: all 0.2s ease;
      }

      .tab-link.active {
        color: #4a90e2;
        border-bottom-color: #4a90e2;
      }

      .container { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

      .page-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #2c3e50; border-left: 6px solid #4a90e2; padding-left: 10px; }

      /* =========================================
          3. å¡ç‰‡è¨­è¨ˆ
          ========================================= */
      .record-card {
        background: white;
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
      }

      .card-accent { position: absolute; left: 0; top: 0; bottom: 0; width: 8px; background: #bdc3c7; }
      .accent-heart { background: #ff6b6b; }
      .accent-bone { background: #f1c40f; }
      .accent-eye { background: #1abc9c; }
      .accent-rehab { background: #9b59b6; }
      .accent-dental { background: #3498db; }

      .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
      .date-box { font-size: 24px; font-weight: 900; color: #34495e; }

      .edit-btn {
        background: #4a90e2;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
      }

      .card-body { display: flex; flex-direction: column; gap: 10px; }
      .info-item { font-size: 18px; line-height: 1.4; display: flex; align-items: flex-start; }
      .label-text { color: #7f8c8d; font-weight: bold; min-width: 95px; flex-shrink: 0; }
      .content-text { color: #333; font-weight: 500; }
      
      .dept-text { color: #333; font-weight: bold; }

      .medical-notes { background: #f8f9fa; padding: 12px; border-radius: 12px; border: 1px solid #edf2f7; margin-top: 5px; }
      .notes-title { font-weight: bold; color: #4a90e2; display: block; margin-bottom: 4px; }

      .remark-box { color: #e67e22; font-weight: bold; font-size: 17px; margin-top: 5px; }

      /* =========================================
          4. CRUD å½ˆçª—
          ========================================= */
      .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        width: 90%;
        max-width: 450px;
        border-radius: 25px;
        padding: 25px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-title { font-size: 22px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #2c3e50; }
      .form-group { margin-bottom: 18px; }
      .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; font-size: 18px; }
      .form-group input, .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid #edf2f7;
        border-radius: 12px;
        font-size: 18px;
        box-sizing: border-box;
        background-color: #f9fbff;
      }
      .modal-btns { display: flex; gap: 10px; margin-top: 25px; }
      .btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; }
      .btn-save { background: #2ecc71; color: white; }
      .btn-delete { background: #e74c3c; color: white; }
      .btn-cancel { background: #95a5a6; color: white; }

      .add-fab {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 70px;
        height: 70px;
        background: #4a90e2;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 40px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1500;
      }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div style="font-size: 20px; font-weight: bold;">çœ‹è¨ºè³‡è¨Š</div>
      <div class="volunteer-area">
        <img id="userAvatar" class="avatar" src="https://via.placeholder.com/45" style="display: none" />
        <span id="userName" style="font-weight: bold">è¼‰å…¥ä¸­...</span>
      </div>
    </nav>

    <div class="tab-nav">
      <a href="./index copy.html" class="tab-link active">çœ‹è¨ºç´€éŒ„</a>
      <a href="../family-view/index.html" class="tab-link">çœ‹è¨ºé€²åº¦</a>
    </div>

    <div class="container">
      <h2 class="page-title">å°±é†«ç´€éŒ„ç®¡ç†</h2>
      <div id="recordList"></div>
      <div id="noDataMsg" class="no-data" style="display: none; text-align:center; padding: 50px; color:#999;">ç›®å‰æ²’æœ‰ç´€éŒ„å–”ï¼</div>
    </div>

    <div class="add-fab" onclick="openModal()">+</div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <div id="modalTitle" class="modal-title">ä¿®æ”¹çœ‹è¨ºç´€éŒ„</div>
        <input type="hidden" id="editIndex">
        
        <div class="form-group">
          <label>ğŸ“… çœ‹è¨ºæ—¥æœŸ</label>
          <input type="date" id="field_date">
        </div>
        <div class="form-group">
          <label>â° çœ‹è¨ºæ™‚é–“</label>
          <input type="time" id="field_time">
        </div>
        <div class="form-group">
          <label>ğŸ¥ é†«ç”Ÿç§‘åˆ¥</label>
          <input type="text" id="field_dept" placeholder="ä¾‹å¦‚ï¼šå¿ƒè‡Ÿå…§ç§‘">
        </div>
        <div class="form-group">
          <label>ğŸ‘¨â€âš•ï¸ é†«ç”Ÿå§“å</label>
          <input type="text" id="field_doctor" placeholder="é†«ç”Ÿåå­—">
        </div>
        <div class="form-group">
          <label>ğŸ“– å›‘å’å…§å®¹</label>
          <textarea id="field_details" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>ğŸ”” æé†’å‚™è¨»</label>
          <input type="text" id="field_remarks">
        </div>

        <div class="modal-btns">
          <button class="btn btn-delete" id="deleteBtn" onclick="deleteRecord()">åˆªé™¤</button>
          <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
          <button class="btn btn-save" onclick="saveRecord()">å„²å­˜</button>
        </div>
      </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      /* -----------------------------------------
       1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š (Global Config)
       ----------------------------------------- */
      const LIFF_ID = "2008484068-qkydRNYN";
      const POST_SUPABASE_API_URL =
        "https://supabase-api-six.vercel.app/consultations";

      let userId = "";
      let userName = "";
      let currentEditEventId = "";
      let editRowIndex = null;
      let isEditing = false;
      let originalData = {};

      const avatarEl = document.getElementById("volunteerAvatar");
      const nameEl = document.getElementById("volunteerName");

      
      // å·²æ›´æ–°ç‚º 5 ç­†å‡è³‡æ–™
      let dummyData = [
        {
          visit_time: "2026-01-06T09:30",
          department: "å¿ƒè‡Ÿå…§ç§‘",
          doctor_name: "é™³å¿—æ˜",
          visit_details: "å®šæœŸå›è¨ºï¼Œæ•¸å€¼æ­£å¸¸ã€‚æ³¨æ„é£²é£Ÿæ¸…æ·¡ã€‚",
          remarks: "è¨˜å¾—æ—©æ™šé‡è¡€å£“"
        },
        {
          visit_time: "2025-12-20T14:15",
          department: "éª¨ç§‘",
          doctor_name: "æ—å»ºå‹³",
          visit_details: "å·¦è†è“‹ç–¼ç—›ï¼Œé€²è¡Œå¾©å¥ã€‚æ¸›å°‘çˆ¬æ¨“æ¢¯ã€‚",
          remarks: "ä¸‹é€±äºŒå¾©å¥"
        },
        {
          visit_time: "2025-11-15T10:00",
          department: "çœ¼ç§‘",
          doctor_name: "å¼µç¾æƒ ",
          visit_details: "è¦–ç¶²è†œæª¢æŸ¥æ­£å¸¸ã€‚çœ¼è—¥æ°´æ¯å¤©æ—©æ™šé»ä¸€æ¬¡ã€‚",
          remarks: "å‡ºé–€æˆ´å¤ªé™½çœ¼é¡"
        },
        {
          visit_time: "2025-10-05T15:30",
          department: "å¾©å¥ç§‘",
          doctor_name: "ç‹å¤§å¤«",
          visit_details: "è‚©é ¸ç— ç—›æ”¹å–„ä¸­ï¼ŒæŒçºŒæ‹‰ç­‹é‹å‹•ã€‚",
          remarks: "æ¯å¤©åœ¨å®¶æ‹‰ç­‹10åˆ†é˜"
        },
        {
          visit_time: "2025-09-12T09:00",
          department: "ç‰™ç§‘",
          doctor_name: "æé†«å¸«",
          visit_details: "æ´—ç‰™åŠä¾‹è¡Œæª¢æŸ¥ï¼Œæœ‰ä¸€é¡†è¼•å¾®è›€ç‰™ä¸‹æ¬¡è™•ç†ã€‚",
          remarks: "é£¯å¾Œè¨˜å¾—ç”¨ç‰™ç·š"
        }
      ];

      /* -----------------------------------------
       2. åˆå§‹åŒ–èˆ‡ LIFF æ•´åˆ (Init & LIFF)
       ----------------------------------------- */
      initDateTimePickers();
      initLiffAndSetProfile();
      updateNoRecordMessage();

      async function initLiffAndSetProfile() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            nameEl.innerText = "æœªç™»å…¥";
            avatarEl.style.display = "none";
            await loadData();
            return;
          }

          const profile = await liff.getProfile();
          userId = profile.userId;
          userName = profile.displayName;
          localStorage.setItem("userId", userId);
          console.log("LIFF Profile userId:", userId, "userName:", userName);

          nameEl.innerText = profile.displayName || "å¿—å·¥";
          if (profile.pictureUrl) {
            avatarEl.src = profile.pictureUrl;
            avatarEl.style.display = "inline-block";
          } else {
            avatarEl.style.display = "none";
          }

          await loadData();
        } catch (err) {
          console.error("LIFF init error:", err);
        }
      }

      avatarEl.addEventListener("click", () => {
        if (liff.isLoggedIn()) {
          // æª¢æŸ¥å¾Œç«¯æ˜¯å¦æœ‰é€™å€‹userIdè¨»å†Š
          fetch(`https://supabase-api-six.vercel.app/identify/${userId}`)
            .then((res) => res.json())
            .then((result) => {
              if (!result.success) {
                // ç„¡æ•ˆèº«åˆ†ï¼Œå°å‘è¨»å†Šé é¢
                alert("ç¬¬ä¸€æ¬¡å°‡ç‚ºæ‚¨å°å…¥è¨»å†Šé é¢ï¼Œé»æ“Šã€Œç¢ºå®šã€å‰å¾€è¨»å†Šé é¢ã€‚");
                window.location.href = "../../Login-or-register/index.html";
              } else {
                // å·²è¨»å†Šï¼Œå–å¾—èº«åˆ†
                let identify = result.role; //å›å‚³æ–‡å­—(å¿—å·¥æˆ–é•·è€…)
                console.log("ç™»å…¥è§’è‰² roleï¼š", result.role);
                localStorage.setItem("fromPage", "record-information");
                switch (identify) {
                  case "å¿—å·¥":
                    window.location.href =
                      "../../Login-or-register/å¿—å·¥è³‡æ–™é¡¯ç¤º.html";
                    break;
                  case "é•·è€…":
                    window.location.href =
                      "../../Login-or-register/é•·è¼©è³‡æ–™é¡¯ç¤º.html";
                    break;
                  default:
                    // "æœªè¨»å†Š" æˆ– undefined éƒ½å°å¾€ç™»å…¥
                    window.location.href = "../../Login-or-register/index.html";
                }
              }
            })
            .catch((err) => {
              console.error("èº«åˆ†æª¢æŸ¥ API éŒ¯èª¤ï¼š", err);
              // API å‡ºéŒ¯ä¹Ÿè¦–ç‚ºç„¡æ•ˆèº«åˆ†
              window.location.href = "../../Login-or-register/index.html";
            });
        } else {
          liff.login({ redirectUri: window.location.href });
        }
      });

      nameEl.addEventListener("click", () => {
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
        } else {
          alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
        }
      });

      function renderCards(data) {
        const listContainer = document.getElementById("recordList");
        listContainer.innerHTML = "";
        data.sort((a, b) => new Date(b.visit_time) - new Date(a.visit_time));

        data.forEach((item, index) => {
          const dt = new Date(item.visit_time);
          const dateStr = `${dt.getFullYear()}å¹´ ${dt.getMonth()+1}æœˆ ${dt.getDate()}æ—¥`;
          const timeStr = dt.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });

          let accentClass = "";
          if (item.department.includes("å¿ƒè‡Ÿ")) accentClass = "accent-heart";
          else if (item.department.includes("éª¨")) accentClass = "accent-bone";
          else if (item.department.includes("çœ¼")) accentClass = "accent-eye";
          else if (item.department.includes("å¾©å¥")) accentClass = "accent-rehab";
          else if (item.department.includes("ç‰™")) accentClass = "accent-dental";

          const card = `
            <div class="record-card">
              <div class="card-accent ${accentClass}"></div>
              <div class="card-header">
                <div class="date-box">${dateStr}</div>
                <button class="edit-btn" onclick="openModal(${index})">ç·¨è¼¯</button>
              </div>
              <div class="card-body">
                <div class="info-item">
                  <span class="label-text">çœ‹è¨ºæ™‚é–“ï¼š</span>
                  <span class="content-text" style="font-size: 20px; color: #4a90e2;">${timeStr}</span>
                </div>
                <div class="info-item">
                  <span class="label-text">é†«ç”Ÿç§‘åˆ¥ï¼š</span>
                  <span class="content-text dept-text">${item.department}</span>
                </div>
                <div class="info-item">
                  <span class="label-text">é†«ç”Ÿå§“åï¼š</span>
                  <span class="content-text">${item.doctor_name} é†«å¸«</span>
                </div>
                <div class="medical-notes">
                  <span class="notes-title">ğŸ“– é†«ç”Ÿå›‘å’å…§å®¹ï¼š</span>
                  <span class="content-text">${item.visit_details}</span>
                </div>
                ${item.remarks ? `<div class="remark-box">ğŸ”” æé†’ï¼š${item.remarks}</div>` : ""}
              </div>
            </div>
          `;
          listContainer.innerHTML += card;
        });
      }

      function openModal(index = -1) {
        const modal = document.getElementById("editModal");
        const deleteBtn = document.getElementById("deleteBtn");
        document.getElementById("editIndex").value = index;

        if (index === -1) {
          document.getElementById("modalTitle").innerText = "æ–°å¢çœ‹è¨ºç´€éŒ„";
          document.getElementById("field_date").value = "";
          document.getElementById("field_time").value = "";
          document.getElementById("field_dept").value = "";
          document.getElementById("field_doctor").value = "";
          document.getElementById("field_details").value = "";
          document.getElementById("field_remarks").value = "";
          deleteBtn.style.display = "none";
        } else {
          document.getElementById("modalTitle").innerText = "ä¿®æ”¹çœ‹è¨ºç´€éŒ„";
          const item = dummyData[index];
          const parts = item.visit_time.split('T');
          document.getElementById("field_date").value = parts[0];
          document.getElementById("field_time").value = parts[1];
          document.getElementById("field_dept").value = item.department;
          document.getElementById("field_doctor").value = item.doctor_name;
          document.getElementById("field_details").value = item.visit_details;
          document.getElementById("field_remarks").value = item.remarks;
          deleteBtn.style.display = "block";
        }
        modal.style.display = "flex";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function saveRecord() {
        const index = parseInt(document.getElementById("editIndex").value);
        const datePart = document.getElementById("field_date").value;
        const timePart = document.getElementById("field_time").value;

        if (!datePart || !timePart || !document.getElementById("field_dept").value) {
          alert("è«‹å¡«å¯«æ—¥æœŸã€æ™‚é–“èˆ‡ç§‘åˆ¥å–”ï¼");
          return;
        }

        const newData = {
          visit_time: `${datePart}T${timePart}`,
          department: document.getElementById("field_dept").value,
          doctor_name: document.getElementById("field_doctor").value,
          visit_details: document.getElementById("field_details").value,
          remarks: document.getElementById("field_remarks").value
        };

        if (index === -1) {
          dummyData.push(newData);
        } else {
          dummyData[index] = newData;
        }

        renderCards(dummyData);
        closeModal();
      }

      function deleteRecord() {
        const index = parseInt(document.getElementById("editIndex").value);
        if (confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
          dummyData.splice(index, 1);
          renderCards(dummyData);
          closeModal();
        }
      }
    </script>
  </body>
</html>