<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- 響應式，讓手機可正確縮放 -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>看診資訊</title>

  <style>
    /* ==============================
       全域設定：版面與字體
       ============================== */
    body { 
      font-family: "Arial", sans-serif;
      padding: 0;
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .input-container, .search-container {
      margin-left: 25px;
      margin-right: 25px;
    }

    .input-container {
      margin-top: 15px;
    }

    .search-container {
      margin-bottom: 30px;
    }

    .title {
      margin: 5px 0;
      font-size: 26px;
    }

    /* 標題樣式 */
    h1 { 
      margin-top: 5px;
      margin-bottom: 5px;
      /*font-size: 42px; */ 
    }
    h2 { 
      margin-top: 5px;
      margin-bottom: 5px;
      font-size: 20px; 
      display: inline-block; }

    h3 { 
      margin: 0; 
      font-size: 16px; 
      color: #555; 
    }

    /* 表單外框樣式 */
    .input-container > form {
      width:100%; 
      margin: 10px 0;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 20px;
      box-sizing: border-box;
    }

    /* ==============================
       表格容器樣式
       ============================== */
    .table-container {
      width: 100%;
      margin: 5px ;
      /* 允許水平滾動，必要時顯示水平滾軸 */
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* 行動裝置平滑滾動 */
      /* 若希望在內容超出時總是顯示水平滾軸（某些系統會隱藏），可改用 overflow: auto; */
      /* max-height: 200px;  限制高度，超過出現滾輪 */
      border: 1px solid #aaa;
      border-radius: 20px;
      background-color: white;
      display: none; /* ✅ 一開始整個容器隱藏 */
    }

    /* 表格基本樣式 */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      /* 設定比容器寬，當容器較窄會出現橫向滾動 */
      min-width: 800px; 
      box-sizing: border-box;
    }
    
    /*#message {
      margin-top: 15px;
      font-weight: bold;
      color: #444;
    }*/

    th, td { 
      padding:10px; 
      text-align:center; 
      border: 1px solid #ddd;
      white-space: nowrap; /* 防止換行，配合橫向滾動 */
    }
    
    /* 行動裝置上仍可觸發橫向捲動（若想在窄螢幕降低 min-width 可用下面的設定） */
    @media (max-width: 600px) {
      table { min-width: 700px; }
    }

    /* 表頭固定 */
    th { 
      background-color:#f9f9f9; 
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* ==============================
       響應式設定（手機介面）
       ============================== */
    @media (max-width: 768px) {
    
      form { width: 95%; }
      /* 在手機上移除強制最小寬度 讓表格可縮放並出現橫向滾動 */
      table { min-width: 0; width:100%; }
      /* 調整輸入欄位字級與按鈕更適合手機 */
      input[type="text"], input[type="date"], input[type="time"], textarea { font-size:16px; padding:10px; }
      button { padding:12px 18px; font-size:16px; }
    }

    /* 表單輸入欄位樣式 */
    label{ 
      display:block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 20px;
    }

    input[type="text"], input[type="date"], input[type="time"],
    textarea {
      width:100% ;
      padding:8px;
      margin-top:5px;
      border-radius:10px;
      border:1px solid #888;
      font-size:14px;
      box-sizing:border-box;
      background-color: white; /* 主表單預設白底 */
      color: #222;
    }
    /* 若輸入欄位為 readonly，也保持白底（覆蓋瀏覽器預設灰底） */
    input[readonly], textarea[readonly], input[readonly]:not([type="checkbox"]) {
      background-color: white;
      cursor: default;
    }
    textarea { font-size:16px; }

    /* 按鈕樣式 */
    button {
      margin-top:15px; 
      padding:10px 20px; 
      border:none; 
      border-radius:10px;
      background-color:#4a90e2; color:white; 
      cursor:pointer; 
      font-size:20px;
    }
    button:hover { background-color:#357abd; }

    /* 表格列的交錯顏色 */
    .evenrowcolor{ background-color: #f9f9f9; }
    .oddrowcolor{ background-color: #ffffff; }

    /* ==============================
       Modal 編輯視窗樣式
       ============================== */
    #editModal {
      display:none;
      position:fixed; top:0; left:0;
      width:100%; height:100%;
      background-color:rgba(0,0,0,0.5);
      z-index:1000;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #editModal.show { display:block; opacity:1; }

    /* Modal 盒子：固定寬度但會在窄螢幕縮放；內容可垂直滾動 */
    #editModal > div {
      background:#fff;
      width:420px;
      max-width: calc(100% - 40px); /* 在小螢幕時自動縮小 */
      margin:80px auto;
      padding:20px 24px;
      border-radius:15px;
      position:relative;
      box-sizing: border-box;
      max-height: calc(100vh - 100px); /* 可見範圍內最大高度 */
      overflow-y: auto; /* 內容超出時顯示捲軸 */
      transform:translateY(-20px);
      transition:transform 0.3s ease;
    }
    #editModal.show > div { transform:translateY(0); }

    /* ==============================
       編輯視窗按鈕樣式
       ============================== */
    #cancelEditBtn {
      background:none;
      border:none;
      color:#555;
      font-size:20px;
      position:absolute;
      top:10px;
      right:10px;
      cursor:pointer;
      border-radius:5px;
      padding:5px 10px;
      transition: all 0.3s ease;
    }
    #cancelEditBtn:hover {
      background-color:#e74c3c; /* 紅色背景 */
      color:white;
      transform: scale(1.1);
    }

    /* 編輯按鈕 */
    #enterEditBtn {
      position:absolute; top:10px; right:10px;
      background-color:#f4b977; color:#333;
      border:none; border-radius:8px; padding:6px 12px; cursor:pointer;
      transition:all 0.3s ease;
    }
    #enterEditBtn:hover { background-color:#e0b557; }

    /* 儲存與刪除按鈕 */
    #saveEditBtn, #deleteEditBtn {
      margin-top:10px; font-size:16px; padding:8px 15px;
      border-radius:10px; border:none; cursor:pointer; display:none;
    }
    #saveEditBtn { background-color:#4a90e2; color:white; }
    #saveEditBtn:hover { background-color:#357abd; }
    #deleteEditBtn { background-color:#f37a7a; color:white; }
    #deleteEditBtn:hover { background-color:#d94a4a; }

    h3{ margin-top:0; text-align:center; }

    /* ==============================
       儲存提示視窗 (是否儲存變更)
       ============================== */
    #saveConfirmModal {
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background-color:rgba(0,0,0,0.5);
      z-index:2000;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #saveConfirmModal.show { display:block; opacity:1; }

    #saveConfirmModal > div {
      background:#fff;
      width:350px;
      margin:150px auto;
      padding:25px;
      border-radius:15px;
      text-align:center;
      transform:translateY(-20px);
      transition:transform 0.3s ease;
    }
    #saveConfirmModal.show > div { transform:translateY(0); }

    /* 提示視窗按鈕樣式 */
    #saveConfirmModal button {
      margin:10px;
      padding:8px 18px;
      font-size:16px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition: all 0.3s ease;
    }
    #confirmSaveBtn { background-color:#4a90e2; color:white; }
    #confirmSaveBtn:hover { background-color:#357abd; }

    #confirmDiscardBtn { background-color:#f37a7a; color:white; }
    #confirmDiscardBtn:hover { background-color:#d94a4a; }

    #continueEditBtn {
      background-color:#f2f2f2;
      color:white;
      font-size:15px;
    }
    #continueEditBtn:hover { background-color:#ffffff; }
    
    /* 導覽列 */
  .nav-1{
    display: flex;                 /* 水平排列內容 */
   /* font-weight: 500;*/
    align-items: center;           /* 垂直置中 */
    justify-content: space-between;/* 兩端對齊：左/右 */
    padding: 10px 25px;           /* 右側保留內距，左側移除讓內容靠近頁邊 */
    position: sticky;              /* 滾動時吸附上方 */
    top: 0;                        /* 吸附頂部 */
    z-index: 1001;                 /* 保證在其他元素之上 */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: 100%;
    left: 0;
    right: 0;
    color: black;
    background-color: white;
    box-sizing: border-box; /* 確保padding不會超出寬度 */
    border-bottom: 1px solid #ddd; /* 建議加這行讓導覽列更明顯 */
  }

  .record-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
    }


  /* volunteer area */
  .volunteer-area { display:flex; align-items:center; gap:8px; }
  .volunteer-area .avatar {
    width:36px; height:36px; border-radius:50%; object-fit:cover;
    border:1px solid #ddd; display:none;
  }
  /* 可點擊的登入區域樣式 */
  .volunteer-area #volunteerName {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    background: transparent;
  }
  .volunteer-area button { padding:4px 8px; border-radius:6px; font-size:14px; }
  </style>
</head>

<body>
<!-- ==============================
     頁面標題與表單
     ============================== -->
<!-- 導覽列 -->
<nav class="nav-1" >
  <div>
    <h1 style="margin:0; font-size: 28px;">看診資訊</h1>
  </div>

  <div style="display:flex; align-items:center;">
    <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="default-avatar.png" alt="avatar"
             onerror="this.style.display='none';" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="點此以 Line 登入" style="cursor:pointer; font-size: 26px;">載入中</span>
      </span>
    </h1>
  </div>
</nav>


<div class="input-container"> 
<h1 class="title" style="font-size: 24px;"> 輸入內容</h1>
<!-- 輸入表單區 -->
<form>
  <label>長輩姓名<input type="text" id="elderName"></label>
  <label>看診日期<input type="date" id="date"></label>
  <label>看診時間<input type="time" id="time"></label>
  <label>醫生姓名<input type="text" id="name"></label>
  <label>醫生科別
  <input type="text" id="department" list="departmentList">
  <datalist id="departmentList">
    <option value="內科"></option>
    <option value="外科"></option>
    <option value="小兒科"></option>
    <option value="婦產科"></option>
    <option value="耳鼻喉科"></option>
    <option value="眼科"></option>
    <option value="皮膚科"></option>
    <option value="骨科"></option>
    <option value="泌尿科"></option>
    <option value="神經內科"></option>
    <option value="精神科"></option>
    <option value="心臟內科"></option>
    <option value="胸腔內科"></option>
    <option value="胃腸肝膽科"></option>
    <option value="內分泌新陳代謝科"></option>
    <option value="復健科"></option>
    <option value="整形外科"></option>
    <option value="大腸直腸外科"></option>
    <option value="急診醫學科"></option>
    <option value="家庭醫學科"></option>
  </datalist>
</label>
    <label for="record">看診內容 <textarea id="record" rows="2"></textarea></label>
   

    <label for="note">備註<textarea id="note" rows="2"></textarea></label>
    
  
  <button type="button" onclick="addRow()">新增</button>
</form>
</div>

<div class="search-container"> 
<!-- 查詢標題 -->

<h1 class="title" style="font-size: 24px;">查詢</h1>

<!-- 新增：無資料時顯示的訊息 -->
<div id="no-record-msg" class="no-record">目前尚未有紀錄</div>

<!-- ==============================
     資料表格區域
     ============================== -->
<div class="table-container">
  <table id="dataTable">
    <thead>
    <tr>
      <th>長輩姓名</th>
      <th>看診日期</th>
      <th>看診時間</th>
      <th>醫生姓名</th>
      <th>醫生科別</th>
      <th>看診內容</th>
      <th>備註</th>
      <th>操作</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
  
</div>
</div>

<!-- ==============================
     編輯資料 Modal 視窗
     ============================== -->
<div id="editModal">
  <div>
    <button id="cancelEditBtn" title="按 Esc 或點我關閉">✖</button>
    <button id="enterEditBtn">編輯</button>

    <div style="display: flex; justify-content: center;">
  <h2>看診資訊</h2>
</div>
    <!-- 欄位資料 -->
    <label>長輩姓名<input type="text" id="editElderName" placeholder="長輩姓名" readonly></label>
    <label>日期<input type="date" id="editDate" readonly></label>
    <label>時間<input type="time" id="editTime" readonly></label>
    <label>醫生姓名<input type="text" id="editDoctorName" placeholder="請輸入醫生姓名" readonly>
    </label>
    <label>醫生科別
  <input type="text" id="editDepartment" list="editDepartmentList" placeholder="請選擇科別" readonly>
  <datalist id="editDepartmentList">
    <option value="內科"></option>
    <option value="外科"></option>
    <option value="小兒科"></option>
    <option value="婦產科"></option>
    <option value="耳鼻喉科"></option>
    <option value="眼科"></option>
    <option value="皮膚科"></option>
    <option value="骨科"></option>
    <option value="泌尿科"></option>
    <option value="神經內科"></option>
    <option value="精神科"></option>
    <option value="心臟內科"></option>
    <option value="胸腔內科"></option>
    <option value="胃腸肝膽科"></option>
    <option value="內分泌新陳代謝科"></option>
    <option value="復健科"></option>
    <option value="整形外科"></option>
    <option value="大腸直腸外科"></option>
    <option value="急診醫學科"></option>
    <option value="家庭醫學科"></option>
  </datalist>
  </label>
    <label>內容<textarea id="editRecord" rows="3" readonly></textarea></label>
    <label>備註<textarea id="editNote" rows="3" readonly></textarea></label>

    <!-- 儲存/刪除按鈕 -->
    <div style="text-align:center; margin-top:10px;">
      <button id="saveEditBtn">儲存</button>
      <button id="deleteEditBtn">刪除</button>
    </div>
  </div>
</div>

<!-- ==============================
     儲存確認提示視窗
     ============================== -->
<div id="saveConfirmModal">
  <div>
    <h3>此次修改需要儲存嗎？</h3>
    <p>若未儲存，變更的內容將會遺失。</p>
    <button id="confirmSaveBtn">儲存</button>
    <button id="continueEditBtn">繼續編輯</button>
    <button id="confirmDiscardBtn">放棄</button>
  </div>
</div>

<!-- ==============================
     JavaScript 程式區
     ============================== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<!-- 刪除或註解掉原本這行 UMD 載入（不要同時保留）-->
<!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script> -->

<!-- 新增：以 module 動態 import ESM 版並建立 init Promise -->
<script type="module">
  // 使用 ESM 版本，避免 UMD 的 eval 被 CSP 擋掉
  // 注意：請先在檔案上方確認已經有 SUPABASE_URL / SUPABASE_ANON_KEY / CLINIC_TABLE 常數定義
  // 例如已在你的檔案中： const SUPABASE_URL = 'https://...'; const SUPABASE_ANON_KEY = '...';
  // 這段會設定全域 supabaseClient 並回傳 promise 供頁面等候
  window.initSupabasePromise = (async () => {
    try {
      if (typeof SUPABASE_URL === 'string' && typeof SUPABASE_ANON_KEY === 'string'
          && !SUPABASE_URL.includes('your-clinic-project')) {
        const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
        // supabaseClient 為檔案內同名變數（請勿重覆宣告）
        window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // 如果你的檔案內用的是局部 let supabaseClient = null;，請改用 window.supabaseClient 或移除重覆宣告
        console.debug('Supabase (ESM) client initialized');
        return window.supabaseClient;
      } else {
        console.debug('Supabase not configured - using local fallback');
        return null;
      }
    } catch (err) {
      console.warn('Supabase init failed', err);
      return null;
    }
  })();

  // 確保 addRow 在全域可呼叫（放在 addRow 函式定義之後）
  window.addRow = window.addRow || addRow;
</script>

<!-- 並且需要讓 window.onload 等待 initSupabasePromise（替換原本的 window.onload） -->
<script>
  // filepath: c:\Users\nctdr\OneDrive\桌面\前端網頁\1016\Topics\Topics\record-information\index copy.html
  // ...existing code...
  // 把原本的 window.onload = function () { loadData(); updateNoRecordMessage(); } 換成下面
  window.onload = async function () {
    try {
      // 等待 Supabase 初始化（若有設定）
      if (window.initSupabasePromise) {
        await window.initSupabasePromise;
        // 若 init 成功，將 module script 裡的 client 指向檔案內使用的變數名
        if (window.supabaseClient) {
          // 若你檔案內宣告 let supabaseClient = null;，請同步指回去：
          try { supabaseClient = window.supabaseClient; } catch(e) {}
        }
      }
    } catch(e) {
      console.warn('initSupabasePromise error', e);
    }
    // 最後再載入資料（會自動用 supabaseClient 或 localStorage）
    try {
      await loadData();
      updateNoRecordMessage();
      console.debug('page loaded');
    } catch (err) {
      console.error('loadData error', err);
    }
  };
</script>

<script>
/* ====== 原本頁面程式 (已保留、但下方會覆寫部分函式) ====== */
let editRowIndex = null;
let isEditing = false;
let originalData = {};

function clearInputs() {
  ["elderName", "date", "time", "name", "department", "record", "note"].forEach(id => {
    document.getElementById(id).value = "";
  });
}

/* ==============================
   ✅ 顯示／隱藏「目前尚未有紀錄」提示
   ============================== */
function updateNoRecordMessage() {
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  const hasRecords = tbody.rows.length > 0;
  const container = document.querySelector(".table-container");
  const noRecordMsg = document.getElementById("no-record-msg");

  if (hasRecords) {
    container.style.display = "block";
    noRecordMsg.style.display = "none";
  } else {
    container.style.display = "none";
    noRecordMsg.style.display = "block";
  }
}

// ✅ 初始化載入 localStorage 資料
// =============================
window.onload = function () {
  loadData();
  updateNoRecordMessage(); // 初次檢查
};

async function addRow() {
  const elderName = document.getElementById("elderName").value.trim();
  const date = document.getElementById("date").value.trim();
  const time = document.getElementById("time").value.trim();
  if (!date || !time) {
    alert("請輸入日期與時間！");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const department = document.getElementById("department").value.trim();
  const record = document.getElementById("record").value.trim();
  const note = document.getElementById("note").value.trim();

  const rowObj = {
    elder_name: elderName,
    date: date,
    time: time,
    doctor_name: name,
    department: department,
    record: record,
    note: note
  };

  if (supabaseClient) {
    // 若已設定 Supabase，新增後重新 fetch 顯示
    const inserted = await insertToSupabase(rowObj);
    if (inserted) {
      await fetchFromSupabase();
      clearInputs();
      alert('已新增並同步到 Supabase ✅');
      return;
    } else {
      alert('新增到 Supabase 失敗，改為儲存在本機');
    }
  }

  // fallback：原本 local 操作
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  const newRow = tbody.insertRow(-1);
  newRow.insertCell(0).innerText = elderName;
  newRow.insertCell(1).innerText = date;
  newRow.insertCell(2).innerText = time;
  newRow.insertCell(3).innerText = name;
  newRow.insertCell(4).innerText = department;
  newRow.insertCell(5).innerText = record;
  newRow.insertCell(6).innerText = note;
  const actionCell = newRow.insertCell(7);
  const editBtn = document.createElement("button");
  editBtn.type = "button";
  editBtn.innerText = "編輯";
  editBtn.style.padding = "6px 10px";
  editBtn.onclick = () => openEditModal(newRow);
  actionCell.appendChild(editBtn);

  sortTableByDateTime("dataTable");
  altRows("dataTable");
  addEditButtonsToRows();
  clearInputs();
  updateNoRecordMessage();
  saveData();
}

/* ==============================
   ✅ 日期 + 時間排序函式（穩定版）
   ============================== */
function sortTableByDateTime(tableId) {
  const table = document.getElementById(tableId);
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.rows);

  rows.sort((a, b) => {
    const dateA = a.cells[1]?.innerText || "";
    const timeA = a.cells[2]?.innerText || "";
    const dateB = b.cells[1]?.innerText || "";
    const timeB = b.cells[2]?.innerText || "";
    const dtA = new Date(`${dateA} ${timeA}`);
    const dtB = new Date(`${dateB} ${timeB}`);
    return dtA - dtB;
  });

  rows.forEach(r => tbody.appendChild(r));
}

function saveData() {
  localStorage.setItem("clinicData", document.getElementById("dataTable").innerHTML);
}

async function loadData() {
  if (supabaseClient) {
    await fetchFromSupabase();
    return;
  }
  const saved = localStorage.getItem("clinicData");
  if (saved) {
    document.getElementById("dataTable").innerHTML = saved;
    addEditButtonsToRows();
  }
  updateNoRecordMessage();
}

/* 修改 openEditModal 以記錄目前編輯的 row id（若有） */
function openEditModal(row) {
  editRowIndex = row.rowIndex;
  // 從 dataset 讀 id（可能為空，代表本機資料）
  const rowId = row.dataset.id || '';
  // 把 id 存到隱藏欄位（或全域變數）
  window.currentEditRowId = rowId;

  ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].forEach((f, i) => {
    const val = row.cells[i].innerText;
    document.getElementById("edit" + f).value = val;
    originalData[f] = val;
  });
  setReadOnly(false);
  const modal = document.getElementById("editModal");
  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);
  document.querySelector(".nav-1").style.display = "none";
}

/* 修改儲存按鈕事件：若有 Supabase 就更新後重新 fetch */
document.getElementById("saveEditBtn").onclick = async () => {
  const row = document.getElementById("dataTable").rows[editRowIndex];
  const updated = {
    elder_name: document.getElementById("editElderName").value.trim(),
    date: document.getElementById("editDate").value.trim(),
    time: document.getElementById("editTime").value.trim(),
    doctor_name: document.getElementById("editDoctorName").value.trim(),
    department: document.getElementById("editDepartment").value.trim(),
    record: document.getElementById("editRecord").value.trim(),
    note: document.getElementById("editNote").value.trim()
  };

  if (supabaseClient && window.currentEditRowId) {
    const res = await updateSupabase(window.currentEditRowId, updated);
    if (res) {
      await fetchFromSupabase();
      alert("資料已更新並同步到 Supabase ✅");
      closeModal();
      return;
    } else {
      alert("更新 Supabase 失敗，請稍後再試。");
    }
  }

  // fallback local update
  ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].forEach((f, i) => {
    row.cells[i].innerText = document.getElementById("edit" + f).value;
  });
  sortTableByDateTime("dataTable");
  altRows("dataTable");
  alert("資料已更新 ✅");
  saveData();
  closeModal();
};

document.getElementById("deleteEditBtn").onclick = async () => {
  if (!confirm("確定刪除此筆資料？")) return;
  const row = document.getElementById("dataTable").rows[editRowIndex];
  const id = window.currentEditRowId || row.dataset.id;
  if (supabaseClient && id) {
    await deleteFromSupabase(id);
    await fetchFromSupabase();
    alert("已從 Supabase 刪除");
    closeModal();
    return;
  }

  // fallback local delete
  document.getElementById("dataTable").deleteRow(editRowIndex);
  sortTableByDateTime("dataTable");
  altRows("dataTable");
  alert("資料已刪除 ✅");
  updateNoRecordMessage();
  saveData();
  closeModal();
};

/* ==============================
   在這裡開始覆寫部分函式以支援 Supabase
   ============================== */

/* 在這裡放置 Supabase 設定（請修改下面兩個常數為你的看診資訊資料庫） */
const SUPABASE_URL = 'https://your-clinic-project.supabase.co'; // ← TODO: 替換成「看診資訊」Supabase URL（你要放入的地方）
const SUPABASE_ANON_KEY = 'your-anon-public-key';               // ← TODO: 替換成對應的 anon/public key
const CLINIC_TABLE = 'consultations';                          // ← TODO: 替換成你在 Supabase 中的 table 名稱（例如：consultations 或 clinic_records）

let supabaseClient = null;
let PRIMARY_KEY = 'id'; // 會在 fetch 時自動偵測是否為 uuid

(async function initSupabase() {
  try {
    if (SUPABASE_URL && SUPABASE_ANON_KEY && !SUPABASE_URL.includes('your-clinic-project')) {
      // 使用 ESM 版（+esm）動態 import，避免 UMD 裡的 eval 被 CSP 擋掉
      const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.debug('Supabase (ESM) client initialized for 看診資訊');
    } else {
      console.debug('Supabase not configured - will use localStorage fallback');
    }
  } catch (e) {
    console.warn('Supabase init failed', e);
    supabaseClient = null;
  }
})();

/* 小工具：避免 XSS 的簡單 escape */
function escapeHtml(str) {
  if (str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/* ====== 用 Supabase 抓資料並以迴圈顯示（fetch + forEach） ====== */
async function fetchFromSupabase() {
  if (!supabaseClient) return;
  try {
    const { data, error } = await supabaseClient
      .from(CLINIC_TABLE)
      .select('*')
      .order('visit_time', { ascending: true }) // 若你用 date + time 欄位請改成相對應排序欄
      ;

    if (error) throw error;

    // 若第一筆有 uuid 欄位，將 PRIMARY_KEY 設成 uuid（你提供的 schema 有 uuid）
    if (Array.isArray(data) && data.length > 0) {
      PRIMARY_KEY = data[0].uuid ? 'uuid' : (data[0].id ? 'id' : PRIMARY_KEY);
    }

    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';

    // 用迴圈把每筆資料建立成表格列（對應你提供的欄位名稱）
    data.forEach((r) => {
      const tr = document.createElement('tr');

      const elder = escapeHtml(r.elder_name || r.elderName || '');
      // 有些資料表可能把時間分成 date/time 或 single datetime (visit_time)
      const date = escapeHtml(r.date || (r.visit_time ? r.visit_time.split('T')[0] : ''));
      const time = escapeHtml(r.time || (r.visit_time ? (new Date(r.visit_time)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''));
      const doctor = escapeHtml(r.doctor_name || r.doctorName || '');
      const dept = escapeHtml(r.department || '');
      const record = escapeHtml(r.visit_details || r.record || '');
      const note = escapeHtml(r.remarks || r.note || '');

      tr.dataset.id = r[PRIMARY_KEY] || '';

      tr.innerHTML = `
        <td>${elder}</td>
        <td>${date}</td>
        <td>${time}</td>
        <td>${doctor}</td>
        <td>${dept}</td>
        <td>${record}</td>
        <td>${note}</td>
        <td>
          <button type="button" class="edit-row-btn" style="padding:6px 10px">編輯</button>
          <button type="button" class="delete-row-btn" style="padding:6px 10px;margin-left:6px;background:#f37a7a;color:white;">刪除</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // 綁定按鈕
    document.querySelectorAll('.edit-row-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        openEditModal(row);
      });
    });
    document.querySelectorAll('.delete-row-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const row = e.target.closest('tr');
        const id = row.dataset.id;
        if (!id) {
          row.remove();
          saveData();
          updateNoRecordMessage();
          return;
        }
        if (confirm('確定刪除此筆資料（資料庫）？')) {
          await deleteFromSupabase(id);
          await fetchFromSupabase();
        }
      });
    });

    altRows('dataTable');
    updateNoRecordMessage();

  } catch (err) {
    console.error('fetchFromSupabase error', err);
  }
}

/* 新增：將資料存到 Supabase（Insert） */
async function insertToSupabase(rowObj) {
  if (!supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.from(CLINIC_TABLE).insert([rowObj]).select();
    if (error) throw error;
    return data && data[0];
  } catch (e) {
    console.warn('insertToSupabase failed', e);
    return null;
  }
}

/* 更新 Supabase（Update） */
async function updateSupabase(id, rowObj) {
  if (!supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.from(CLINIC_TABLE).update(rowObj).eq(PRIMARY_KEY, id).select();
    if (error) throw error;
    return data && data[0];
  } catch (e) {
    console.warn('updateSupabase failed', e);
    return null;
  }
}

/* 刪除 Supabase（Delete） */
async function deleteFromSupabase(id) {
  if (!supabaseClient) return null;
  try {
    const { data, error } = await supabaseClient.from(CLINIC_TABLE).delete().eq(PRIMARY_KEY, id);
    if (error) throw error;
    return data;
  } catch (e) {
    console.warn('deleteFromSupabase failed', e);
    return null;
  }
}

/* --------- 移除原本會造成 ReferenceError 的簡單 onload（把下面這段刪除或註解） --------- */
/*
window.onload = function () {
  loadData();
  updateNoRecordMessage(); // 初次檢查
};
*/
