<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>看診資訊</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      /* =========================================
         1. 基礎設定與配色
         ========================================= */
      body {
        font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
        padding: 0;
        margin: 0;
        background-color: #f0f4f8;
        color: #333;
      }

      /* =========================================
       2. 頂部導覽列
       ========================================= */
      .nav-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1001;
        width: 100%;
        padding: 10px 25px;
        background-color: white;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        color: black;
        box-sizing: border-box;
      }

      .volunteer-area {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .volunteer-area .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #ddd;
        display: none;
      }

      .volunteer-area #volunteerName {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        background: transparent;
      }

      /* =========================================
         2. 分頁導覽列 (Tabs)
         ========================================= */
      .tab-nav {
        display: flex;
        padding: 0 20px;
        background-color: #ffffff;
        border-bottom: 2px solid #ddd;
        margin-bottom: 15px;
      }

      .tab-link {
        flex: 1;
        text-align: center;
        text-decoration: none;
        padding: 20px 0;
        font-size: 20px;
        font-weight: bold;
        color: #666;
        border-bottom: 4px solid transparent;
        transition: all 0.2s ease;
      }

      .tab-link.active {
        color: #4a90e2;
        border-bottom-color: #4a90e2;
      }

      .container { 
        padding: 0 15px; 
        max-width: 600px; 
        margin: 0 auto; 
        padding-bottom: 100px; 
      }

      .page-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #2c3e50; border-left: 6px solid #4a90e2; padding-left: 10px; }

      /* =========================================
         3. 卡片設計
         ========================================= */
      .record-card {
        background: white;
        border-radius: 20px;
        padding: 20px;
        padding-bottom: 65px; /* 預留底部空間給編輯按鈕 */
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
      }

      .card-header { 
        display: flex; 
        justify-content: space-between; /* 讓日期靠左，時間靠右 */
        align-items: center; 
        margin-bottom: 15px; 
        border-bottom: 1px solid #f0f0f0; 
        padding-bottom: 10px; 
      }
      
      .date-box { font-size: 20px; font-weight: 900; color: #34495e; }

      /* 時間顯示區塊的樣式 */
      .time-box {
        font-size: 20px;
        font-weight: bold;
        color: #34495e;
        display: flex;
        align-items: center;
        gap: 6px; /* Icon 和時間文字的間距 */
      }

      .edit-btn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: #4a90e2;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
      }

      .edit-btn:active {
        transform: scale(0.98);
      }

      .card-body { display: flex; flex-direction: column; gap: 12px; }
      .info-item { font-size: 18px; line-height: 1.4; display: flex; align-items: flex-start; }
      .label-text { color: #333; font-weight: bold; min-width: 95px; flex-shrink: 0; }
      .content-text { color: #333; font-weight: 500; }
      
      .dept-text { color: #333; font-weight: 500; }

      .medical-notes { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #edf2f7; margin-top: 5px; }
      
      .notes-title { font-weight: bold; color: #4a90e2; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
      .remark-box { color: #e67e22; font-weight: bold; font-size: 17px; margin-top: 5px; display: flex; align-items: center; gap: 8px; padding: 0 0 15px;}

      i.fa-solid, i.fa-regular {
        width: 20px; 
        text-align: center;
      }

      /* =========================================
         4. CRUD 彈窗
         ========================================= */
      .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        position: relative; 
        background: white;
        width: 90%;
        max-width: 450px;
        border-radius: 25px;
        padding: 25px;
        max-height: 90vh;
        overflow-y: auto;
      }

      /* 右上角叉叉按鈕 */
      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 40px;        
        height: 40px;      
        border-radius: 10px; 
        background-color: #e74c3c; 
        color: #ffffff;
        border: none;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
        z-index: 2005;
      }
      .close-btn:hover { background-color: #e2e6ea; }
      .close-btn:active { transform: scale(0.95); }

      .modal-title { font-size: 22px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #2c3e50; }
      .form-group { margin-bottom: 18px; }
      .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; font-size: 18px; }
      
      .form-group label i { color: #4a90e2; margin-right: 5px; }

      .form-group input, .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid #edf2f7;
        border-radius: 12px;
        font-size: 18px;
        box-sizing: border-box;
        background-color: #f9fbff;
      }
      .modal-btns { display: flex; gap: 10px; margin-top: 25px; }
      .btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; }
      .btn-save { background: #2ecc71; color: white; }
      .btn-delete { background: #e74c3c; color: white; }

      .add-fab {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 70px;
        height: 70px;
        background: #2ecc71;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;        
        font-size: 30px;        
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1500;
        transition: transform 0.2s;
      }
      .add-fab i {
        display: block; 
        width: 1em; 
        text-align: center;
        margin-right: 1px; 
      }
      .add-fab:active { transform: scale(0.95); }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div>
        <h1 style="margin: 0; font-size: 28px">看診資訊</h1>
      </div>

      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <img
              id="volunteerAvatar"
              class="avatar"
              src="../bookvolunteer/default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <span
              id="volunteerName"
              title="點此以 Line 登入"
              style="cursor: pointer; font-size: 26px"
              >未登入</span
            >
          </span>
        </h1>
      </div>
    </nav>
    <div class="tab-nav">
      <a href="./index copy.html" class="tab-link active">看診紀錄</a>
      <a href="../family-view/index.html" class="tab-link">看診進度</a>
    </div>

    <div class="container">
      <h2 class="page-title">就醫紀錄管理</h2>
      <div id="recordList"></div>
      <div id="noDataMsg" class="no-data" style="display: none; text-align:center; padding: 50px; color:#999;">
        <i class="fa-regular fa-folder-open" style="font-size: 40px; margin-bottom: 10px; display:block;"></i>
        目前沒有紀錄喔！
      </div>
    </div>

    <div class="add-fab" onclick="openModal()"><i class="fa-solid fa-plus"></i></div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div id="modalTitle" class="modal-title">修改看診紀錄</div>
        <input type="hidden" id="editIndex">
        
        <div class="form-group">
          <label><i class="fa-regular fa-calendar-days"></i> 看診日期</label>
          <input type="date" id="field_date">
        </div>
        <div class="form-group">
          <label><i class="fa-regular fa-clock"></i> 看診時間</label>
          <input type="time" id="field_time">
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-hospital"></i> 醫院/診所名稱</label>
          <input type="text" id="field_hospital" placeholder="例如：臺大醫院">
        </div>

        <div class="form-group">
          <label><i class="fa-solid fa-hospital-user"></i> 醫生科別</label>
          <input type="text" id="field_dept" list="dept_list" placeholder="請選擇或輸入科別">
          <datalist id="dept_list">
            <option value="一般內科">
            <option value="心臟內科">
            <option value="胃腸肝膽科">
            <option value="腎臟科">
            <option value="胸腔內科">
            <option value="新陳代謝科">
            <option value="神經內科">
            <option value="一般外科">
            <option value="骨科">
            <option value="泌尿科">
            <option value="神經外科">
            <option value="整形外科">
            <option value="婦產科">
            <option value="小兒科">
            <option value="眼科">
            <option value="耳鼻喉科">
            <option value="皮膚科">
            <option value="精神科(身心科)">
            <option value="復健科">
            <option value="家庭醫學科">
            <option value="牙科">
            <option value="中醫科">
            <option value="急診醫學科">
          </datalist>
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-user-doctor"></i> 醫生姓名</label>
          <input type="text" id="field_doctor" placeholder="醫生名字">
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-file-medical"></i> 囑咐內容</label>
          <textarea id="field_details" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-bell"></i> 提醒備註</label>
          <input type="text" id="field_remarks">
        </div>

        <div class="modal-btns">
          <button class="btn btn-delete" id="deleteBtn" onclick="deleteRecord()">刪除</button>
          <button class="btn btn-save" onclick="saveRecord()">儲存</button>
        </div>
      </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const LIFF_ID = "2008484068-qkydRNYN";
      let userId = "";
      
      let dummyData = [
        {
          visit_time: "2026-01-06T09:30",
          hospital_name: "臺大醫院",
          department: "心臟內科",
          doctor_name: "陳志明",
          visit_details: "定期回診，數值正常。注意飲食清淡。",
          remarks: "記得早晚量血壓"
        },
        {
          visit_time: "2025-12-20T14:15",
          hospital_name: "長庚醫院",
          department: "骨科",
          doctor_name: "林建勳",
          visit_details: "左膝蓋疼痛，進行復健。減少爬樓梯。",
          remarks: "下週二復健"
        },
        {
          visit_time: "2025-11-15T10:00",
          hospital_name: "榮民總醫院",
          department: "眼科",
          doctor_name: "張美惠",
          visit_details: "視網膜檢查正常。眼藥水每天早晚點一次。",
          remarks: "出門戴太陽眼鏡"
        },
        {
          visit_time: "2025-10-05T15:30",
          hospital_name: "馬偕醫院",
          department: "復健科",
          doctor_name: "王大夫",
          visit_details: "肩頸痠痛改善中，持續拉筋運動。",
          remarks: "每天在家拉筋10分鐘"
        },
        {
          visit_time: "2025-09-12T09:00",
          hospital_name: "李氏牙醫診所",
          department: "牙科",
          doctor_name: "李醫師",
          visit_details: "洗牙及例行檢查，有一顆輕微蛀牙下次處理。",
          remarks: "飯後記得用牙線"
        }
      ];

      /* -----------------------------------------
         2. 初始化與 LIFF 整合 (Init & LIFF)
         ----------------------------------------- */
      initLiff();

      async function initLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            userId = profile.userId;
            document.getElementById("userName").innerText = profile.displayName;
            if (profile.pictureUrl) {
              const avatar = document.getElementById("userAvatar");
              avatar.src = profile.pictureUrl; avatar.style.display = "block";
            }
          } else {
            document.getElementById("userName").innerText = "測試模式 (王先生)";
          }
          renderCards(dummyData);
        } catch (err) {
          console.error(err);
          renderCards(dummyData);
        }
      }

      function renderCards(data) {
        const listContainer = document.getElementById("recordList");
        listContainer.innerHTML = "";
        data.sort((a, b) => new Date(b.visit_time) - new Date(a.visit_time));

        data.forEach((item, index) => {
          const dt = new Date(item.visit_time);
          const dateStr = `${dt.getFullYear()}年 ${dt.getMonth()+1}月 ${dt.getDate()}日`;
          const timeStr = dt.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });

          // 這裡合併了「科別」與「醫生姓名」
          const card = `
            <div class="record-card">
              <div class="card-header">
                <div class="date-box">${dateStr}</div>
                
                <div class="time-box">
                  <i class="fa-regular fa-clock"></i> ${timeStr}
                </div>
              </div>

              <div class="card-body">
                <div class="info-item">
                  <span class="label-text">醫院/診所名稱：</span>
                  <span class="content-text">${item.hospital_name || '未填寫'}</span>
                </div>
                
                <div class="info-item">
                  <span class="label-text" style="min-width: auto; margin-right: 8px;">
                    <i class="fa-solid fa-stethoscope" title="醫生科別與姓名"></i>
                  </span>
                  <span class="content-text dept-text">
                    ${item.department} - ${item.doctor_name} 醫師
                  </span>
                </div>

                <div class="medical-notes">
                  <span class="notes-title">
                    <i class="fa-solid fa-notes-medical"></i> 醫生囑咐內容：
                  </span>
                  <span class="content-text">${item.visit_details}</span>
                </div>
                ${item.remarks ? `
                  <div class="remark-box">
                    <i class="fa-solid fa-bell"></i> 提醒：${item.remarks}
                  </div>` : ""}
              </div>
              
              <button class="edit-btn" onclick="openModal(${index})">
                <i class="fa-solid fa-pen"></i> 編輯
              </button>
            </div>
          `;
          listContainer.innerHTML += card;
        });
      }

      function openModal(index = -1) {
        const modal = document.getElementById("editModal");
        const deleteBtn = document.getElementById("deleteBtn");
        document.getElementById("editIndex").value = index;

        if (index === -1) {
          // ================= 新增模式 =================
          document.getElementById("modalTitle").innerText = "新增看診紀錄";
          
          // 1. 取得現在時間
          const now = new Date();
          
          // 2. 格式化為 YYYY-MM-DD
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const dd = String(now.getDate()).padStart(2, '0');
          const today = `${yyyy}-${mm}-${dd}`;
          
          // 3. 格式化為 HH:mm
          const hh = String(now.getHours()).padStart(2, '0');
          const min = String(now.getMinutes()).padStart(2, '0');
          const currentTime = `${hh}:${min}`;

          // 4. 填入欄位
          document.getElementById("field_date").value = today;
          document.getElementById("field_time").value = currentTime;

          // 清空其他欄位
          document.getElementById("field_hospital").value = ""; 
          document.getElementById("field_dept").value = "";
          document.getElementById("field_doctor").value = "";
          document.getElementById("field_details").value = "";
          document.getElementById("field_remarks").value = "";
          deleteBtn.style.display = "none";
        } else {
          // ================= 編輯模式 =================
          document.getElementById("modalTitle").innerText = "修改看診紀錄";
          const item = dummyData[index];
          const parts = item.visit_time.split('T');
          document.getElementById("field_date").value = parts[0];
          document.getElementById("field_time").value = parts[1];
          document.getElementById("field_hospital").value = item.hospital_name || ""; 
          document.getElementById("field_dept").value = item.department;
          document.getElementById("field_doctor").value = item.doctor_name;
          document.getElementById("field_details").value = item.visit_details;
          document.getElementById("field_remarks").value = item.remarks;
          deleteBtn.style.display = "block";
        }
        modal.style.display = "flex";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      function saveRecord() {
        const index = parseInt(document.getElementById("editIndex").value);
        const datePart = document.getElementById("field_date").value;
        const timePart = document.getElementById("field_time").value;
        const hospitalPart = document.getElementById("field_hospital").value; 

        if (!datePart || !timePart || !document.getElementById("field_dept").value) {
          alert("請填寫日期、時間與科別喔！");
          return;
        }

        const newData = {
          visit_time: `${datePart}T${timePart}`,
          hospital_name: hospitalPart, 
          department: document.getElementById("field_dept").value,
          doctor_name: document.getElementById("field_doctor").value,
          visit_details: document.getElementById("field_details").value,
          remarks: document.getElementById("field_remarks").value
        };

        if (index === -1) {
          dummyData.push(newData);
        } else {
          dummyData[index] = newData;
        }

        renderCards(dummyData);
        closeModal();
      }

      function deleteRecord() {
        const index = parseInt(document.getElementById("editIndex").value);
        if (confirm("確定要刪除這筆紀錄嗎？")) {
          dummyData.splice(index, 1);
          renderCards(dummyData);
          closeModal();
        }
      }
    </script>
  </body>
</html>