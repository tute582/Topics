<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>çœ‹è¨ºè³‡è¨Š</title>

    <style>
      /* =========================================
       1. å…¨åŸŸèˆ‡åŸºç¤è¨­å®š
       ========================================= */
      body {
        font-family: "Arial", sans-serif;
        padding: 0;
        box-sizing: border-box;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      /* =========================================
       2. é ‚éƒ¨å°è¦½åˆ—
       ========================================= */
      .nav-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1001;
        width: 100%;
        padding: 10px 25px;
        background-color: white;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        color: black;
      }

      .volunteer-area {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .volunteer-area .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #ddd;
        display: none;
      }

      .volunteer-area #volunteerName {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        background: transparent;
      }

      .volunteer-area button {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 14px;
        margin-top: 0;
      }

      /* =========================================
       3. ç‰ˆé¢å®¹å™¨èˆ‡æ’ç‰ˆ
       ========================================= */
      .input-container,
      .search-container {
        padding: 0 25px;
        margin-top: 15px;
        box-sizing: border-box;
      }

      .search-container {
        margin-bottom: 30px;
      }

      .title {
        margin: 5px 0;
        font-size: 26px;
      }

      h1 {
        margin: 5px 0;
      }
      h2 {
        margin: 5px 0;
        font-size: 20px;
        display: inline-block;
      }
      h3 {
        margin: 0;
        font-size: 16px;
        color: #555;
      }

      /* =========================================
       4. è¡¨å–®èˆ‡è¼¸å…¥å…ƒä»¶
       ========================================= */
      .input-container > form {
        width: 100%;
        margin: 10px 0;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 20px;
        background-color: white;
      }

      label {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        font-size: 20px;
      }

      /* --- è¼¸å…¥æ¬„ä½é€šç”¨è¨­å®š --- */
      input[type="text"],
      textarea,
      .picker-display {
        /* [ä¿®æ”¹] æ”¹åç‚º picker-display ä¾›æ—¥æœŸèˆ‡æ™‚é–“å…±ç”¨ */
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 10px;
        border: 1px solid #888;
        font-size: 14px;
        background-color: white;
        color: #222;
        box-sizing: border-box;
        min-width: 0;
        min-height: 38px; /* ç¢ºä¿é«˜åº¦ä¸€è‡´ */
      }

      textarea {
        font-size: 16px;
      }

      input[readonly],
      textarea[readonly],
      .picker-display.readonly-mode {
        background-color: #f7f7f7; /* å”¯è®€æ™‚è®Šç° */
        cursor: default;
        color: #555;
      }

      /* --- [é—œéµä¿®æ”¹] æ—¥æœŸèˆ‡æ™‚é–“é¸æ“‡å™¨å°ˆç”¨æ¨£å¼ (Picker Hack) --- */
      .picker-wrapper {
        position: relative;
        width: 100%;
        margin-top: 5px;
      }

      /* =========================================
   [æ–°å¢] æ—¥æœŸèˆ‡æ™‚é–“çš„åœ–ç¤ºè¨­å®š
   èªªæ˜ï¼šå› ç‚º input è®Šé€æ˜äº†ï¼Œæˆ‘å€‘è¦æŠŠåœ–ç¤ºç•«åœ¨åº•ä¸‹çš„ display div ä¸Š
   ========================================= */

      /* æ—¥æœŸåœ–ç¤º (æ—¥æ›† SVG) */
      #dateDisplay {
        background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' fill='none' stroke='%23888' stroke-width='1.6'/%3E%3Cline x1='16' y1='2' x2='16' y2='6' stroke='%23888' stroke-width='1.6'/%3E%3Cline x1='8' y1='2' x2='8' y2='6' stroke='%23888' stroke-width='1.6'/%3E%3Cline x1='3' y1='10' x2='21' y2='10' stroke='%23888' stroke-width='1.6'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center; /* é å³å°é½Š */
        background-size: 20px 20px; /* åœ–ç¤ºå¤§å° */
        padding-right: 40px; /* å³é‚Šç•™å‡ºç©ºé–“çµ¦ iconï¼Œé¿å…æ–‡å­—è“‹åˆ° */
      }

      /* æ™‚é–“åœ–ç¤º (æ™‚é˜ SVG) */
      #timeDisplay {
        background-image: url("data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='9' fill='none' stroke='%23888' stroke-width='1.6'/%3E%3Cpath d='M12 7v6l4 2' stroke='%23888' stroke-width='1.6' stroke-linecap='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px 20px;
        padding-right: 40px;
      }

      /* æ›¿èº«ï¼šè² è²¬é¡¯ç¤º formatted text */
      .picker-display {
        display: flex;
        align-items: center;
        margin-top: 0; /* å·²ç¶“åœ¨ wrapper è¨­é margin */
        height: 38px;
        overflow: hidden;
      }

      /* çœŸèº«ï¼šé€æ˜ï¼Œè“‹åœ¨æœ€ä¸Šé¢ */
      .real-picker-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0; /* å®Œå…¨é€æ˜ */
        z-index: 10; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        cursor: pointer;
        -webkit-appearance: none;
      }

      /* --- æŒ‰éˆ•æ¨£å¼ --- */
      button {
        margin-top: 15px;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background-color: #4a90e2;
        color: white;
        cursor: pointer;
        font-size: 20px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #357abd;
      }

      /* =========================================
       5. è³‡æ–™è¡¨æ ¼å€
       ========================================= */
      .table-container {
        width: 100%;
        margin: 5px;
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        border: 1px solid #aaa;
        border-radius: 20px;
        background-color: white;
        display: none;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px;
      }

      th,
      td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
        white-space: nowrap;
      }

      th {
        background-color: #f9f9f9;
        position: sticky;
        top: 0;
        z-index: 2;
      }

      .no-record {
        text-align: center;
        color: #888;
        font-size: 18px;
        margin: 20px 0;
      }

      .evenrowcolor {
        background-color: #f9f9f9;
      }
      .oddrowcolor {
        background-color: #ffffff;
      }

      /* =========================================
       6. ç·¨è¼¯å½ˆçª—
       ========================================= */
      #editModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #editModal.show {
        display: block;
        opacity: 1;
      }

      #editModal > div {
        background: #fff;
        width: 420px;
        max-width: calc(100% - 40px);
        margin: 80px auto;
        padding: 20px 24px;
        border-radius: 15px;
        position: relative;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      #editModal.show > div {
        transform: translateY(0);
      }

      #editModal h3 {
        margin-top: 0;
        text-align: center;
      }

      #cancelEditBtn {
        background: none;
        border: none;
        color: #555;
        font-size: 20px;
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        transition: all 0.3s ease;
      }
      #cancelEditBtn:hover {
        background-color: #e74c3c;
        color: white;
        transform: scale(1.1);
      }

      #enterEditBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #f4b977;
        color: #333;
        font-size: 14px;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
      }
      #enterEditBtn:hover {
        background-color: #e0b557;
      }

      #saveEditBtn,
      #deleteEditBtn {
        margin-top: 10px;
        font-size: 16px;
        padding: 8px 15px;
        display: none;
      }
      #saveEditBtn {
        background-color: #4a90e2;
      }
      #deleteEditBtn {
        background-color: #f37a7a;
      }

      /* =========================================
       7. ç¢ºèªæç¤ºè¦–çª—
       ========================================= */
      #saveConfirmModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #saveConfirmModal.show {
        display: block;
        opacity: 1;
      }

      #saveConfirmModal > div {
        background: #fff;
        width: 350px;
        margin: 150px auto;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
      }

      #saveConfirmModal.show > div {
        transform: translateY(0);
      }

      #saveConfirmModal button {
        margin: 10px;
        padding: 8px 18px;
        font-size: 16px;
      }
      #confirmDiscardBtn {
        background-color: #f37a7a;
      }
      #continueEditBtn {
        background-color: #4a90e2;
      }

      /* =========================================
       8. éŸ¿æ‡‰å¼è¨­è¨ˆ
       ========================================= */
      @media (max-width: 768px) {
        form {
          width: 95%;
        }

        table {
          min-width: 0;
          width: 100%;
        }

        @media (max-width: 600px) {
          table {
            min-width: 700px;
          }
        }

        input[type="text"],
        textarea,
        .picker-display {
          /* ç¢ºä¿æ‰‹æ©Ÿä¸Šæ–‡å­—å¤§å° */
          font-size: 16px;
          padding: 10px;
        }

        button {
          padding: 12px 18px;
          font-size: 16px;
        }
      }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div>
        <h1 style="margin: 0; font-size: 28px">çœ‹è¨ºè³‡è¨Š</h1>
      </div>

      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <img
              id="volunteerAvatar"
              class="avatar"
              src="../bookvolunteer/default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <span
              id="volunteerName"
              title="é»æ­¤ä»¥ Line ç™»å…¥"
              style="cursor: pointer; font-size: 26px"
              >è¼‰å…¥ä¸­</span
            >
          </span>
        </h1>
      </div>
    </nav>

    <div class="input-container">
      <h1 class="title" style="font-size: 24px">è¼¸å…¥å…§å®¹</h1>
      <form>
        <label>é•·è¼©å§“å<input type="text" id="elderName" /></label>

        <label
          >çœ‹è¨ºæ—¥æœŸ
          <div class="picker-wrapper">
            <div id="dateDisplay" class="picker-display"></div>
            <input type="date" id="date" class="real-picker-input" />
          </div>
        </label>

        <label
          >çœ‹è¨ºæ™‚é–“
          <div class="picker-wrapper">
            <div id="timeDisplay" class="picker-display"></div>
            <input type="time" id="time" class="real-picker-input" />
          </div>
        </label>

        <label>é†«ç”Ÿå§“å<input type="text" id="name" /></label>
        <label
          >é†«ç”Ÿç§‘åˆ¥
          <input type="text" id="department" list="departmentList" />
          <datalist id="departmentList">
            <option value="å…§ç§‘"></option>
            <option value="å¤–ç§‘"></option>
            <option value="å°å…’ç§‘"></option>
            <option value="å©¦ç”¢ç§‘"></option>
            <option value="è€³é¼»å–‰ç§‘"></option>
            <option value="çœ¼ç§‘"></option>
            <option value="çš®è†šç§‘"></option>
            <option value="éª¨ç§‘"></option>
            <option value="æ³Œå°¿ç§‘"></option>
            <option value="ç¥ç¶“å…§ç§‘"></option>
            <option value="ç²¾ç¥ç§‘"></option>
            <option value="å¿ƒè‡Ÿå…§ç§‘"></option>
            <option value="èƒ¸è…”å…§ç§‘"></option>
            <option value="èƒƒè…¸è‚è†½ç§‘"></option>
            <option value="å…§åˆ†æ³Œæ–°é™³ä»£è¬ç§‘"></option>
            <option value="å¾©å¥ç§‘"></option>
            <option value="æ•´å½¢å¤–ç§‘"></option>
            <option value="å¤§è…¸ç›´è…¸å¤–ç§‘"></option>
            <option value="æ€¥è¨ºé†«å­¸ç§‘"></option>
            <option value="å®¶åº­é†«å­¸ç§‘"></option>
          </datalist>
        </label>
        <label for="record"
          >çœ‹è¨ºå…§å®¹ <textarea id="record" rows="2"></textarea>
        </label>

        <label for="note">å‚™è¨»<textarea id="note" rows="2"></textarea></label>

        <button type="button" onclick="addRow()">æ–°å¢</button>
      </form>
    </div>

    <div class="search-container">
      <h1 class="title" style="font-size: 24px">æŸ¥è©¢</h1>

      <div id="no-record-msg" class="no-record">ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>

      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>é•·è¼©å§“å</th>
              <th>çœ‹è¨ºæ—¥æœŸ</th>
              <th>çœ‹è¨ºæ™‚é–“</th>
              <th>é†«ç”Ÿå§“å</th>
              <th>é†«ç”Ÿç§‘åˆ¥</th>
              <th>çœ‹è¨ºå…§å®¹</th>
              <th>å‚™è¨»</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="editModal">
      <div>
        <button id="cancelEditBtn" title="æŒ‰ Esc æˆ–é»æˆ‘é—œé–‰">âœ–</button>
        <button id="enterEditBtn">ç·¨è¼¯</button>

        <div style="display: flex; justify-content: center">
          <h2>çœ‹è¨ºè³‡è¨Š</h2>
        </div>
        <label
          >é•·è¼©å§“å<input
            type="text"
            id="editElderName"
            placeholder="é•·è¼©å§“å"
            readonly
        /></label>

        <label
          >æ—¥æœŸ
          <div class="picker-wrapper">
            <div
              id="editDateDisplay"
              class="picker-display readonly-mode"
            ></div>
            <input
              type="date"
              id="editDate"
              class="real-picker-input"
              readonly
            />
          </div>
        </label>

        <label
          >æ™‚é–“
          <div class="picker-wrapper">
            <div
              id="editTimeDisplay"
              class="picker-display readonly-mode"
            ></div>
            <input
              type="time"
              id="editTime"
              class="real-picker-input"
              readonly
            />
          </div>
        </label>

        <label
          >é†«ç”Ÿå§“å<input
            type="text"
            id="editDoctorName"
            placeholder="è«‹è¼¸å…¥é†«ç”Ÿå§“å"
            readonly
          />
        </label>
        <label
          >é†«ç”Ÿç§‘åˆ¥
          <input
            type="text"
            id="editDepartment"
            list="editDepartmentList"
            placeholder="è«‹é¸æ“‡ç§‘åˆ¥"
            readonly
          />
          <datalist id="editDepartmentList">
            <option value="å…§ç§‘"></option>
            <option value="å¤–ç§‘"></option>
            <option value="å°å…’ç§‘"></option>
            <option value="å©¦ç”¢ç§‘"></option>
            <option value="è€³é¼»å–‰ç§‘"></option>
            <option value="çœ¼ç§‘"></option>
            <option value="çš®è†šç§‘"></option>
            <option value="éª¨ç§‘"></option>
            <option value="æ³Œå°¿ç§‘"></option>
            <option value="ç¥ç¶“å…§ç§‘"></option>
            <option value="ç²¾ç¥ç§‘"></option>
            <option value="å¿ƒè‡Ÿå…§ç§‘"></option>
            <option value="èƒ¸è…”å…§ç§‘"></option>
            <option value="èƒƒè…¸è‚è†½ç§‘"></option>
            <option value="å…§åˆ†æ³Œæ–°é™³ä»£è¬ç§‘"></option>
            <option value="å¾©å¥ç§‘"></option>
            <option value="æ•´å½¢å¤–ç§‘"></option>
            <option value="å¤§è…¸ç›´è…¸å¤–ç§‘"></option>
            <option value="æ€¥è¨ºé†«å­¸ç§‘"></option>
            <option value="å®¶åº­é†«å­¸ç§‘"></option>
          </datalist>
        </label>
        <label
          >å…§å®¹<textarea id="editRecord" rows="3" readonly></textarea>
        </label>
        <label>å‚™è¨»<textarea id="editNote" rows="3" readonly></textarea></label>

        <div style="text-align: center; margin-top: 10px">
          <button id="saveEditBtn">å„²å­˜</button>
          <button id="deleteEditBtn">åˆªé™¤</button>
        </div>
      </div>
    </div>

    <div id="saveConfirmModal">
      <div>
        <h3>æ­¤æ¬¡ä¿®æ”¹éœ€è¦å„²å­˜å—ï¼Ÿ</h3>
        <p>è‹¥æœªå„²å­˜ï¼Œè®Šæ›´çš„å…§å®¹å°‡æœƒéºå¤±ã€‚</p>
        <button id="continueEditBtn">ç¹¼çºŒç·¨è¼¯</button>
        <button id="confirmDiscardBtn">æ”¾æ£„</button>
      </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      /* -----------------------------------------
   1. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š (Global Config)
   ----------------------------------------- */
      const LIFF_ID = "2008484068-qkydRNYN";
      const POST_SUPABASE_API_URL =
        "https://supabase-api-six.vercel.app/consultations";

      let userId = "";
      let userName = "";
      let currentEditEventId = "";
      let editRowIndex = null;
      let isEditing = false;
      let originalData = {};

      const avatarEl = document.getElementById("volunteerAvatar");
      const nameEl = document.getElementById("volunteerName");

      /* -----------------------------------------
   2. åˆå§‹åŒ–èˆ‡ LIFF æ•´åˆ (Init & LIFF)
   ----------------------------------------- */
      // [ä¿®æ”¹] åˆå§‹åŒ–æ™‚é–“èˆ‡æ—¥æœŸé¸æ“‡å™¨
      initDateTimePickers();
      initLiffAndSetProfile();
      updateNoRecordMessage();

      async function initLiffAndSetProfile() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            nameEl.innerText = "æœªç™»å…¥";
            avatarEl.style.display = "none";
            await loadData();
            return;
          }

          const profile = await liff.getProfile();
          userId = profile.userId;
          userName = profile.displayName;
          localStorage.setItem("userId", userId);
          console.log("LIFF Profile userId:", userId, "userName:", userName);

          nameEl.innerText = profile.displayName || "å¿—å·¥";
          if (profile.pictureUrl) {
            avatarEl.src = profile.pictureUrl;
            avatarEl.style.display = "inline-block";
          } else {
            avatarEl.style.display = "none";
          }

          await loadData();
        } catch (err) {
          console.error("LIFF init error:", err);
        }
      }

      avatarEl.addEventListener("click", () => {
        if (liff.isLoggedIn()) {
          // æª¢æŸ¥å¾Œç«¯æ˜¯å¦æœ‰é€™å€‹userIdè¨»å†Š
          fetch(`https://supabase-api-six.vercel.app/identify/${userId}`)
            .then((res) => res.json())
            .then((result) => {
              if (!result.success) {
                // ç„¡æ•ˆèº«åˆ†ï¼Œå°å‘è¨»å†Šé é¢
                alert("ç¬¬ä¸€æ¬¡å°‡ç‚ºæ‚¨å°å…¥è¨»å†Šé é¢ï¼Œé»æ“Šã€Œç¢ºå®šã€å‰å¾€è¨»å†Šé é¢ã€‚");
                window.location.href = "../../Login-or-register/index.html";
              } else {
                // å·²è¨»å†Šï¼Œå–å¾—èº«åˆ†
                let identify = result.role; //å›å‚³æ–‡å­—(å¿—å·¥æˆ–é•·è€…)
                console.log("ç™»å…¥è§’è‰² roleï¼š", result.role);
                localStorage.setItem("fromPage", "record-information");
                switch (identify) {
                  case "å¿—å·¥":
                    window.location.href =
                      "../../Login-or-register/å¿—å·¥è³‡æ–™é¡¯ç¤º.html";
                    break;
                  case "é•·è€…":
                    window.location.href =
                      "../../Login-or-register/é•·è¼©è³‡æ–™é¡¯ç¤º.html";
                    break;
                  default:
                    // "æœªè¨»å†Š" æˆ– undefined éƒ½å°å¾€ç™»å…¥
                    window.location.href = "../../Login-or-register/index.html";
                }
              }
            })
            .catch((err) => {
              console.error("èº«åˆ†æª¢æŸ¥ API éŒ¯èª¤ï¼š", err);
              // API å‡ºéŒ¯ä¹Ÿè¦–ç‚ºç„¡æ•ˆèº«åˆ†
              window.location.href = "../../Login-or-register/index.html";
            });
        } else {
          liff.login({ redirectUri: window.location.href });
        }
      });

      nameEl.addEventListener("click", () => {
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
        } else {
          alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
        }
      });

      /* -----------------------------------------
   3. æ—¥æœŸèˆ‡æ™‚é–“é¸æ“‡å™¨é‚è¼¯ (Date & Time Picker Logic)
   ----------------------------------------- */
      function initDateTimePickers() {
        // åˆå§‹åŒ–æ™‚é–“
        const timeInput = document.getElementById("time");
        timeInput.addEventListener("input", function () {
          updateTimeDisplay(this.value, "timeDisplay");
        });
        const editTimeInput = document.getElementById("editTime");
        editTimeInput.addEventListener("input", function () {
          updateTimeDisplay(this.value, "editTimeDisplay");
        });

        // [æ–°å¢] åˆå§‹åŒ–æ—¥æœŸ
        const dateInput = document.getElementById("date");
        dateInput.addEventListener("input", function () {
          updateDateDisplay(this.value, "dateDisplay");
        });
        const editDateInput = document.getElementById("editDate");
        editDateInput.addEventListener("input", function () {
          updateDateDisplay(this.value, "editDateDisplay");
        });
      }

      // æ›´æ–°æ™‚é–“é¡¯ç¤º
      function updateTimeDisplay(timeValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);

        if (!timeValue) {
          displayEl.textContent = "";
          displayEl.style.color = "#888";
          return;
        }

        const [hourStr, minuteStr] = timeValue.split(":");
        let hour = parseInt(hourStr);
        let period = "ä¸Šåˆ";

        if (hour >= 12) {
          period = "ä¸‹åˆ";
          if (hour > 12) hour -= 12;
        }
        if (hour === 0) hour = 12;

        const formattedHour = hour.toString().padStart(2, "0");
        displayEl.textContent = `${period} ${formattedHour}:${minuteStr}`;

        if (!displayEl.classList.contains("readonly-mode")) {
          displayEl.style.color = "#222";
        }
      }

      // [æ–°å¢] æ›´æ–°æ—¥æœŸé¡¯ç¤º (å°‡ YYYY-MM-DD è½‰ç‚º YYYY å¹´ MM æœˆ DD æ—¥)
      function updateDateDisplay(dateValue, displayElementId) {
        const displayEl = document.getElementById(displayElementId);

        if (!dateValue) {
          displayEl.textContent = "";
          displayEl.style.color = "#888";
          return;
        }

        const [year, month, day] = dateValue.split("-");
        // é¡¯ç¤ºæ ¼å¼ï¼š2025 å¹´ 11 æœˆ 24 æ—¥
        displayEl.textContent = `${year} å¹´ ${month} æœˆ ${day} æ—¥`;

        if (!displayEl.classList.contains("readonly-mode")) {
          displayEl.style.color = "#222";
        }
      }

      /* -----------------------------------------
   4. è³‡æ–™è®€å– (READ - Load Data)
   ----------------------------------------- */
      async function loadData() {
        const table = document.getElementById("dataTable");
        const tbody = table.querySelector("tbody");

        tbody.innerHTML = "";
        if (userId == "") {
          console.log("æ²’æœ‰æª¢æ¸¬åˆ°ä½¿ç”¨è€…ç™»å…¥ID");
          return;
        }

        const GET_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}`;

        try {
          const res = await fetch(GET_SUPABASE_API_URL);
          const json = await res.json();

          if (
            !json.success ||
            !Array.isArray(json.data) ||
            json.data.length === 0
          ) {
            console.warn("âš  API é›–æˆåŠŸä½†ç„¡è³‡æ–™");
            updateNoRecordMessage();
            return;
          }

          json.data.forEach((d) => {
            const datetime = d.visit_time ? new Date(d.visit_time) : null;
            const date = datetime ? datetime.toISOString().split("T")[0] : "";
            const time = datetime
              ? datetime.toISOString().split("T")[1].substring(0, 5)
              : "";

            const newRow = tbody.insertRow(-1);
            newRow.insertCell(0).innerText = d.elder_name || "";
            newRow.insertCell(1).innerText = date;
            newRow.insertCell(2).innerText = time;
            newRow.insertCell(3).innerText = d.doctor_name || "";
            newRow.insertCell(4).innerText = d.department || "";
            newRow.insertCell(5).innerText = d.visit_details || "";
            newRow.insertCell(6).innerText = d.remarks || "";

            newRow.dataset.event_id = d.event_id;

            const actionCell = newRow.insertCell(7);
            const editBtn = document.createElement("button");
            editBtn.innerText = "ç·¨è¼¯";
            editBtn.type = "button";
            editBtn.style.padding = "6px 10px";
            editBtn.onclick = () => openEditModal(newRow);
            actionCell.appendChild(editBtn);
          });

          sortTableByDateTime("dataTable");
          altRows("dataTable");
          addEditButtonsToRows();
          updateNoRecordMessage();
        } catch (err) {
          console.error("âŒ API è®€å–å¤±æ•—", err);
          updateNoRecordMessage();
        }
      }

      /* -----------------------------------------
   5. è³‡æ–™æ–°å¢ (CREATE - Add Row)
   ----------------------------------------- */
      async function addRow() {
        const elderName = document.getElementById("elderName").value.trim();
        const date = document.getElementById("date").value.trim();
        const time = document.getElementById("time").value.trim();
        const name = document.getElementById("name").value.trim();
        const department = document.getElementById("department").value.trim();
        const record = document.getElementById("record").value.trim();
        const note = document.getElementById("note").value.trim();
        const table = document.getElementById("dataTable");
        const tbody = table.querySelector("tbody");

        if (!date || !time) {
          alert("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ™‚é–“ï¼");
          return;
        }

        let newEventId = null;

        try {
          const payload = {
            elder_user_id: userId,
            elder_name: elderName,
            visit_time: `${date} ${time}`,
            doctor_name: name,
            department: department,
            visit_details: record,
            remarks: note,
          };

          const res = await fetch(POST_SUPABASE_API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await res.json();

          if (!res.ok) {
            console.error("âŒ ä¸Šå‚³å¤±æ•—:", result);
            alert("âš ï¸ ä¸Šå‚³è³‡æ–™å¤±æ•—ï¼");
            return;
          }

          console.log("ğŸ‰ æ–°å¢æˆåŠŸ", result);
          newEventId = result?.data?.event_id;

          const newRow = tbody.insertRow(-1);
          newRow.dataset.event_id = newEventId;

          newRow.insertCell(0).innerText = elderName;
          newRow.insertCell(1).innerText = date;
          newRow.insertCell(2).innerText = time;
          newRow.insertCell(3).innerText = name;
          newRow.insertCell(4).innerText = department;
          newRow.insertCell(5).innerText = record;
          newRow.insertCell(6).innerText = note;

          const actionCell = newRow.insertCell(7);
          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.innerText = "ç·¨è¼¯";
          editBtn.style.padding = "6px 10px";
          editBtn.onclick = () => openEditModal(newRow);
          actionCell.appendChild(editBtn);

          sortTableByDateTime("dataTable");
          altRows("dataTable");
          updateNoRecordMessage();

          clearInputs();
        } catch (err) {
          console.error("âŒ Supabase éŒ¯èª¤:", err);
          alert("âš ï¸ ç„¡æ³•é€£ç·šè³‡æ–™åº«");
          return;
        }
      }

      /* -----------------------------------------
   6. è³‡æ–™æ›´æ–°èˆ‡åˆªé™¤ (UPDATE & DELETE)
   ----------------------------------------- */
      document.getElementById("saveEditBtn").onclick = () => {
        const row = document.getElementById("dataTable").rows[editRowIndex];

        // æ›´æ–°å‰ç«¯è¡¨æ ¼å…§å®¹
        [
          "ElderName",
          "Date",
          "Time",
          "DoctorName",
          "Department",
          "Record",
          "Note",
        ].forEach((f, i) => {
          row.cells[i].innerText = document.getElementById("edit" + f).value;
        });

        sortTableByDateTime("dataTable");
        altRows("dataTable");
        saveEditData();
        closeModal();
      };

      async function saveEditData() {
        if (!currentEditEventId) {
          console.error("âŒ event_id ä¸å­˜åœ¨ï¼Œç„¡æ³• PATCH");
          return;
        }

        const elderName = document.getElementById("editElderName").value;
        const date = document.getElementById("editDate").value;
        const time = document.getElementById("editTime").value;
        const doctorName = document.getElementById("editDoctorName").value;
        const department = document.getElementById("editDepartment").value;
        const record = document.getElementById("editRecord").value;
        const note = document.getElementById("editNote").value;
        const visit_time = `${date}T${time}:00`;

        const payload = {
          elder_name: elderName,
          visit_time: visit_time,
          doctor_name: doctorName,
          department: department,
          visit_details: record,
          remarks: note,
        };

        const PATCH_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}/${currentEditEventId}`;

        try {
          const res = await fetch(PATCH_SUPABASE_API_URL, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const json = await res.json();
          console.log("PATCH å›å‚³ï¼š", json);

          if (json.success) {
            alert("è³‡æ–™æ›´æ–°å·²å®Œæˆï¼âœ¨");
          } else {
            alert("æ›´æ–°å¤±æ•—ï¼š" + json.message);
          }
        } catch (err) {
          console.error("âŒ PATCH API éŒ¯èª¤ï¼š", err);
          alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
        }
      }

      document.getElementById("deleteEditBtn").onclick = () => {
        if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) {
          document.getElementById("dataTable").deleteRow(editRowIndex);
          sortTableByDateTime("dataTable");
          altRows("dataTable");
          deleteData();
          closeModal();
        }
      };

      async function deleteData() {
        const DELETE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}/${currentEditEventId}`;

        try {
          const res = await fetch(DELETE_API_URL, {
            method: "DELETE",
          });

          if (!res.ok) {
            const result = await res.json().catch(() => ({}));
            alert("åˆªé™¤å¤±æ•—: " + (result.message || res.status));
            return;
          }
          alert("åˆªé™¤æˆåŠŸï¼");
        } catch (err) {
          console.error("DELETE Errorï¼š", err);
          alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
        }
      }

      /* -----------------------------------------
   7. å½ˆçª—èˆ‡ UI æ§åˆ¶é‚è¼¯ (UI & Modals)
   ----------------------------------------- */
      function updateNoRecordMessage() {
        const table = document.getElementById("dataTable");
        const tbody = table.querySelector("tbody");
        const hasRecords = tbody.rows.length > 0;
        const container = document.querySelector(".table-container");
        const noRecordMsg = document.getElementById("no-record-msg");

        if (hasRecords) {
          container.style.display = "block";
          noRecordMsg.style.display = "none";
        } else {
          container.style.display = "none";
          noRecordMsg.style.display = "block";
        }
      }

      // [ä¿®æ”¹] æ¸…ç©ºè¼¸å…¥æ¬„ä½ï¼ŒåŒæ™‚é‡ç½®æ™‚é–“èˆ‡æ—¥æœŸçš„å‡é¡¯ç¤º
      function clearInputs() {
        [
          "elderName",
          "date",
          "time",
          "name",
          "department",
          "record",
          "note",
        ].forEach((id) => {
          document.getElementById(id).value = "";
        });
        // æ¸…ç©ºæ™‚é–“æ–‡å­—
        document.getElementById("timeDisplay").textContent = "";
        document.getElementById("timeDisplay").style.color = "#888";
        // æ¸…ç©ºæ—¥æœŸæ–‡å­—
        document.getElementById("dateDisplay").textContent = "";
        document.getElementById("dateDisplay").style.color = "#888";
      }

      function sortTableByDateTime(tableId) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.rows);

        rows.sort((a, b) => {
          const dateA = a.cells[1]?.innerText || "";
          const timeA = a.cells[2]?.innerText || "";
          const dateB = b.cells[1]?.innerText || "";
          const timeB = b.cells[2]?.innerText || "";
          const dtA = new Date(`${dateA} ${timeA}`);
          const dtB = new Date(`${dateB} ${timeB}`);
          return dtA - dtB;
        });

        rows.forEach((r) => tbody.appendChild(r));
      }

      function altRows(id) {
        const table = document.getElementById(id);
        const rows = table.getElementsByTagName("tr");
        for (let i = 1; i < rows.length; i++)
          rows[i].className = i % 2 === 0 ? "evenrowcolor" : "oddrowcolor";
      }

      function openEditModal(row) {
        editRowIndex = row.rowIndex;
        currentEditEventId = row.dataset.event_id;
        const modal = document.getElementById("editModal");

        [
          "ElderName",
          "Date",
          "Time",
          "DoctorName",
          "Department",
          "Record",
          "Note",
        ].forEach((f, i) => {
          const val = row.cells[i].innerText;
          document.getElementById("edit" + f).value = val;
          originalData[f] = val;
        });

        // æ›´æ–°å‡é¡¯ç¤ºæ¡†
        const timeVal = row.cells[2].innerText;
        updateTimeDisplay(timeVal, "editTimeDisplay");
        const dateVal = row.cells[1].innerText;
        updateDateDisplay(dateVal, "editDateDisplay");

        setReadOnly(false);

        modal.style.display = "block";
        setTimeout(() => modal.classList.add("show"), 10);
        document.querySelector(".nav-1").style.display = "none";
      }

      // [ä¿®æ”¹] çµ±ä¸€ç®¡ç† ReadOnly æ¨£å¼
      function setReadOnly(readOnly) {
        document
          .querySelectorAll("#editModal input, #editModal textarea")
          .forEach((el) => {
            el.readOnly = readOnly;
            // å¦‚æœä¸æ˜¯ date æˆ– timeï¼ŒèƒŒæ™¯è®Šç° (å› ç‚º date/time æœ‰è‡ªå·±çš„å‡é¡¯ç¤ºæ¡†è™•ç†èƒŒæ™¯)
            if (el.type !== "date" && el.type !== "time") {
              el.style.backgroundColor = readOnly ? "#f7f7f7" : "white";
            }
          });

        // è™•ç†å‡é¡¯ç¤ºæ¡†çš„å”¯è®€æ¨£å¼ (æ™‚é–“ & æ—¥æœŸ)
        togglePickerReadOnly("editTimeDisplay", "editTime", readOnly);
        togglePickerReadOnly("editDateDisplay", "editDate", readOnly);

        document.getElementById("saveEditBtn").style.display = readOnly
          ? "none"
          : "inline-block";
        document.getElementById("deleteEditBtn").style.display = readOnly
          ? "none"
          : "inline-block";
        document.getElementById("enterEditBtn").style.display = readOnly
          ? "inline-block"
          : "none";
        isEditing = !readOnly;
      }

      // [æ–°å¢] è¼”åŠ©å‡½å¼ï¼šåˆ‡æ›å‡é¡¯ç¤ºæ¡†çš„å”¯è®€ç‹€æ…‹
      function togglePickerReadOnly(displayId, inputId, readOnly) {
        const displayEl = document.getElementById(displayId);
        const inputEl = document.getElementById(inputId);

        if (readOnly) {
          displayEl.classList.add("readonly-mode");
          displayEl.style.color = "#555";
          inputEl.style.pointerEvents = "none"; // ç¦æ­¢é»æ“Šè§¸ç™¼åŸç”Ÿé¸å–®
        } else {
          displayEl.classList.remove("readonly-mode");
          // å¦‚æœæœ‰å€¼é¡¯ç¤ºæ·±è‰²ï¼Œæ²’å€¼é¡¯ç¤ºæ·ºè‰²
          displayEl.style.color = inputEl.value ? "#222" : "#888";
          inputEl.style.pointerEvents = "auto";
        }
      }

      document.getElementById("enterEditBtn").onclick = () =>
        setReadOnly(false);

      function closeModal() {
        const modal = document.getElementById("editModal");
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
        setReadOnly(true);
        document.querySelector(".nav-1").style.display = "flex";
      }

      function tryCloseModal() {
        if (isEditing && hasChanges()) {
          showSaveConfirmModal();
        } else {
          closeModal();
        }
      }

      function hasChanges() {
        return [
          "ElderName",
          "Date",
          "Time",
          "DoctorName",
          "Department",
          "Record",
          "Note",
        ].some(
          (f) => document.getElementById("edit" + f).value !== originalData[f]
        );
      }

      document.getElementById("cancelEditBtn").onclick = () => tryCloseModal();
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") tryCloseModal();
      });

      /* -----------------------------------------
   8. å„²å­˜ç¢ºèªè¦–çª— (Save Confirm Modal)
   ----------------------------------------- */
      function showSaveConfirmModal() {
        const modal = document.getElementById("saveConfirmModal");
        modal.style.display = "block";
        setTimeout(() => modal.classList.add("show"), 10);
      }

      function closeSaveConfirmModal() {
        const modal = document.getElementById("saveConfirmModal");
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
      }

      document.getElementById("confirmDiscardBtn").onclick = () => {
        closeSaveConfirmModal();
        closeModal();
      };

      document.getElementById("continueEditBtn").onclick = () => {
        closeSaveConfirmModal();
      };

      function addEditButtonsToRows() {
        const tbody = document
          .getElementById("dataTable")
          .querySelector("tbody");
        Array.from(tbody.rows).forEach((row) => {
          if (row.cells.length < 8) {
            const actionCell = row.insertCell(7);
            const editBtn = document.createElement("button");
            editBtn.type = "button";
            editBtn.innerText = "ç·¨è¼¯";
            editBtn.style.padding = "6px 10px";
            editBtn.onclick = () => openEditModal(row);
            actionCell.appendChild(editBtn);
          }
        });
      }
    </script>
  </body>
</html>
