<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>看診資訊</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
      /* =========================================
         1. 基礎設定與配色
         ========================================= */
      body {
        font-family: "PingFang TC", "Microsoft JhengHei", sans-serif;
        padding: 0;
        margin: 0;
        background-color: #f0f4f8;
        color: #333;
      }

      /* =========================================
       2. 頂部導覽列
       ========================================= */
      .nav-1 {
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1001;
        width: 100%;
        padding: 10px 25px;
        background-color: white;
        border-bottom: 1px solid #ddd;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        color: black;
        box-sizing: border-box;
      }

      .volunteer-area {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .volunteer-area .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #ddd;
        display: none;
      }

      .volunteer-area #volunteerName {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        background: transparent;
      }

      /* =========================================
         2. 分頁導覽列 (Tabs)
         ========================================= */
      .tab-nav {
        display: flex;
        padding: 0 20px;
        background-color: #ffffff;
        border-bottom: 2px solid #ddd;
        margin-bottom: 15px;
      }

      .tab-link {
        flex: 1;
        text-align: center;
        text-decoration: none;
        padding: 20px 0;
        font-size: 20px;
        font-weight: bold;
        color: #666;
        border-bottom: 4px solid transparent;
        transition: all 0.2s ease;
      }

      .tab-link.active {
        color: #4a90e2;
        border-bottom-color: #4a90e2;
      }

      .container { 
        padding: 0 15px; 
        max-width: 600px; 
        margin: 0 auto; 
        padding-bottom: 100px; 
      }

      .page-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #2c3e50; border-left: 6px solid #4a90e2; padding-left: 10px; }

      /* =========================================
         [新增] 志工專用下拉選單樣式
         ========================================= */
      .volunteer-select-box {
        display: none; /* 預設隱藏，JS 判斷身分後開啟 */
        background-color: #e3f2fd; /* 淡藍色背景 */
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        border: 1px solid #90caf9;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      }

      .volunteer-select-box label {
        font-weight: bold;
        color: #1565c0;
        display: block;
        margin-bottom: 8px;
        font-size: 18px;
      }

      /* 修改：同時支援 input 與 select */
      .volunteer-select-box input,
      .volunteer-select-box select {
        width: 100%;
        padding: 10px;
        border: 2px solid #bbdefb;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        background: #fff;
        cursor: pointer;
        /* 移除 iOS 預設圓角與樣式 */
        -webkit-appearance: none; 
        appearance: none;
        /* 加個箭頭讓它看起來像下拉選單 (選用) */
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 12px auto;
      }

      /* =========================================
         3. 卡片設計
         ========================================= */
      .record-card {
        background: white;
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: relative;
        overflow: hidden;
      }

      .card-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 15px; 
        border-bottom: 1px solid #f0f0f0; 
        padding-bottom: 10px; 
      }
      
      .date-box { font-size: 20px; font-weight: 900; color: #34495e; }

      .time-box {
        font-size: 20px;
        font-weight: bold;
        color: #34495e;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .card-body { display: flex; flex-direction: column; gap: 12px; }
      .info-item { font-size: 18px; line-height: 1.4; display: flex; align-items: flex-start; }
      .label-text { color: #333; font-weight: bold; min-width: 95px; flex-shrink: 0; }
      .content-text { color: #333; font-weight: 500; }
      
      .dept-text { color: #333; font-weight: 500; }

      .medical-notes { background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #edf2f7; margin-top: 5px; }
      
      .notes-title { font-weight: bold; color: #4a90e2; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }

      /* 回診資訊樣式 */
      .next-visit-box {
        color: #27ae60;
        font-weight: bold;
        font-size: 17px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* 底部並排區域 (提醒 + 按鈕) */
      .card-footer-row {
        display: flex;
        justify-content: space-between; /* 左右推開 */
        align-items: center;            /* 垂直置中 */
        margin-top: 15px;               /* 與上方內容的間距 */
        padding-top: 12px;
        border-top: 1px dashed #eee;    /* 虛線分隔線 */
        min-height: 36px;
      }

      /* 提醒文字盒 */
      .remark-box { 
        color: #e67e22; 
        font-weight: bold; 
        font-size: 16px;   /* 字體縮小 */
        margin: 0;         /* 移除外距 */
        padding: 0;
        display: flex; 
        align-items: center; 
        gap: 6px;
        flex: 1;           /* 佔據剩餘空間 */
      }

      /* 編輯按鈕 */
      .edit-btn {
        position: static;  /* 移除絕對定位 */
        background: #4a90e2;
        color: white;
        border: none;
        padding: 6px 16px; /* 縮小內距 */
        border-radius: 8px;
        font-size: 15px;   /* 縮小字體 */
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        flex-shrink: 0;    /* 防止按鈕被壓縮 */
        transition: transform 0.1s;
      }

      .edit-btn:active {
        transform: scale(0.95);
      }

      i.fa-solid, i.fa-regular {
        width: 20px; 
        text-align: center;
      }

      /* =========================================
         4. CRUD 彈窗
         ========================================= */
      .modal {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        position: relative; 
        background: white;
        width: 90%;
        max-width: 450px;
        border-radius: 25px;
        padding: 25px;
        max-height: 90vh;
        overflow-y: auto;
      }

      /* 右上角叉叉按鈕 */
      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 40px;        
        height: 40px;       
        border-radius: 10px; 
        background-color: #e74c3c; 
        color: #ffffff;
        border: none;
        font-size: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
        z-index: 2005;
      }
      .close-btn:hover { background-color: #e2e6ea; }
      .close-btn:active { transform: scale(0.95); }

      .modal-title { font-size: 22px; font-weight: bold; margin-bottom: 20px; text-align: center; color: #2c3e50; }
      .form-group { margin-bottom: 18px; }
      .form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; font-size: 18px; }
      
      .form-group label i { color: #4a90e2; margin-right: 5px; }

      .form-group input, .form-group textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid #edf2f7;
        border-radius: 12px;
        font-size: 18px;
        box-sizing: border-box;
        background-color: #f9fbff;
      }
      .modal-btns { display: flex; gap: 10px; margin-top: 25px; }
      .btn { flex: 1; padding: 15px; border-radius: 15px; border: none; font-size: 18px; font-weight: bold; cursor: pointer; }
      .btn-save { background: #2ecc71; color: white; }
      .btn-delete { background: #e74c3c; color: white; }

      .add-fab {
        position: fixed;
        right: 20px;
        bottom: 20px;
        width: 70px;
        height: 70px;
        background: #2ecc71;
        color: white;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        line-height: 1;        
        font-size: 30px;        
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 1500;
        transition: transform 0.2s;
      }
      .add-fab i {
        display: block; 
        width: 1em; 
        text-align: center;
        margin-right: 1px; 
      }
      .add-fab:active { transform: scale(0.95); }

      /* 全螢幕 Loading 樣式 */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.85);
        display: none; 
        align-items: center;
        justify-content: center;
        z-index: 9999; 
      }

      .loading-box {
        text-align: center;
        padding: 30px 40px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
      }

      .spinner {
        width: 48px;
        height: 48px;
        border: 5px solid #e0e0e0;
        border-top-color: #4caf50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      .loading-text {
        font-size: 15px;
        color: #333;
        line-height: 1.6;
      }

      .loading-text span {
        font-size: 13px;
        color: #777;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>

  <body>
    <nav class="nav-1">
      <div>
        <h1 style="margin: 0; font-size: 28px">看診資訊</h1>
      </div>

      <div style="display: flex; align-items: center">
        <h1 style="margin: 0; text-align: right">
          <span
            class="volunteer-area"
            style="display: flex; align-items: center; gap: 8px"
          >
            <img
              id="volunteerAvatar"
              class="avatar"
              src="../bookvolunteer/default-avatar.png"
              alt="avatar"
              style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
                border: 2px solid #0984e3;
              "
            />
            <span
              id="volunteerName"
              title="點此以 Line 登入"
              style="cursor: pointer; font-size: 26px"
              >未登入</span
            >
          </span>
        </h1>
      </div>
    </nav>
    <div class="tab-nav">
      <a href="./index.html" class="tab-link active">看診紀錄</a>
      <a href="./family-view.html" class="tab-link">看診進度</a>
    </div>

    <div class="container">
      
      <div id="volunteerOnlyArea" class="volunteer-select-box">
        <label><i class="fa-solid fa-user-tag"></i> 切換檢視個案</label>
        <select id="volunteer_patient_select" onchange="handlePatientChange()">
            <option value="" disabled selected>請選擇個案...</option>
        </select>
      </div>

      <h2 class="page-title">就醫紀錄管理</h2>
      <div id="recordList"></div>
      <div id="noDataMsg" class="no-data" style="display: none; text-align:center; padding: 50px; color:#999;">
        <i class="fa-regular fa-folder-open" style="font-size: 40px; margin-bottom: 10px; display:block;"></i>
        目前沒有紀錄喔！
      </div>
    </div>

    <div class="add-fab" onclick="openModal()"><i class="fa-solid fa-plus"></i></div>

    <div id="editModal" class="modal">
      <div class="modal-content">
        <button class="close-btn" onclick="closeModal()">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <div id="modalTitle" class="modal-title">修改看診紀錄</div>
        <input type="hidden" id="editIndex">
        
        <div id="camera-area" style="margin-top: 0px">
          <iframe
          id="cameraFrame"
            src="./UpdateImage.html"
            style="
              width: 100%;
              max-width: 700px;
              height: 50px;
              border: none;
              border-radius: 12px;
              background: #fff;
              transition: height 0.3s ease;
            "
          ></iframe>
        </div>

        <div class="form-group">
          <label><i class="fa-regular fa-calendar-days"></i> 看診日期</label>
          <input type="date" id="field_date">
        </div>
        <div class="form-group">
          <label><i class="fa-regular fa-clock"></i> 看診時間</label>
          <input type="time" id="field_time">
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-hospital"></i> 醫院/診所名稱</label>
          <input type="text" id="field_hospital" placeholder="例如：臺大醫院">
        </div>

        <div class="form-group">
          <label><i class="fa-solid fa-hospital-user"></i> 醫生科別</label>
          <input type="text" id="field_dept" list="dept_list" placeholder="請選擇或輸入科別">
          <datalist id="dept_list">
            <option value="一般內科">
            <option value="心臟內科">
            <option value="胃腸肝膽科">
            <option value="腎臟科">
            <option value="胸腔內科">
            <option value="新陳代謝科">
            <option value="神經內科">
            <option value="一般外科">
            <option value="骨科">
            <option value="泌尿科">
            <option value="神經外科">
            <option value="整形外科">
            <option value="婦產科">
            <option value="小兒科">
            <option value="眼科">
            <option value="耳鼻喉科">
            <option value="皮膚科">
            <option value="精神科(身心科)">
            <option value="復健科">
            <option value="家庭醫學科">
            <option value="牙科">
            <option value="中醫科">
            <option value="急診醫學科">
          </datalist>
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-user-doctor"></i> 醫生姓名</label>
          <input type="text" id="field_doctor" placeholder="醫生名字">
        </div>
        <div class="form-group">
          <label><i class="fa-solid fa-file-medical"></i> 囑咐內容</label>
          <textarea id="field_details" rows="3"></textarea>
        </div>
        
        <div class="form-group">
          <label><i class="fa-regular fa-calendar-check"></i> 下一次回診時間</label>
          <div style="display: flex; gap: 10px;">
            <input type="date" id="field_next_date" style="flex: 1;">
            <input type="time" id="field_next_time" style="flex: 1;">
          </div>
        </div>

        <div class="form-group">
          <label><i class="fa-solid fa-bell"></i> 提醒備註</label>
          <input type="text" id="field_remarks">
        </div>

        <div class="modal-btns">
          <button class="btn btn-delete" id="deleteBtn" onclick="deleteRecord()">刪除</button>
          <button class="btn btn-save" onclick="saveRecord()">儲存</button>
        </div>
      </div>
    </div>

    <div id="mainLoadingOverlay" class="loading-overlay">
      <div class="loading-box">
        <div class="spinner"></div>
        <div class="loading-text">
          <span id="loadingTitle" style="font-size:16px; color:#333; display:block; margin-bottom:5px;">正在處理中...</span>
          <span id="loadingSubtitle" style="font-size:13px; color:#777;">請稍候</span>
        </div>
      </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
      const LIFF_ID = "2008484068-qkydRNYN";
      const API_BASE_URL = "https://supabase-api-six.vercel.app";
      
      let userId = ""; 
      let userName = "";
      let pictureUrl = "";
      let identifyRole = "";

      // ★★★ 新增變數：目前正在檢視的長輩 ID 與 名稱 ★★★
      let currentViewingId = ""; 
      let currentViewingName = ""; 


      const avatarEl = document.getElementById("volunteerAvatar");
      const nameEl = document.getElementById("volunteerName");
      
      let dummyData = [];
      let currentBase64 = "";

      /* -----------------------------------------
         統一控制 Loading 的函式
         ----------------------------------------- */
      function showLoading(title = "正在處理中...", subtitle = "請稍候") {
        document.getElementById('loadingTitle').innerText = title;
        document.getElementById('loadingSubtitle').innerText = subtitle;
        document.getElementById('mainLoadingOverlay').style.display = 'flex';
      }

      function hideLoading() {
        document.getElementById('mainLoadingOverlay').style.display = 'none';
      }

      /* -----------------------------------------
         2. 初始化與 LIFF 整合 (Init & LIFF)
         ----------------------------------------- */
      initLiffAndSetProfile();

      async function initLiffAndSetProfile() {
        try {
          await liff.init({ liffId: LIFF_ID });

          if (!liff.isLoggedIn()) {
            liff.login(); 
            return;
          }

          const profile = await liff.getProfile();
          userId = profile.userId;
          userName = profile.displayName;
          pictureUrl = profile.pictureUrl;
          localStorage.setItem("userId", userId);
          console.log("LIFF Profile userId:", userId, "userName:", userName);

          checkIdentity(userId);

        } catch (err) {
          console.error("LIFF init error:", err);
        }
      }

      async function checkIdentity(uid) {
        showLoading("正在驗證身分...", "請稍候");
        try {
            const response = await fetch(`${API_BASE_URL}/identify/${uid}`);
            const result = await response.json();

            if (!result.success) {
                alert("首次使用需先完成個人資料註冊，\n並同意我們存取您的個人資料。\n請點擊「確定」前往註冊。");
                window.location.href = "../../Login-or-register/index.html"; 
            } else {
                identifyRole = result.role;
                nameEl.innerText = userName || "未登入";
                if (pictureUrl) {
                    avatarEl.src = pictureUrl;
                    avatarEl.style.display = "inline-block";
                }

                if (identifyRole === "志工") {
                    document.getElementById("volunteerOnlyArea").style.display = "block";
                    // ★★★ 如果是志工，呼叫 API 載入長輩清單 ★★★
                    await loadElderOptions(uid); 
                } else {
                    document.getElementById("volunteerOnlyArea").style.display = "none";
                    // 長輩身分，設定目前的 viewingId 為自己，並載入資料
                    currentViewingId = uid;
                    currentViewingName = userName;
                    fetchConsultations(uid);
                }
            }
        } catch (err) {
            console.error("Identity Check Error:", err);
            alert("目前無法通過身分驗證，請確認登入狀態或重新登入。");
        } finally {
            hideLoading();
        }
      }

      // ★★★ 修改：呼叫 API 取得志工對應的長輩清單 ★★★
      async function loadElderOptions(volunteerId) {
          const selectEl = document.getElementById("volunteer_patient_select");
          selectEl.innerHTML = '<option value="" disabled selected>載入中...</option>';

          try {
            // 呼叫你的 API
            const response = await fetch(`${API_BASE_URL}/appointments/by-volunteer/${volunteerId}`);
            const result = await response.json();

            selectEl.innerHTML = '<option value="" disabled selected>請選擇個案...</option>';

            if (result.success && result.data && result.data.length > 0) {
                // 將回傳的資料加入下拉選單
                result.data.forEach(elder => {
                    const option = document.createElement("option");
                    option.value = elder.elder_id;
                    const displaySuffix = elder.elder_display_id ? `(${elder.elder_display_id})` : "";
                    option.textContent = `${elder.elder_name} ${displaySuffix}`;
                    selectEl.appendChild(option);
                });

                // 自動選取第一位長輩並載入資料
                selectEl.value = result.data[0].elder_id;
                currentViewingId = result.data[0].elder_id;
                currentViewingName = result.data[0].elder_name;
                fetchConsultations(currentViewingId);
                
            } else {
                // 如果志工沒有綁定長輩
                const option = document.createElement("option");
                option.text = "目前無綁定的長者";
                option.disabled = true;
                selectEl.appendChild(option);
                // 清空下方列表
                renderCards([]);
            }

          } catch (err) {
            console.error("Load Elders Error:", err);
            selectEl.innerHTML = '<option value="" disabled selected>載入失敗</option>';
            alert("無法取得長者列表，請檢查網路連線");
          }
      }

      // ★★★ 新增：處理切換長輩 ★★★
      function handlePatientChange() {
          const selectEl = document.getElementById("volunteer_patient_select");
          const selectedId = selectEl.value;
          const selectedOption = selectEl.options[selectEl.selectedIndex];
          
          if (selectedId) {
              let showName = selectedOption.text;
              console.log(`切換檢視長輩：${showName} (${selectedId})`);
              currentViewingId = selectedId;
              currentViewingName = showName;
              fetchConsultations(selectedId);
          }
      }

      avatarEl.addEventListener("click", () => {
          if (liff.isLoggedIn()) {
            fetch(`${API_BASE_URL}/identify/${userId}`)
              .then((res) => res.json())
              .then((result) => {
                if (!result.success) {
                  window.location.href = "../../Login-or-register/index.html";
                } else {
                  let identify = result.role; 
                  localStorage.setItem("fromPage", "family-view");
                  switch (identify) {
                    case "志工":
                      window.location.href = "../../Login-or-register/志工資料顯示.html";
                      break;
                    case "長者":
                      window.location.href = "../../Login-or-register/長輩資料顯示.html";
                      break;
                    default:
                      window.location.href = "../../Login-or-register/index.html";
                  }
                }
              })
              .catch(() => {
                window.location.href = "../../Login-or-register/index.html";
              });
          } else {
            liff.login({ redirectUri: window.location.href });
          }
        });

      nameEl.addEventListener("click", () => {
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: window.location.href });
        } else {
          alert("已登入：" + (nameEl.innerText || "志工"));
        }
      });

      // ★★★ 修改：根據傳入的 uid 抓資料 ★★★
      async function fetchConsultations(targetUid) {
        showLoading("正在載入看診紀錄...", "請稍候");
        try {
            const response = await fetch(`${API_BASE_URL}/consultations/${targetUid}`);
            const result = await response.json();
            
            if (result.success && Array.isArray(result.data)) {
                dummyData = result.data.map(item => ({
                    event_id: item.event_id,
                    visit_time: item.visit_time,
                    hospital_name: item.hospital_name || "",
                    doctor_name: item.doctor_name,
                    department: item.department,
                    visit_details: item.visit_details,
                    remarks: item.remarks,
                    next_visit: item.next_visit_time,
                    image_base64: item.image_base64
                }));
                renderCards(dummyData);
            } else {
                console.warn("API 回傳成功但無資料或格式錯誤", result);
                dummyData = [];
                renderCards([]);
            }
        } catch (err) {
            console.error("Fetch Consultations Error:", err);
            alert("載入資料失敗，請檢查網路連線");
        } finally {
            hideLoading();
        }
      }

      function renderCards(data) {
        const listContainer = document.getElementById("recordList");
        listContainer.innerHTML = "";
        
        data.sort((a, b) => new Date(b.visit_time) - new Date(a.visit_time));

        data.forEach((item, index) => {
          const dt = new Date(item.visit_time);
          const dateStr = `${dt.getFullYear()}年 ${dt.getMonth()+1}月 ${dt.getDate()}日`;
          const timeStr = dt.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });

          let nextVisitHtml = "";
          if (item.next_visit) {
             const ndt = new Date(item.next_visit);
             const nDateStr = `${ndt.getFullYear()}/${ndt.getMonth()+1}/${ndt.getDate()}`;
             const nTimeStr = item.next_visit.includes("T") ? ndt.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false }) : "";
             
             nextVisitHtml = `
                <div class="next-visit-box">
                    <i class="fa-regular fa-calendar-check"></i> 下次回診：${nDateStr} ${nTimeStr}
                </div>
             `;
          }

          const remarkHtml = item.remarks ? 
            `<div class="remark-box"><i class="fa-solid fa-bell"></i> 提醒：${item.remarks}</div>` : 
            `<div class="remark-box"></div>`;

          const card = `
            <div class="record-card">
              <div class="card-header">
                <div class="date-box">${dateStr}</div>
                <div class="time-box">
                  <i class="fa-regular fa-clock"></i> ${timeStr}
                </div>
              </div>

              <div class="card-body">
                <div class="info-item">
                  <span class="label-text">醫院/診所名稱：</span>
                  <span class="content-text">${item.hospital_name || '未填寫'}</span>
                </div>
                
                <div class="info-item">
                  <span class="label-text" style="min-width: auto; margin-right: 8px;">
                    <i class="fa-solid fa-stethoscope" title="醫生科別與姓名"></i>
                  </span>
                  <span class="content-text dept-text">
                    ${item.department} - ${item.doctor_name} 醫師
                  </span>
                </div>

                <div class="medical-notes">
                  <span class="notes-title">
                    <i class="fa-solid fa-notes-medical"></i> 醫生囑咐內容：
                  </span>
                  <span class="content-text">${item.visit_details}</span>
                </div>

                ${nextVisitHtml}

                <div class="card-footer-row">
                    ${remarkHtml}
                    
                    <button class="edit-btn" onclick="openModal(${index})">
                      <i class="fa-solid fa-pen"></i> 編輯
                    </button>
                </div>
              </div>
            </div>
          `;
          listContainer.innerHTML += card;
        });

        if (data.length === 0) {
            document.getElementById("noDataMsg").style.display = "block";
        } else {
            document.getElementById("noDataMsg").style.display = "none";
        }
      }

      function openModal(index = -1) {
        const modal = document.getElementById("editModal");
        const deleteBtn = document.getElementById("deleteBtn");
        document.getElementById("editIndex").value = index;

        // 重置全域 base64 變數
        currentBase64 = "";

        const iframe = document.getElementById("cameraFrame");
        if (iframe) {
          iframe.style.height = "50px"; 
          iframe.src = iframe.src; 
        }

        if (index === -1) {
          // ================= 新增模式 =================
          document.getElementById("modalTitle").innerText = "新增看診紀錄";
          
          const now = new Date();
          const yyyy = now.getFullYear();
          const mm = String(now.getMonth() + 1).padStart(2, '0');
          const dd = String(now.getDate()).padStart(2, '0');
          const today = `${yyyy}-${mm}-${dd}`;
          
          const hh = String(now.getHours()).padStart(2, '0');
          const min = String(now.getMinutes()).padStart(2, '0');
          const currentTime = `${hh}:${min}`;

          document.getElementById("field_date").value = today;
          document.getElementById("field_time").value = currentTime;

          document.getElementById("field_hospital").value = ""; 
          document.getElementById("field_dept").value = "";
          document.getElementById("field_doctor").value = "";
          document.getElementById("field_details").value = "";
          document.getElementById("field_remarks").value = "";
          
          document.getElementById("field_next_date").value = "";
          document.getElementById("field_next_time").value = "";

          deleteBtn.style.display = "none";
        } else {
          // ================= 編輯模式 =================
          document.getElementById("modalTitle").innerText = "修改看診紀錄";
          const item = dummyData[index];
          
          const parts = item.visit_time.split('T');
          document.getElementById("field_date").value = parts[0];
          document.getElementById("field_time").value = parts[1];

          document.getElementById("field_hospital").value = item.hospital_name || ""; 
          document.getElementById("field_dept").value = item.department;
          document.getElementById("field_doctor").value = item.doctor_name;
          document.getElementById("field_details").value = item.visit_details;
          document.getElementById("field_remarks").value = item.remarks;
          
          if (item.next_visit) {
              if (item.next_visit.includes("T")) {
                  const nParts = item.next_visit.split('T');
                  document.getElementById("field_next_date").value = nParts[0];
                  document.getElementById("field_next_time").value = nParts[1];
              } else {
                  document.getElementById("field_next_date").value = item.next_visit;
                  document.getElementById("field_next_time").value = "";
              }
          } else {
              document.getElementById("field_next_date").value = "";
              document.getElementById("field_next_time").value = "";
          }

          deleteBtn.style.display = "block";
        }
        modal.style.display = "flex";
      }

      function closeModal() {
        document.getElementById("editModal").style.display = "none";
      }

      async function saveRecord() {
        const index = parseInt(document.getElementById("editIndex").value);
        const datePart = document.getElementById("field_date").value;
        const timePart = document.getElementById("field_time").value;
        const hospitalPart = document.getElementById("field_hospital").value; 
        const department = document.getElementById("field_dept").value;
        const remark = document.getElementById("field_remarks").value;
        const doctorName = document.getElementById("field_doctor").value;
        const visitDetails = document.getElementById("field_details").value;

        const nextDatePart = document.getElementById("field_next_date").value;
        const nextTimePart = document.getElementById("field_next_time").value;
        let nextVisitStr = "";
        
        if (nextDatePart) {
            if (nextTimePart) {
                nextVisitStr = `${nextDatePart}T${nextTimePart}`;
            } else {
                nextVisitStr = nextDatePart; 
            }
        }

        if (!datePart || !timePart || !department) {
          alert("請填寫日期、時間與科別喔！");
          return;
        }

        const fullVisitTime = `${datePart}T${timePart}`;

        // ★★★ 判斷目標長輩 ID ★★★
        // 若身分為志工，使用 currentViewingId；若為長輩，使用自己的 userId
        let targetElderId = "";
        let targetElderName = "";

        if (identifyRole === "志工") {
            if (!currentViewingId) {
                alert("請先選擇一位長輩！");
                return;
            }
            targetElderId = currentViewingId;
            targetElderName = currentViewingName.split(' ')[0]; // 簡單取名
        } else {
            targetElderId = userId;
            targetElderName = userName;
        }

        showLoading("正在儲存資料...", "請稍候");

        try {
            if (index === -1) {
                // ================= 新增 (POST) =================
                const payload = {
                    "elder_user_id": targetElderId,  // 使用選定的長輩 ID
                    "elder_name": targetElderName,
                    "volunteer_user_id": identifyRole === "志工" ? userId : null,
                    "volunteer_name": identifyRole === "志工" ? userName : null,
                    "visit_time": fullVisitTime,
                    "hospital_name": hospitalPart,
                    "doctor_name": doctorName,
                    "department": department,
                    "visit_details": visitDetails,
                    "remarks": remark,
                    "next_visit_time": nextVisitStr,
                    "image_base64": currentBase64 
                };

                const res = await fetch(`${API_BASE_URL}/consultations`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();

                if (result.success) {
                    if (nextVisitStr) {
                        await addToSchedule(targetElderId, targetElderName, nextVisitStr, remark);
                    } else {
                        alert("✅ 新增成功！");
                    }
                    closeModal();
                    fetchConsultations(targetElderId); // 重新載入目標長輩資料
                } else {
                    alert("新增失敗：" + (result.message || "未知錯誤"));
                }

            } else {
                // ================= 編輯 (PATCH) =================
                const item = dummyData[index];
                const eventId = item.event_id; 

                const payload = {
                    "elder_name": targetElderName,
                    "volunteer_user_id": identifyRole === "志工" ? userId : null,
                    "volunteer_name": identifyRole === "志工" ? userName : null,
                    "visit_time": fullVisitTime,
                    "hospital_name": hospitalPart,
                    "doctor_name": doctorName,
                    "department": department,
                    "visit_details": visitDetails,
                    "remarks": remark,
                    "next_visit_time": nextVisitStr,
                    "image_base64": currentBase64 
                };

                // 注意：API url 需要傳入該筆資料所屬的 user_id (即 targetElderId)
                const res = await fetch(`${API_BASE_URL}/consultations/${targetElderId}/${eventId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();

                if (result.success) {
                    alert("✅ 更新成功！");
                    closeModal();
                    fetchConsultations(targetElderId); 
                } else {
                    alert("更新失敗：" + (result.message || "未知錯誤"));
                }
            }
        } catch (err) {
            console.error("Save Error:", err);
            alert("系統錯誤，無法儲存");
        } finally {
            hideLoading();
        }
      }

      // [獨立函式] 加入行事曆 (記得傳入正確的 elderId)
      async function addToSchedule(eId, eName, nextTime, remarkText) {
         showLoading("正在加入行事曆提醒...", "請稍候");
         try {
            const apiPayload = {
                "elder_user_id": eId, 
                "elder_name": eName,
                "schedule_time": nextTime,
                "schedule_note": "回診",
                "is_reminded": true,
                "remark": "提醒您，明日要回診，請攜帶您的健保卡\n" + (remarkText || ""),
                "reminder_method": "day"
            };

            const response = await fetch(`${API_BASE_URL}/schedules`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(apiPayload)
            });
            const result = await response.json();

            if (result.success) {
                alert("✅ 資料已儲存，並成功加入行事曆！");
            } else {
                alert("⚠️ 資料已儲存，但加入行事曆失敗。");
            }
         } catch (err) {
            console.error(err);
            alert("⚠️ 資料已儲存，但連線錯誤導致行事曆加入失敗。");
         }
      }

      async function deleteRecord() {
        const index = parseInt(document.getElementById("editIndex").value);
        if (!confirm("確定要刪除這筆紀錄嗎？")) return;

        const item = dummyData[index];
        const eventId = item.event_id;

        // 判斷當前操作對象 ID
        let targetId = (identifyRole === "志工") ? currentViewingId : userId;

        showLoading("正在刪除...", "請稍候");
        try {
            const res = await fetch(`${API_BASE_URL}/consultations/${targetId}/${eventId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" }
            });
            
            try {
                const result = await res.json(); 
                if(!result.success) throw new Error("Delete failed");
            } catch(e) {
                if(!res.ok) throw e;
            }

            alert("刪除成功");
            closeModal();
            fetchConsultations(targetId);

        } catch (err) {
            console.error("Delete Error:", err);
            alert("刪除失敗，請稍後再試");
        } finally {
            hideLoading();
        }
      }

      window.addEventListener('message', function(event) {
        if (!event.data) return;

        if (event.data.type === 'resize-iframe') {
          const iframe = document.getElementById('cameraFrame');
          if (iframe) {
            iframe.style.height = (event.data.height + 20) + 'px';
          }
        }

        if (event.data.type === 'fill-data') {
          const data = event.data.data;
          console.log("收到 AI 資料:", data);

          if (event.data.base64) {
              currentBase64 = event.data.base64; 
          }

          const visitDate = data.patient_info?.visit_date;
          if (visitDate) {
             document.getElementById("field_date").value = visitDate;
          }

          if (data.hospital_info?.name) {
             document.getElementById("field_hospital").value = data.hospital_info.name;
          }

          if (data.hospital_info?.department) {
             document.getElementById("field_dept").value = data.hospital_info.department;
          }

          if (data.hospital_info?.doctor_name) {
             document.getElementById("field_doctor").value = data.hospital_info.doctor_name;
          }

          if (data.notes?.side_effects) {
             document.getElementById("field_details").value = data.notes.side_effects;
          }

          if (data.notes?.warnings) {
             document.getElementById("field_remarks").value = data.notes.warnings;
          }

          const followUpDate = data.patient_info?.follow_up_date;
          const followUpTime = data.patient_info?.follow_up_time;

          if (followUpDate) {
              document.getElementById("field_next_date").value = followUpDate;
          }
          if (followUpTime) {
              document.getElementById("field_next_time").value = followUpTime;
          }
        }

        if (event.data.type === 'show-loading') {
          showLoading("正在為您辨識圖片中的文字資訊", "請稍候，這可能需要約 10～30 秒");
        }
        
        if (event.data.type === 'hide-loading') {
          hideLoading();
        }
      });
    </script>
  </body>
</html>