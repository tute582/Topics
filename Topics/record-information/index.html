<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- éŸ¿æ‡‰å¼ï¼Œè®“æ‰‹æ©Ÿå¯æ­£ç¢ºç¸®æ”¾ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>çœ‹è¨ºè³‡è¨Š</title>

  <style>
    /* ==============================
       å…¨åŸŸè¨­å®šï¼šç‰ˆé¢èˆ‡å­—é«”
       ============================== */
    body { 
      font-family: "Arial", sans-serif;
      padding: 0;
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .input-container { margin-top: 15px; }
    .search-container { margin-bottom: 30px; }

    /* çµ±ä¸€å·¦å³å°é½Šï¼šä¸€å€‹å®¹å™¨æ§åˆ¶å·¦å³å…§è· */
    .input-container, .search-container {
      padding: 0 25px; /* èˆ‡æ¨™é¡Œç›¸åŒçš„å·¦å³é–“è· */
      box-sizing: border-box;
    }

    .title {
      margin: 5px 0;
      font-size: 26px;
    }

    /* æ¨™é¡Œæ¨£å¼ */
    h1 { 
      margin-top: 5px;
      margin-bottom: 5px;
      /*font-size: 42px; */ 
    }
    h2 { 
      margin-top: 5px;
      margin-bottom: 5px;
      font-size: 20px; 
      display: inline-block; }

    h3 { 
      margin: 0; 
      font-size: 16px; 
      color: #555; 
    }

    /* è¡¨å–®å¤–æ¡†æ¨£å¼ */
    .input-container > form {
      width:100%; 
      margin: 10px 0;
      padding: 20px; /* åªä¿ç•™ä¸Šä¸‹å…§è·ï¼Œå·¦å³ç”±å®¹å™¨æ§åˆ¶ï¼Œé¿å…é›™é‡å…§è· */
      border: 1px solid #ccc;
      border-radius: 20px;
      box-sizing: border-box;
    }

    /* ==============================
       è¡¨æ ¼å®¹å™¨æ¨£å¼
       ============================== */
    .table-container {
      width: 100%;
      margin: 5px ;
      /* å…è¨±æ°´å¹³æ»¾å‹•ï¼Œå¿…è¦æ™‚é¡¯ç¤ºæ°´å¹³æ»¾è»¸ */
      overflow-x: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* è¡Œå‹•è£ç½®å¹³æ»‘æ»¾å‹• */
      /* è‹¥å¸Œæœ›åœ¨å…§å®¹è¶…å‡ºæ™‚ç¸½æ˜¯é¡¯ç¤ºæ°´å¹³æ»¾è»¸ï¼ˆæŸäº›ç³»çµ±æœƒéš±è—ï¼‰ï¼Œå¯æ”¹ç”¨ overflow: auto; */
      /* max-height: 200px;  é™åˆ¶é«˜åº¦ï¼Œè¶…éå‡ºç¾æ»¾è¼ª */
      border: 1px solid #aaa;
      border-radius: 20px;
      background-color: white;
      display: none; /* âœ… ä¸€é–‹å§‹æ•´å€‹å®¹å™¨éš±è— */
    }

    /* è¡¨æ ¼åŸºæœ¬æ¨£å¼ */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      /* è¨­å®šæ¯”å®¹å™¨å¯¬ï¼Œç•¶å®¹å™¨è¼ƒçª„æœƒå‡ºç¾æ©«å‘æ»¾å‹• */
      min-width: 800px; 
      box-sizing: border-box;
    }
    
    /*#message {
      margin-top: 15px;
      font-weight: bold;
      color: #444;
    }*/

    th, td { 
      padding:10px; 
      text-align:center; 
      border: 1px solid #ddd;
      white-space: nowrap; /* é˜²æ­¢æ›è¡Œï¼Œé…åˆæ©«å‘æ»¾å‹• */
    }
    
    /* è¡Œå‹•è£ç½®ä¸Šä»å¯è§¸ç™¼æ©«å‘æ²å‹•ï¼ˆè‹¥æƒ³åœ¨çª„è¢å¹•é™ä½ min-width å¯ç”¨ä¸‹é¢çš„è¨­å®šï¼‰ */
    @media (max-width: 600px) {
      table { min-width: 700px; }
    }

    /* è¡¨é ­å›ºå®š */
    th { 
      background-color:#f9f9f9; 
      position: sticky;
      top: 0;
      z-index: 2;
    }

    /* ==============================
       éŸ¿æ‡‰å¼è¨­å®šï¼ˆæ‰‹æ©Ÿä»‹é¢ï¼‰
       ============================== */
    @media (max-width: 768px) {
    
      form { width: 95%; }
      /* åœ¨æ‰‹æ©Ÿä¸Šç§»é™¤å¼·åˆ¶æœ€å°å¯¬åº¦ è®“è¡¨æ ¼å¯ç¸®æ”¾ä¸¦å‡ºç¾æ©«å‘æ»¾å‹• */
      table { min-width: 0; width:100%; }
      /* èª¿æ•´è¼¸å…¥æ¬„ä½å­—ç´šèˆ‡æŒ‰éˆ•æ›´é©åˆæ‰‹æ©Ÿ */
      input[type="text"], input[type="date"], input[type="time"], textarea { font-size:16px; padding:10px; }
      button { padding:12px 18px; font-size:16px; }
    }

    /* è¡¨å–®è¼¸å…¥æ¬„ä½æ¨£å¼ */
    label{ 
      display:block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 20px;
    }

    input[type="date"],
    input[type="time"] {
      width: 100%;
      min-width: 0;     /* iOS å¿…åŠ  */
      -webkit-appearance: none;
      appearance: none; /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
    }
    input[type="text"],
    textarea {
      width:100% ;
      padding:8px;
      margin-top:5px;
      border-radius:10px;
      border:1px solid #888;
      font-size:14px;
      box-sizing:border-box;
      background-color: white; /* ä¸»è¡¨å–®é è¨­ç™½åº• */
      color: #222;
    }
    /* è‹¥è¼¸å…¥æ¬„ä½ç‚º readonlyï¼Œä¹Ÿä¿æŒç™½åº•ï¼ˆè¦†è“‹ç€è¦½å™¨é è¨­ç°åº•ï¼‰ */
    input[readonly], textarea[readonly], input[readonly]:not([type="checkbox"]) {
      background-color: white;
      cursor: default;
    }
    textarea { font-size:16px; }

    /* æŒ‰éˆ•æ¨£å¼ */
    button {
      margin-top:15px; 
      padding:10px 20px; 
      border:none; 
      border-radius:10px;
      background-color:#4a90e2; color:white; 
      cursor:pointer; 
      font-size:20px;
    }
    button:hover { background-color:#357abd; }

    /* è¡¨æ ¼åˆ—çš„äº¤éŒ¯é¡è‰² */
    .evenrowcolor{ background-color: #f9f9f9; }
    .oddrowcolor{ background-color: #ffffff; }

    /* ==============================
       Modal ç·¨è¼¯è¦–çª—æ¨£å¼
       ============================== */
    #editModal {
      display:none;
      position:fixed; top:0; left:0;
      width:100%; height:100%;
      background-color:rgba(0,0,0,0.5);
      z-index:1000;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #editModal.show { display:block; opacity:1; }

    /* Modal ç›’å­ï¼šå›ºå®šå¯¬åº¦ä½†æœƒåœ¨çª„è¢å¹•ç¸®æ”¾ï¼›å…§å®¹å¯å‚ç›´æ»¾å‹• */
    #editModal > div {
      background:#fff;
      width:420px;
      max-width: calc(100% - 40px); /* åœ¨å°è¢å¹•æ™‚è‡ªå‹•ç¸®å° */
      margin:80px auto;
      padding:20px 24px;
      border-radius:15px;
      position:relative;
      box-sizing: border-box;
      max-height: calc(100vh - 100px); /* å¯è¦‹ç¯„åœå…§æœ€å¤§é«˜åº¦ */
      overflow-y: auto; /* å…§å®¹è¶…å‡ºæ™‚é¡¯ç¤ºæ²è»¸ */
      transform:translateY(-20px);
      transition:transform 0.3s ease;
    }
    #editModal.show > div { transform:translateY(0); }

    /* ==============================
       ç·¨è¼¯è¦–çª—æŒ‰éˆ•æ¨£å¼
       ============================== */
    #cancelEditBtn {
      background:none;
      border:none;
      color:#555;
      font-size:20px;
      position:absolute;
      top:10px;
      right:10px;
      cursor:pointer;
      border-radius:5px;
      padding:5px 10px;
      transition: all 0.3s ease;
    }
    #cancelEditBtn:hover {
      background-color:#e74c3c; /* ç´…è‰²èƒŒæ™¯ */
      color:white;
      transform: scale(1.1);
    }

    /* ç·¨è¼¯æŒ‰éˆ• */
    #enterEditBtn {
      position:absolute; top:10px; right:10px;
      background-color:#f4b977; color:#333;
      border:none; border-radius:8px; padding:6px 12px; cursor:pointer;
      transition:all 0.3s ease;
    }
    #enterEditBtn:hover { background-color:#e0b557; }

    /* å„²å­˜èˆ‡åˆªé™¤æŒ‰éˆ• */
    #saveEditBtn, #deleteEditBtn {
      margin-top:10px; font-size:16px; padding:8px 15px;
      border-radius:10px; border:none; cursor:pointer; display:none;
    }
    #saveEditBtn { background-color:#4a90e2; color:white; }
    #saveEditBtn:hover { background-color:#357abd; }
    #deleteEditBtn { background-color:#f37a7a; color:white; }
    #deleteEditBtn:hover { background-color:#d94a4a; }

    h3{ margin-top:0; text-align:center; }

    /* ==============================
       å„²å­˜æç¤ºè¦–çª— (æ˜¯å¦å„²å­˜è®Šæ›´)
       ============================== */
    #saveConfirmModal {
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background-color:rgba(0,0,0,0.5);
      z-index:2000;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    #saveConfirmModal.show { display:block; opacity:1; }

    #saveConfirmModal > div {
      background:#fff;
      width:350px;
      margin:150px auto;
      padding:25px;
      border-radius:15px;
      text-align:center;
      transform:translateY(-20px);
      transition:transform 0.3s ease;
    }
    #saveConfirmModal.show > div { transform:translateY(0); }

    /* æç¤ºè¦–çª—æŒ‰éˆ•æ¨£å¼ */
    #saveConfirmModal button {
      margin:10px;
      padding:8px 18px;
      font-size:16px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      transition: all 0.3s ease;
    }
    #confirmSaveBtn { background-color:#4a90e2; color:white; }
    #confirmSaveBtn:hover { background-color:#357abd; }

    #confirmDiscardBtn { background-color:#f37a7a; color:white; }
    #confirmDiscardBtn:hover { background-color:#d94a4a; }

    #continueEditBtn {
      background-color:#f2f2f2;
      color:white;
      font-size:15px;
    }
    #continueEditBtn:hover { background-color:#ffffff; }
    
    /* å°è¦½åˆ— */
  .nav-1{
    display: flex;                 /* æ°´å¹³æ’åˆ—å…§å®¹ */
   /* font-weight: 500;*/
    align-items: center;           /* å‚ç›´ç½®ä¸­ */
    justify-content: space-between;/* å…©ç«¯å°é½Šï¼šå·¦/å³ */
    padding: 10px 25px;           /* å³å´ä¿ç•™å…§è·ï¼Œå·¦å´ç§»é™¤è®“å…§å®¹é è¿‘é é‚Š */
    position: sticky;              /* æ»¾å‹•æ™‚å¸é™„ä¸Šæ–¹ */
    top: 0;                        /* å¸é™„é ‚éƒ¨ */
    z-index: 1001;                 /* ä¿è­‰åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    width: 100%;
    left: 0;
    right: 0;
    color: black;
    background-color: white;
    box-sizing: border-box; /* ç¢ºä¿paddingä¸æœƒè¶…å‡ºå¯¬åº¦ */
    border-bottom: 1px solid #ddd; /* å»ºè­°åŠ é€™è¡Œè®“å°è¦½åˆ—æ›´æ˜é¡¯ */
  }

  .record-item {
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }

    .no-record {
      text-align: center;
      color: #888;
      font-size: 18px;
      margin: 20px 0;
    }


  /* volunteer area */
  .volunteer-area { display:flex; align-items:center; gap:8px; }
  .volunteer-area .avatar {
    width:36px; height:36px; border-radius:50%; object-fit:cover;
    border:1px solid #ddd; display:none;
  }
  /* å¯é»æ“Šçš„ç™»å…¥å€åŸŸæ¨£å¼ */
  .volunteer-area #volunteerName {
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    background: transparent;
  }
  .volunteer-area button { padding:4px 8px; border-radius:6px; font-size:14px; }
  </style>
</head>

<body>
<!-- ==============================
     é é¢æ¨™é¡Œèˆ‡è¡¨å–®
     ============================== -->
<!-- å°è¦½åˆ— -->
<nav class="nav-1" >
  <div>
    <h1 style="margin:0; font-size: 28px;">çœ‹è¨ºè³‡è¨Š</h1>
  </div>

  <div style="display:flex; align-items:center;">
    <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥" style="cursor:pointer; font-size: 26px;">è¼‰å…¥ä¸­</span>
      </span>
    </h1>
  </div>
</nav>


<div class="input-container"> 
<h1 class="title" style="font-size: 24px;"> è¼¸å…¥å…§å®¹</h1>
<!-- è¼¸å…¥è¡¨å–®å€ -->
<form>
  <label>é•·è¼©å§“å<input type="text" id="elderName"></label>
  <label>çœ‹è¨ºæ—¥æœŸ<input type="date" id="date"></label>
  <label>çœ‹è¨ºæ™‚é–“<input type="time" id="time"></label>
  <label>é†«ç”Ÿå§“å<input type="text" id="name"></label>
  <label>é†«ç”Ÿç§‘åˆ¥
  <input type="text" id="department" list="departmentList">
  <datalist id="departmentList">
    <option value="å…§ç§‘"></option>
    <option value="å¤–ç§‘"></option>
    <option value="å°å…’ç§‘"></option>
    <option value="å©¦ç”¢ç§‘"></option>
    <option value="è€³é¼»å–‰ç§‘"></option>
    <option value="çœ¼ç§‘"></option>
    <option value="çš®è†šç§‘"></option>
    <option value="éª¨ç§‘"></option>
    <option value="æ³Œå°¿ç§‘"></option>
    <option value="ç¥ç¶“å…§ç§‘"></option>
    <option value="ç²¾ç¥ç§‘"></option>
    <option value="å¿ƒè‡Ÿå…§ç§‘"></option>
    <option value="èƒ¸è…”å…§ç§‘"></option>
    <option value="èƒƒè…¸è‚è†½ç§‘"></option>
    <option value="å…§åˆ†æ³Œæ–°é™³ä»£è¬ç§‘"></option>
    <option value="å¾©å¥ç§‘"></option>
    <option value="æ•´å½¢å¤–ç§‘"></option>
    <option value="å¤§è…¸ç›´è…¸å¤–ç§‘"></option>
    <option value="æ€¥è¨ºé†«å­¸ç§‘"></option>
    <option value="å®¶åº­é†«å­¸ç§‘"></option>
  </datalist>
</label>
    <label for="record">çœ‹è¨ºå…§å®¹ <textarea id="record" rows="2"></textarea></label>
   

    <label for="note">å‚™è¨»<textarea id="note" rows="2"></textarea></label>
    
  
  <button type="button" onclick="addRow()">æ–°å¢</button>
</form>
</div>

<div class="search-container"> 
<!-- æŸ¥è©¢æ¨™é¡Œ -->

<h1 class="title" style="font-size: 24px;">æŸ¥è©¢</h1>

<!-- æ–°å¢ï¼šç„¡è³‡æ–™æ™‚é¡¯ç¤ºçš„è¨Šæ¯ -->
<div id="no-record-msg" class="no-record">ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>

<!-- ==============================
     è³‡æ–™è¡¨æ ¼å€åŸŸ
     ============================== -->
<div class="table-container">
  <table id="dataTable">
    <thead>
    <tr>
      <th>é•·è¼©å§“å</th>
      <th>çœ‹è¨ºæ—¥æœŸ</th>
      <th>çœ‹è¨ºæ™‚é–“</th>
      <th>é†«ç”Ÿå§“å</th>
      <th>é†«ç”Ÿç§‘åˆ¥</th>
      <th>çœ‹è¨ºå…§å®¹</th>
      <th>å‚™è¨»</th>
      <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
  
</div>
</div>

<!-- ==============================
     ç·¨è¼¯è³‡æ–™ Modal è¦–çª—
     ============================== -->
<div id="editModal">
  <div>
    <button id="cancelEditBtn" title="æŒ‰ Esc æˆ–é»æˆ‘é—œé–‰">âœ–</button>
    <button id="enterEditBtn">ç·¨è¼¯</button>

    <div style="display: flex; justify-content: center;">
  <h2>çœ‹è¨ºè³‡è¨Š</h2>
</div>
    <!-- æ¬„ä½è³‡æ–™ -->
    <label>é•·è¼©å§“å<input type="text" id="editElderName" placeholder="é•·è¼©å§“å" readonly></label>
    <label>æ—¥æœŸ<input type="date" id="editDate" readonly></label>
    <label>æ™‚é–“<input type="time" id="editTime" readonly></label>
    <label>é†«ç”Ÿå§“å<input type="text" id="editDoctorName" placeholder="è«‹è¼¸å…¥é†«ç”Ÿå§“å" readonly>
    </label>
    <label>é†«ç”Ÿç§‘åˆ¥
  <input type="text" id="editDepartment" list="editDepartmentList" placeholder="è«‹é¸æ“‡ç§‘åˆ¥" readonly>
  <datalist id="editDepartmentList">
    <option value="å…§ç§‘"></option>
    <option value="å¤–ç§‘"></option>
    <option value="å°å…’ç§‘"></option>
    <option value="å©¦ç”¢ç§‘"></option>
    <option value="è€³é¼»å–‰ç§‘"></option>
    <option value="çœ¼ç§‘"></option>
    <option value="çš®è†šç§‘"></option>
    <option value="éª¨ç§‘"></option>
    <option value="æ³Œå°¿ç§‘"></option>
    <option value="ç¥ç¶“å…§ç§‘"></option>
    <option value="ç²¾ç¥ç§‘"></option>
    <option value="å¿ƒè‡Ÿå…§ç§‘"></option>
    <option value="èƒ¸è…”å…§ç§‘"></option>
    <option value="èƒƒè…¸è‚è†½ç§‘"></option>
    <option value="å…§åˆ†æ³Œæ–°é™³ä»£è¬ç§‘"></option>
    <option value="å¾©å¥ç§‘"></option>
    <option value="æ•´å½¢å¤–ç§‘"></option>
    <option value="å¤§è…¸ç›´è…¸å¤–ç§‘"></option>
    <option value="æ€¥è¨ºé†«å­¸ç§‘"></option>
    <option value="å®¶åº­é†«å­¸ç§‘"></option>
  </datalist>
  </label>
    <label>å…§å®¹<textarea id="editRecord" rows="3" readonly></textarea></label>
    <label>å‚™è¨»<textarea id="editNote" rows="3" readonly></textarea></label>

    <!-- å„²å­˜/åˆªé™¤æŒ‰éˆ• -->
    <div style="text-align:center; margin-top:10px;">
      <button id="saveEditBtn">å„²å­˜</button>
      <button id="deleteEditBtn">åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- ==============================
     å„²å­˜ç¢ºèªæç¤ºè¦–çª—
     ============================== -->
<div id="saveConfirmModal">
  <div>
    <h3>æ­¤æ¬¡ä¿®æ”¹éœ€è¦å„²å­˜å—ï¼Ÿ</h3>
    <p>è‹¥æœªå„²å­˜ï¼Œè®Šæ›´çš„å…§å®¹å°‡æœƒéºå¤±ã€‚</p>
    <button id="confirmSaveBtn">å„²å­˜</button>
    <button id="continueEditBtn">ç¹¼çºŒç·¨è¼¯</button>
    <button id="confirmDiscardBtn">æ”¾æ£„</button>
  </div>
</div>

<!-- ==============================
     JavaScript ç¨‹å¼å€
     ============================== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
let editRowIndex = null;
let isEditing = false;
let originalData = {};

//Liffåˆå§‹åŒ–ç›¸é—œè®Šæ•¸
const LIFF_ID = "2008484068-qkydRNYN";
const avatarEl = document.getElementById("volunteerAvatar");
const nameEl = document.getElementById("volunteerName");
let userId = "";
let userName = "";
let currentEditEventId = "";

//åŸ·è¡Œfunction
initLiffAndSetProfile();
updateNoRecordMessage();

//æ¸…é™¤è¼¸å…¥è³‡æ–™
function clearInputs() {
  ["elderName", "date", "time", "name", "department", "record", "note"].forEach(id => {
    document.getElementById(id).value = "";
  });
}

/* ==============================
   âœ… é¡¯ç¤ºï¼éš±è—ã€Œç›®å‰å°šæœªæœ‰ç´€éŒ„ã€æç¤º
   ============================== */
function updateNoRecordMessage() {
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  const hasRecords = tbody.rows.length > 0;
  const container = document.querySelector(".table-container");
  const noRecordMsg = document.getElementById("no-record-msg");

  if (hasRecords) {
    container.style.display = "block";
    noRecordMsg.style.display = "none";
  } else {
    container.style.display = "none";
    noRecordMsg.style.display = "block";
  }
}

//æ–°å¢è³‡æ–™
async  function addRow() {
  const elderName = document.getElementById("elderName").value.trim();
  const date = document.getElementById("date").value.trim();
  const time = document.getElementById("time").value.trim();
  const name = document.getElementById("name").value.trim();
  const department = document.getElementById("department").value.trim();
  const record = document.getElementById("record").value.trim();
  const note = document.getElementById("note").value.trim();
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  // å­˜å…¥å®Œæˆè®Šæ•¸
  clearInputs();

  if (!date || !time) {
    alert("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ™‚é–“ï¼");
    return;
  }

  //Supabase Post API
  let newEventId = null;   // æ–°å¢çš„ event_id
  try {
    const payload = {
      elder_user_id : userId,   //çœ‹è¨ºè³‡è¨Šå¯èƒ½ç”±å¿—å·¥è¼¸å…¥ï¼Œæ—¥å¾Œæœ‰åˆ¤æ–·èº«åˆ†æ™‚ä½¿ç”¨
      elder_name : elderName,   //å› åŸå…ˆæœ‰è¦ç”¨æ–¼å¿—å·¥å”åŠ©è¼¸å…¥ï¼Œä½†å°šæœªè™•ç†
      visit_time: `${date} ${time}`,
      doctor_name: name,
      department: department,
      visit_details:record,
      remarks: note
    };

    const POST_SUPABASE_API_URL = "https://supabase-api-six.vercel.app/consultations";
    const res = await fetch(POST_SUPABASE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (!res.ok) {
      console.error("âŒ ä¸Šå‚³å¤±æ•—:", result);
      alert("âš ï¸ ä¸Šå‚³è³‡æ–™å¤±æ•—ï¼");
      return;
    }

    console.log("ğŸ‰ æ–°å¢æˆåŠŸ", result);

    newEventId = result?.data?.event_id; // â† å¾ API å›å‚³å–å¾— eventId
    if (!newEventId) console.warn("âš  ç„¡æ³•å–å¾— event_id");

    // æ–°å¢ä¸€åˆ—è³‡æ–™
    const newRow = tbody.insertRow(-1);
    newRow.insertCell(0).innerText = elderName;
    newRow.insertCell(1).innerText = date;
    newRow.insertCell(2).innerText = time;
    newRow.insertCell(3).innerText = name;
    newRow.insertCell(4).innerText = department;
    newRow.insertCell(5).innerText = record;
    newRow.insertCell(6).innerText = note;

    // æ“ä½œæ¬„
    const actionCell = newRow.insertCell(7);
    const editBtn = document.createElement("button");
    editBtn.type = "button";
    editBtn.innerText = "ç·¨è¼¯";
    editBtn.style.padding = "6px 10px";
    editBtn.onclick = () => openEditModal(newRow);
    actionCell.appendChild(editBtn);

    // æ›´æ–°è¡¨æ ¼ç‹€æ…‹
    sortTableByDateTime("dataTable");
    altRows("dataTable");
    addEditButtonsToRows();
    updateNoRecordMessage(); // âœ… æ–°å¢å¾Œç«‹å³æ›´æ–°æç¤º
  } catch (err) {
    console.error("âŒ Supabase éŒ¯èª¤:", err);
    alert("âš ï¸ ç„¡æ³•é€£ç·šè³‡æ–™åº«");
    return;
  }
}

/* ==============================
   âœ… æ—¥æœŸ + æ™‚é–“æ’åºå‡½å¼ï¼ˆç©©å®šç‰ˆï¼‰
   ============================== */
function sortTableByDateTime(tableId) {
  const table = document.getElementById(tableId);
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.rows);

  rows.sort((a, b) => {
    const dateA = a.cells[1]?.innerText || "";
    const timeA = a.cells[2]?.innerText || "";
    const dateB = b.cells[1]?.innerText || "";
    const timeB = b.cells[2]?.innerText || "";
    const dtA = new Date(`${dateA} ${timeA}`);
    const dtB = new Date(`${dateB} ${timeB}`);
    return dtA - dtB;
  });

  rows.forEach(r => tbody.appendChild(r));
}

//åˆå§‹åŒ–è¼‰å…¥è³‡æ–™
async function loadData() {
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");

  tbody.innerHTML = "";
  if (userId=="")
  {
    console.log("æ²’æœ‰æª¢æ¸¬åˆ°ä½¿ç”¨è€…ç™»å…¥IDï¼Œæ˜¯å¦æœªç™»å…¥LINEå¸³è™Ÿ?");
    return
  }
  const GET_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}`;

  try {
    const res = await fetch(GET_SUPABASE_API_URL);
    const json = await res.json();

    if (!json.success || !Array.isArray(json.data) || json.data.length === 0) {
      console.warn("âš  API é›–æˆåŠŸä½†ç„¡è³‡æ–™");
      updateNoRecordMessage();
      return;
    }

    json.data.forEach(d => {
      const datetime = d.visit_time ? new Date(d.visit_time) : null;
      const date = datetime ? datetime.toISOString().split("T")[0] : "";
      const time = datetime ? datetime.toISOString().split("T")[1].substring(0, 5) : "";

      const newRow = tbody.insertRow(-1);
      newRow.insertCell(0).innerText = d.elder_name || "";
      newRow.insertCell(1).innerText = date;
      newRow.insertCell(2).innerText = time;
      newRow.insertCell(3).innerText = d.doctor_name || "";
      newRow.insertCell(4).innerText = d.department || "";
      newRow.insertCell(5).innerText = d.visit_details || "";
      newRow.insertCell(6).innerText = d.remarks || "";
      newRow.dataset.event_id = d.event_id

      const actionCell = newRow.insertCell(7);
      const editBtn = document.createElement("button");
      editBtn.innerText = "ç·¨è¼¯";
      editBtn.type = "button";
      editBtn.style.padding = "6px 10px";
      editBtn.onclick = () => openEditModal(newRow);
      actionCell.appendChild(editBtn);
    });

    sortTableByDateTime("dataTable");
    altRows("dataTable");
    addEditButtonsToRows();
    updateNoRecordMessage();
  } catch (err) {
    console.error("âŒ API è®€å–å¤±æ•—", err);
    updateNoRecordMessage();
  }
}

function altRows(id) {
  const table = document.getElementById(id);
  const rows = table.getElementsByTagName("tr");
  for (let i = 1; i < rows.length; i++)
    rows[i].className = (i % 2 === 0) ? "evenrowcolor" : "oddrowcolor";
}

//é–‹å•Ÿç·¨è¼¯è¦–çª—
function openEditModal(row) {
  editRowIndex = row.rowIndex;
  currentEditEventId = row.dataset.event_id;
  const modal = document.getElementById("editModal");
  ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].forEach((f, i) => {
    const val = row.cells[i].innerText;
    document.getElementById("edit" + f).value = val;
    originalData[f] = val;
  });
  setReadOnly(false);
  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);
  document.querySelector(".nav-1").style.display = "none";
}

function setReadOnly(readOnly) {
  document.querySelectorAll("#editModal input, #editModal textarea").forEach(el => {
    el.readOnly = readOnly;
    if (el.type === "date" || el.type === "time") {
      el.style.backgroundColor = "white";
    } else {
      el.style.backgroundColor = readOnly ? "#f7f7f7" : "white";
    }
  });
  document.getElementById("saveEditBtn").style.display = readOnly ? "none" : "inline-block";
  document.getElementById("deleteEditBtn").style.display = readOnly ? "none" : "inline-block";
  document.getElementById("enterEditBtn").style.display = readOnly ? "inline-block" : "none";
  isEditing = !readOnly;
}

document.getElementById("enterEditBtn").onclick = () => setReadOnly(false);

//ç·¨è¼¯ä¸­çš„"å„²å­˜"æŒ‰éˆ•è¢«é»é¸æ™‚åŸ·è¡Œ
document.getElementById("saveEditBtn").onclick = () => {
  const row = document.getElementById("dataTable").rows[editRowIndex];
  ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].forEach((f, i) => {
    row.cells[i].innerText = document.getElementById("edit" + f).value;
  });

  sortTableByDateTime("dataTable");
  altRows("dataTable");
  saveEditData(); // âœ… æ›´æ–°è®Šæ›´
  closeModal();
};

//ç·¨è¼¯ä¸­çš„"åˆªé™¤"æŒ‰éˆ•è¢«é»é¸æ™‚åŸ·è¡Œ
document.getElementById("deleteEditBtn").onclick = () => {
  if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) {
    document.getElementById("dataTable").deleteRow(editRowIndex);
    sortTableByDateTime("dataTable");
    altRows("dataTable");
    deleteData(); // âœ… åˆªé™¤å¾Œå„²å­˜
    closeModal();
  }
};

//é€éPatch URL æ›´æ–°ç·¨è¼¯è³‡æ–™åˆ°è³‡æ–™åº«
async function saveEditData() {
  if (!currentEditEventId) {
    console.error("âŒ event_id ä¸å­˜åœ¨ï¼Œç„¡æ³• PATCH");
    return;
  }

  const elderName = document.getElementById("editElderName").value;
  const date = document.getElementById("editDate").value;
  const time = document.getElementById("editTime").value;
  const doctorName = document.getElementById("editDoctorName").value;
  const department = document.getElementById("editDepartment").value;
  const record = document.getElementById("editRecord").value;
  const note = document.getElementById("editNote").value;

  const visit_time = `${date}T${time}:00`;

  const payload = {
    elder_name: elderName,
    visit_time: visit_time,
    doctor_name: doctorName,
    department: department,
    visit_details: record,
    remarks: note
  };

  const PATCH_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}/${currentEditEventId}`;

  try {
    const res = await fetch(PATCH_SUPABASE_API_URL, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    console.log("PATCH å›å‚³ï¼š", json);

    if (json.success) {
      alert("è³‡æ–™æ›´æ–°å·²å®Œæˆï¼âœ¨");
    } else {
      alert("æ›´æ–°å¤±æ•—ï¼š" + json.message);
    }
  } catch (err) {
    console.error("âŒ PATCH API éŒ¯èª¤ï¼š", err);
    alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  }
}

//é€éDelete URL åˆªé™¤ç·¨è¼¯è³‡æ–™åˆ°è³‡æ–™åº«
async function deleteData() {
  // ğŸ“Œ æ­£ç¢º Delete API URL
  const DELETE_API_URL =
    `https://supabase-api-six.vercel.app/consultations/${userId}/${currentEditEventId}`;

  try {
    const res = await fetch(DELETE_API_URL, {
      method: "DELETE"
    });

    if (!res.ok) {
      alert("åˆªé™¤å¤±æ•—: " + (result.message || res.status));
      return;
    }
    alert("åˆªé™¤æˆåŠŸï¼");
  }catch (err) {
    console.error("DELETE Errorï¼š", err);
    alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
  }
}

function hasChanges() {
  return ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].some(
    f => document.getElementById("edit" + f).value !== originalData[f]
  );
}

function tryCloseModal() {
  if (isEditing && hasChanges()) {
    showSaveConfirmModal();
  } else {
    closeModal();
  }
}

//é—œé–‰ç·¨è¼¯å®¤çª—
function closeModal() {
  const modal = document.getElementById("editModal");
  modal.classList.remove("show");
  setTimeout(() => (modal.style.display = "none"), 300);
  setReadOnly(true);
  document.querySelector(".nav-1").style.display = "flex";
}

document.getElementById("cancelEditBtn").onclick = () => tryCloseModal();
document.addEventListener("keydown", e => {
  if (e.key === "Escape") tryCloseModal();
});

function showSaveConfirmModal() {
  const modal = document.getElementById("saveConfirmModal");
  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);
}

function closeSaveConfirmModal() {
  const modal = document.getElementById("saveConfirmModal");
  modal.classList.remove("show");
  setTimeout(() => (modal.style.display = "none"), 300);
}

document.getElementById("confirmSaveBtn").onclick = () => {
  document.getElementById("saveEditBtn").click();
  closeSaveConfirmModal();
};

document.getElementById("confirmDiscardBtn").onclick = () => {
  closeSaveConfirmModal();
  closeModal();
};

document.getElementById("continueEditBtn").onclick = () => {
  closeSaveConfirmModal();
};

/* ==============================
   âœ… LIFF åˆå§‹åŒ–
   ============================== */
async function initLiffAndSetProfile() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      nameEl.innerText = "æœªç™»å…¥";
      avatarEl.style.display = "none";
      //æ¸¬è©¦ç”¨
      await loadData();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    console.log("LIFF Profile userId:", userId, "userName:", userName);

    nameEl.innerText = profile.displayName || "å¿—å·¥";
    if (profile.pictureUrl) {
      avatarEl.src = profile.pictureUrl;
      avatarEl.style.display = "inline-block";  
    } 
    else {
      avatarEl.style.display = "none";
    }

    await loadData();
  } catch (err) {
    console.error("LIFF init error:", err);
  }
}

avatarEl.addEventListener("click", () => {
  if (liff.isLoggedIn()) {
    // å·²ç™»å…¥å‰‡é€²å…¥è¨»å†Šé é¢ï¼ˆå¯æ”¹ç‚ºéœ€è¦çš„é é¢è·¯å¾‘ï¼‰
    window.location.href = "../../Login-or-register/index.html";
  } else {
    // ä½¿ç”¨ç•¶å‰é é¢ä½œç‚º redirectUriï¼Œé©ç”¨æ¡Œæ©Ÿ/å¹³æ¿/æ‰‹æ©Ÿ
    liff.login({ redirectUri: window.location.href });
  }
});

nameEl.addEventListener("click", () => {
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
  } else {
    alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
  }
});

/* ==============================
   âœ… åˆå§‹åŒ–è¡¨æ ¼æŒ‰éˆ•
   ============================== */
function addEditButtonsToRows() {
  const tbody = document.getElementById("dataTable").querySelector("tbody");
  Array.from(tbody.rows).forEach(row => {
    if (row.cells.length < 8) {
      const actionCell = row.insertCell(7);
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.innerText = "ç·¨è¼¯";
      editBtn.style.padding = "6px 10px";
      editBtn.onclick = () => openEditModal(row);
      actionCell.appendChild(editBtn);
    }
  });
}

</script>

</body>
</html>
