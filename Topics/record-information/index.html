<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- éŸ¿æ‡‰å¼ï¼Œè®“æ‰‹æ©Ÿå¯æ­£ç¢ºç¸®æ”¾ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>çœ‹è¨ºè³‡è¨Š</title>

<style>
    /* =========================================
       1. å…¨åŸŸèˆ‡åŸºç¤è¨­å®š (Global & Reset)
       èªªæ˜ï¼šé‡ç½®ç€è¦½å™¨é è¨­é‚Šè·ï¼Œè¨­å®šå…¨ç«™å­—é«”èˆ‡ç›’æ¨¡å‹
       ========================================= */
    body {
        font-family: "Arial", sans-serif; /* è¨­å®šé€šç”¨å­—é«” */
        padding: 0;
        box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’å¤§å¯¬åº¦ */
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* =========================================
       2. é ‚éƒ¨å°è¦½åˆ— (Navigation)
       åŠŸèƒ½ï¼šå›ºå®šåœ¨ç•«é¢ä¸Šæ–¹çš„æ¨™é¡Œåˆ—ï¼ŒåŒ…å«ä½¿ç”¨è€…è³‡è¨Š
       ========================================= */
    .nav-1 {
        display: flex;              /* ä½¿ç”¨ Flex æ’ç‰ˆè®“å·¦å³ç‰©ä»¶å°é½Š */
        align-items: center;        /* å‚ç›´ç½®ä¸­ */
        justify-content: space-between; /* å·¦å³å…©ç«¯å°é½Š */
        
        position: sticky;           /* ã€é—œéµã€‘è®“å°è¦½åˆ—æ»¾å‹•æ™‚å¸é™„åœ¨é ‚éƒ¨ */
        top: 0;
        z-index: 1001;              /* å±¤ç´šè¨­é«˜ï¼Œç¢ºä¿è“‹éå…§å®¹èˆ‡è¡¨æ ¼æ¨™é ­ */
        
        width: 100%;
        padding: 10px 25px;         /* ä¸Šä¸‹ 10pxï¼Œå·¦å³ 25px */
        background-color: white;
        border-bottom: 1px solid #ddd; /* åº•éƒ¨ç´°ç·šå¢åŠ å±¤æ¬¡æ„Ÿ */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); /* å¾®å¾®é™°å½± */
        color: black;
    }

    /* --- å°è¦½åˆ—å³å´ï¼šå¿—å·¥/ä½¿ç”¨è€…ç™»å…¥è³‡è¨Šå€ --- */
    .volunteer-area {
        display: flex;
        align-items: center;
        gap: 8px; /* å…ƒç´ é–“è· */
    }

    .volunteer-area .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%; /* åœ“å½¢é ­åƒ */
        object-fit: cover;  /* åœ–ç‰‡ä¸è®Šå½¢å¡«æ»¿ */
        border: 1px solid #ddd;
        display: none;      /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œé€é JS é¡¯ç¤º */
    }

    .volunteer-area #volunteerName {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 6px;
        background: transparent;
    }

    .volunteer-area button {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 14px;
        margin-top: 0; /* è¦†è“‹ä¸‹æ–¹å…¨åŸŸ button çš„ margin è¨­å®š */
    }

    /* =========================================
       3. ç‰ˆé¢å®¹å™¨èˆ‡æ’ç‰ˆ (Layout Containers)
       åŠŸèƒ½ï¼šæ§åˆ¶å…§å®¹èˆ‡å…©å´çš„é–“è·ï¼Œç¢ºä¿æ•´é½Š
       ========================================= */
    
    /* çµ±ä¸€å·¦å³å°é½Šï¼šæ‰€æœ‰ä¸»è¦å€å¡Šå…±ç”¨æ­¤å…§è· */
    .input-container,
    .search-container {
        padding: 0 25px; /* èˆ‡å°è¦½åˆ—å·¦å³é–“è·ä¸€è‡´ï¼Œè¦–è¦ºè¼ƒæ•´é½Š */
        margin-top: 15px;
        box-sizing: border-box;
    }

    .search-container {
        margin-bottom: 30px; /* æœå°‹å€å¡Šä¸‹æ–¹çš„ç·©è¡ç©ºé–“ */
    }

    /* --- æ¨™é¡Œæ–‡å­—æ¨£å¼ --- */
    .title {
        margin: 5px 0;
        font-size: 26px;
    }

    h1 { margin: 5px 0; }
    h2 { 
        margin: 5px 0; 
        font-size: 20px; 
        display: inline-block; 
    }
    h3 { 
        margin: 0; 
        font-size: 16px; 
        color: #555; /* æ¬¡è¦æ¨™é¡Œé¡è‰²è¼ƒæ·¡ */
    }

    /* =========================================
       4. è¡¨å–®èˆ‡è¼¸å…¥å…ƒä»¶ (Forms & Inputs)
       åŠŸèƒ½ï¼šè¼¸å…¥æ¡†ã€æ—¥æœŸé¸å–®ã€æŒ‰éˆ•çš„è¦–è¦ºé¢¨æ ¼
       ========================================= */
    
    /* è¡¨å–®å¤–æ¡†å¡ç‰‡æ¨£å¼ */
    .input-container > form {
        width: 100%;
        margin: 10px 0;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 20px; /* åœ“è§’å¡ç‰‡é¢¨æ ¼ */
        background-color: white;
    }

    label {
        display: block;
        width: 100%;
        margin-bottom: 15px;
        font-size: 20px;
    }

    /* --- è¼¸å…¥æ¬„ä½ (æ–‡å­—ã€æ—¥æœŸã€æ™‚é–“ã€å¤šè¡Œ) é€šç”¨è¨­å®š --- */
    input[type="text"],
    input[type="date"],
    input[type="time"],
    textarea {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border-radius: 10px;
        border: 1px solid #888;
        font-size: 14px;
        background-color: white;
        color: #222;
        box-sizing: border-box;
        min-width: 0; /* ä¿®æ­£ iOS flex item æœ€å°å¯¬åº¦å•é¡Œ */
    }

    /* ç§»é™¤ iOS Safari åŸç”Ÿå¤–è§€ (å¦‚åœ“è§’é™°å½±)ï¼Œè®“æ¨£å¼çµ±ä¸€ */
    input[type="date"],
    input[type="time"] {
        -webkit-appearance: none;
        appearance: none;
    }

    textarea { font-size: 16px; }

    /* å”¯è®€ç‹€æ…‹æ¨£å¼ï¼šä¿æŒç™½åº• (è¦†è“‹ç€è¦½å™¨é è¨­çš„ç°è‰²) */
    input[readonly],
    textarea[readonly],
    input[readonly]:not([type="checkbox"]) {
        background-color: white;
        cursor: default; /* æ»‘é¼ æ¸¸æ¨™ä¸è®Šç‚ºè¼¸å…¥ç‹€ */
    }

    /* --- æŒ‰éˆ•æ¨£å¼ --- */
    button {
        margin-top: 15px;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background-color: #4a90e2; /* ä¸»è‰²èª¿è—è‰² */
        color: white;
        cursor: pointer;
        font-size: 20px;
        transition: background-color 0.3s; /* æ»‘é¼ æ‡¸åœçš„æ¼¸è®Šæ•ˆæœ */
    }

    button:hover {
        background-color: #357abd; /* æ·±è—è‰² */
    }

    /* =========================================
       5. è³‡æ–™è¡¨æ ¼å€ (Data Tables)
       åŠŸèƒ½ï¼šé¡¯ç¤ºæœå°‹çµæœï¼Œæ”¯æ´æ‰‹æ©Ÿæ©«å‘æ²å‹•
       ========================================= */
    
    /* è¡¨æ ¼å®¹å™¨ï¼šè² è²¬ç”¢ç”Ÿæ²è»¸ */
    .table-container {
        width: 100%;
        margin: 5px;
        /* ã€é—œéµã€‘è®“è¡¨æ ¼å…§å®¹éé•·æ™‚å‡ºç¾æ©«å‘æ²è»¸ï¼Œä¸ç ´ç‰ˆ */
        overflow-x: auto;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* è®“ iOS æ»¾å‹•æ›´æ»‘é † */
        border: 1px solid #aaa;
        border-radius: 20px;
        background-color: white;
        display: none; /* é è¨­éš±è—ï¼Œæœå°‹å¾Œç”± JS é–‹å•Ÿ */
    }

    table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 800px; /* è¨­å®šæœ€å°å¯¬åº¦ï¼Œå¼·åˆ¶åœ¨å°è¢å¹•è§¸ç™¼æ©«å‘æ²å‹• */
    }

    th, td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ddd;
        white-space: nowrap; /* ç¦æ­¢æ–‡å­—æ›è¡Œï¼Œä¿æŒè¡¨æ ¼æ•´é½Š */
    }

    /* è¡¨é ­å›ºå®šåŠŸèƒ½ (Sticky Header) */
    th {
        background-color: #f9f9f9;
        position: sticky; /* å›ºå®šä½ç½® */
        top: 0;           /* å¸é™„åœ¨å®¹å™¨é ‚éƒ¨ */
        z-index: 2;       /* ç¢ºä¿è“‹éä¸‹æ–¹è³‡æ–™ */
    }

    /* åˆ—è¡¨é …ç›®æ¨£å¼ (è‹¥éè¡¨æ ¼å‘ˆç¾æ™‚ä½¿ç”¨) */
    .record-item {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
    }

    .no-record {
        text-align: center;
        color: #888;
        font-size: 18px;
        margin: 20px 0;
    }

    /* è¡¨æ ¼æ–‘é¦¬ç´‹ (éš”è¡Œè®Šè‰²) */
    .evenrowcolor { background-color: #f9f9f9; }
    .oddrowcolor { background-color: #ffffff; }

    /* =========================================
       6. ç·¨è¼¯å½ˆçª— (Edit Modal)
       åŠŸèƒ½ï¼šé»æ“Šç·¨è¼¯æ™‚è·³å‡ºçš„å…¨è¢å¹•é®ç½©èˆ‡å°è©±æ¡†
       ========================================= */
    #editModal {
        display: none;          /* é è¨­ä¸é¡¯ç¤º */
        position: fixed;        /* å›ºå®šè¦†è“‹æ•´å€‹è¦–çª— */
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5); /* åŠé€æ˜é»‘åº•é®ç½© */
        z-index: 1000;
        opacity: 0;             /* é€æ˜åº¦å‹•ç•«èµ·å§‹ç‹€æ…‹ */
        transition: opacity 0.3s ease;
    }

    /* åŠ ä¸Š .show é¡åˆ¥æ™‚é¡¯ç¤º */
    #editModal.show {
        display: block;
        opacity: 1;
    }

    /* Modal æœ¬é«” (ç™½è‰²å¡ç‰‡) */
    #editModal > div {
        background: #fff;
        width: 420px;
        max-width: calc(100% - 40px); /* æ‰‹æ©Ÿç‰ˆä¿ç•™å·¦å³é‚Šè· */
        margin: 80px auto;            /* è·é›¢é ‚éƒ¨ 80px */
        padding: 20px 24px;
        border-radius: 15px;
        position: relative;
        max-height: calc(100vh - 100px); /* é™åˆ¶é«˜åº¦é¿å…è¶…å‡ºè¢å¹• */
        overflow-y: auto;             /* å…§å®¹éå¤šæ™‚é¡¯ç¤ºå‚ç›´æ²è»¸ */
        transform: translateY(-20px); /* ä½ç§»å‹•ç•«èµ·å§‹ä½ç½® */
        transition: transform 0.3s ease;
    }

    #editModal.show > div {
        transform: translateY(0);     /* ä½ç§»å›åŸä½ */
    }

    #editModal h3 {
        margin-top: 0;
        text-align: center;
    }

    /* --- ç·¨è¼¯è¦–çª—å…§çš„æŒ‰éˆ•ç¾¤ --- */
    /* å³ä¸Šè§’å–æ¶ˆ/é—œé–‰åœ–ç¤º */
    #cancelEditBtn {
        background: none;
        border: none;
        color: #555;
        font-size: 20px;
        position: absolute;
        top: 10px; right: 10px;
        padding: 5px 10px;
        transition: all 0.3s ease;
    }
    #cancelEditBtn:hover {
        background-color: #e74c3c; /* ç´…è‰²è­¦ç¤º */
        color: white;
        transform: scale(1.1);
    }

    /* é€²å…¥ç·¨è¼¯æ¨¡å¼æŒ‰éˆ• */
    #enterEditBtn {
        position: absolute;
        top: 10px; right: 10px;
        background-color: #f4b977; /* æ©˜é»ƒè‰² */
        color: #333;
        font-size: 14px;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
    }
    #enterEditBtn:hover { background-color: #e0b557; }

    /* å„²å­˜èˆ‡åˆªé™¤æŒ‰éˆ• (é è¨­éš±è—ï¼Œé€²å…¥ç·¨è¼¯æ¨¡å¼å¾Œé¡¯ç¤º) */
    #saveEditBtn, #deleteEditBtn {
        margin-top: 10px;
        font-size: 16px;
        padding: 8px 15px;
        display: none; 
    }
    #saveEditBtn { background-color: #4a90e2; }
    #deleteEditBtn { background-color: #f37a7a; }

    /* =========================================
       7. ç¢ºèªæç¤ºè¦–çª— (Confirmation Modal)
       åŠŸèƒ½ï¼šè©¢å•ã€Œæ˜¯å¦å„²å­˜è®Šæ›´ã€çš„äºŒæ¬¡ç¢ºèª
       ========================================= */
    #saveConfirmModal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 2000; /* å±¤ç´šæœ€é«˜ï¼Œè“‹éç·¨è¼¯è¦–çª— */
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    #saveConfirmModal.show {
        display: block;
        opacity: 1;
    }

    #saveConfirmModal > div {
        background: #fff;
        width: 350px;
        margin: 150px auto;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        transform: translateY(-20px);
        transition: transform 0.3s ease;
    }

    #saveConfirmModal.show > div { transform: translateY(0); }

    /* ç¢ºèªè¦–çª—æŒ‰éˆ• */
    #saveConfirmModal button {
        margin: 10px;
        padding: 8px 18px;
        font-size: 16px;
    }
    #confirmSaveBtn { background-color: #4a90e2; }
    #confirmDiscardBtn { background-color: #f37a7a; }
    #continueEditBtn { background-color: #f2f2f2; color: #333; }

    /* =========================================
       8. éŸ¿æ‡‰å¼è¨­è¨ˆ (RWD for Mobile)
       åŠŸèƒ½ï¼šé‡å°è¢å¹•å¯¬åº¦å°æ–¼ 768px (æ‰‹æ©Ÿ/å¹³æ¿) çš„èª¿æ•´
       ========================================= */
    @media (max-width: 768px) {
        form { width: 95%; } /* è¡¨å–®ä½”æ»¿è¢å¹•å¯¬åº¦ */
        
        /* æ‰‹æ©Ÿç‰ˆè¨­å®šï¼šç§»é™¤è¡¨æ ¼æœ€å°å¯¬åº¦é™åˆ¶ï¼Œè®“å®¹å™¨æ§åˆ¶æ»¾å‹• */
        table {
            min-width: 0;
            width: 100%;
        }
        
        /* æ¥µå°è¢å¹• (å¦‚ iPhone SE) è¨­å®šæœ€å°å¯¬åº¦ä»¥ç¢ºä¿æ©«å‘æ²å‹• */
        @media (max-width: 600px) {
            table { min-width: 700px; }
        }

        /* æ”¾å¤§è¼¸å…¥æ¡†æ–‡å­—èˆ‡æŒ‰éˆ•ï¼Œæ–¹ä¾¿æ‰‹æŒ‡é»æ“Š */
        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea {
            font-size: 16px; /* 16px é˜²æ­¢ iOS è¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§ç•«é¢ */
            padding: 10px;
        }

        button {
            padding: 12px 18px;
            font-size: 16px;
        }
    }
</style>
</head>

<body>
<!-- ==============================
     é é¢æ¨™é¡Œèˆ‡è¡¨å–®
     ============================== -->
<!-- å°è¦½åˆ— -->
<nav class="nav-1" >
  <div>
    <h1 style="margin:0; font-size: 28px;">çœ‹è¨ºè³‡è¨Š</h1>
  </div>

  <div style="display:flex; align-items:center;">
    <h1 style="margin:0; text-align:right;">
      <span class="volunteer-area" style="display:flex; align-items:center; gap:8px;">
        <img id="volunteerAvatar" class="avatar" src="../bookvolunteer/default-avatar.png" alt="avatar" 
             style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #0984e3;">
        <span id="volunteerName" title="é»æ­¤ä»¥ Line ç™»å…¥" style="cursor:pointer; font-size: 26px;">è¼‰å…¥ä¸­</span>
      </span>
    </h1>
  </div>
</nav>


<div class="input-container"> 
<h1 class="title" style="font-size: 24px;"> è¼¸å…¥å…§å®¹</h1>
<!-- è¼¸å…¥è¡¨å–®å€ -->
<form>
  <label>é•·è¼©å§“å<input type="text" id="elderName"></label>
  <label>çœ‹è¨ºæ—¥æœŸ<input type="date" id="date"></label>
  <label>çœ‹è¨ºæ™‚é–“<input type="time" id="time"></label>
  <label>é†«ç”Ÿå§“å<input type="text" id="name"></label>
  <label>é†«ç”Ÿç§‘åˆ¥
  <input type="text" id="department" list="departmentList">
  <datalist id="departmentList">
    <option value="å…§ç§‘"></option>
    <option value="å¤–ç§‘"></option>
    <option value="å°å…’ç§‘"></option>
    <option value="å©¦ç”¢ç§‘"></option>
    <option value="è€³é¼»å–‰ç§‘"></option>
    <option value="çœ¼ç§‘"></option>
    <option value="çš®è†šç§‘"></option>
    <option value="éª¨ç§‘"></option>
    <option value="æ³Œå°¿ç§‘"></option>
    <option value="ç¥ç¶“å…§ç§‘"></option>
    <option value="ç²¾ç¥ç§‘"></option>
    <option value="å¿ƒè‡Ÿå…§ç§‘"></option>
    <option value="èƒ¸è…”å…§ç§‘"></option>
    <option value="èƒƒè…¸è‚è†½ç§‘"></option>
    <option value="å…§åˆ†æ³Œæ–°é™³ä»£è¬ç§‘"></option>
    <option value="å¾©å¥ç§‘"></option>
    <option value="æ•´å½¢å¤–ç§‘"></option>
    <option value="å¤§è…¸ç›´è…¸å¤–ç§‘"></option>
    <option value="æ€¥è¨ºé†«å­¸ç§‘"></option>
    <option value="å®¶åº­é†«å­¸ç§‘"></option>
  </datalist>
</label>
    <label for="record">çœ‹è¨ºå…§å®¹ <textarea id="record" rows="2"></textarea></label>
   

    <label for="note">å‚™è¨»<textarea id="note" rows="2"></textarea></label>
    
  
  <button type="button" onclick="addRow()">æ–°å¢</button>
</form>
</div>

<div class="search-container"> 
<!-- æŸ¥è©¢æ¨™é¡Œ -->

<h1 class="title" style="font-size: 24px;">æŸ¥è©¢</h1>

<!-- æ–°å¢ï¼šç„¡è³‡æ–™æ™‚é¡¯ç¤ºçš„è¨Šæ¯ -->
<div id="no-record-msg" class="no-record">ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>

<!-- ==============================
     è³‡æ–™è¡¨æ ¼å€åŸŸ
     ============================== -->
<div class="table-container">
  <table id="dataTable">
    <thead>
    <tr>
      <th>é•·è¼©å§“å</th>
      <th>çœ‹è¨ºæ—¥æœŸ</th>
      <th>çœ‹è¨ºæ™‚é–“</th>
      <th>é†«ç”Ÿå§“å</th>
      <th>é†«ç”Ÿç§‘åˆ¥</th>
      <th>çœ‹è¨ºå…§å®¹</th>
      <th>å‚™è¨»</th>
      <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody></tbody>
  </table>
  
</div>
</div>

<!-- ==============================
     ç·¨è¼¯è³‡æ–™ Modal è¦–çª—
     ============================== -->
<div id="editModal">
  <div>
    <button id="cancelEditBtn" title="æŒ‰ Esc æˆ–é»æˆ‘é—œé–‰">âœ–</button>
    <button id="enterEditBtn">ç·¨è¼¯</button>

    <div style="display: flex; justify-content: center;">
  <h2>çœ‹è¨ºè³‡è¨Š</h2>
</div>
    <!-- æ¬„ä½è³‡æ–™ -->
    <label>é•·è¼©å§“å<input type="text" id="editElderName" placeholder="é•·è¼©å§“å" readonly></label>
    <label>æ—¥æœŸ<input type="date" id="editDate" readonly></label>
    <label>æ™‚é–“<input type="time" id="editTime" readonly></label>
    <label>é†«ç”Ÿå§“å<input type="text" id="editDoctorName" placeholder="è«‹è¼¸å…¥é†«ç”Ÿå§“å" readonly>
    </label>
    <label>é†«ç”Ÿç§‘åˆ¥
  <input type="text" id="editDepartment" list="editDepartmentList" placeholder="è«‹é¸æ“‡ç§‘åˆ¥" readonly>
  <datalist id="editDepartmentList">
    <option value="å…§ç§‘"></option>
    <option value="å¤–ç§‘"></option>
    <option value="å°å…’ç§‘"></option>
    <option value="å©¦ç”¢ç§‘"></option>
    <option value="è€³é¼»å–‰ç§‘"></option>
    <option value="çœ¼ç§‘"></option>
    <option value="çš®è†šç§‘"></option>
    <option value="éª¨ç§‘"></option>
    <option value="æ³Œå°¿ç§‘"></option>
    <option value="ç¥ç¶“å…§ç§‘"></option>
    <option value="ç²¾ç¥ç§‘"></option>
    <option value="å¿ƒè‡Ÿå…§ç§‘"></option>
    <option value="èƒ¸è…”å…§ç§‘"></option>
    <option value="èƒƒè…¸è‚è†½ç§‘"></option>
    <option value="å…§åˆ†æ³Œæ–°é™³ä»£è¬ç§‘"></option>
    <option value="å¾©å¥ç§‘"></option>
    <option value="æ•´å½¢å¤–ç§‘"></option>
    <option value="å¤§è…¸ç›´è…¸å¤–ç§‘"></option>
    <option value="æ€¥è¨ºé†«å­¸ç§‘"></option>
    <option value="å®¶åº­é†«å­¸ç§‘"></option>
  </datalist>
  </label>
    <label>å…§å®¹<textarea id="editRecord" rows="3" readonly></textarea></label>
    <label>å‚™è¨»<textarea id="editNote" rows="3" readonly></textarea></label>

    <!-- å„²å­˜/åˆªé™¤æŒ‰éˆ• -->
    <div style="text-align:center; margin-top:10px;">
      <button id="saveEditBtn">å„²å­˜</button>
      <button id="deleteEditBtn">åˆªé™¤</button>
    </div>
  </div>
</div>

<!-- ==============================
     å„²å­˜ç¢ºèªæç¤ºè¦–çª—
     ============================== -->
<div id="saveConfirmModal">
  <div>
    <h3>æ­¤æ¬¡ä¿®æ”¹éœ€è¦å„²å­˜å—ï¼Ÿ</h3>
    <p>è‹¥æœªå„²å­˜ï¼Œè®Šæ›´çš„å…§å®¹å°‡æœƒéºå¤±ã€‚</p>
    <button id="confirmSaveBtn">å„²å­˜</button>
    <button id="continueEditBtn">ç¹¼çºŒç·¨è¼¯</button>
    <button id="confirmDiscardBtn">æ”¾æ£„</button>
  </div>
</div>

<!-- ==============================
     JavaScript ç¨‹å¼å€
     ============================== -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
let editRowIndex = null;
let isEditing = false;
let originalData = {};

//Liffåˆå§‹åŒ–ç›¸é—œè®Šæ•¸
const LIFF_ID = "2008484068-qkydRNYN";
const avatarEl = document.getElementById("volunteerAvatar");
const nameEl = document.getElementById("volunteerName");
let userId = "";
let userName = "";
let currentEditEventId = "";

//åŸ·è¡Œfunction
initLiffAndSetProfile();
updateNoRecordMessage();

//æ¸…é™¤è¼¸å…¥è³‡æ–™
function clearInputs() {
  ["elderName", "date", "time", "name", "department", "record", "note"].forEach(id => {
    document.getElementById(id).value = "";
  });
}

/* ==============================
   âœ… é¡¯ç¤ºï¼éš±è—ã€Œç›®å‰å°šæœªæœ‰ç´€éŒ„ã€æç¤º
   ============================== */
function updateNoRecordMessage() {
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  const hasRecords = tbody.rows.length > 0;
  const container = document.querySelector(".table-container");
  const noRecordMsg = document.getElementById("no-record-msg");

  if (hasRecords) {
    container.style.display = "block";
    noRecordMsg.style.display = "none";
  } else {
    container.style.display = "none";
    noRecordMsg.style.display = "block";
  }
}

//æ–°å¢è³‡æ–™
async  function addRow() {
  const elderName = document.getElementById("elderName").value.trim();
  const date = document.getElementById("date").value.trim();
  const time = document.getElementById("time").value.trim();
  const name = document.getElementById("name").value.trim();
  const department = document.getElementById("department").value.trim();
  const record = document.getElementById("record").value.trim();
  const note = document.getElementById("note").value.trim();
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");
  // å­˜å…¥å®Œæˆè®Šæ•¸
  clearInputs();

  if (!date || !time) {
    alert("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ™‚é–“ï¼");
    return;
  }

  //Supabase Post API
  let newEventId = null;   // æ–°å¢çš„ event_id
  try {
    const payload = {
      elder_user_id : userId,   //çœ‹è¨ºè³‡è¨Šå¯èƒ½ç”±å¿—å·¥è¼¸å…¥ï¼Œæ—¥å¾Œæœ‰åˆ¤æ–·èº«åˆ†æ™‚ä½¿ç”¨
      elder_name : elderName,   //å› åŸå…ˆæœ‰è¦ç”¨æ–¼å¿—å·¥å”åŠ©è¼¸å…¥ï¼Œä½†å°šæœªè™•ç†
      visit_time: `${date} ${time}`,
      doctor_name: name,
      department: department,
      visit_details:record,
      remarks: note
    };

    const POST_SUPABASE_API_URL = "https://supabase-api-six.vercel.app/consultations";
    const res = await fetch(POST_SUPABASE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (!res.ok) {
      console.error("âŒ ä¸Šå‚³å¤±æ•—:", result);
      alert("âš ï¸ ä¸Šå‚³è³‡æ–™å¤±æ•—ï¼");
      return;
    }

    console.log("ğŸ‰ æ–°å¢æˆåŠŸ", result);

    newEventId = result?.data?.event_id; // â† å¾ API å›å‚³å–å¾— eventId
    if (!newEventId) console.warn("âš  ç„¡æ³•å–å¾— event_id");

    // æ–°å¢ä¸€åˆ—è³‡æ–™
    const newRow = tbody.insertRow(-1);
    newRow.insertCell(0).innerText = elderName;
    newRow.insertCell(1).innerText = date;
    newRow.insertCell(2).innerText = time;
    newRow.insertCell(3).innerText = name;
    newRow.insertCell(4).innerText = department;
    newRow.insertCell(5).innerText = record;
    newRow.insertCell(6).innerText = note;

    // æ“ä½œæ¬„
    const actionCell = newRow.insertCell(7);
    const editBtn = document.createElement("button");
    editBtn.type = "button";
    editBtn.innerText = "ç·¨è¼¯";
    editBtn.style.padding = "6px 10px";
    editBtn.onclick = () => openEditModal(newRow);
    actionCell.appendChild(editBtn);

    // æ›´æ–°è¡¨æ ¼ç‹€æ…‹
    sortTableByDateTime("dataTable");
    altRows("dataTable");
    addEditButtonsToRows();
    updateNoRecordMessage(); // âœ… æ–°å¢å¾Œç«‹å³æ›´æ–°æç¤º
  } catch (err) {
    console.error("âŒ Supabase éŒ¯èª¤:", err);
    alert("âš ï¸ ç„¡æ³•é€£ç·šè³‡æ–™åº«");
    return;
  }
}

/* ==============================
   âœ… æ—¥æœŸ + æ™‚é–“æ’åºå‡½å¼ï¼ˆç©©å®šç‰ˆï¼‰
   ============================== */
function sortTableByDateTime(tableId) {
  const table = document.getElementById(tableId);
  const tbody = table.querySelector("tbody");
  const rows = Array.from(tbody.rows);

  rows.sort((a, b) => {
    const dateA = a.cells[1]?.innerText || "";
    const timeA = a.cells[2]?.innerText || "";
    const dateB = b.cells[1]?.innerText || "";
    const timeB = b.cells[2]?.innerText || "";
    const dtA = new Date(`${dateA} ${timeA}`);
    const dtB = new Date(`${dateB} ${timeB}`);
    return dtA - dtB;
  });

  rows.forEach(r => tbody.appendChild(r));
}

//åˆå§‹åŒ–è¼‰å…¥è³‡æ–™
async function loadData() {
  const table = document.getElementById("dataTable");
  const tbody = table.querySelector("tbody");

  tbody.innerHTML = "";
  if (userId=="")
  {
    console.log("æ²’æœ‰æª¢æ¸¬åˆ°ä½¿ç”¨è€…ç™»å…¥IDï¼Œæ˜¯å¦æœªç™»å…¥LINEå¸³è™Ÿ?");
    return
  }
  const GET_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}`;

  try {
    const res = await fetch(GET_SUPABASE_API_URL);
    const json = await res.json();

    if (!json.success || !Array.isArray(json.data) || json.data.length === 0) {
      console.warn("âš  API é›–æˆåŠŸä½†ç„¡è³‡æ–™");
      updateNoRecordMessage();
      return;
    }

    json.data.forEach(d => {
      const datetime = d.visit_time ? new Date(d.visit_time) : null;
      const date = datetime ? datetime.toISOString().split("T")[0] : "";
      const time = datetime ? datetime.toISOString().split("T")[1].substring(0, 5) : "";

      const newRow = tbody.insertRow(-1);
      newRow.insertCell(0).innerText = d.elder_name || "";
      newRow.insertCell(1).innerText = date;
      newRow.insertCell(2).innerText = time;
      newRow.insertCell(3).innerText = d.doctor_name || "";
      newRow.insertCell(4).innerText = d.department || "";
      newRow.insertCell(5).innerText = d.visit_details || "";
      newRow.insertCell(6).innerText = d.remarks || "";
      newRow.dataset.event_id = d.event_id

      const actionCell = newRow.insertCell(7);
      const editBtn = document.createElement("button");
      editBtn.innerText = "ç·¨è¼¯";
      editBtn.type = "button";
      editBtn.style.padding = "6px 10px";
      editBtn.onclick = () => openEditModal(newRow);
      actionCell.appendChild(editBtn);
    });

    sortTableByDateTime("dataTable");
    altRows("dataTable");
    addEditButtonsToRows();
    updateNoRecordMessage();
  } catch (err) {
    console.error("âŒ API è®€å–å¤±æ•—", err);
    updateNoRecordMessage();
  }
}

function altRows(id) {
  const table = document.getElementById(id);
  const rows = table.getElementsByTagName("tr");
  for (let i = 1; i < rows.length; i++)
    rows[i].className = (i % 2 === 0) ? "evenrowcolor" : "oddrowcolor";
}

//é–‹å•Ÿç·¨è¼¯è¦–çª—
function openEditModal(row) {
  editRowIndex = row.rowIndex;
  currentEditEventId = row.dataset.event_id;
  const modal = document.getElementById("editModal");
  ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].forEach((f, i) => {
    const val = row.cells[i].innerText;
    document.getElementById("edit" + f).value = val;
    originalData[f] = val;
  });
  setReadOnly(false);
  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);
  document.querySelector(".nav-1").style.display = "none";
}

function setReadOnly(readOnly) {
  document.querySelectorAll("#editModal input, #editModal textarea").forEach(el => {
    el.readOnly = readOnly;
    if (el.type === "date" || el.type === "time") {
      el.style.backgroundColor = "white";
    } else {
      el.style.backgroundColor = readOnly ? "#f7f7f7" : "white";
    }
  });
  document.getElementById("saveEditBtn").style.display = readOnly ? "none" : "inline-block";
  document.getElementById("deleteEditBtn").style.display = readOnly ? "none" : "inline-block";
  document.getElementById("enterEditBtn").style.display = readOnly ? "inline-block" : "none";
  isEditing = !readOnly;
}

document.getElementById("enterEditBtn").onclick = () => setReadOnly(false);

//ç·¨è¼¯ä¸­çš„"å„²å­˜"æŒ‰éˆ•è¢«é»é¸æ™‚åŸ·è¡Œ
document.getElementById("saveEditBtn").onclick = () => {
  const row = document.getElementById("dataTable").rows[editRowIndex];
  ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].forEach((f, i) => {
    row.cells[i].innerText = document.getElementById("edit" + f).value;
  });

  sortTableByDateTime("dataTable");
  altRows("dataTable");
  saveEditData(); // âœ… æ›´æ–°è®Šæ›´
  closeModal();
};

//ç·¨è¼¯ä¸­çš„"åˆªé™¤"æŒ‰éˆ•è¢«é»é¸æ™‚åŸ·è¡Œ
document.getElementById("deleteEditBtn").onclick = () => {
  if (confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) {
    document.getElementById("dataTable").deleteRow(editRowIndex);
    sortTableByDateTime("dataTable");
    altRows("dataTable");
    deleteData(); // âœ… åˆªé™¤å¾Œå„²å­˜
    closeModal();
  }
};

//é€éPatch URL æ›´æ–°ç·¨è¼¯è³‡æ–™åˆ°è³‡æ–™åº«
async function saveEditData() {
  if (!currentEditEventId) {
    console.error("âŒ event_id ä¸å­˜åœ¨ï¼Œç„¡æ³• PATCH");
    return;
  }

  const elderName = document.getElementById("editElderName").value;
  const date = document.getElementById("editDate").value;
  const time = document.getElementById("editTime").value;
  const doctorName = document.getElementById("editDoctorName").value;
  const department = document.getElementById("editDepartment").value;
  const record = document.getElementById("editRecord").value;
  const note = document.getElementById("editNote").value;

  const visit_time = `${date}T${time}:00`;

  const payload = {
    elder_name: elderName,
    visit_time: visit_time,
    doctor_name: doctorName,
    department: department,
    visit_details: record,
    remarks: note
  };

  const PATCH_SUPABASE_API_URL = `https://supabase-api-six.vercel.app/consultations/${userId}/${currentEditEventId}`;

  try {
    const res = await fetch(PATCH_SUPABASE_API_URL, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    console.log("PATCH å›å‚³ï¼š", json);

    if (json.success) {
      alert("è³‡æ–™æ›´æ–°å·²å®Œæˆï¼âœ¨");
    } else {
      alert("æ›´æ–°å¤±æ•—ï¼š" + json.message);
    }
  } catch (err) {
    console.error("âŒ PATCH API éŒ¯èª¤ï¼š", err);
    alert("æ›´æ–°å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ console");
  }
}

//é€éDelete URL åˆªé™¤ç·¨è¼¯è³‡æ–™åˆ°è³‡æ–™åº«
async function deleteData() {
  // ğŸ“Œ æ­£ç¢º Delete API URL
  const DELETE_API_URL =
    `https://supabase-api-six.vercel.app/consultations/${userId}/${currentEditEventId}`;

  try {
    const res = await fetch(DELETE_API_URL, {
      method: "DELETE"
    });

    if (!res.ok) {
      alert("åˆªé™¤å¤±æ•—: " + (result.message || res.status));
      return;
    }
    alert("åˆªé™¤æˆåŠŸï¼");
  }catch (err) {
    console.error("DELETE Errorï¼š", err);
    alert("åˆªé™¤æ™‚ç™¼ç”ŸéŒ¯èª¤");
  }
}

function hasChanges() {
  return ["ElderName", "Date", "Time", "DoctorName", "Department", "Record", "Note"].some(
    f => document.getElementById("edit" + f).value !== originalData[f]
  );
}

function tryCloseModal() {
  if (isEditing && hasChanges()) {
    showSaveConfirmModal();
  } else {
    closeModal();
  }
}

//é—œé–‰ç·¨è¼¯å®¤çª—
function closeModal() {
  const modal = document.getElementById("editModal");
  modal.classList.remove("show");
  setTimeout(() => (modal.style.display = "none"), 300);
  setReadOnly(true);
  document.querySelector(".nav-1").style.display = "flex";
}

document.getElementById("cancelEditBtn").onclick = () => tryCloseModal();
document.addEventListener("keydown", e => {
  if (e.key === "Escape") tryCloseModal();
});

function showSaveConfirmModal() {
  const modal = document.getElementById("saveConfirmModal");
  modal.style.display = "block";
  setTimeout(() => modal.classList.add("show"), 10);
}

function closeSaveConfirmModal() {
  const modal = document.getElementById("saveConfirmModal");
  modal.classList.remove("show");
  setTimeout(() => (modal.style.display = "none"), 300);
}

document.getElementById("confirmSaveBtn").onclick = () => {
  document.getElementById("saveEditBtn").click();
  closeSaveConfirmModal();
};

document.getElementById("confirmDiscardBtn").onclick = () => {
  closeSaveConfirmModal();
  closeModal();
};

document.getElementById("continueEditBtn").onclick = () => {
  closeSaveConfirmModal();
};

/* ==============================
   âœ… LIFF åˆå§‹åŒ–
   ============================== */
async function initLiffAndSetProfile() {
  try {
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isLoggedIn()) {
      nameEl.innerText = "æœªç™»å…¥";
      avatarEl.style.display = "none";
      //æ¸¬è©¦ç”¨
      await loadData();
      return;
    }

    const profile = await liff.getProfile();
    userId = profile.userId;
    userName = profile.displayName;
    console.log("LIFF Profile userId:", userId, "userName:", userName);

    nameEl.innerText = profile.displayName || "å¿—å·¥";
    if (profile.pictureUrl) {
      avatarEl.src = profile.pictureUrl;
      avatarEl.style.display = "inline-block";  
    } 
    else {
      avatarEl.style.display = "none";
    }

    await loadData();
  } catch (err) {
    console.error("LIFF init error:", err);
  }
}

avatarEl.addEventListener("click", () => {
  if (liff.isLoggedIn()) {
    // å·²ç™»å…¥å‰‡é€²å…¥è¨»å†Šé é¢ï¼ˆå¯æ”¹ç‚ºéœ€è¦çš„é é¢è·¯å¾‘ï¼‰
    window.location.href = "../../Login-or-register/index.html";
  } else {
    // ä½¿ç”¨ç•¶å‰é é¢ä½œç‚º redirectUriï¼Œé©ç”¨æ¡Œæ©Ÿ/å¹³æ¿/æ‰‹æ©Ÿ
    liff.login({ redirectUri: window.location.href });
  }
});

nameEl.addEventListener("click", () => {
  if (!liff.isLoggedIn()) {
    liff.login({ redirectUri: window.location.href });
  } else {
    alert("å·²ç™»å…¥ï¼š" + (nameEl.innerText || "å¿—å·¥"));
  }
});

/* ==============================
   âœ… åˆå§‹åŒ–è¡¨æ ¼æŒ‰éˆ•
   ============================== */
function addEditButtonsToRows() {
  const tbody = document.getElementById("dataTable").querySelector("tbody");
  Array.from(tbody.rows).forEach(row => {
    if (row.cells.length < 8) {
      const actionCell = row.insertCell(7);
      const editBtn = document.createElement("button");
      editBtn.type = "button";
      editBtn.innerText = "ç·¨è¼¯";
      editBtn.style.padding = "6px 10px";
      editBtn.onclick = () => openEditModal(row);
      actionCell.appendChild(editBtn);
    }
  });
}

</script>

</body>
</html>
